<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>工程・工数管理システム（共有版）</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>

    <script>
        // Babel警告を非表示にする
        console.warn = function (message) {
            if (
                typeof message === "string" &&
                message.includes("You are using the in-browser Babel transformer")
            ) {
                return; // Babel警告を無視
            }
            // その他の警告は通常通り表示
            console.log("Warning:", message);
        };
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
                "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans",
                "Helvetica Neue", sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(135deg,
                    #0f0f0f 0%,
                    #1a1a1a 50%,
                    #000000 100%);
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* モバイル向けスタイル */
        @media (max-width: 768px) {
            .mobile-container {
                padding: 16px 12px;
                padding-bottom: calc(106px + env(safe-area-inset-bottom));
            }

            .mobile-header {
                padding: 8px 12px;
                margin-bottom: 8px;
            }

            .mobile-text-sm {
                font-size: 12px;
            }

            .mobile-text-xs {
                font-size: 10px;
            }

            .mobile-compact-card {
                padding: 8px 12px;
                margin-bottom: 8px;
            }

            /* 配線仕様モーダル内のコンパクトカードのマージン調整 */
            .space-y-3>* {
                margin-bottom: 0 !important;
            }

            /* メーカー指定など深い階層のglassカードも対象に */
            .space-y-3 .mobile-compact-card.glass-card {
                margin-bottom: 0 !important;
            }

            .mobile-button {
                padding: 8px 12px;
                font-size: 12px;
            }

            .mobile-button-small {
                padding: 6px 8px;
                font-size: 10px;
            }
        }

        .icon {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            text-align: center;
            font-size: 1rem;
            line-height: 1.25rem;
        }

        /* ローディングスピナーアニメーション */
        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .glass-card-dark {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .dark-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .dark-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* selectのオプション部分を黒くする */
        .dark-input option {
            background: #1a1a1a;
            color: white;
            border: none;
        }

        .dark-input option:hover {
            background: #2a2a2a;
        }

        .dark-input option:checked {
            background: #3a3a3a;
        }

        /* 既存のselect.dark-inputスタイルを削除して、以下に置き換え */

        /* カスタムセレクトボックス */
        .custom-select-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .custom-select {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 40px 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            transition: all 0.3s ease;
        }

        .custom-select:focus {
            outline: none;
            /* アウトラインだけは消す */
        }

        /* カスタム矢印ボタン */
        .custom-select-arrow {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .custom-select-arrow::before {
            content: '▼';
            color: rgba(255, 255, 255, 0.5);
            font-size: 10px;
            line-height: 1;
        }

        .custom-select-container:hover .custom-select-arrow::before {
            color: rgba(255, 255, 255, 0.7);
            /* ホバー時は明るく */
        }

        /* ホバー時のスタイルは削除 */
        /* .custom-select-container:hover .custom-select-arrow::before を削除 */
        /* フォーカス時の矢印（オプション - 不要なら削除可） */
        /* オプションのスタイル */
        .custom-select option {
            background: #1a1a1a;
            color: white;
            padding: 8px;
        }

        .custom-select option:hover {
            background: #2a2a2a;
        }

        .custom-select option:checked {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .gradient-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: all 0.3s ease;
            transform: translateY(0);
        }

        .gradient-button:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .gradient-green {
            background: linear-gradient(45deg, #11998e, #38ef7d);
        }

        .gradient-green:hover {
            background: linear-gradient(45deg, #38ef7d, #11998e);
        }

        .gradient-red {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .gradient-red:hover {
            background: linear-gradient(45deg, #ee5a24, #ff6b6b);
        }

        .gradient-purple {
            background: linear-gradient(45deg, #a8edea, #fed6e3);
            color: #333;
        }

        .gradient-purple:hover {
            background: linear-gradient(45deg, #fed6e3, #a8edea);
        }


        .gradient-orange {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            color: #333;
        }

        .gradient-orange:hover {
            background: linear-gradient(45deg, #fecfef, #ff9a9e);
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea, #764ba2);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .neon-text {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .floating-animation {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .stat-card {
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.1),
                    rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .modal-overlay {
            /* 既存のスタイル */
            position: fixed;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            height: 100dvh !important;

            /* 強制的に全画面表示 */
            margin: 0 !important;
            padding: 0 !important;
            transform: none !important;

            /* セーフエリア対応は内側要素で */
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            animation: fadeIn 0.3s ease-out;
            overflow: hidden;
            touch-action: none !important;
        }

        /* モーダル内容にセーフエリアを適用 */
        .modal-content {
            animation: slideUp 0.3s ease-out;
            max-width: calc(90vw - env(safe-area-inset-left) - env(safe-area-inset-right));
            max-height: calc(90vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            margin: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            overflow-y: auto;
            z-index: 10000;
            touch-action: auto !important;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-open {
            touch-action: none !important;
            -webkit-overflow-scrolling: touch !important;
        }

        .auth-background {
            background: linear-gradient(135deg,
                    #0f0f0f 0%,
                    #1a1a1a 50%,
                    #000000 100%);
        }

        /* 日付入力のカレンダーアイコンを明るくする */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0);
            cursor: pointer;
        }

        /* パスワード入力の目のアイコンを明るくする */
        input[type="password"]::-ms-reveal {
            filter: invert(1);
        }

        /* Firefox用の日付入力スタイル */
        input[type="date"] {
            color-scheme: dark;
            height: 46px !important;
            min-height: 46px !important;
            box-sizing: border-box;
            text-align: left !important;
            direction: ltr !important;
            -webkit-text-align-last: left !important;
            text-align-last: left !important;
        }

        /* Webkit系ブラウザの日付入力内部テキスト左詰め */
        input[type="date"]::-webkit-datetime-edit,
        input[type="date"]::-webkit-datetime-edit-fields-wrapper,
        input[type="date"]::-webkit-datetime-edit-text {
            text-align: left !important;
            padding-left: 0 !important;
        }

        /* 全ての入力フィールドとセレクトボックスのアウトラインを削除 */
        input:focus,
        select:focus,
        textarea:focus,
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus {
            outline: none !important;
            box-shadow: none !important;
            border-color: rgba(102, 126, 234, 0.5) !important;
        }

        .creator-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* ドラッグアンドドロップのスタイル */
        .task-draggable {
            cursor: grab;
            transition: all 0.2s ease;
        }

        .task-draggable:active {
            cursor: grabbing;
        }

        .task-dragging {
            opacity: 0.5;
        }

        .task-drag-over {
            border: 2px solid #667eea !important;
            background: rgba(102, 126, 234, 0.1) !important;
        }

        .drag-handle {
            color: rgba(255, 255, 255, 0.5);
            cursor: grab;
            padding: 4px;
            margin-right: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            user-select: none;
        }

        .drag-handle:hover {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.1);
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* ガントチャートのスタイル */
        .gantt-container {
            min-width: 1200px;
        }

        .gantt-bar {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .gantt-bar:hover {
            transform: scaleY(1.1);
            z-index: 10;
        }

        .gantt-grid-line {
            border-right: 1px dashed rgba(255, 255, 255, 0.1);
        }

        /* ガントチャートのスクロールバー */
        /* 修正後 */
        .gantt-scroll::-webkit-scrollbar {
            height: 8px;
            /* 横スクロールバー */
            width: 8px;
            /* 縦スクロールバー */
        }

        .gantt-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .gantt-scroll::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 4px;
        }

        .gantt-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }

        /* 縦スクロールバー専用スタイル */
        .gantt-scroll-vertical::-webkit-scrollbar {
            width: 8px;
        }

        .gantt-scroll-vertical::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .gantt-scroll-vertical::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 4px;
        }

        .gantt-scroll-vertical::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }

        /* スクロールバーの交差部分（コーナー）のスタイル */
        .gantt-scroll-vertical::-webkit-scrollbar-corner {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        /* ガントチャート専用のスクロールバーコーナー */
        .timeline-area::-webkit-scrollbar-corner {
            background: rgba(0, 0, 0, 0.3);
        }

        /* タイムラインエリア専用のスクロールバースタイル */
        .timeline-area::-webkit-scrollbar {
            height: 8px;
            /* 横スクロールバー */
            width: 8px;
            /* 縦スクロールバー */
        }

        .timeline-area::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .timeline-area::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 4px;
        }

        .timeline-area::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }

        /* 横スクロールバー専用の高さ調整 */
        .timeline-area::-webkit-scrollbar:horizontal {
            height: 8px;
        }

        /* 縦スクロールバー専用の幅調整 */
        .timeline-area::-webkit-scrollbar:vertical {
            width: 8px;
        }

        /* ガントチャートの境界線統一 */
        .gantt-day-cell {
            box-sizing: border-box;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gantt-day-header {
            box-sizing: border-box;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* かっこいいユーザーアイコン */
        .user-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
        }


        /* カスタムチェックボックス */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        input[type="checkbox"]:checked {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-color: transparent;
        }

        input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 14px;
            line-height: 1;
        }

        input[type="checkbox"]:hover {
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        /* カスタムスピンボタン */
        input[type="number"] {
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: none;
            position: relative;
        }

        /* Webkit系ブラウザ用のスピンボタンカスタマイズ */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
            display: none;
        }

        /* カスタムスピンボタンコンテナ */
        .number-input-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .number-input-container input[type="number"] {
            width: 100%;
            padding-right: 40px;
            /* スピンボタン用のスペース */
        }

        /* カスタムスピンボタン */
        .custom-spin-buttons {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .spin-button {
            width: 20px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.5);
            font-size: 10px;
            line-height: 1;
            transition: all 0.2s ease;
            user-select: none;
        }

        .spin-button:hover {
            color: rgba(255, 255, 255, 0.7);
        }

        .spin-button:active {
            transform: scale(0.95);
        }

        .spin-button-up::before {
            content: '▲';
        }

        .spin-button-down::before {
            content: '▼';
        }

        /* カスタムラジオボタン */
        input[type="radio"] {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            flex-shrink: 0;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* 強制的にレンダリングを安定化 */
            will-change: transform;
            backface-visibility: hidden;
        }

        input[type="radio"]:checked {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-color: transparent;
        }

        /* 白い点を常に存在させ、透明度で制御 */
        input[type="radio"]::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.2s ease;
            /* レンダリング安定化 */
            will-change: opacity;
            backface-visibility: hidden;
        }

        input[type="radio"]:checked::after {
            opacity: 1;
        }

        input[type="radio"]:hover {
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .project-tasks-container {
            transition: max-height 0.3s ease, padding 0.5s ease;
        }

        .project-tasks-container.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
        }

        .project-tasks-container.expanded {
            max-height: none;
            padding-top: 7px;
            padding-bottom: 7px;
            overflow: visible;
        }

        /* 会社詳細コンテナのアニメーション */
        .company-details-container {
            transition: max-height 0.3s ease, padding 0.5s ease;
        }

        .company-details-container.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
        }

        .company-details-container.expanded {
            max-height: 2000px;
            padding-top: 7px;
            padding-bottom: 7px;
            overflow: visible;
        }
    </style>
    <link rel="manifest" href="manifest.json">
    <meta name="theme_color" content="#000000">
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // Firebase設定（実際の設定値に変更してください）
        const firebaseConfig = {
            apiKey: "AIzaSyDBBOuz7NC_8qjTKMoolwiN-sQt2-V8Q2U",
            authDomain: "project-management-app-d2c9a.firebaseapp.com",
            projectId: "project-management-app-d2c9a",
            storageBucket: "project-management-app-d2c9a.firebasestorage.app",
            messagingSenderId: "579983603816",
            appId: "1:579983603816:web:e0a868bd27bd5c8068e3dd",
            measurementId: "G-3Q7D9LZ35E"
        };

        // Firebase初期化
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // Unicodeアイコンの定義
        const icons = {
            plus: '➕',
            play: '▶️',
            pause: '⏸️',
            trash: '🗑️',
            folder: '📁',
            save: '💾',
            refresh: '🔄',
            clock: '🕐',
            chart: '📊',
            check: '✅',
            chevronDown: '▼',
            chevronRight: '▶',
            user: '👤',
            logout: '🚪',
            admin: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        };

        // アイコンボタンのベースコンポーネント（スマホ対応版）
        const IconButton = ({ onClick, icon }) => {
            const [isHovered, setIsHovered] = useState(false);

            const handleClick = (e) => {
                setIsHovered(false);
                if (onClick) {
                    onClick(e);
                }
            };

            return (
                <button
                    onClick={handleClick}
                    // マウスイベント
                    onMouseEnter={() => setIsHovered(true)}
                    onMouseLeave={() => setIsHovered(false)}
                    onMouseDown={() => setIsHovered(true)}
                    onMouseUp={() => setIsHovered(false)}
                    // タッチイベント（スマホ対応）
                    onTouchStart={() => setIsHovered(true)}
                    onTouchEnd={() => setIsHovered(false)}
                    onTouchCancel={() => setIsHovered(false)}
                    style={{
                        color: isHovered ? '#ffffff' : '#9ca3af',
                        transition: 'color 0.2s',
                        background: 'transparent',
                        border: 'none',
                        cursor: 'pointer',
                        padding: '4px',
                        display: 'inline-flex',
                        WebkitTapHighlightColor: 'transparent', // iOS Safari のタップハイライトを無効化
                    }}
                >
                    {icon}
                </button>
            );
        };

        // 編集ボタン
        const EditButton = ({ onClick }) => (
            <IconButton
                onClick={onClick}
                icon={
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                    </svg>
                }
            />
        );

        // 詳細ボタン（サイズ調整版）
        const InfoButton = ({ onClick }) => (
            <IconButton
                onClick={onClick}
                icon={
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M12 16V12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                        <circle cx="12" cy="8" r="0.5" fill="currentColor" />
                    </svg>
                }
            />
        );

        // お気に入りボタン
        const FavoriteButton = ({ onClick, isFavorite }) => (
            <IconButton
                onClick={onClick}
                icon={
                    <svg width="13" height="13" viewBox="0 0 24 24" fill={isFavorite ? "#fbbf24" : "none"} stroke={isFavorite ? "#fbbf24" : "currentColor"} strokeWidth="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                    </svg>
                }
            />
        );

        // 削除ボタン（✕アイコン - 改良版）
        const DeleteButton = ({ onClick }) => (
            <IconButton
                onClick={onClick}
                icon={
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round">
                        <line x1="19" y1="5" x2="5" y2="19" />
                        <line x1="5" y1="5" x2="19" y2="19" />
                    </svg>
                }
            />
        );

        // コピーボタン
        const CopyButton = ({ onClick }) => (
            <IconButton
                onClick={onClick}
                icon={
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                    </svg>
                }
            />
        );

        // メールマーク
        const MailButton = ({ onClick }) => (
            <IconButton
                onClick={onClick}
                icon={
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="gray" strokeWidth="2">
                        <rect x="2" y="4" width="20" height="16" rx="2" />
                        <path d="M22 7l-10 5L2 7" />
                    </svg>
                }
            />
        );

        // タブナビゲーション用アイコンコンポーネント（細いバージョン）
        const TabIcons = {
            // 案件アイコン（フォルダー - 改良版）
            Projects: ({ size = 20, color = "currentColor" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M3 7v11a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-7l-2-2H5a2 2 0 0 0-2 2z" />
                </svg>
            ),

            // 会社アイコン（ビル）
            Companies: ({ size = 20, color = "currentColor" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M3 21h18" />
                    <path d="M5 21V7l8-4v18" />
                    <path d="M19 21V11l-6-3" />
                    <rect x="9" y="9" width="4" height="4" />
                    <rect x="9" y="14" width="4" height="4" />
                </svg>
            ),

            // ガントチャートアイコン（線を上寄せ）
            Gantt: ({ size = 20, color = "currentColor" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <rect x="3" y="4" width="18" height="16" rx="2" />
                    <rect x="7" y="7" width="8" height="2" />
                    <rect x="9" y="11" width="6" height="2" />
                    <rect x="6" y="15" width="9" height="2" />
                </svg>
            ),

            // 分析アイコン（棒グラフ - シンプル版）
            Analytics: ({ size = 20, color = "currentColor" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <rect x="5" y="13" width="3" height="8" />
                    <rect x="10.5" y="9" width="3" height="12" />
                    <rect x="16" y="5" width="3" height="16" />
                </svg>
            ),

            // マイページアイコン（ユーザー）
            MyPage: ({ size = 20, color = "currentColor" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                    <circle cx="12" cy="7" r="4" />
                </svg>
            ),

            // ログアウトアイコン（扉から出る）
            Logout: ({ size = 20, color = "currentColor" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                    <polyline points="16,17 21,12 16,7" />
                    <line x1="21" y1="12" x2="9" y2="12" />
                </svg>
            )
        };

        function ProjectManagementApp() {
            // 認証関連の状態
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authMode, setAuthMode] = useState('login'); // 'login' or 'register'
            const [authForm, setAuthForm] = useState({
                email: '',
                password: '',
                name: '',
                confirmPassword: ''
            });
            const [authError, setAuthError] = useState('');
            const [emailVerificationSent, setEmailVerificationSent] = useState(false);
            const [waitingForVerification, setWaitingForVerification] = useState(false);
            const [isRegistering, setIsRegistering] = useState(false); // ← この行を追加
            const [currentCalendarDate, setCurrentCalendarDate] = useState(new Date());

            // 既存の状態
            const [projects, setProjects] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [workSessions, setWorkSessions] = useState([]); // 作業履歴を追加
            const [activeTab, setActiveTab] = useState('tasks');
            // 修正後：完全な初期化関数
            const resetNewProjectForm = () => {
                setNewProject({
                    name: '',
                    company: '',
                    description: '',
                    startDate: '',
                    deadline: '',
                    amount: '',
                    checklistTemplateId: '',
                    wiringTemplateId: ''
                });
                setSelectedTemplate(null);
                setCompanyInputMode('select');
            };
            const resetNewTaskForm = () => {
                setNewTask({
                    title: '',
                    description: '',
                    estimatedHours: '',
                    projectId: '',
                    actualHours: '',
                    checklistTemplateId: ''
                });
            };
            // ↑この直後または直前に以下を追加
            const [newProject, setNewProject] = useState({
                name: '',
                company: '',
                description: '',
                startDate: '',
                deadline: '',
                amount: '',
                laborCost: '',
                materialCost: '',
                checklistTemplateId: '',
                wiringTemplateId: ''
            });
            const [newTask, setNewTask] = useState({
                title: '',
                description: '',
                estimatedHours: '',
                projectId: '',
                actualHours: '',
                checklistTemplateId: ''  // 追加
            });
            // タイマー状態
            const [activeTimers, setActiveTimers] = useState({});
            const [showNewProjectForm, setShowNewProjectForm] = useState(false);
            const [showNewTaskForm, setShowNewTaskForm] = useState(false);
            const [lastSaved, setLastSaved] = useState(null);
            const [autoSaveEnabled, setAutoSaveEnabled] = useState(true);
            const [collapsedProjects, setCollapsedProjects] = useState({});
            const [searchQuery, setSearchQuery] = useState('');
            // 既存のcollapsedProjectsの後に追加
            const [collapsedCompanies, setCollapsedCompanies] = useState({});
            // ガントチャート案件名欄の幅管理
            const [ganttProjectNameWidth, setGanttProjectNameWidth] = useState({ mobile: 120, desktop: 256 });

            // ガントチャート案件名欄のタッチハンドラー
            const toggleGanttProjectNameWidth = useCallback((isMobile) => {
                setGanttProjectNameWidth(prev => {
                    if (isMobile) {
                        // モバイル: 120px ⇄ 0px（完全に非表示）
                        return {
                            ...prev,
                            mobile: prev.mobile === 120 ? 0 : 120
                        };
                    } else {
                        // デスクトップ: 256px ⇄ 0px（完全に非表示）
                        return {
                            ...prev,
                            desktop: prev.desktop === 256 ? 0 : 256
                        };
                    }
                });
            }, []);

            // 実際の表示幅を考慮したテキスト省略関数
            const truncateFullWidthText = useCallback((text, maxFullWidthChars = 8) => {
                if (!text) return text;

                let widthCount = 0;
                let result = '';

                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    // 全角文字の判定（ひらがな、カタカナ、漢字、全角記号等）
                    const isFullWidth = char.match(/[^\x01-\x7E\xA1-\xDF]/);
                    // 半角文字は全角文字の約0.65倍の幅として計算
                    const charWidth = isFullWidth ? 1 : 0.65;

                    // 次の文字を追加すると制限を超える場合
                    if (widthCount + charWidth > maxFullWidthChars) {
                        return result + '...';
                    }

                    widthCount += charWidth;
                    result += char;
                }

                return result;
            }, []);

            // タスクテンプレート用の状態を追加
            const [taskTemplates, setTaskTemplates] = useState([]);
            const [showTemplateForm, setShowTemplateForm] = useState(false);
            const [newTemplate, setNewTemplate] = useState({
                name: '',
                companyId: '',  // ← 追加
                tasks: [{ title: '', estimatedHours: '', description: '' }]
            });

            // 配線仕様テンプレート用の状態を追加
            const [wiringTemplates, setWiringTemplates] = useState([]);
            const [showWiringForm, setShowWiringForm] = useState(false);
            const [editingWiring, setEditingWiring] = useState(null);
            const [newWiring, setNewWiring] = useState({
                name: '',
                companyId: '',
                specifications: {
                    wire: {
                        power: {
                            standards: [],
                            wiringType: '',
                            phases: {
                                rPhase: '',
                                sPhase: '',
                                tPhase: '',
                                nPhase: '',
                                lPhase: ''
                            },
                            remarks: ''
                        },
                        ground: {
                            caseColor: '',
                            caseDiameter: '',
                            doorColor: '',
                            doorDiameter: '',
                            panelColor: '',
                            panelDiameter: '',
                            remarks: ''
                        },
                        insulationCap: '',
                        insulationCapDiameter: '',
                        insulationCapRemarks: '',
                        controlAC: {
                            standards: '',
                            customStandard: '',
                            commonColor: '',
                            commonDiameter: '',
                            nonCommonColor: '',
                            nonCommonDiameter: '',
                            remarks: ''
                        },
                        controlDC: {
                            standards: '',
                            customStandard: '',
                            pBusColor: '',
                            pBusDiameter: '',
                            nBusColor: '',
                            nBusDiameter: '',
                            otherColor: '',
                            otherDiameter: '',
                            remarks: ''
                        },
                        specialSpec: '',  // ← 追加
                        manufacturerSpecified: false,
                        manufacturer: ''
                    },
                    // ↓ 新規追加
                    markTube: {
                        orientation: {
                            up: '',
                            down: '',
                            left: '',
                            right: ''
                        },
                        fontSize: '',
                        customFontSize: '',
                        length: '',
                        customLength: '',
                        printSpec: '',
                        printSpecDetail: '',
                        remarks: ''  // ← この行を追加
                    },
                    otherConfirm: {
                        tighteningPen: '',
                        tighteningPenDetail: '',
                        matchMark: '',
                        screw: '',
                        screwDetail: '',
                        hookTube: '',
                        spiralTube: '',
                        spiralTubeDetail: '',
                        insulock: '',
                        insulockDetail: '',
                        mountBase: '',
                        mountBaseDetail: '',
                        routeSpecialNote: '',
                        remarks: ''  // ← この行を追加
                    },
                    terminal: {
                        power: '',
                        controlAC: '',
                        controlDC: '',
                        simultaneousCrimp: '',
                        remarks: '',
                        screwClamp: '',
                        screwlessClamp: '',
                        manufacturerSpecified: false,
                        manufacturer: ''
                    },
                    terminalBlock: {
                        cover: '',
                        namePlate: '',
                        bridge: '',
                        maxWires: '',
                        remarks: '',
                        manufacturerSpecified: false,
                        manufacturer: ''
                    },
                    namePlate: {
                        fontSize: '',
                        customFontSize: '',
                        remarks: ''
                    },
                    deviceSeal: {
                        fontSize: '',
                        customFontSize: '',
                        length: '',
                        customLength: '',
                        positions: [],
                        customPosition: '',
                        remarks: ''
                    }
                }
            });
            const [projectWirings, setProjectWirings] = useState({}); // プロジェクトごとの配線仕様
            // チェックリスト関連の状態を追加
            const [checklistTemplates, setChecklistTemplates] = useState([]);
            const [showChecklistForm, setShowChecklistForm] = useState(false);
            const [editingChecklist, setEditingChecklist] = useState(null);
            const [newChecklist, setNewChecklist] = useState({
                name: '',
                companyId: '',
                checkType: 'double', // 'single' または 'double' を追加
                categories: [
                    {
                        name: '',
                        items: [{ name: '', description: '' }]
                    }
                ]
            });
            const [showChecklistModal, setShowChecklistModal] = useState(false);
            const [currentProjectChecklist, setCurrentProjectChecklist] = useState(null);
            const [projectChecklists, setProjectChecklists] = useState({});
            const [selectedTemplate, setSelectedTemplate] = useState(null);
            const [editingTemplate, setEditingTemplate] = useState(null);
            const [originalTemplate, setOriginalTemplate] = useState(null);
            // テンプレートタスクのドラッグ&ドロップ用状態
            const [draggedTemplateTask, setDraggedTemplateTask] = useState(null);
            const [dragOverTemplateTask, setDragOverTemplateTask] = useState(null);
            // チェックリストテンプレートのドラッグ&ドロップ用状態
            const [draggedChecklistCategory, setDraggedChecklistCategory] = useState(null);
            const [dragOverChecklistCategory, setDragOverChecklistCategory] = useState(null);
            const [draggedChecklistItem, setDraggedChecklistItem] = useState(null);
            const [dragOverChecklistItem, setDragOverChecklistItem] = useState(null);
            // チェックリスト編集用の状態を追加
            const [editingProjectChecklist, setEditingProjectChecklist] = useState(null);
            const [showEditChecklistModal, setShowEditChecklistModal] = useState(false);

            // 工数入力モーダル用の状態を追加
            const [showHoursInputModal, setShowHoursInputModal] = useState(false);
            const [hoursInputTask, setHoursInputTask] = useState(null);
            const [selectedDate, setSelectedDate] = useState(() => {
                const today = new Date();
                return today.getFullYear() + '-' +
                    String(today.getMonth() + 1).padStart(2, '0') + '-' +
                    String(today.getDate()).padStart(2, '0');
            });
            const [dailyHours, setDailyHours] = useState('');

            // ソート機能用の状態を追加
            const [sortOption, setSortOption] = useState('created-desc'); // 'created-desc', 'created-asc', 'deadline-asc', 'deadline-desc', 'progress-desc', 'progress-asc'
            const [statusFilter, setStatusFilter] = useState('active'); // 'all', 'active', 'completed'

            // 会社管理用の状態を追加
            const [companies, setCompanies] = useState([]);
            const [showCompanyForm, setShowCompanyForm] = useState(false);
            const [newCompany, setNewCompany] = useState({ name: '', description: '' });
            const [companyInputMode, setCompanyInputMode] = useState('select'); // 'select' or 'manual'
            const [editCompany, setEditCompany] = useState(null);
            const [showEditCompanyForm, setShowEditCompanyForm] = useState(false);

            // 削除確認用の状態
            const [deleteConfirm, setDeleteConfirm] = useState({
                show: false,
                type: '', // 'project' または 'task'
                id: null,
                name: '',
                inputName: ''
            });

            // ログアウト確認用の状態
            const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);

            // 編集用の状態
            const [editProject, setEditProject] = useState(null);
            const [editTask, setEditTask] = useState(null);
            const [showEditProjectForm, setShowEditProjectForm] = useState(false);
            const [showEditTaskForm, setShowEditTaskForm] = useState(false);

            // タイマー経過時間用
            const [timerDisplays, setTimerDisplays] = useState({});


            // activeTimersをFirestoreに保存
            const [isTimerDataLoaded, setIsTimerDataLoaded] = useState(false);

            useEffect(() => {
                console.log('activeTimers changed:', activeTimers, 'user:', user?.uid, 'loaded:', isTimerDataLoaded);
                if (user && Object.keys(activeTimers).length > 0) {
                    console.log('Saving activeTimers to Firestore');
                    const timerData = {
                        userId: user.uid,
                        activeTimers: activeTimers,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // setかaddかを判断するため直接Firestoreを操作
                    db.collection('activeTimers').doc(user.uid).set(timerData, { merge: true })
                        .then(() => {
                            console.log('activeTimers保存成功');
                        })
                        .catch(error => {
                            console.error('activeTimers保存エラー:', error);
                        });
                } else if (user && Object.keys(activeTimers).length === 0 && isTimerDataLoaded && typeof activeTimers === 'object' && activeTimers !== null) {
                    // タイマーが全て停止された場合はドキュメントを削除（データ読み込み完了後のみ）
                    console.log('Deleting activeTimers from Firestore - activeTimers:', activeTimers);
                    db.collection('activeTimers').doc(user.uid).delete().catch(error => {
                        console.error('Failed to delete active timers:', error);
                    });
                }
            }, [activeTimers, user, isTimerDataLoaded]);

            // Firestoreからタイマー状態を復元
            useEffect(() => {
                console.log('Attempting to restore activeTimers for user:', user?.uid);
                if (user) {
                    db.collection('activeTimers').doc(user.uid).get()
                        .then(doc => {
                            console.log('activeTimers document exists:', doc.exists);
                            if (doc.exists) {
                                const data = doc.data();
                                console.log('activeTimers data from Firestore:', data);
                                if (data.activeTimers) {
                                    console.log('Restoring activeTimers:', data.activeTimers);
                                    setActiveTimers(data.activeTimers);
                                    setIsTimerDataLoaded(true);
                                } else {
                                    console.log('No activeTimers in document');
                                    setIsTimerDataLoaded(true);
                                }
                            } else {
                                console.log('No activeTimers document found');
                                setIsTimerDataLoaded(true);
                            }
                        })
                        .catch(error => {
                            console.error('Failed to load active timers from Firestore:', error);
                        });
                }
            }, [user]);

            // アプリ起動時にアクティブなタイマーの表示を復元
            useEffect(() => {
                const updateTimerDisplays = () => {
                    setTimerDisplays(prev => {
                        const newDisplays = { ...prev };
                        Object.keys(activeTimers).forEach(taskId => {
                            if (activeTimers[taskId]) {
                                const elapsedSeconds = Math.floor((Date.now() - activeTimers[taskId].startTime) / 1000);
                                const minutes = Math.floor(elapsedSeconds / 60);
                                const seconds = elapsedSeconds % 60;
                                newDisplays[taskId] = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            }
                        });
                        return newDisplays;
                    });
                };

                // 初回実行
                if (Object.keys(activeTimers).length > 0) {
                    updateTimerDisplays();
                }
            }, [activeTimers]);  // activeTimersが変更された時に実行


            // ドラッグアンドドロップ用の状態
            const [draggedTask, setDraggedTask] = useState(null);
            const [dragOverTask, setDragOverTask] = useState(null);

            // ガントチャートドラッグスクロール用の状態
            const [isDragging, setIsDragging] = useState(false);
            const [startX, setStartX] = useState(0);
            const [scrollLeft, setScrollLeft] = useState(0);
            const ganttScrollRef = useRef(null);
            const scrollPositionRef = useRef(0);

            // 工数詳細表示用の状態
            const [showHoursDetail, setShowHoursDetail] = useState(false);
            const [detailTaskId, setDetailTaskId] = useState(null);

            // プロジェクト詳細表示用の状態
            const [showProjectDetail, setShowProjectDetail] = useState(false);
            const [detailProjectId, setDetailProjectId] = useState(null);

            // 配線仕様モーダル用の状態
            const [showWiringModal, setShowWiringModal] = useState(false);
            const [currentProjectWiring, setCurrentProjectWiring] = useState(null);

            // 日別工数表示モーダル用の状態
            const [showDailyHoursModal, setShowDailyHoursModal] = useState(false);
            const [selectedDateForModal, setSelectedDateForModal] = useState('');
            const [dailyHoursSessions, setDailyHoursSessions] = useState([]);

            // 作業履歴フィルター用の状態
            const [workHistoryFilter, setWorkHistoryFilter] = useState('today'); // 'all', 'today', 'thisweek', 'thismonth', 'lastmonth'

            // お気に入り機能用の状態
            const [favorites, setFavorites] = useState([]);

            // 管理者権限機能用の状態
            const [isAdmin, setIsAdmin] = useState(false);
            const [isMasterAdmin, setIsMasterAdmin] = useState(false);
            const [showUserManagementModal, setShowUserManagementModal] = useState(false);
            const [allUsers, setAllUsers] = useState([]);
            const [adminUsers, setAdminUsers] = useState([]);

            // ユーザーアイコン色設定用の状態
            const [showColorPickerModal, setShowColorPickerModal] = useState(false);
            const [userIconColor, setUserIconColor] = useState('linear-gradient(45deg, #667eea 0%, #764ba2 100%)');
            const [tempIconColor, setTempIconColor] = useState('linear-gradient(45deg, #667eea 0%, #764ba2 100%)');
            const [otherUserColors, setOtherUserColors] = useState({}); // 他のユーザーの色設定

            // マスターアカウントのUID
            const MASTER_ADMIN_UID = 'fjczVboagRRuUNvWVJ9tOLszEnd2';

            // ユーザーの色を取得する関数
            const getUserIconColor = (userId) => {
                if (userId === user?.uid) {
                    return userIconColor; // 現在のユーザー
                }
                return otherUserColors[userId] || 'linear-gradient(45deg, #667eea 0%, #764ba2 100%)'; // 他のユーザーまたはデフォルト
            };

            // 他のユーザーの色設定を読み込む関数
            const loadOtherUserColor = async (userId) => {
                if (userId === user?.uid || otherUserColors[userId]) return; // 現在のユーザーまたは既に読み込み済み

                try {
                    const userSettingsRef = db.collection('userSettings').doc(userId);
                    const userSettingsSnapshot = await userSettingsRef.get();

                    if (userSettingsSnapshot.exists) {
                        const settings = userSettingsSnapshot.data();
                        if (settings.iconColor) {
                            setOtherUserColors(prev => ({
                                ...prev,
                                [userId]: settings.iconColor
                            }));
                        }
                    }
                } catch (error) {
                    console.log(`ユーザー${userId}の色設定読み込みエラー:`, error.message);
                }
            };

            // 全ユーザーの色設定を一括読み込みする関数
            const loadAllUserColors = async (currentUser) => {
                try {
                    // 全userSettingsを取得
                    const userSettingsSnapshot = await db.collection('userSettings').get();
                    const colors = {};

                    userSettingsSnapshot.docs.forEach(doc => {
                        const userId = doc.id;
                        const data = doc.data();

                        // 現在のユーザー以外の色設定を保存
                        if (userId !== currentUser.uid && data.iconColor) {
                            colors[userId] = data.iconColor;
                        }
                    });

                    setOtherUserColors(colors);
                    console.log('全ユーザー色設定読み込み完了:', Object.keys(colors).length, '件');
                } catch (error) {
                    console.log('全ユーザー色設定読み込みエラー:', error.message);
                }
            };


            const autoSaveTimer = useRef(null);


            // 認証状態の監視
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // メール確認状態を再取得
                        await user.reload();

                        // メール確認済みの場合のみログイン状態にする
                        if (user.emailVerified) {
                            setUser(user);
                            loadSharedData(user);
                        } else {
                            setUser(null);
                            // 新規登録中でない場合のみ、確認待ち画面を表示
                            if (!isRegistering && !emailVerificationSent) {
                                setWaitingForVerification(true);
                            }
                        }
                    } else {
                        setUser(null);
                        // ログアウト時はデータをクリア
                        setProjects([]);
                        setTasks([]);
                        setWorkSessions([]);
                        setActiveTimers({});
                        setCompanies([]);
                        setTaskTemplates([]);
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [isRegistering, emailVerificationSent]); // ← 依存配列に追加

            // 共有データの読み込み（userIdフィルタを削除）
            const loadSharedData = async (currentUser) => {  // ⬅️ 引数を追加
                try {
                    // 全プロジェクトの読み込み（userIdフィルタなし）
                    const projectsSnapshot = await db.collection('projects').get();
                    const projectsData = projectsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    projectsData.sort((a, b) => {
                        const aDate = a.createdAt ? a.createdAt.toDate() : new Date(0);
                        const bDate = b.createdAt ? b.createdAt.toDate() : new Date(0);
                        return bDate - aDate;
                    });
                    setProjects(projectsData);

                    // 全プロジェクトを初期状態で閉じる
                    const initialCollapsed = {};
                    projectsData.forEach(project => {
                        initialCollapsed[project.id] = true;
                    });
                    setCollapsedProjects(initialCollapsed);

                    // 全タスクの読み込み（userIdフィルタなし）
                    const tasksSnapshot = await db.collection('tasks').get();
                    const tasksData = tasksSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    tasksData.sort((a, b) => {
                        const aDate = a.createdAt ? a.createdAt.toDate() : new Date(0);
                        const bDate = b.createdAt ? b.createdAt.toDate() : new Date(0);
                        return bDate - aDate;
                    });
                    setTasks(tasksData);

                    // 全作業セッションの読み込み
                    const workSessionsSnapshot = await db.collection('workSessions').get();
                    const workSessionsData = workSessionsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    workSessionsData.sort((a, b) => {
                        const aDate = a.endTime ? a.endTime.toDate() :
                            a.startTime ? a.startTime.toDate() : new Date(0);
                        const bDate = b.endTime ? b.endTime.toDate() :
                            b.startTime ? b.startTime.toDate() : new Date(0);
                        return bDate - aDate;
                    });
                    setWorkSessions(workSessionsData);

                    // ⬇️ 全会社の読み込み（修正）⬇️
                    const companiesSnapshot = await db.collection('companies').get();
                    const companiesData = companiesSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    companiesData.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    setCompanies(companiesData);
                    console.log('会社データ読み込み完了:', companiesData.length, '件');  // デバッグ用

                    // 全会社を初期状態で閉じる
                    const initialCollapsedCompanies = {};
                    companiesData.forEach(company => {
                        initialCollapsedCompanies[company.id] = true;
                    });
                    setCollapsedCompanies(initialCollapsedCompanies);

                    // ⬇️ タスクテンプレートの読み込み（修正）⬇️
                    if (currentUser && currentUser.uid) {  // ⬅️ currentUserを使用
                        // タスクテンプレートの読み込み（全ユーザー共有）
                        const templatesSnapshot = await db.collection('taskTemplates').get();
                        const templatesData = templatesSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setTaskTemplates(templatesData);
                        console.log('工程テンプレート読み込み完了:', templatesData.length, '件');
                        // チェックリストテンプレートの読み込み
                        try {
                            const checklistsSnapshot = await db.collection('checklistTemplates').get();
                            const checklistsData = checklistsSnapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            setChecklistTemplates(checklistsData);
                            console.log('検査リストテンプレート読み込み完了:', checklistsData.length, '件');
                        } catch (error) {
                            console.log('検査リストテンプレート読み込みエラー（初回は正常）:', error.message);
                            setChecklistTemplates([]);
                        }

                        // 配線仕様テンプレートの読み込み
                        try {
                            const wiringSnapshot = await db.collection('wiringTemplates').get();
                            const wiringData = wiringSnapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            setWiringTemplates(wiringData);
                            console.log('配線仕様テンプレート読み込み完了:', wiringData.length, '件');
                        } catch (error) {
                            console.log('配線仕様テンプレート読み込みエラー（初回は正常）:', error.message);
                            setWiringTemplates([]);
                        }

                        // プロジェクトの配線仕様を読み込み
                        try {
                            const projectWiringSnapshot = await db.collection('projectWirings').get();
                            const projectWiringData = {};
                            projectWiringSnapshot.docs.forEach(doc => {
                                const data = doc.data();
                                projectWiringData[data.projectId] = {
                                    id: doc.id,
                                    ...data
                                };
                            });
                            setProjectWirings(projectWiringData);
                            console.log('案件配線仕様読み込み完了:', Object.keys(projectWiringData).length, '件');
                        } catch (error) {
                            console.log('案件配線仕様読み込みエラー（初回は正常）:', error.message);
                            setProjectWirings({});
                        }

                        /// プロジェクトのチェックリスト状態を読み込み
                        try {
                            const projectChecklistsSnapshot = await db.collection('projectChecklists').get();
                            const projectChecklistsData = {};
                            projectChecklistsSnapshot.docs.forEach(doc => {
                                const data = doc.data();
                                // taskIdをキーとして保存
                                const checklistKey = `task_${data.taskId}`;
                                projectChecklistsData[checklistKey] = {
                                    id: doc.id,
                                    ...data
                                };
                            });
                            setProjectChecklists(projectChecklistsData);
                            console.log('案件検査リスト読み込み完了:', Object.keys(projectChecklistsData).length, '件');
                        } catch (error) {
                            console.log('案件検査リスト読み込みエラー（初回は正常）:', error.message);
                            setProjectChecklists({});
                        }

                        // お気に入りデータの読み込み
                        if (currentUser) {
                            try {
                                const favoritesSnapshot = await db.collection('favorites')
                                    .where('userId', '==', currentUser.uid)
                                    .get();
                                const favoritesData = favoritesSnapshot.docs.map(doc => ({
                                    id: doc.id,
                                    ...doc.data()
                                }));
                                setFavorites(favoritesData);
                                console.log('お気に入り読み込み完了:', favoritesData.length, '件');
                            } catch (error) {
                                console.log('お気に入り読み込みエラー（初回は正常）:', error.message);
                                setFavorites([]);
                            }

                            // 管理者権限の確認
                            await checkAdminRights(currentUser);

                            // ユーザー設定の読み込み（アイコン色など）
                            try {
                                const userSettingsRef = db.collection('userSettings').doc(currentUser.uid);
                                const userSettingsSnapshot = await userSettingsRef.get();

                                if (userSettingsSnapshot.exists) {
                                    const settings = userSettingsSnapshot.data();
                                    if (settings.iconColor) {
                                        setUserIconColor(settings.iconColor);
                                        setTempIconColor(settings.iconColor);
                                    }
                                } else {
                                    // 初回のユーザーはデフォルト色を設定
                                    console.log('ユーザー設定が見つかりません。デフォルト色を使用します。');
                                }
                            } catch (error) {
                                console.log('ユーザー設定読み込みエラー:', error.message);
                            }
                        }
                    }

                    // 全ユーザーの色設定を読み込み
                    await loadAllUserColors(currentUser);

                    setLastSaved(new Date());
                } catch (error) {
                    console.error('データ読み込みエラー:', error);
                }
            };

            // 新規登録
            const handleRegister = async (e) => {
                e.preventDefault();
                setAuthError('');

                if (authForm.password !== authForm.confirmPassword) {
                    setAuthError('パスワードが一致しません');
                    return;
                }

                if (authForm.password.length < 6) {
                    setAuthError('パスワードは6文字以上で入力してください');
                    return;
                }

                try {
                    setIsRegistering(true); // 新規登録開始フラグを設定

                    const userCredential = await auth.createUserWithEmailAndPassword(
                        authForm.email,
                        authForm.password
                    );

                    // メール確認を送信
                    const actionCodeSettings = {
                        // 本番環境と開発環境を自動判定
                        url: window.location.href.includes('127.0.0.1')
                            ? 'http://127.0.0.1:5500/index.html'
                            : window.location.origin,
                        handleCodeInApp: false
                    };

                    await userCredential.user.sendEmailVerification(actionCodeSettings);

                    // ユーザーのdisplayNameを設定
                    await userCredential.user.updateProfile({
                        displayName: authForm.name
                    });

                    // ユーザープロフィール情報を保存（メール未確認フラグ付き）
                    await db.collection('users').doc(userCredential.user.uid).set({
                        name: authForm.name,
                        email: authForm.email,
                        emailVerified: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // 確認メール送信完了フラグを立てる
                    setEmailVerificationSent(true);
                    setIsRegistering(false); // 新規登録完了フラグを設定

                    // 一旦ログアウト（メール確認まで待機）
                    await auth.signOut();

                    setAuthForm({ email: '', password: '', name: '', confirmPassword: '' });
                } catch (error) {
                    console.error('新規登録エラー:', error);
                    setAuthError(getAuthErrorMessage(error.code));
                    setIsRegistering(false); // エラー時もフラグをリセット
                }
            };

            // ログイン
            const handleLogin = async (e) => {
                e.preventDefault();
                setAuthError('');

                try {
                    const userCredential = await auth.signInWithEmailAndPassword(
                        authForm.email,
                        authForm.password
                    );

                    // メール確認状態を再取得
                    await userCredential.user.reload();

                    // メール確認済みかチェック
                    if (!userCredential.user.emailVerified) {
                        setWaitingForVerification(true);
                        await auth.signOut();
                        return;
                    }

                    // メール確認済みの場合、Firestoreのフラグを更新
                    await db.collection('users').doc(userCredential.user.uid).update({
                        emailVerified: true,
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    setAuthForm({ email: '', password: '', name: '', confirmPassword: '' });
                    setWaitingForVerification(false);
                } catch (error) {
                    console.error('ログインエラー:', error);
                    setAuthError(getAuthErrorMessage(error.code));
                }
            };

            // ログアウト確認を表示
            const handleLogout = () => {
                setShowLogoutConfirm(true);
            };

            // 実際のログアウト処理
            const confirmLogout = async () => {
                try {
                    await auth.signOut();
                    setShowLogoutConfirm(false);
                } catch (error) {
                    console.error('ログアウトエラー:', error);
                }
            };

            // Firebaseエラーメッセージの日本語化
            const getAuthErrorMessage = (errorCode) => {
                switch (errorCode) {
                    case 'auth/email-already-in-use':
                        return 'このメールアドレスは既に使用されています';
                    case 'auth/invalid-email':
                        return '無効なメールアドレスです';
                    case 'auth/weak-password':
                        return 'パスワードが弱すぎます';
                    case 'auth/user-not-found':
                        return 'ユーザーが見つかりません';
                    case 'auth/wrong-password':
                        return 'パスワードが間違っています';
                    case 'auth/too-many-requests':
                        return 'リクエストが多すぎます。しばらく時間をおいてから再試行してください';
                    default:
                        return 'エラーが発生しました';
                }
            };

            // Firestoreへのデータ保存（共有データとして作成者情報付きで保存）
            const saveToFirestore = async (collection, data, docId = null) => {
                console.log('saveToFirestore called:', { collection, data, docId, user: user?.uid });
                if (!user) {
                    console.error('ユーザーがログインしていません');
                    return null;
                }

                try {
                    let dataWithUser;

                    if (docId) {
                        // 更新時は作成者情報を変更せず、更新者情報のみ追加
                        dataWithUser = {
                            ...data,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedBy: user.uid,
                            updatedByName: user.displayName || user.email
                        };
                    } else {
                        // 新規作成時は作成者情報を設定
                        dataWithUser = {
                            ...data,
                            createdBy: user.uid,
                            createdByName: user.displayName || user.email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                    }

                    console.log('Firestore保存データ:', dataWithUser);

                    if (docId) {
                        await db.collection(collection).doc(docId).update(dataWithUser);
                        console.log(`${collection}更新成功:`, docId);
                        return docId;
                    } else {
                        const docRef = await db.collection(collection).add(dataWithUser);
                        console.log(`${collection}作成成功:`, docRef.id);
                        return docRef.id;
                    }
                } catch (error) {
                    console.error('Firestore保存エラー:', error);
                    console.error('エラーコード:', error.code);
                    console.error('エラーメッセージ:', error.message);

                    // 具体的なエラーメッセージを表示
                    if (error.code === 'permission-denied') {
                        alert('🔒 アクセス権限エラー\n\nFirebase Consoleでセキュリティルールを共有型に変更してください。\n\n詳細な手順:\n1. Firebase Console → Firestore Database → ルール\n2. 認証されたユーザーが全データにアクセスできるよう変更\n3. 「公開」ボタンをクリック');
                    } else if (error.code === 'failed-precondition') {
                        alert('インデックスの設定が必要です。Firebase Consoleでインデックスを作成してください。');
                    } else {
                        alert('データの保存に失敗しました: ' + error.message);
                    }
                    return null;
                }
            };

            // Firestoreからのデータ削除
            const deleteFromFirestore = async (collection, docId) => {
                try {
                    await db.collection(collection).doc(docId).delete();
                    return true;
                } catch (error) {
                    console.error('削除エラー:', error);
                    return false;
                }
            };

            // タイマー経過時間更新用
            useEffect(() => {
                const interval = setInterval(() => {
                    setTimerDisplays(prev => {
                        const newDisplays = { ...prev };
                        Object.keys(activeTimers).forEach(taskId => {
                            if (activeTimers[taskId]) {
                                const elapsedSeconds = Math.floor((Date.now() - activeTimers[taskId].startTime) / 1000);
                                const minutes = Math.floor(elapsedSeconds / 60);
                                const seconds = elapsedSeconds % 60;
                                newDisplays[taskId] = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            }
                        });
                        return newDisplays;
                    });
                }, 1000);

                return () => clearInterval(interval);
            }, [activeTimers]);

            // 削除確認ダイアログを開く
            const openDeleteConfirm = useCallback((type, id, name) => {
                setDeleteConfirm({
                    show: true,
                    type,
                    id,
                    name,
                    inputName: ''
                });
            }, []);

            // ユーザーのタスク別工数を取得
            // 現在の関数を修正
            const getUserTaskHours = useCallback((userId, taskId) => {
                const sessions = workSessions.filter(s => s.userId === userId && s.taskId === taskId);
                return sessions.reduce((sum, session) => sum + (session.hours || session.totalHours || 0), 0);
            }, [workSessions]);

            // 編集ダイアログを開く
            const openEditProject = useCallback((project) => {
                // 現在のプロジェクトに保存されているwiringTemplateIdを使用
                setEditProject({
                    ...project,
                    wiringTemplateId: project.wiringTemplateId || ''
                });
                const existingCompany = companies.find(company => company.name === project.company);
                if (existingCompany || !project.company) {
                    setCompanyInputMode('select');
                } else {
                    setCompanyInputMode('manual');
                }
                setSelectedTemplate(null);
                setShowEditProjectForm(true);
            }, [companies]);

            const openEditTask = useCallback((task) => {
                if (!task || !task.id) return;

                // 現在のユーザーの工数を取得
                const currentUserHours = getUserTaskHours(user.uid, task.id);

                setEditTask({
                    ...task,
                    estimatedHours: parseFloat(task.estimatedHours) || 0,
                    actualHours: currentUserHours  // 自分の実績工数を初期値として設定
                });
                setShowEditTaskForm(true);
            }, [user, getUserTaskHours]);

            // プロジェクト更新
            const updateProject = useCallback(async () => {
                if (editProject && editProject.name.trim()) {
                    const updatedProject = {
                        ...editProject,
                        amount: parseFloat(editProject.amount) || 0,
                        // 作成者情報を明示的に保持
                        createdBy: editProject.createdBy,
                        createdByName: editProject.createdByName,
                        createdAt: editProject.createdAt
                    };

                    const success = await saveToFirestore('projects', updatedProject, editProject.id);
                    if (success) {
                        // タスクテンプレートが選択されていたらタスクを作成
                        if (selectedTemplate) {
                            console.log('工程テンプレートから工程作成開始:', selectedTemplate.name);
                            await createTasksFromTemplate(editProject.id, selectedTemplate);
                            setSelectedTemplate(null);
                            console.log('工程テンプレートからの工程作成完了');
                        }

                        // 配線仕様テンプレートが選択されていたらコピーを作成
                        if (editProject.wiringTemplateId) {
                            const wiringTemplate = wiringTemplates.find(t => t.id === editProject.wiringTemplateId);
                            if (wiringTemplate) {
                                const existingWiring = projectWirings[editProject.id];

                                const wiringCopy = {
                                    projectId: editProject.id,
                                    templateId: wiringTemplate.id,
                                    templateName: wiringTemplate.name,
                                    specifications: wiringTemplate.specifications
                                };

                                if (existingWiring) {
                                    // 既存の配線仕様を更新
                                    const wiringDocId = await saveToFirestore('projectWirings', wiringCopy, existingWiring.id);
                                    if (wiringDocId) {
                                        setProjectWirings(prev => ({
                                            ...prev,
                                            [editProject.id]: {
                                                id: existingWiring.id,
                                                ...wiringCopy
                                            }
                                        }));
                                    }
                                } else {
                                    // 新規配線仕様を作成
                                    const wiringDocId = await saveToFirestore('projectWirings', wiringCopy);
                                    if (wiringDocId) {
                                        setProjectWirings(prev => ({
                                            ...prev,
                                            [editProject.id]: {
                                                id: wiringDocId,
                                                ...wiringCopy
                                            }
                                        }));
                                    }
                                }
                            }
                        }

                        setProjects(prevProjects =>
                            prevProjects.map(p =>
                                p.id === editProject.id ? { ...updatedProject, id: editProject.id } : p
                            )
                        );
                        setShowEditProjectForm(false);
                        setEditProject(null);
                        setCompanyInputMode('select');
                        setLastSaved(new Date());
                    }
                }
            }, [editProject, user, selectedTemplate, wiringTemplates, projectWirings]);

            // タスク更新
            const updateTask = useCallback(async () => {
                if (editTask && editTask.title.trim()) {
                    const updatedTask = {
                        ...editTask,
                        estimatedHours: parseFloat(editTask.estimatedHours) || 0,
                        checklistTemplateId: editTask.checklistTemplateId || null,
                        createdBy: editTask.createdBy,
                        createdByName: editTask.createdByName,
                        createdAt: editTask.createdAt
                    };

                    const success = await saveToFirestore('tasks', updatedTask, editTask.id);
                    if (success) {
                        // チェックリストテンプレートが変更された場合の処理
                        const oldTemplateId = tasks.find(t => t.id === editTask.id)?.checklistTemplateId;
                        const newTemplateId = editTask.checklistTemplateId;

                        if (oldTemplateId !== newTemplateId) {
                            const checklistKey = `task_${editTask.id}`;

                            // 新しいテンプレートが選択された場合のみ既存のチェックリストを削除
                            // 「任意」を選択した場合（newTemplateIdが空文字）は削除しない
                            if (newTemplateId && projectChecklists[checklistKey]) {
                                await deleteFromFirestore('projectChecklists', projectChecklists[checklistKey].id);

                                // ローカル状態を即座に更新
                                setProjectChecklists(prev => {
                                    const newChecklists = { ...prev };
                                    delete newChecklists[checklistKey];
                                    return newChecklists;
                                });
                            }

                            // 新しいチェックリストテンプレートが選択された場合、コピーを作成
                            if (newTemplateId) {
                                const template = checklistTemplates.find(t => t.id === newTemplateId);
                                if (template) {
                                    const checklistCopy = {
                                        taskId: editTask.id,
                                        templateId: template.id,
                                        templateName: template.name,
                                        checkType: template.checkType || 'double',
                                        categories: template.categories.map(cat => ({
                                            ...cat,
                                            items: cat.items.map(item => ({
                                                ...item,
                                                firstCheck: false,
                                                secondCheck: false
                                            }))
                                        }))
                                    };

                                    const checklistDocId = await saveToFirestore('projectChecklists', checklistCopy);
                                    if (checklistDocId) {
                                        setProjectChecklists(prev => ({
                                            ...prev,
                                            [checklistKey]: {
                                                id: checklistDocId,
                                                ...checklistCopy
                                            }
                                        }));
                                    }
                                }
                            }
                        }

                        setTasks(prevTasks =>
                            prevTasks.map(t =>
                                t.id === editTask.id ? { ...updatedTask, id: editTask.id } : t
                            )
                        );
                        setShowEditTaskForm(false);
                        setEditTask(null);
                        setLastSaved(new Date());
                        setTimeout(() => updateProjectStatuses(), 100);
                    }
                }
            }, [editTask, tasks, checklistTemplates, projectChecklists]);

            // 会社作成
            const createCompany = useCallback(async () => {
                if (!newCompany.name.trim()) {
                    return;
                }

                if (!user) {
                    return;
                }

                try {
                    const company = {
                        ...newCompany,
                        name: newCompany.name.trim()
                    };

                    const docId = await saveToFirestore('companies', company);

                    if (docId) {
                        const newCompanyData = {
                            id: docId,
                            ...company,
                            createdBy: user.uid,
                            createdByName: user.displayName || user.email,
                            createdAt: firebase.firestore.Timestamp.now(),
                            updatedAt: firebase.firestore.Timestamp.now()
                        };
                        setCompanies(prevCompanies => [...prevCompanies, newCompanyData].sort((a, b) => a.name.localeCompare(b.name)));
                        setNewCompany({ name: '', description: '' });
                        setShowCompanyForm(false);
                        setLastSaved(new Date());
                    }
                } catch (error) {
                    console.error('会社作成エラー:', error);
                }
            }, [newCompany, user]);

            // 会社削除
            const deleteCompany = useCallback(async (companyId) => {
                const success = await deleteFromFirestore('companies', companyId);
                if (success) {
                    // 関連するチェックリストテンプレートを削除
                    const relatedChecklists = checklistTemplates.filter(c => c.companyId === companyId);
                    for (const checklist of relatedChecklists) {
                        await deleteFromFirestore('checklistTemplates', checklist.id);
                    }

                    // 関連するタスクテンプレートを削除
                    const relatedTemplates = taskTemplates.filter(t => t.companyId === companyId);
                    for (const template of relatedTemplates) {
                        await deleteFromFirestore('taskTemplates', template.id);
                    }

                    // 関連する配線仕様テンプレートを削除
                    const relatedWiringTemplates = wiringTemplates.filter(w => w.companyId === companyId);
                    for (const wiringTemplate of relatedWiringTemplates) {
                        await deleteFromFirestore('wiringTemplates', wiringTemplate.id);
                    }

                    // ローカルの状態を更新
                    setCompanies(prevCompanies => prevCompanies.filter(c => c.id !== companyId));
                    setChecklistTemplates(prevChecklists => prevChecklists.filter(c => c.companyId !== companyId));
                    setTaskTemplates(prevTemplates => prevTemplates.filter(t => t.companyId !== companyId));
                    setWiringTemplates(prevWiringTemplates => prevWiringTemplates.filter(w => w.companyId !== companyId));
                    setLastSaved(new Date());
                    return true;
                }
                return false;
            }, [checklistTemplates, taskTemplates, wiringTemplates]);

            // 削除実行
            const handleDelete = useCallback(async () => {
                let success = false;

                if (deleteConfirm.type === 'project') {
                    success = await deleteProject(deleteConfirm.id);
                } else if (deleteConfirm.type === 'task') {
                    success = await deleteTask(deleteConfirm.id);
                } else if (deleteConfirm.type === 'company') {
                    success = await deleteCompany(deleteConfirm.id);
                } else if (deleteConfirm.type === 'template') {
                    success = await deleteTemplate(deleteConfirm.id);
                } else if (deleteConfirm.type === 'checklist') {
                    success = await deleteChecklistTemplate(deleteConfirm.id);
                } else if (deleteConfirm.type === 'projectChecklist') {
                    // プロジェクトのチェックリストを削除
                    success = await deleteFromFirestore('projectChecklists', deleteConfirm.id);
                    if (success) {
                        // ローカル状態を正しく更新
                        setProjectChecklists(prev => {
                            const newChecklists = { ...prev };
                            // IDで該当するチェックリストを探して削除
                            Object.keys(newChecklists).forEach(key => {
                                if (newChecklists[key].id === deleteConfirm.id) {
                                    // 対応するタスクのchecklistTemplateIdもクリア
                                    const taskIdMatch = key.match(/task_(.+)/);
                                    if (taskIdMatch) {
                                        const taskId = taskIdMatch[1];
                                        setTasks(prevTasks =>
                                            prevTasks.map(task =>
                                                task.id === taskId
                                                    ? { ...task, checklistTemplateId: null }
                                                    : task
                                            )
                                        );
                                    }
                                    delete newChecklists[key];
                                }
                            });
                            return newChecklists;
                        });
                    }
                } else if (deleteConfirm.type === 'wiring') {
                    success = await deleteWiringTemplate(deleteConfirm.id);
                } else if (deleteConfirm.type === 'projectWiring') {
                    success = await deleteFromFirestore('projectWirings', deleteConfirm.id);
                    if (success) {
                        // projectWiringsの状態を更新
                        setProjectWirings(prev => {
                            const newWirings = { ...prev };
                            let deletedProjectId = null;
                            // プロジェクトIDで該当する配線仕様を探して削除
                            Object.keys(newWirings).forEach(key => {
                                if (newWirings[key].id === deleteConfirm.id) {
                                    deletedProjectId = key;
                                    delete newWirings[key];
                                }
                            });
                            return newWirings;
                        });

                        // editProjectのwiringTemplateIdもリセット
                        if (editProject) {
                            setEditProject(prev => ({
                                ...prev,
                                wiringTemplateId: ''
                            }));
                        }
                    }
                }

                if (success) {
                    setDeleteConfirm({ show: false, type: '', id: null, name: '', inputName: '' });
                }
            }, [deleteConfirm, deleteProject, deleteTask, deleteCompany, deleteTemplate, deleteChecklistTemplate, deleteWiringTemplate]);

            // 会社編集を開く
            const openEditCompany = useCallback((company) => {
                setEditCompany({ ...company });
                setShowEditCompanyForm(true);
            }, []);

            // 会社更新
            const updateCompany = useCallback(async () => {
                if (editCompany && editCompany.name.trim()) {
                    const updatedCompany = {
                        ...editCompany,
                        createdBy: editCompany.createdBy,
                        createdByName: editCompany.createdByName,
                        createdAt: editCompany.createdAt
                    };

                    const success = await saveToFirestore('companies', updatedCompany, editCompany.id);
                    if (success) {
                        setCompanies(prevCompanies =>
                            prevCompanies.map(c =>
                                c.id === editCompany.id ? { ...updatedCompany, id: editCompany.id } : c
                            ).sort((a, b) => a.name.localeCompare(b.name))
                        );
                        setShowEditCompanyForm(false);
                        setEditCompany(null);
                        setLastSaved(new Date());
                    }
                }
            }, [editCompany, user]);

            // 検索フィルター（早期定義）
            const filteredProjects = useMemo(() => {
                if (!projects || !Array.isArray(projects)) return [];
                if (!searchQuery.trim()) return projects;
                return projects.filter(project =>
                    (project.name || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
                    (project.company || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
                    (project.description || '').toLowerCase().includes(searchQuery.toLowerCase())
                );
            }, [projects, searchQuery]);

            // プロジェクト折りたたみ管理
            const toggleProjectCollapse = useCallback((projectId) => {
                setCollapsedProjects(prev => ({
                    ...prev,
                    [projectId]: !prev[projectId]
                }));
            }, []);

            // 会社折りたたみ管理
            const toggleCompanyCollapse = useCallback((companyId) => {
                setCollapsedCompanies(prev => ({
                    ...prev,
                    [companyId]: !prev[companyId]
                }));
            }, []);

            const resetAllForms = () => {
                // 新規案件フォーム
                setNewProject({
                    name: '', company: '', description: '', startDate: '',
                    deadline: '', amount: '', checklistTemplateId: '', wiringTemplateId: ''
                });
                setSelectedTemplate(null);

                // 新規工程フォーム
                setNewTask({
                    title: '', description: '', estimatedHours: '',
                    projectId: '', actualHours: '', checklistTemplateId: ''
                });

                // 編集フォーム
                setEditProject(null);
                setEditTask(null);
                setEditCompany(null);

                // その他のフォーム状態
                setCompanyInputMode('select');
                setNewCompany({ name: '', description: '' });
                setEditingTemplate(null);
                setNewTemplate({ name: '', companyId: '', tasks: [{ title: '', estimatedHours: '', description: '' }] });

                // チェックリスト関連を完全リセット
                setEditingChecklist(null);
                setNewChecklist({
                    name: '',
                    companyId: '',
                    checkType: 'single',
                    categories: [{ name: '', items: [{ name: '', description: '' }] }]
                });

                setEditingWiring(null);
                setHoursInputTask(null);
                setSelectedDate(new Date().toISOString().split('T')[0]);
                setDailyHours('');

                // 編集中のプロジェクトチェックリストも完全リセット
                setEditingProjectChecklist(null);
            };

            // 修正後のuseEffect
            useEffect(() => {
                const handleEscKey = (event) => {
                    if (event.key === 'Escape') {
                        // 全フォームを初期化
                        resetAllForms();

                        // 全モーダルを閉じる
                        setShowNewProjectForm(false);
                        setShowNewTaskForm(false);
                        setDeleteConfirm({ show: false, type: '', id: null, name: '', inputName: '' });
                        setShowEditProjectForm(false);
                        setShowEditTaskForm(false);
                        setShowEditCompanyForm(false);
                        setShowCompanyForm(false);
                        setShowHoursDetail(false);
                        setShowProjectDetail(false);
                        setShowTemplateForm(false);
                        setShowChecklistForm(false);
                        setShowChecklistModal(false);
                        setShowWiringForm(false);
                        setShowHoursInputModal(false);
                        setShowEditChecklistModal(false);
                        setShowLogoutConfirm(false);
                        setShowWiringModal(false); // 追加
                        setShowDailyHoursModal(false); // 追加
                        setEditingProjectChecklist(null); // 追加
                    }
                };

                document.addEventListener('keydown', handleEscKey);
                return () => {
                    document.removeEventListener('keydown', handleEscKey);
                };
            }, []);

            // プロジェクトステータス更新（useEffectによる補完）
            const updateProjectStatuses = useCallback(() => {
                setProjects(prevProjects => {
                    let hasChanged = false;
                    const updatedProjects = prevProjects.map(project => {
                        // リアルタイムで統計を計算
                        const projectTasks = tasks.filter(task => String(task.projectId) === String(project.id));
                        const completedTasks = projectTasks.filter(task => task.status === '完了').length;
                        const progress = projectTasks.length > 0 ? (completedTasks / projectTasks.length) * 100 : 0;

                        const newStatus = progress >= 100 ? '完了' : '進行中';
                        if (project.status !== newStatus) {
                            hasChanged = true;
                            const updatedProject = { ...project, status: newStatus };
                            // Firestoreにも保存
                            saveToFirestore('projects', updatedProject, project.id);
                            return updatedProject;
                        }
                        return project;
                    });

                    return hasChanged ? updatedProjects : prevProjects;
                });
            }, [tasks, user]);

            // モーダル表示時のbodyスクロール制御
            // showHoursInputModalを追加
            useEffect(() => {
                const isModalOpen = showNewProjectForm || showNewTaskForm || deleteConfirm.show ||
                    showEditProjectForm || showEditTaskForm || showCompanyForm ||
                    showEditCompanyForm || showHoursDetail || showProjectDetail ||
                    showTemplateForm || showChecklistForm || showChecklistModal ||
                    showEditChecklistModal || showHoursInputModal || showLogoutConfirm ||
                    showWiringModal || showDailyHoursModal || showUserManagementModal || showColorPickerModal;

                if (isModalOpen) {
                    // 現在のスクロール位置を保存
                    scrollPositionRef.current = window.pageYOffset || document.documentElement.scrollTop;
                    document.body.style.position = 'fixed';
                    document.body.style.top = `-${scrollPositionRef.current}px`;
                    document.body.style.width = '100%';
                    document.body.classList.add('modal-open');
                } else {
                    // スクロール位置を復元
                    document.body.style.position = '';
                    document.body.style.top = '';
                    document.body.style.width = '';
                    document.body.classList.remove('modal-open');
                    // 少し遅延させてスクロール位置を復元
                    requestAnimationFrame(() => {
                        window.scrollTo(0, scrollPositionRef.current);
                    });
                }

                return () => {
                    // クリーンアップ
                    document.body.style.position = '';
                    document.body.style.top = '';
                    document.body.style.width = '';
                    document.body.classList.remove('modal-open');
                };
            }, [showNewProjectForm, showNewTaskForm, deleteConfirm.show,
                showEditProjectForm, showEditTaskForm, showCompanyForm,
                showEditCompanyForm, showHoursDetail, showProjectDetail,
                showTemplateForm, showChecklistForm, showChecklistModal,
                showEditChecklistModal, showHoursInputModal, showLogoutConfirm,
                showWiringModal, showDailyHoursModal, showUserManagementModal, showColorPickerModal]);

            useEffect(() => {
                if (projects.length > 0 && tasks.length > 0) {
                    // 少し遅延させて重複実行を避ける
                    const timer = setTimeout(() => {
                        updateProjectStatuses();
                    }, 100);

                    return () => clearTimeout(timer);
                }
            }, [tasks.map(t => t.status).join(','), projects.length, updateProjectStatuses]);

            // プロジェクト作成（最適化版）
            const createProject = useCallback(async () => {
                if (!newProject.name.trim()) {
                    return;
                }

                if (!user) {
                    return;
                }

                try {
                    const project = {
                        ...newProject,
                        amount: parseFloat(newProject.amount) || 0,
                        status: '進行中'
                    };

                    console.log('案件作成開始:', project);
                    const docId = await saveToFirestore('projects', project);
                    console.log('Firestore保存完了:', docId);

                    if (docId) {
                        const newProjectData = {
                            id: docId,
                            ...project,
                            createdBy: user.uid,
                            createdByName: user.displayName || user.email,
                            createdAt: firebase.firestore.Timestamp.now(),
                            updatedAt: firebase.firestore.Timestamp.now()
                        };
                        setProjects(prevProjects => [newProjectData, ...prevProjects]);

                        // タスクテンプレートが選択されていたらタスクを作成
                        if (selectedTemplate) {
                            console.log('工程テンプレートから工程作成開始:', selectedTemplate.name);
                            await createTasksFromTemplate(docId, selectedTemplate);
                            setSelectedTemplate(null);
                            console.log('工程テンプレートからの工程作成完了');
                        }

                        // 配線仕様テンプレートが選択されていたらコピーを作成
                        if (newProject.wiringTemplateId) {
                            const wiringTemplate = wiringTemplates.find(t => t.id === newProject.wiringTemplateId);
                            if (wiringTemplate) {
                                const wiringCopy = {
                                    projectId: docId,
                                    templateId: wiringTemplate.id,
                                    templateName: wiringTemplate.name,
                                    specifications: wiringTemplate.specifications
                                };

                                const wiringDocId = await saveToFirestore('projectWirings', wiringCopy);
                                if (wiringDocId) {
                                    setProjectWirings(prev => ({
                                        ...prev,
                                        [docId]: {
                                            id: wiringDocId,
                                            ...wiringCopy
                                        }
                                    }));
                                }
                            }
                        }

                        // 修正：この部分を以下に置き換え
                        setNewProject({
                            name: '',
                            company: '',
                            description: '',
                            startDate: '',
                            deadline: '',
                            amount: '',
                            checklistTemplateId: '',
                            wiringTemplateId: ''
                        });
                        setSelectedTemplate(null);
                        setCompanyInputMode('select');
                        setShowNewProjectForm(false);
                        setLastSaved(new Date());
                        console.log('案件作成成功');
                    } else {
                        throw new Error('案件の保存に失敗しました');
                    }
                } catch (error) {
                    console.error('案件作成エラー:', error);
                }
            }, [newProject, user, selectedTemplate, wiringTemplates]);
            // プロジェクト削除（最適化版）
            const deleteProject = useCallback(async (projectId) => {
                const success = await deleteFromFirestore('projects', projectId);
                if (success) {
                    // 関連タスクを削除
                    const relatedTasks = tasks.filter(t => String(t.projectId) === String(projectId));
                    for (const task of relatedTasks) {
                        await deleteFromFirestore('tasks', task.id);

                        // タスクに関連するチェックリストも削除
                        const checklistKey = `task_${task.id}`;
                        if (projectChecklists[checklistKey]) {
                            const checklistId = projectChecklists[checklistKey].id;
                            if (checklistId) {
                                await deleteFromFirestore('projectChecklists', checklistId);
                            }
                        }
                    }

                    // 関連するworkSessionsも削除
                    const relatedSessions = workSessions.filter(s => String(s.projectId) === String(projectId));
                    for (const session of relatedSessions) {
                        await deleteFromFirestore('workSessions', session.id);
                    }

                    // 関連するprojectWiringsも削除
                    if (projectWirings[projectId]) {
                        const wiringId = projectWirings[projectId].id;
                        if (wiringId) {
                            await deleteFromFirestore('projectWirings', wiringId);
                        }
                    }

                    // ローカルの状態を更新
                    setProjects(prevProjects => prevProjects.filter(p => p.id !== projectId));
                    setTasks(prevTasks => prevTasks.filter(t => String(t.projectId) !== String(projectId)));
                    setWorkSessions(prevSessions => prevSessions.filter(s => String(s.projectId) !== String(projectId)));

                    // 関連するタスクのチェックリストも削除
                    setProjectChecklists(prev => {
                        const newChecklists = { ...prev };
                        relatedTasks.forEach(task => {
                            delete newChecklists[`task_${task.id}`];
                        });
                        return newChecklists;
                    });

                    // 関連するprojectWiringsもローカル状態から削除
                    setProjectWirings(prev => {
                        const newWirings = { ...prev };
                        delete newWirings[projectId];
                        return newWirings;
                    });

                    // お気に入りからも削除
                    const relatedFavorites = favorites.filter(fav => String(fav.projectId) === String(projectId));
                    for (const favorite of relatedFavorites) {
                        await deleteFromFirestore('favorites', favorite.id);
                    }
                    setFavorites(prev => prev.filter(fav => String(fav.projectId) !== String(projectId)));

                    setLastSaved(new Date());
                    return true;
                }
                return false;
            }, [tasks, workSessions, projectChecklists, projectWirings, favorites]);

            const createTask = async () => {
                if (!newTask.title.trim()) {
                    return;
                }

                if (!newTask.projectId) {
                    return;
                }

                if (!user) {
                    return;
                }

                try {
                    // プロジェクト内の最大order値を取得
                    const projectTasks = tasks.filter(task => String(task.projectId) === String(newTask.projectId));
                    const maxOrder = projectTasks.length > 0 ? Math.max(...projectTasks.map(task => task.order || 0)) : -1;

                    const task = {
                        title: newTask.title,
                        description: newTask.description,
                        projectId: String(newTask.projectId),
                        estimatedHours: parseFloat(newTask.estimatedHours) || 0,
                        status: '進行中',
                        order: maxOrder + 1,
                        checklistTemplateId: newTask.checklistTemplateId || null
                    };

                    console.log('工程作成開始:', task);
                    const docId = await saveToFirestore('tasks', task);
                    console.log('Firestore保存完了:', docId);

                    if (docId) {
                        const newTaskData = {
                            id: docId,
                            ...task,
                            createdBy: user.uid,
                            createdByName: user.displayName || user.email,
                            createdAt: firebase.firestore.Timestamp.now(),
                            updatedAt: firebase.firestore.Timestamp.now()
                        };
                        setTasks(prevTasks => [...prevTasks, newTaskData]);

                        // チェックリストテンプレートが選択されていたら、コピーを作成
                        if (newTask.checklistTemplateId) {
                            const template = checklistTemplates.find(t => t.id === newTask.checklistTemplateId);
                            if (template) {
                                const checklistCopy = {
                                    taskId: docId,
                                    templateId: template.id,
                                    templateName: template.name,
                                    checkType: template.checkType || 'double',
                                    categories: template.categories.map(cat => ({
                                        ...cat,
                                        items: cat.items.map(item => ({
                                            ...item,
                                            firstCheck: false,
                                            secondCheck: false
                                        }))
                                    }))
                                };

                                const checklistKey = `task_${docId}`;
                                const checklistDocId = await saveToFirestore('projectChecklists', checklistCopy);
                                if (checklistDocId) {
                                    setProjectChecklists(prev => ({
                                        ...prev,
                                        [checklistKey]: {
                                            id: checklistDocId,
                                            ...checklistCopy
                                        }
                                    }));
                                }
                            }
                        }

                        // 修正：この部分を以下に置き換え
                        setNewTask({
                            title: '',
                            description: '',
                            estimatedHours: '',
                            projectId: '',
                            actualHours: '',
                            checklistTemplateId: ''
                        });
                        setShowNewTaskForm(false);
                        setLastSaved(new Date());
                        setTimeout(() => updateProjectStatuses(), 100);
                        console.log('工程作成成功');
                    } else {
                        throw new Error('工程の保存に失敗しました');
                    }
                } catch (error) {
                    console.error('工程作成エラー:', error);
                }
            };

            // タスクステータス更新
            const updateTaskStatus = async (taskId, status) => {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    const updatedTask = {
                        ...task,
                        status,
                        createdBy: task.createdBy,
                        createdByName: task.createdByName,
                        createdAt: task.createdAt
                    };

                    // タスクが完了になった場合、アクティブなタイマーを停止
                    // タスクが完了になった場合、アクティブなタイマーを停止の部分を修正
                    if (status === '完了' && activeTimers[taskId]) {
                        const startTime = activeTimers[taskId].startTime;
                        const endTime = Date.now();
                        const duration = (endTime - startTime) / (1000 * 60 * 60);

                        const project = projects.find(p => String(p.id) === String(task.projectId));

                        if (duration > 0) {
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);

                            // 今日の既存セッションを探す
                            const existingSession = workSessions.find(s =>
                                s.userId === user.uid &&
                                s.taskId === taskId &&
                                s.date &&
                                s.date.toDate().toDateString() === today.toDateString()
                            );

                            if (existingSession) {
                                // 既存セッションに時間を追加
                                const updatedSession = {
                                    ...existingSession,
                                    hours: (existingSession.hours || 0) + duration,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                };

                                saveToFirestore('workSessions', updatedSession, existingSession.id).then(() => {
                                    setWorkSessions(prevSessions =>
                                        prevSessions.map(s =>
                                            s.id === existingSession.id
                                                ? { ...s, hours: updatedSession.hours }
                                                : s
                                        )
                                    );
                                });
                            } else {
                                // 新規セッションを作成
                                const workSession = {
                                    taskId: taskId,
                                    taskName: task.title,
                                    projectId: task.projectId,
                                    projectName: project?.name || 'Unknown Project',
                                    userId: user.uid,
                                    userName: user.displayName || user.email,
                                    date: firebase.firestore.Timestamp.fromDate(today),
                                    hours: duration,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                };

                                saveToFirestore('workSessions', workSession).then(docId => {
                                    if (docId) {
                                        const newWorkSession = {
                                            id: docId,
                                            ...workSession
                                        };
                                        setWorkSessions(prevSessions => [newWorkSession, ...prevSessions]);
                                    }
                                });
                            }
                        }

                        setActiveTimers(prev => {
                            const newTimers = { ...prev };
                            delete newTimers[taskId];
                            return newTimers;
                        });

                        setTimerDisplays(prevDisplays => {
                            const newDisplays = { ...prevDisplays };
                            delete newDisplays[taskId];
                            return newDisplays;
                        });
                    }

                    const success = await saveToFirestore('tasks', updatedTask, taskId);
                    if (success) {
                        setTasks(tasks.map(task =>
                            task.id === taskId ? updatedTask : task
                        ));
                        setLastSaved(new Date());
                        setTimeout(() => updateProjectStatuses(), 100);
                    }
                }
            };

            // タイマー開始/停止
            const toggleTimer = async (taskId) => {
                console.log('toggleTimer called for taskId:', taskId);
                setActiveTimers(prev => {
                    const newTimers = { ...prev };
                    if (newTimers[taskId]) {
                        const startTime = newTimers[taskId].startTime;
                        const endTime = Date.now();
                        const additionalHours = (endTime - startTime) / (1000 * 60 * 60);

                        const task = tasks.find(t => t.id === taskId);
                        const project = projects.find(p => String(p.id) === String(task?.projectId));

                        if (task && additionalHours > 0 && user) {
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);

                            // 今日の既存セッションを探す
                            const existingSession = workSessions.find(s =>
                                s.userId === user.uid &&
                                s.taskId === taskId &&
                                s.date &&
                                s.date.toDate().toDateString() === today.toDateString()
                            );

                            if (existingSession) {
                                // 既存セッションに時間を追加
                                const updatedSession = {
                                    ...existingSession,
                                    hours: (existingSession.hours || 0) + additionalHours,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                };

                                saveToFirestore('workSessions', updatedSession, existingSession.id).then(() => {
                                    setWorkSessions(prevSessions =>
                                        prevSessions.map(s =>
                                            s.id === existingSession.id
                                                ? { ...s, hours: updatedSession.hours, updatedAt: new Date() }
                                                : s
                                        )
                                    );
                                });
                            } else {
                                // 新規セッションを作成
                                const newSession = {
                                    userId: user.uid,
                                    userName: user.displayName || user.email,
                                    taskId: taskId,
                                    taskName: task.title,
                                    projectId: task.projectId,
                                    projectName: project?.name || 'Unknown Project',
                                    date: firebase.firestore.Timestamp.fromDate(today),
                                    hours: additionalHours,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                };

                                saveToFirestore('workSessions', newSession).then(docId => {
                                    if (docId) {
                                        setWorkSessions(prevSessions => [
                                            ...prevSessions,
                                            {
                                                ...newSession,
                                                id: docId,
                                                createdAt: new Date(),
                                                updatedAt: new Date()
                                            }
                                        ]);
                                    }
                                });
                            }
                        }

                        delete newTimers[taskId];
                        setTimerDisplays(prevDisplays => {
                            const newDisplays = { ...prevDisplays };
                            delete newDisplays[taskId];
                            return newDisplays;
                        });
                    } else {
                        // 新しいタイマーを開始する前に、他のすべてのタイマーを停止
                        Object.keys(newTimers).forEach(activeTaskId => {
                            if (activeTaskId !== taskId && newTimers[activeTaskId]) {
                                const startTime = newTimers[activeTaskId].startTime;
                                const endTime = Date.now();
                                const additionalHours = (endTime - startTime) / (1000 * 60 * 60);

                                const activeTask = tasks.find(t => t.id === activeTaskId);
                                const activeProject = projects.find(p => String(p.id) === String(activeTask?.projectId));

                                if (activeTask && additionalHours > 0 && user) {
                                    const today = new Date();
                                    today.setHours(0, 0, 0, 0);

                                    // 今日の既存セッションを探す
                                    const existingSession = workSessions.find(s =>
                                        s.userId === user.uid &&
                                        s.taskId === activeTaskId &&
                                        s.date &&
                                        s.date.toDate().toDateString() === today.toDateString()
                                    );

                                    if (existingSession) {
                                        // 既存セッションに時間を追加
                                        const updatedSession = {
                                            ...existingSession,
                                            hours: (existingSession.hours || 0) + additionalHours,
                                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                        };

                                        saveToFirestore('workSessions', updatedSession, existingSession.id).then(() => {
                                            setWorkSessions(prevSessions =>
                                                prevSessions.map(s =>
                                                    s.id === existingSession.id
                                                        ? { ...s, hours: updatedSession.hours, updatedAt: new Date() }
                                                        : s
                                                )
                                            );
                                        });
                                    } else {
                                        // 新規セッションを作成
                                        const newSession = {
                                            userId: user.uid,
                                            userName: user.displayName || user.email,
                                            taskId: activeTaskId,
                                            taskName: activeTask.title,
                                            projectId: activeTask.projectId,
                                            projectName: activeProject?.name || 'Unknown Project',
                                            date: firebase.firestore.Timestamp.fromDate(today),
                                            hours: additionalHours,
                                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                        };

                                        saveToFirestore('workSessions', newSession).then(docId => {
                                            if (docId) {
                                                setWorkSessions(prevSessions => [
                                                    ...prevSessions,
                                                    {
                                                        ...newSession,
                                                        id: docId,
                                                        createdAt: new Date(),
                                                        updatedAt: new Date()
                                                    }
                                                ]);
                                            }
                                        });
                                    }
                                }

                                delete newTimers[activeTaskId];
                            }
                        });

                        // タイマー表示もクリア
                        setTimerDisplays(prevDisplays => {
                            const newDisplays = { ...prevDisplays };
                            Object.keys(newTimers).forEach(activeTaskId => {
                                if (activeTaskId !== taskId) {
                                    delete newDisplays[activeTaskId];
                                }
                            });
                            return {
                                ...newDisplays,
                                [taskId]: '00:00'
                            };
                        });

                        newTimers[taskId] = { startTime: Date.now() };
                    }
                    console.log('toggleTimer newTimers:', newTimers);
                    return newTimers;
                });
            };

            // タスク削除
            const deleteTask = useCallback(async (taskId) => {
                const success = await deleteFromFirestore('tasks', taskId);
                if (success) {
                    // 関連するworkSessionsも削除
                    const relatedSessions = workSessions.filter(s => s.taskId === taskId);
                    for (const session of relatedSessions) {
                        await deleteFromFirestore('workSessions', session.id);
                    }

                    // 関連するprojectChecklistsも削除
                    const checklistKey = `task_${taskId}`;
                    if (projectChecklists[checklistKey]) {
                        const checklistId = projectChecklists[checklistKey].id;
                        if (checklistId) {
                            await deleteFromFirestore('projectChecklists', checklistId);
                        }
                    }

                    // ローカルの状態を更新
                    setTasks(prevTasks => prevTasks.filter(t => t.id !== taskId));
                    setWorkSessions(prevSessions => prevSessions.filter(s => s.taskId !== taskId));
                    setProjectChecklists(prev => {
                        const newChecklists = { ...prev };
                        delete newChecklists[checklistKey];
                        return newChecklists;
                    });
                    setActiveTimers(prev => {
                        const newTimers = { ...prev };
                        delete newTimers[taskId];
                        return newTimers;
                    });
                    setLastSaved(new Date());
                    setTimeout(() => updateProjectStatuses(), 100);
                    return true;
                }
                return false;
            }, [workSessions, projectChecklists]);

            // 工数詳細を開く
            const openHoursDetail = useCallback((taskId) => {
                setDetailTaskId(taskId);
                setShowHoursDetail(true);
            }, []);

            // 工数入力モーダルを開く関数
            const openHoursInputModal = useCallback((task) => {
                setHoursInputTask(task);
                const today = new Date();
                const todayStr = today.getFullYear() + '-' +
                    String(today.getMonth() + 1).padStart(2, '0') + '-' +
                    String(today.getDate()).padStart(2, '0');
                setSelectedDate(todayStr);

                // 選択した日付の既存工数を取得
                const existingSession = workSessions.find(s =>
                    s.userId === user.uid &&
                    s.taskId === task.id &&
                    s.date &&
                    s.date.toDate().toDateString() === new Date(selectedDate).toDateString()
                );

                setDailyHours(existingSession ? parseFloat(existingSession.hours).toFixed(1) : '');
                setShowHoursInputModal(true);
            }, [workSessions, user]);

            // 日別工数を保存する関数
            const saveDailyHours = useCallback(async () => {
                if (!hoursInputTask || !selectedDate) return;

                const hours = parseFloat(dailyHours) || 0;
                const dateObj = new Date(selectedDate);

                // 既存のセッションを探す
                const existingSession = workSessions.find(s =>
                    s.userId === user.uid &&
                    s.taskId === hoursInputTask.id &&
                    s.date &&
                    s.date.toDate().toDateString() === dateObj.toDateString()
                );

                const project = projects.find(p => String(p.id) === String(hoursInputTask.projectId));

                if (existingSession) {
                    // 既存セッションを更新
                    if (hours === 0) {
                        // 工数が0の場合は削除
                        await deleteFromFirestore('workSessions', existingSession.id);
                        setWorkSessions(prev => prev.filter(s => s.id !== existingSession.id));
                    } else {
                        // 工数を更新
                        const updatedSession = {
                            ...existingSession,
                            hours: hours,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        await saveToFirestore('workSessions', updatedSession, existingSession.id);
                        setWorkSessions(prev => prev.map(s =>
                            s.id === existingSession.id ? { ...s, hours: hours, updatedAt: new Date() } : s
                        ));
                    }
                } else if (hours > 0) {
                    // 新規セッションを作成
                    const newSession = {
                        userId: user.uid,
                        userName: user.displayName || user.email,
                        taskId: hoursInputTask.id,
                        taskName: hoursInputTask.title,
                        projectId: hoursInputTask.projectId,
                        projectName: project?.name || 'Unknown Project',
                        date: firebase.firestore.Timestamp.fromDate(dateObj),
                        hours: hours,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    const sessionId = await saveToFirestore('workSessions', newSession);
                    if (sessionId) {
                        setWorkSessions(prev => [...prev, {
                            ...newSession,
                            id: sessionId,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        }]);
                    }
                }

                setShowHoursInputModal(false);
                setHoursInputTask(null);
                setDailyHours('');
            }, [hoursInputTask, selectedDate, dailyHours, workSessions, user, projects]);

            // プロジェクト詳細を開く
            const openProjectDetail = useCallback((projectId) => {
                setDetailProjectId(projectId);
                setShowProjectDetail(true);
            }, []);

            // 配線仕様モーダルを開く
            const openWiringModal = useCallback((projectId) => {
                const wiring = projectWirings[projectId];
                if (wiring) {
                    setCurrentProjectWiring(wiring);
                    setShowWiringModal(true);
                }
            }, [projectWirings]);

            // 日別工数モーダルを開く
            const openDailyHoursModal = useCallback((dateStr) => {
                const targetDate = new Date(dateStr);
                const sessionsForDate = workSessions.filter(session => {
                    if (session.userId !== user.uid || !session.date) return false;

                    // Firestore Timestampを日付に変換して比較
                    const sessionDate = session.date.toDate();
                    return sessionDate.toDateString() === targetDate.toDateString();
                });

                setSelectedDateForModal(dateStr);
                setDailyHoursSessions(sessionsForDate);
                setShowDailyHoursModal(true);
            }, [workSessions, user]);

            // 管理者権限確認
            const checkAdminRights = useCallback(async (currentUser) => {
                if (!currentUser) {
                    setIsAdmin(false);
                    setIsMasterAdmin(false);
                    return;
                }

                // マスターアカウントの確認
                const isMaster = currentUser.uid === MASTER_ADMIN_UID;
                setIsMasterAdmin(isMaster);

                try {
                    // usersコレクションから管理者権限を確認（権限エラーを避けるため）
                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    const userData = userDoc.exists ? userDoc.data() : {};
                    const hasAdminRights = isMaster || (userData.isAdmin === true);
                    setIsAdmin(hasAdminRights);

                    console.log('権限確認完了:', {
                        uid: currentUser.uid,
                        isAdmin: hasAdminRights,
                        isMaster,
                        userData: userData
                    });
                } catch (error) {
                    console.error('管理者権限確認エラー:', error);
                    setIsAdmin(isMaster); // マスターアカウントのみフォールバック
                }
            }, [MASTER_ADMIN_UID]);

            // お気に入り機能
            const toggleFavorite = useCallback(async (projectId) => {
                if (!user) return;

                const existingFavorite = favorites.find(fav => fav.projectId === projectId && fav.userId === user.uid);

                try {
                    if (existingFavorite) {
                        // お気に入り解除
                        await deleteFromFirestore('favorites', existingFavorite.id);
                        setFavorites(prev => prev.filter(fav => fav.id !== existingFavorite.id));
                    } else {
                        // お気に入り追加
                        const favoriteData = {
                            userId: user.uid,
                            projectId: projectId,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        const docId = await saveToFirestore('favorites', favoriteData);
                        if (docId) {
                            setFavorites(prev => [...prev, { id: docId, ...favoriteData }]);
                        }
                    }
                } catch (error) {
                    console.error('お気に入り操作エラー:', error);
                }
            }, [user, favorites, saveToFirestore, deleteFromFirestore]);

            // プロジェクトがお気に入りかどうかを判定
            const isFavorite = useCallback((projectId) => {
                return favorites.some(fav => fav.projectId === projectId && fav.userId === user?.uid);
            }, [favorites, user]);

            // ユーザー管理機能
            const loadAllUsers = useCallback(async () => {
                if (!isMasterAdmin) return;

                try {
                    // 全ユーザーの読み込み
                    const usersSnapshot = await db.collection('users').get();
                    const users = usersSnapshot.docs.map(doc => {
                        const userData = doc.data();
                        return {
                            id: doc.id,
                            email: userData.email,
                            displayName: userData.displayName || userData.name || null,
                            ...userData
                        };
                    });
                    setAllUsers(users);

                    // usersコレクションから管理者権限を読み込み
                    const adminUserIds = users.filter(user => user.isAdmin === true).map(user => user.id);
                    setAdminUsers(adminUserIds);

                    console.log('ユーザー管理データ読み込み完了:', { users: users.length, admins: adminUserIds.length });
                    console.log('ユーザー詳細:', users);
                    console.log('管理者ユーザー:', adminUserIds);
                } catch (error) {
                    console.error('ユーザー管理データ読み込みエラー:', error);
                }
            }, [isMasterAdmin]);

            const updateAdminStatus = useCallback(async (userId, isAdmin) => {
                if (!isMasterAdmin || userId === MASTER_ADMIN_UID) return;

                try {
                    // usersコレクションでisAdminフラグを管理
                    const userRef = db.collection('users').doc(userId);

                    if (isAdmin) {
                        await userRef.set({ isAdmin: true }, { merge: true });
                        setAdminUsers(prev => [...prev.filter(id => id !== userId), userId]);
                    } else {
                        await userRef.set({ isAdmin: false }, { merge: true });
                        setAdminUsers(prev => prev.filter(id => id !== userId));
                    }

                    console.log('管理者権限更新完了:', { userId, isAdmin });

                    // 現在のユーザーの権限が変更された場合、権限を再確認
                    if (userId === user?.uid) {
                        await checkAdminRights(user);
                    }
                } catch (error) {
                    console.error('管理者権限更新エラー:', error);
                }
            }, [isMasterAdmin, MASTER_ADMIN_UID, user, checkAdminRights]);

            const openWiringEditModal = useCallback((projectId) => {
                const wiring = projectWirings[projectId];
                if (wiring) {
                    setEditingWiring(wiring);
                    setNewWiring({
                        name: wiring.templateName || wiring.name || '',
                        companyId: wiring.companyId || '',
                        specifications: wiring.specifications || {
                            wire: {
                                power: {
                                    standards: [],
                                    wiringType: '',
                                    phases: {},
                                    remarks: ''
                                },
                                ground: {
                                    caseColor: '',
                                    caseDiameter: '',
                                    doorColor: '',
                                    doorDiameter: '',
                                    panelColor: '',
                                    panelDiameter: '',
                                    remarks: ''
                                },
                                insulationCap: '',
                                insulationCapDiameter: '',
                                insulationCapRemarks: '',
                                controlAC: {
                                    standards: [],
                                    commonColor: '',
                                    commonDiameter: '',
                                    nonCommonColor: '',
                                    nonCommonDiameter: '',
                                    remarks: ''
                                },
                                controlDC: {
                                    standards: [],
                                    pBusColor: '',
                                    pBusDiameter: '',
                                    nBusColor: '',
                                    nBusDiameter: '',
                                    otherColor: '',
                                    otherDiameter: '',
                                    remarks: ''
                                },
                                specialSpec: '',
                                manufacturerSpecified: false,
                                manufacturer: ''
                            },
                            markTube: {
                                orientation: { up: '', down: '', left: '', right: '' },
                                fontSize: '',
                                customFontSize: '',
                                length: '',
                                customLength: '',
                                printSpec: '',
                                printSpecDetail: '',
                                remarks: ''
                            },
                            otherConfirm: {
                                tighteningPen: '',
                                tighteningPenDetail: '',
                                matchMark: '',
                                screw: '',
                                screwDetail: '',
                                hookTube: '',
                                spiralTube: '',
                                spiralTubeDetail: '',
                                insulock: '',
                                insulockDetail: '',
                                mountBase: '',
                                mountBaseDetail: '',
                                routeSpecialNote: '',
                                remarks: ''
                            },
                            terminal: {
                                power: '',
                                controlAC: '',
                                controlDC: '',
                                simultaneousCrimp: '',
                                screwClamp: '',
                                screwlessClamp: '',
                                remarks: '',
                                manufacturerSpecified: false,
                                manufacturer: ''
                            },
                            terminalBlock: {
                                cover: '',
                                namePlate: '',
                                bridge: '',
                                maxWires: '',
                                remarks: '',
                                manufacturerSpecified: false,
                                manufacturer: ''
                            },
                            namePlate: {
                                fontSize: '',
                                customFontSize: '',
                                remarks: ''
                            },
                            deviceSeal: {
                                fontSize: '',
                                customFontSize: '',
                                length: '',
                                customLength: '',
                                positions: [],
                                customPosition: '',
                                remarks: ''
                            }
                        }
                    });
                    setShowWiringForm(true);
                }
            }, [projectWirings]);

            // ドラッグアンドドロップのハンドラー
            const handleDragStart = (e, task) => {
                setDraggedTask(task);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.outerHTML);
                e.target.style.opacity = '0.5';
            };

            const handleDragEnd = (e) => {
                e.target.style.opacity = '1';
                // 確実にすべての状態をクリア
                setDraggedTask(null);
                setDragOverTask(null);

                // 少し遅延してもう一度クリア（保険）
                setTimeout(() => {
                    setDragOverTask(null);
                }, 50);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                // ドラッグオーバー中は常にタスクを設定（判定エリアを広げる）
                const taskElement = e.currentTarget.closest('.task-draggable');
                if (taskElement && draggedTask) {
                    const taskId = taskElement.getAttribute('data-task-id');
                    if (taskId) {
                        const task = tasks.find(t => t.id === taskId);
                        if (task && task.id !== draggedTask.id) {
                            setDragOverTask(task);
                        }
                    }
                }
            };

            const handleDragEnter = (e, task) => {
                e.preventDefault();
                if (draggedTask && task.id !== draggedTask.id) {
                    setDragOverTask(task);
                }
            };

            const handleDragLeave = (e) => {
                // relatedTargetをチェックして、本当に要素から離れたか判定
                const relatedTarget = e.relatedTarget;
                const currentTarget = e.currentTarget;

                // 子要素への移動でない場合、または完全に外に出た場合のみクリア
                if (!relatedTarget || !currentTarget.contains(relatedTarget)) {
                    setDragOverTask(null);
                }
            };

            // グローバルなドラッグ終了の監視
            useEffect(() => {
                const handleGlobalDragEnd = () => {
                    setDraggedTask(null);
                    setDragOverTask(null);
                };

                // ドキュメント全体でドラッグ終了をキャッチ
                document.addEventListener('dragend', handleGlobalDragEnd);
                document.addEventListener('drop', handleGlobalDragEnd);

                return () => {
                    document.removeEventListener('dragend', handleGlobalDragEnd);
                    document.removeEventListener('drop', handleGlobalDragEnd);
                };
            }, []);

            const handleDrop = async (e, targetTask) => {
                e.preventDefault();

                // ドロップ後は必ずクリア
                setDragOverTask(null);

                if (!draggedTask || draggedTask.id === targetTask.id) {
                    return;
                }

                // 同じプロジェクト内でのみドロップを許可
                if (draggedTask.projectId !== targetTask.projectId) {
                    return;
                }

                // プロジェクト内のタスク一覧を取得
                const projectTasks = tasks
                    .filter(task => String(task.projectId) === String(draggedTask.projectId))
                    .sort((a, b) => (a.order || 0) - (b.order || 0));

                // 新しい順序を計算
                const draggedIndex = projectTasks.findIndex(task => task.id === draggedTask.id);
                const targetIndex = projectTasks.findIndex(task => task.id === targetTask.id);

                if (draggedIndex === -1 || targetIndex === -1) return;

                // タスクを移動
                const newProjectTasks = [...projectTasks];
                const [movedTask] = newProjectTasks.splice(draggedIndex, 1);
                newProjectTasks.splice(targetIndex, 0, movedTask);

                // 新しい順序を設定
                const updatedTasks = newProjectTasks.map((task, index) => ({
                    ...task,
                    order: index
                }));

                // Firestoreに順序を保存
                try {
                    const updatePromises = updatedTasks.map(task =>
                        saveToFirestore('tasks', { ...task, order: task.order }, task.id)
                    );
                    await Promise.all(updatePromises);

                    // ローカル状態を更新
                    setTasks(prevTasks => {
                        const otherTasks = prevTasks.filter(task => String(task.projectId) !== String(draggedTask.projectId));
                        return [...otherTasks, ...updatedTasks].sort((a, b) => {
                            const aDate = a.createdAt ? a.createdAt.toDate() : new Date(0);
                            const bDate = b.createdAt ? b.createdAt.toDate() : new Date(0);
                            return bDate - aDate;
                        });
                    });

                    setLastSaved(new Date());
                } catch (error) {
                    console.error('工程順序の更新に失敗:', error);
                }

                setDraggedTask(null);
                setDragOverTask(null);
            };

            // ガントチャートドラッグスクロールのハンドラー
            const handleGanttMouseDown = (e) => {
                if (e.target.closest('.gantt-bar')) return; // プロジェクトバーをクリックした場合は無視

                // タイムラインエリア（右下）を取得
                const timelineArea = document.querySelector('.timeline-area');
                if (!timelineArea) return;

                setIsDragging(true);
                setStartX(e.pageX - timelineArea.offsetLeft);
                setScrollLeft(timelineArea.scrollLeft);
                timelineArea.style.cursor = 'grabbing';
                timelineArea.style.userSelect = 'none';
            };

            const handleGanttMouseMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();

                // タイムラインエリア（右下）を取得
                const timelineArea = document.querySelector('.timeline-area');
                if (!timelineArea) return;

                const x = e.pageX - timelineArea.offsetLeft;
                const walk = (x - startX) * 2; // スクロール速度調整
                timelineArea.scrollLeft = scrollLeft - walk;
            };

            const handleGanttMouseUp = () => {
                setIsDragging(false);
                const timelineArea = document.querySelector('.timeline-area');
                if (timelineArea) {
                    timelineArea.style.cursor = 'grab';
                    timelineArea.style.userSelect = 'auto';
                }
            };

            const handleGanttMouseLeave = () => {
                if (isDragging) {
                    setIsDragging(false);
                    const timelineArea = document.querySelector('.timeline-area');
                    if (timelineArea) {
                        timelineArea.style.cursor = 'grab';
                        timelineArea.style.userSelect = 'auto';
                    }
                }
            };


            // ガントチャートドラッグスクロールのイベントリスナー設定
            useEffect(() => {
                const ganttElement = ganttScrollRef.current;
                if (!ganttElement) return;

                const handleMouseMove = (e) => handleGanttMouseMove(e);
                const handleMouseUp = () => handleGanttMouseUp();

                if (isDragging) {
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                }

                return () => {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
            }, [isDragging, startX, scrollLeft]);




            // タスクテンプレート保存
            const saveTemplate = async () => {
                if (!newTemplate.name.trim() || newTemplate.tasks.length === 0) return;

                const template = {
                    ...newTemplate,
                    createdAt: editingTemplate ? editingTemplate.createdAt : firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (editingTemplate) {
                    await db.collection('taskTemplates').doc(editingTemplate.id).update(template);
                    setTaskTemplates(prev => prev.map(t =>
                        t.id === editingTemplate.id ? {
                            ...template,
                            id: editingTemplate.id,
                            createdAt: editingTemplate.createdAt,
                            updatedAt: new Date()
                        } : t
                    ));
                } else {
                    const docRef = await db.collection('taskTemplates').add(template);
                    setTaskTemplates(prev => [...prev, {
                        ...template,
                        id: docRef.id,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    }]);
                }

                setShowTemplateForm(false);
                setEditingTemplate(null);
                setOriginalTemplate(null);
                setNewTemplate({ name: '', companyId: '', tasks: [{ title: '', estimatedHours: '', description: '' }] });
            };

            // タスクテンプレート編集のキャンセル処理を統一
            const cancelTemplateEdit = () => {
                // 編集時はオリジナルデータがあれば戻す、なければ初期値
                if (editingTemplate && originalTemplate) {
                    setNewTemplate({ ...originalTemplate });
                } else {
                    setNewTemplate({ name: '', companyId: '', tasks: [{ title: '', estimatedHours: '', description: '' }] });
                }
                setShowTemplateForm(false);
                setEditingTemplate(null);
                setOriginalTemplate(null);
            };

            // タスクテンプレート削除（確認モーダルを使用）
            const deleteTemplate = useCallback(async (templateId) => {
                const success = await deleteFromFirestore('taskTemplates', templateId);
                if (success) {
                    setTaskTemplates(prev => prev.filter(t => t.id !== templateId));
                    setLastSaved(new Date());
                    return true;
                }
                return false;
            }, []);

            // タスクテンプレートコピー
            const copyTemplate = useCallback(async (template) => {
                try {
                    const copiedTemplate = {
                        name: template.name + ' のコピー',
                        companyId: template.companyId,
                        tasks: template.tasks.map(task => ({
                            title: task.title,
                            estimatedHours: task.estimatedHours,
                            description: task.description
                        })),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    const docRef = await db.collection('taskTemplates').add(copiedTemplate);
                    if (docRef && docRef.id) {
                        setTaskTemplates(prev => [...prev, {
                            ...copiedTemplate,
                            id: docRef.id,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        }]);
                        setLastSaved(new Date());
                        return true;
                    }
                } catch (error) {
                    console.error('Error copying task template:', error);
                }
                return false;
            }, []);

            // チェックリストテンプレート保存
            const saveChecklistTemplate = useCallback(async () => {
                if (!newChecklist.name.trim()) return;

                const template = {
                    ...newChecklist,
                    createdAt: editingChecklist ? editingChecklist.createdAt : firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (editingChecklist) {
                    // 編集モード
                    const success = await saveToFirestore('checklistTemplates', template, editingChecklist.id);
                    if (success) {
                        setChecklistTemplates(prev => prev.map(t =>
                            t.id === editingChecklist.id ? {
                                ...template,
                                id: editingChecklist.id,
                                createdAt: editingChecklist.createdAt,
                                updatedAt: new Date()
                            } : t
                        ));
                        setShowChecklistForm(false);
                        setEditingChecklist(null);
                        setNewChecklist({
                            name: '',
                            companyId: '',
                            checkType: 'single',
                            categories: [{ name: '', items: [{ name: '', description: '' }] }]
                        });
                    }
                } else {
                    // 新規作成モード
                    const docId = await saveToFirestore('checklistTemplates', template);
                    if (docId) {
                        setChecklistTemplates(prev => [...prev, {
                            ...template,
                            id: docId,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        }]);
                        setShowChecklistForm(false);
                        setNewChecklist({
                            name: '',
                            companyId: '',
                            checkType: 'single',
                            categories: [{ name: '', items: [{ name: '', description: '' }] }]
                        });
                    }
                }
            }, [newChecklist, editingChecklist]);

            // チェックリスト削除
            const deleteChecklistTemplate = useCallback(async (templateId) => {
                const success = await deleteFromFirestore('checklistTemplates', templateId);
                if (success) {
                    setChecklistTemplates(prev => prev.filter(t => t.id !== templateId));
                    return true;
                }
                return false;
            }, []);

            // チェックリストテンプレートコピー
            const copyChecklistTemplate = useCallback(async (template) => {
                try {
                    const copiedTemplate = {
                        name: template.name + ' のコピー',
                        companyId: template.companyId,
                        checkType: template.checkType || 'single',
                        categories: template.categories.map(category => ({
                            name: category.name,
                            items: category.items.map(item => ({
                                name: item.name,
                                description: item.description
                            }))
                        })),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    const docRef = await db.collection('checklistTemplates').add(copiedTemplate);
                    if (docRef && docRef.id) {
                        setChecklistTemplates(prev => [...prev, {
                            ...copiedTemplate,
                            id: docRef.id,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        }]);
                        return true;
                    }
                } catch (error) {
                    console.error('Error copying checklist template:', error);
                }
                return false;
            }, []);

            // 配線仕様テンプレート保存
            const saveWiringTemplate = useCallback(async () => {
                if (!newWiring.name.trim()) return;

                const template = {
                    ...newWiring,
                    createdAt: editingWiring ? editingWiring.createdAt : firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (editingWiring) {
                    // 編集モード
                    if (editingWiring.projectId) {
                        // プロジェクトの配線仕様を編集
                        const success = await saveToFirestore('projectWirings', template, editingWiring.id);
                        if (success) {
                            setProjectWirings(prev => ({
                                ...prev,
                                [editingWiring.projectId]: {
                                    ...prev[editingWiring.projectId],
                                    ...template,
                                    templateName: template.name
                                }
                            }));
                            setShowWiringForm(false);
                            setEditingWiring(null);
                            resetWiringForm();
                        }
                    } else {
                        // テンプレートを編集
                        const success = await saveToFirestore('wiringTemplates', template, editingWiring.id);
                        if (success) {
                            setWiringTemplates(prev => prev.map(t =>
                                t.id === editingWiring.id ? {
                                    ...template,
                                    id: editingWiring.id,
                                    createdAt: editingWiring.createdAt,
                                    updatedAt: new Date()
                                } : t
                            ));
                            setShowWiringForm(false);
                            setEditingWiring(null);
                            resetWiringForm();
                        }
                    }
                } else {
                    // 新規作成モード（既存の処理）
                    const docId = await saveToFirestore('wiringTemplates', template);
                    if (docId) {
                        setWiringTemplates(prev => [...prev, {
                            ...template,
                            id: docId,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        }]);
                        setShowWiringForm(false);
                        resetWiringForm();
                    }
                }
            }, [newWiring, editingWiring]);

            // 配線仕様フォームをリセット
            const resetWiringForm = () => {
                setNewWiring({
                    name: '',
                    companyId: '',
                    specifications: {
                        wire: {
                            power: {
                                standards: [],
                                wiringType: '',
                                phases: {
                                    rPhase: '',
                                    sPhase: '',
                                    tPhase: '',
                                    nPhase: '',
                                    lPhase: ''
                                },
                                remarks: ''
                            },
                            ground: {
                                caseColor: '',
                                caseDiameter: '',
                                doorColor: '',
                                doorDiameter: '',
                                panelColor: '',
                                panelDiameter: '',
                                remarks: ''
                            },
                            insulationCap: '',
                            insulationCapDiameter: '',
                            insulationCapRemarks: '',
                            controlAC: {
                                standards: '',
                                customStandard: '',
                                commonColor: '',
                                commonDiameter: '',
                                nonCommonColor: '',
                                nonCommonDiameter: '',
                                remarks: ''
                            },
                            controlDC: {
                                standards: '',
                                customStandard: '',
                                pBusColor: '',
                                pBusDiameter: '',
                                nBusColor: '',
                                nBusDiameter: '',
                                otherColor: '',
                                otherDiameter: '',
                                remarks: ''
                            },
                            specialSpec: '',  // ← 追加
                            manufacturerSpecified: false,
                            manufacturer: ''
                        },
                        markTube: {
                            orientation: {
                                up: '',
                                down: '',
                                left: '',
                                right: ''
                            },
                            fontSize: '',
                            customFontSize: '',
                            length: '',
                            customLength: '',
                            printSpec: '',
                            printSpecDetail: '',
                            remarks: ''  // ← この行を追加
                        },
                        otherConfirm: {
                            tighteningPen: '',
                            tighteningPenDetail: '',
                            matchMark: '',
                            screw: '',
                            screwDetail: '',
                            hookTube: '',
                            spiralTube: '',
                            spiralTubeDetail: '',
                            insulock: '',
                            insulockDetail: '',
                            mountBase: '',
                            mountBaseDetail: '',
                            routeSpecialNote: '',
                            remarks: ''  // ← この行を追加
                        },
                        terminal: {
                            power: '',
                            controlAC: '',
                            controlDC: '',
                            simultaneousCrimp: '',
                            screwClamp: '',
                            screwlessClamp: '',
                            remarks: '',
                            manufacturerSpecified: false,
                            manufacturer: ''
                        },
                        terminalBlock: {
                            cover: '',
                            namePlate: '',
                            bridge: '',
                            maxWires: '',
                            remarks: '',
                            manufacturerSpecified: false,
                            manufacturer: ''
                        },
                        namePlate: {
                            fontSize: '',
                            customFontSize: '',
                            remarks: ''
                        },
                        deviceSeal: {
                            fontSize: '',
                            customFontSize: '',
                            length: '',
                            customLength: '',
                            positions: [],
                            customPosition: '',
                            remarks: ''
                        }
                    }
                });
            };

            // 配線仕様テンプレート削除
            const deleteWiringTemplate = useCallback(async (templateId) => {
                const success = await deleteFromFirestore('wiringTemplates', templateId);
                if (success) {
                    setWiringTemplates(prev => prev.filter(t => t.id !== templateId));
                    return true;
                }
                return false;
            }, []);

            // 配線仕様テンプレートコピー
            const copyWiringTemplate = useCallback(async (template) => {
                try {
                    // 深いコピーを作成
                    const copiedTemplate = {
                        name: template.name + ' のコピー',
                        companyId: template.companyId,
                        specifications: JSON.parse(JSON.stringify(template.specifications || {})),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    const docRef = await db.collection('wiringTemplates').add(copiedTemplate);
                    if (docRef && docRef.id) {
                        setWiringTemplates(prev => [...prev, {
                            ...copiedTemplate,
                            id: docRef.id,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        }]);
                        return true;
                    }
                } catch (error) {
                    console.error('Error copying wiring template:', error);
                }
                return false;
            }, []);

            /// 検査モーダルを開く
            const openChecklistModal = useCallback(async (entityId, entityType = 'task') => {
                const checklistKey = `task_${entityId}`;

                if (projectChecklists[checklistKey]) {
                    const checklist = projectChecklists[checklistKey];
                    // タスクの完了状態を確認
                    const task = tasks.find(t => t.id === entityId);
                    const isTaskCompleted = task?.status === '完了';

                    setCurrentProjectChecklist({
                        ...checklist,
                        isTaskCompleted: isTaskCompleted
                    });
                } else {
                    // チェックリストが存在しない場合は何もしない
                    return;
                }
                setShowChecklistModal(true);
            }, [projectChecklists, tasks]);

            // チェックリスト編集モーダルを開く
            const openEditChecklistModal = useCallback((taskId) => {
                const checklistKey = `task_${taskId}`;
                const checklist = projectChecklists[checklistKey];

                if (checklist) {
                    // 深いコピーを作成して元データへの影響を防ぐ
                    setEditingProjectChecklist({
                        ...checklist,
                        taskId: taskId,
                        checkType: checklist.checkType || 'double',
                        name: checklist.templateName || checklist.name || '',
                        templateName: checklist.templateName || checklist.name || '',
                        // categoriesも深いコピーを作成
                        categories: JSON.parse(JSON.stringify(checklist.categories || []))
                    });
                    setShowEditChecklistModal(true);
                }
            }, [projectChecklists]);

            // チェックリストを保存
            const saveEditedChecklist = useCallback(async () => {
                if (!editingProjectChecklist) return;

                const checklistKey = `task_${editingProjectChecklist.taskId}`;
                const docId = projectChecklists[checklistKey]?.id;

                // 保存用のデータを準備（名前とテンプレート名を両方更新）
                const updatedChecklist = {
                    ...editingProjectChecklist,
                    templateName: editingProjectChecklist.templateName || editingProjectChecklist.name,
                    name: editingProjectChecklist.name || editingProjectChecklist.templateName
                };

                const savedId = await saveToFirestore('projectChecklists', updatedChecklist, docId);
                if (savedId) {
                    setProjectChecklists(prev => ({
                        ...prev,
                        [checklistKey]: {
                            id: docId || savedId,
                            ...updatedChecklist
                        }
                    }));
                    setShowEditChecklistModal(false);
                    setEditingProjectChecklist(null);
                }
            }, [editingProjectChecklist, projectChecklists]);

            // チェックリスト項目更新（自動保存）
            const updateChecklistItem = useCallback(async (catIndex, itemIndex, checkType, value) => {
                setCurrentProjectChecklist(prev => {
                    const updated = { ...prev };
                    const item = updated.categories[catIndex].items[itemIndex];

                    // チェック状態を更新
                    item[checkType] = value;

                    // ユーザー情報と時刻を記録
                    if (value) {
                        // チェックされた場合
                        item[`${checkType}By`] = user.uid;
                        item[`${checkType}ByName`] = user.displayName || user.email;
                        item[`${checkType}At`] = new Date().toISOString();
                    } else {
                        // チェックが外された場合、ユーザー情報をクリア
                        delete item[`${checkType}By`];
                        delete item[`${checkType}ByName`];
                        delete item[`${checkType}At`];
                    }

                    // 自動保存
                    const checklistKey = `task_${updated.taskId}`;
                    const docId = projectChecklists[checklistKey]?.id;
                    saveToFirestore('projectChecklists', updated, docId).then(savedId => {
                        if (savedId) {
                            setProjectChecklists(prevChecklists => ({
                                ...prevChecklists,
                                [checklistKey]: {
                                    id: docId || savedId,
                                    ...updated
                                }
                            }));
                        }
                    });

                    return updated;
                });
            }, [projectChecklists, user]);

            // プロジェクトのチェックリスト保存
            const saveProjectChecklist = useCallback(async () => {
                const checklistKey = `task_${currentProjectChecklist.taskId}`;
                const docId = projectChecklists[checklistKey]?.id;
                const savedId = await saveToFirestore('projectChecklists', currentProjectChecklist, docId);

                if (savedId) {
                    setProjectChecklists(prev => ({
                        ...prev,
                        [checklistKey]: {
                            id: docId || savedId,
                            ...currentProjectChecklist
                        }
                    }));
                    setShowChecklistModal(false);
                }
            }, [currentProjectChecklist, projectChecklists]);

            // タスクテンプレートからタスク作成
            const createTasksFromTemplate = async (projectId, template) => {
                for (const taskData of template.tasks) {
                    const task = {
                        title: taskData.title,
                        description: taskData.description,
                        projectId: String(projectId),
                        estimatedHours: parseFloat(taskData.estimatedHours) || 0,
                        status: '進行中',
                        order: 0
                    };
                    const docId = await saveToFirestore('tasks', task);
                    if (docId) {
                        const newTaskData = {
                            id: docId,
                            ...task,
                            createdBy: user.uid,
                            createdByName: user.displayName || user.email,
                            createdAt: firebase.firestore.Timestamp.now(),
                            updatedAt: firebase.firestore.Timestamp.now()
                        };
                        setTasks(prevTasks => [...prevTasks, newTaskData]);
                    }
                }
            };

            // タスクの総工数を取得（全ユーザーの合計）
            // 現在の関数を修正
            const getTaskTotalHours = useCallback((taskId) => {
                const taskSessions = workSessions.filter(s => s.taskId === taskId);
                return taskSessions.reduce((sum, session) => sum + (session.hours || session.totalHours || 0), 0);
            }, [workSessions]);

            // 期間フィルター関数
            const filterSessionsByPeriod = useCallback((sessions, period) => {
                const now = new Date();
                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                switch (period) {
                    case 'thisMonth':
                        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                        return sessions.filter(s => {
                            const date = s.lastUpdated?.toDate ? s.lastUpdated.toDate() :
                                s.date?.toDate ? s.date.toDate() :
                                    s.endTime?.toDate ? s.endTime.toDate() : new Date();
                            return date >= startOfMonth;
                        });

                    case 'lastMonth':
                        const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
                        return sessions.filter(s => {
                            const date = s.lastUpdated?.toDate ? s.lastUpdated.toDate() :
                                s.date?.toDate ? s.date.toDate() :
                                    s.endTime?.toDate ? s.endTime.toDate() : new Date();
                            return date >= startOfLastMonth && date <= endOfLastMonth;
                        });

                    case 'last3Months':
                        const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
                        return sessions.filter(s => {
                            const date = s.lastUpdated?.toDate ? s.lastUpdated.toDate() :
                                s.date?.toDate ? s.date.toDate() :
                                    s.endTime?.toDate ? s.endTime.toDate() : new Date();
                            return date >= threeMonthsAgo;
                        });

                    case 'last6Months':
                        const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
                        return sessions.filter(s => {
                            const date = s.lastUpdated?.toDate ? s.lastUpdated.toDate() :
                                s.date?.toDate ? s.date.toDate() :
                                    s.endTime?.toDate ? s.endTime.toDate() : new Date();
                            return date >= sixMonthsAgo;
                        });

                    case 'thisYear':
                        const startOfYear = new Date(now.getFullYear(), 0, 1);
                        return sessions.filter(s => {
                            const date = s.lastUpdated?.toDate ? s.lastUpdated.toDate() :
                                s.date?.toDate ? s.date.toDate() :
                                    s.endTime?.toDate ? s.endTime.toDate() : new Date();
                            return date >= startOfYear;
                        });

                    default:
                        return sessions;
                }
            }, []);

            // 現在のユーザーの各タスク工数マップ
            const userTaskHoursMap = useMemo(() => {
                const map = {};
                if (!user || !tasks) return map;

                tasks.forEach(task => {
                    if (task && task.id) {
                        map[task.id] = getUserTaskHours(user.uid, task.id);
                    }
                });
                return map;
            }, [tasks, user, getUserTaskHours]);

            // 全タスクの総工数マップ
            const taskTotalHoursMap = useMemo(() => {
                const map = {};
                if (!tasks) return map;

                tasks.forEach(task => {
                    if (task && task.id) {
                        map[task.id] = getTaskTotalHours(task.id);
                    }
                });
                return map;
            }, [tasks, getTaskTotalHours]);

            // プロジェクト統計をメモ化（安全性向上）
            const projectStatsCache = useMemo(() => {
                const cache = {};
                if (!projects || !Array.isArray(projects) || !tasks || !Array.isArray(tasks)) {
                    return cache;
                }

                projects.forEach(project => {
                    if (!project || !project.id) return;

                    const projectTasks = tasks.filter(task =>
                        task && task.projectId && String(task.projectId) === String(project.id)
                    );

                    const totalEstimated = projectTasks.reduce((sum, task) =>
                        sum + (task.estimatedHours || 0), 0
                    );

                    const totalActual = projectTasks.reduce((sum, task) => {
                        if (!task || !task.id) return sum;
                        return sum + (taskTotalHoursMap[task.id] || 0);
                    }, 0);

                    const completedTasks = projectTasks.filter(task =>
                        task.status === '完了'
                    ).length;

                    const progress = projectTasks.length > 0 ?
                        (completedTasks / projectTasks.length) * 100 : 0;

                    const amount = parseFloat(project.amount) || 0;
                    const laborCost = parseFloat(project.laborCost) || 0;
                    const materialCost = parseFloat(project.materialCost) || 0;
                    const hourlyRate = totalActual > 0 ? laborCost / totalActual : 0;

                    cache[project.id] = {
                        totalEstimated,
                        totalActual,
                        completedTasks,
                        totalTasks: projectTasks.length,
                        progress,
                        amount,
                        laborCost,
                        materialCost,
                        hourlyRate
                    };
                });
                return cache;
            }, [projects, tasks, taskTotalHoursMap]);

            // プロジェクト統計取得（キャッシュ使用）
            const getProjectStats = useCallback((projectId) => {
                return projectStatsCache[projectId] || {
                    totalEstimated: 0,
                    totalActual: 0,
                    completedTasks: 0,
                    totalTasks: 0,
                    progress: 0,
                    amount: 0,
                    laborCost: 0,
                    materialCost: 0,
                    hourlyRate: 0
                };
            }, [projectStatsCache]);

            // ソート関数（getProjectStatsの後に配置）
            const sortProjects = useCallback((projectsToSort) => {
                return [...projectsToSort].sort((a, b) => {
                    switch (sortOption) {
                        case 'created-desc':
                            const aDate = a.createdAt ? a.createdAt.toDate() : new Date(0);
                            const bDate = b.createdAt ? b.createdAt.toDate() : new Date(0);
                            return bDate - aDate;

                        case 'created-asc':
                            const aDateAsc = a.createdAt ? a.createdAt.toDate() : new Date(0);
                            const bDateAsc = b.createdAt ? b.createdAt.toDate() : new Date(0);
                            return aDateAsc - bDateAsc;

                        case 'deadline-asc':
                            if (!a.deadline && !b.deadline) return 0;
                            if (!a.deadline) return 1;
                            if (!b.deadline) return -1;
                            return new Date(a.deadline) - new Date(b.deadline);

                        case 'deadline-desc':
                            if (!a.deadline && !b.deadline) return 0;
                            if (!a.deadline) return 1;
                            if (!b.deadline) return -1;
                            return new Date(b.deadline) - new Date(a.deadline);

                        case 'progress-desc':
                            const aProgress = getProjectStats(a.id).progress;
                            const bProgress = getProjectStats(b.id).progress;
                            return bProgress - aProgress;

                        case 'progress-asc':
                            const aProgressAsc = getProjectStats(a.id).progress;
                            const bProgressAsc = getProjectStats(b.id).progress;
                            return aProgressAsc - bProgressAsc;

                        default:
                            return 0;
                    }
                });
            }, [sortOption, getProjectStats]);

            // プロジェクトをソート（メモ化）- 検索フィルター適用（sortProjectsの後に配置）
            const sortedProjects = useMemo(() => {
                let filtered = filteredProjects;

                // ステータスフィルターを適用
                if (statusFilter === 'active') {
                    filtered = filtered.filter(p => p.status === '進行中');
                } else if (statusFilter === 'completed') {
                    filtered = filtered.filter(p => p.status === '完了');
                } else if (statusFilter === 'favorite') {
                    filtered = filtered.filter(p => isFavorite(p.id));
                }

                return sortProjects(filtered);
            }, [filteredProjects, sortProjects, statusFilter, isFavorite]);

            // ローディング画面
            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center auth-background px-4">
                        <div
                            className="glass-card mobile-compact-card rounded-2xl text-center w-full max-w-md mx-4"
                            style={{
                                paddingTop: '40px',
                                paddingBottom: '50px',
                                paddingLeft: '24px',
                                paddingRight: '24px'
                            }}
                        >
                            <div className="text-white mobile-text-base md:text-xl mb-4">読み込み中...</div>
                            <div
                                className="mx-auto"
                                style={{
                                    width: '32px',
                                    height: '32px',
                                    border: '2px solid white',
                                    borderTop: '2px solid transparent',
                                    borderRadius: '50%',
                                    animation: 'spin 1s linear infinite',
                                    WebkitAnimation: 'spin 1s linear infinite'
                                }}
                            ></div>
                        </div>
                    </div>
                );
            }

            // 未ログイン時の認証画面
            if (!user) {
                // メール確認送信完了画面
                if (emailVerificationSent) {
                    return (
                        <div className="min-h-screen flex items-center justify-center auth-background px-4">
                            <div className="glass-card mobile-compact-card p-6 md:p-8 rounded-2xl w-full max-w-md mx-4">
                                <div className="text-center">
                                    <div className="flex justify-center mb-4 mt-2">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="gray" strokeWidth="1.5">
                                            <rect x="2" y="4" width="20" height="16" rx="2" />
                                            <path d="M22 7l-10 5L2 7" />
                                        </svg>
                                    </div>
                                    <h2 className="text-sm md:text-2xl font-bold text-white mb-4">
                                        確認メールを送信しました
                                    </h2>
                                    <p className="text-gray-300 mb-4 mobile-text-sm">
                                        登録されたメールアドレスに確認メールを送信しました。
                                        メール内のリンクをクリックして、メールアドレスの確認を完了してください。
                                    </p>
                                    <p className="mobile-text-xs text-gray-400 mb-6">
                                        メールが届かない場合は、迷惑メールフォルダをご確認ください。
                                    </p>
                                    <button
                                        onClick={() => {
                                            setEmailVerificationSent(false);
                                            setWaitingForVerification(false);
                                            setAuthMode('login');
                                        }}
                                        className="gradient-button text-white px-6 py-3 rounded-xl font-bold w-full text-sm mb-1.5"
                                    >
                                        ログイン画面へ
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }

                // メール未確認の警告画面
                if (waitingForVerification) {
                    return (
                        <div className="min-h-screen flex items-center justify-center auth-background px-4">
                            <div className="glass-card mobile-compact-card p-6 md:p-8 rounded-2xl w-full max-w-md mx-4">
                                <div className="text-center">
                                    <div className="flex justify-center mb-4 mt-2">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="gray" strokeWidth="1.5">
                                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                                            <line x1="12" y1="9" x2="12" y2="13" />
                                            <circle cx="12" cy="17" r="0.5" fill="white" />
                                        </svg>
                                    </div>
                                    <h2 className="text-sm md:text-2xl font-bold text-white mb-4">
                                        メールアドレスの確認が必要です
                                    </h2>
                                    <p className="text-gray-300 mb-6 mobile-text-sm">
                                        メールアドレスの確認が完了していません。
                                        送信された確認メール内のリンクをクリックしてから、
                                        再度ログインしてください。
                                    </p>
                                    <button
                                        onClick={() => {
                                            setWaitingForVerification(false);
                                            setAuthForm({ email: '', password: '', name: '', confirmPassword: '' });
                                        }}
                                        className="gradient-button text-white px-6 py-3 rounded-xl font-bold w-full text-sm mb-1.5"
                                    >
                                        ログイン画面に戻る
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }
                return (
                    <div className="min-h-screen flex items-center justify-center auth-background px-4">
                        <div className="glass-card mobile-compact-card p-6 md:p-8 rounded-2xl w-full max-w-md mx-4">
                            <div className="text-center mb-6 mt-6">
                                <h1 className="text-base md:text-2xl font-bold text-white mb-2 neon-text">
                                    工程・工数管理システム
                                </h1>
                            </div>

                            {authError && (
                                <div className="bg-red-500 bg-opacity-20 border border-red-500 text-red-300 p-3 rounded-lg mb-4 mobile-text-xs">
                                    {authError}
                                </div>
                            )}

                            <form onSubmit={authMode === 'login' ? handleLogin : handleRegister} noValidate>
                                {authMode === 'register' && (
                                    <div className="mb-4">
                                        <input
                                            type="text"
                                            placeholder="名前"
                                            value={authForm.name}
                                            onChange={(e) => setAuthForm({ ...authForm, name: e.target.value })}
                                            className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                            required
                                        />
                                    </div>
                                )}

                                <div className="mb-4">
                                    <input
                                        type="email"
                                        placeholder="メールアドレス"
                                        value={authForm.email}
                                        onChange={(e) => setAuthForm({ ...authForm, email: e.target.value })}
                                        className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                        inputMode="email"
                                        autoComplete="email"
                                        spellCheck="false"
                                        autoCorrect="off"
                                        required
                                    />
                                </div>

                                <div className="mb-4">
                                    <input
                                        type="password"
                                        placeholder="パスワード"
                                        value={authForm.password}
                                        onChange={(e) => setAuthForm({ ...authForm, password: e.target.value })}
                                        className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                        autoComplete="current-password"
                                        required
                                    />
                                </div>

                                {authMode === 'register' && (
                                    <div className="mb-6">
                                        <input
                                            type="password"
                                            placeholder="パスワード確認"
                                            value={authForm.confirmPassword}
                                            onChange={(e) => setAuthForm({ ...authForm, confirmPassword: e.target.value })}
                                            className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                            autoComplete="new-password"
                                            required
                                        />
                                    </div>
                                )}

                                <button
                                    type="submit"
                                    className="w-full gradient-button text-white py-3 rounded-xl font-bold mb-4 hover:shadow-lg transition-all duration-300 text-sm"
                                >
                                    {authMode === 'login' ? 'ログイン' : '新規登録'}
                                </button>
                            </form>

                            <div className="text-center mb-2">
                                <button
                                    onClick={() => {
                                        setAuthMode(authMode === 'login' ? 'register' : 'login');
                                        setAuthError('');
                                        setAuthForm({ email: '', password: '', name: '', confirmPassword: '' });
                                    }}
                                    className="text-gray-300 hover:text-white transition-colors duration-200 text-sm"
                                >
                                    {authMode === 'login' ? '新規登録はこちら' : 'ログインはこちら'}
                                </button>
                            </div>

                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen mobile-container" style={{ background: 'linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #000000 100%)' }}>
                    <div className="max-w-7xl mx-auto">
                        {/* ヘッダー */}
                        <header className="mb-6 md:mb-8">
                            {/* ユーザー情報と保存状態表示 */}
                            <div className="glass-card mobile-header rounded-2xl flex flex-row sm:flex-row justify-between items-center text-white gap-3 sm:gap-4 relative">
                                <div className="flex items-center gap-3 sm:gap-4">
                                    <div className="flex items-center gap-2">
                                        <div
                                            className="user-icon user-icon-small cursor-pointer hover:opacity-80 transition-opacity duration-200"
                                            onClick={() => {
                                                setTempIconColor(userIconColor);
                                                setShowColorPickerModal(true);
                                            }}
                                            style={{ background: userIconColor }}
                                        >
                                            {(user.displayName || user.email || 'U').charAt(0).toUpperCase()}
                                        </div>
                                        {/* タイマー実行中はユーザー名を非表示 */}
                                        {Object.keys(activeTimers).length === 0 && (
                                            <span className="font-medium text-sm sm:text-base">
                                                <span className="hidden sm:inline">ようこそ、</span>
                                                {user.displayName || user.email}
                                                <span className="hidden sm:inline">さん</span>
                                            </span>
                                        )}
                                    </div>
                                    {Object.keys(activeTimers).length === 0 && lastSaved && (
                                        <span className="text-xs text-gray-300 pulse-animation hidden sm:block">
                                            最終同期: {lastSaved.toLocaleString('ja-JP')}
                                        </span>
                                    )}
                                </div>


                                <div className="flex items-center gap-0.5 ml-6">
                                    {/* タイマー実行中の表示 */}
                                    {(() => {
                                        const activeTimerEntries = Object.entries(activeTimers);
                                        if (activeTimerEntries.length === 0) return null;

                                        const [taskId, timer] = activeTimerEntries[0]; // 最初のアクティブタイマー
                                        const task = tasks.find(t => t.id === taskId);
                                        const project = projects.find(p => p.id === task?.projectId);
                                        const duration = Date.now() - timer.startTime;
                                        const minutes = Math.floor(duration / 60000);
                                        const seconds = Math.floor((duration % 60000) / 1000);

                                        return (
                                            <div className="flex items-center gap-1 mr-2">
                                                <span className="text-white text-xs whitespace-nowrap">
                                                    {project && (
                                                        <>
                                                            <span className="text-gray-300 font-bold">
                                                                {project.name.length > 5
                                                                    ? project.name.substring(0, 5)
                                                                    : project.name}

                                                            </span>
                                                            <span className="mx-1"> </span>
                                                        </>
                                                    )}
                                                    <span className="text-red-300 font-bold mr-1">
                                                        {String(minutes).padStart(2, '0')}:{String(seconds).padStart(2, '0')}
                                                    </span>
                                                </span>
                                                <button
                                                    onClick={() => toggleTimer(taskId)}
                                                    className="flex items-center justify-center text-white font-normal transition-all duration-300 gradient-red hover:shadow-lg pulse-animation w-5 h-5 rounded-full flex-shrink-0 text-xs"
                                                    title="タイマー停止"
                                                >
                                                    <span style={{ transform: 'translateX(0.2px)' }}>
                                                        ■
                                                    </span>
                                                </button>
                                            </div>
                                        );
                                    })()}

                                    {/* 管理アイコンボタン（マスター管理者のみ表示） */}
                                    {isMasterAdmin && (
                                        <button
                                            onClick={async () => {
                                                await loadAllUsers();
                                                setShowUserManagementModal(true);
                                            }}
                                            className="p-2 text-gray-400 hover:text-white transition-colors duration-200 flex items-center justify-center"
                                            title="ユーザー管理"
                                            style={{
                                                background: 'transparent',
                                                border: 'none',
                                                cursor: 'pointer',
                                                WebkitTapHighlightColor: 'transparent',
                                                minWidth: '40px',
                                                minHeight: '40px'
                                            }}
                                        >
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                                                <circle cx="12" cy="12" r="3"></circle>
                                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                            </svg>
                                        </button>
                                    )}

                                    {/* リロードボタン */}
                                    <button
                                        onClick={() => {
                                            // 真っ暗な画面を表示
                                            const loadingOverlay = document.createElement('div');
                                            loadingOverlay.style.cssText = `
                                                position: fixed;
                                                top: 0;
                                                left: 0;
                                                width: 100%;
                                                height: 100%;
                                                background: #000000;
                                                z-index: 9999;
                                                pointer-events: all;
                                                overflow: hidden;
                                            `;

                                            // スクロールを無効化
                                            document.body.style.overflow = 'hidden';
                                            document.documentElement.style.overflow = 'hidden';

                                            document.body.appendChild(loadingOverlay);

                                            // 少し遅延してからリロード（ローディング画面を確実に表示）
                                            setTimeout(() => {
                                                // キャッシュを無視して強制リロード
                                                window.location.href = window.location.href + '?t=' + new Date().getTime();
                                            }, 100);
                                        }}
                                        className="p-2 text-gray-400 hover:text-white transition-colors duration-200 flex items-center justify-center"
                                        title="リロード"
                                        style={{
                                            background: 'transparent',
                                            border: 'none',
                                            cursor: 'pointer',
                                            WebkitTapHighlightColor: 'transparent',
                                            minWidth: '40px',
                                            minHeight: '40px'
                                        }}
                                    >
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                            <polyline points="23 4 23 10 17 10"></polyline>
                                            <polyline points="1 20 1 14 7 14"></polyline>
                                            <path d="m3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                        </svg>
                                    </button>

                                    <button
                                        onClick={handleLogout}
                                        className="p-2 text-gray-400 hover:text-white transition-colors duration-200 flex items-center justify-center"
                                        title="ログアウト"
                                        style={{
                                            background: 'transparent',
                                            border: 'none',
                                            cursor: 'pointer',
                                            WebkitTapHighlightColor: 'transparent',
                                            minWidth: '40px',
                                            minHeight: '40px'
                                        }}
                                    >
                                        <TabIcons.Logout size={20} />
                                    </button>
                                </div>
                            </div>
                        </header>

                        <div className="fixed bottom-0 left-0 right-0 z-50 bg-gray-900 bg-opacity-95 backdrop-filter blur-sm border-t border-gray-600 rounded-t-2xl" style={{ paddingBottom: 'env(safe-area-inset-bottom)' }}>
                            <div className="flex px-2 py-1.5 pb-5">
                                <button
                                    onClick={() => setActiveTab('tasks')}
                                    className={`flex-1 py-3 px-2 text-center font-medium transition-all duration-300 rounded-xl mx-1 ${activeTab === 'tasks'
                                        ? 'gradient-button active text-white shadow-lg'
                                        : 'text-gray-300 hover:text-white hover:bg-gray-800'
                                        }`}
                                >
                                    <div className="flex flex-col items-center gap-1">
                                        <TabIcons.Projects size={20} />
                                        <span style={{ fontSize: '10px' }}>案件管理</span>
                                    </div>
                                </button>

                                <button
                                    onClick={() => setActiveTab('companies')}
                                    className={`flex-1 py-3 px-2 text-center font-medium transition-all duration-300 rounded-xl mx-1 ${activeTab === 'companies'
                                        ? 'gradient-button active text-white shadow-lg'
                                        : 'text-gray-300 hover:text-white hover:bg-gray-800'
                                        }`}
                                >
                                    <div className="flex flex-col items-center gap-1">
                                        <TabIcons.Companies size={20} />
                                        <span style={{ fontSize: '10px' }}>会社管理</span>
                                    </div>
                                </button>

                                <button
                                    onClick={() => setActiveTab('gantt')}
                                    className={`flex-1 py-3 px-2 text-center font-medium transition-all duration-300 rounded-xl mx-1 ${activeTab === 'gantt'
                                        ? 'gradient-button active text-white shadow-lg'
                                        : 'text-gray-300 hover:text-white hover:bg-gray-800'
                                        }`}
                                >
                                    <div className="flex flex-col items-center gap-1">
                                        <TabIcons.Gantt size={20} />
                                        <span style={{ fontSize: '10px' }}>工程表</span>
                                    </div>
                                </button>

                                <button
                                    onClick={() => setActiveTab('analytics')}
                                    className={`flex-1 py-3 px-2 text-center font-medium transition-all duration-300 rounded-xl mx-1 ${activeTab === 'analytics'
                                        ? 'gradient-button active text-white shadow-lg'
                                        : 'text-gray-300 hover:text-white hover:bg-gray-800'
                                        }`}
                                >
                                    <div className="flex flex-col items-center gap-1">
                                        <TabIcons.Analytics size={20} />
                                        <span style={{ fontSize: '10px' }}>分析</span>
                                    </div>
                                </button>

                                <button
                                    onClick={() => setActiveTab('mypage')}
                                    className={`flex-1 py-3 px-2 text-center font-medium transition-all duration-300 rounded-xl mx-1 ${activeTab === 'mypage'
                                        ? 'gradient-button active text-white shadow-lg'
                                        : 'text-gray-300 hover:text-white hover:bg-gray-800'
                                        }`}
                                >
                                    <div className="flex flex-col items-center gap-1">
                                        <TabIcons.MyPage size={20} />
                                        <span style={{ fontSize: '10px' }}>ユーザー</span>
                                    </div>
                                </button>
                            </div>
                        </div>

                        {/* 会社管理タブ */}
                        {activeTab === 'companies' && (
                            <div className="space-y-6 md:space-y-8" style={{ minHeight: '100vh' }}>
                                <div className="flex flex-row justify-between items-center gap-3 sm:gap-0">
                                    <h2 className="text-lg md:text-2xl font-bold text-white neon-text" style={{ margin: '1px 0' }}>
                                        会社管理
                                    </h2>
                                    {isAdmin && (
                                        <button
                                            onClick={() => setShowCompanyForm(true)}
                                            className="flex items-center justify-center text-white font-normal transition-all duration-300 gradient-button hover:shadow-lg w-7 h-7 rounded-full flex-shrink-0"
                                        >
                                            ＋
                                        </button>
                                    )}
                                </div>

                                {/* 検索・ソート・ステータスを1行にまとめる */}
                                <div className="glass-card mobile-compact-card rounded-2xl">
                                    <div className="space-y-2">
                                        {/* 検索バー */}
                                        <div className="w-full">
                                            <input
                                                type="text"
                                                placeholder="会社名で検索..."
                                                value={searchQuery}
                                                onChange={(e) => setSearchQuery(e.target.value)}
                                                className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-xs"
                                            />
                                        </div>

                                        {/* 並び替えとステータス（横並び） */}
                                        <div className="flex gap-2">
                                            <div className="flex-1">
                                                <div className="custom-select-container">
                                                    <select
                                                        value={sortOption}
                                                        onChange={(e) => setSortOption(e.target.value)}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="created-desc">作成順（新しい順）</option>
                                                        <option value="created-asc">作成順（古い順）</option>
                                                        <option value="project-count-desc">案件順（多い順）</option>
                                                        <option value="project-count-asc">案件順（少ない順）</option>
                                                        <option value="name-asc">名前順（A-Z）</option>
                                                        <option value="name-desc">名前順（Z-A）</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>

                                            <div className="flex-1">
                                                <div className="custom-select-container">
                                                    <select
                                                        value={statusFilter}
                                                        onChange={(e) => setStatusFilter(e.target.value)}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="all">全て ({filteredProjects.length})</option>
                                                        <option value="active">進行中 ({filteredProjects.filter(p => p.status === '進行中').length})</option>
                                                        <option value="completed">完了 ({filteredProjects.filter(p => p.status === '完了').length})</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* 会社一覧（カード削除、プロジェクトヘッダー風デザイン） */}
                                <div className="space-y-4 md:space-y-6">
                                    {(() => {
                                        // 各会社のプロジェクト情報を計算
                                        const companiesWithProjectInfo = companies.map(company => {
                                            const companyProjects = projects.filter(p => p.company === company.name);
                                            const activeProjects = companyProjects.filter(p => p.status === '進行中');
                                            const completedProjects = companyProjects.filter(p => p.status === '完了');

                                            // ステータスフィルターに応じて表示するプロジェクト数を決定
                                            let displayProjectCount;
                                            if (statusFilter === 'active') {
                                                displayProjectCount = activeProjects.length;
                                            } else if (statusFilter === 'completed') {
                                                displayProjectCount = completedProjects.length;
                                            } else {
                                                displayProjectCount = companyProjects.length; // 全て
                                            }

                                            return {
                                                ...company,
                                                totalProjects: companyProjects.length,
                                                activeProjects: activeProjects.length,
                                                completedProjects: completedProjects.length,
                                                displayProjectCount: displayProjectCount
                                            };
                                        });

                                        // 検索フィルターのみ適用
                                        let filteredCompanies = companiesWithProjectInfo.filter(company =>
                                            (company.name || '').toLowerCase().includes(searchQuery.toLowerCase())
                                        );

                                        // ソート処理
                                        filteredCompanies.sort((a, b) => {
                                            switch (sortOption) {
                                                case 'name-asc':
                                                    return (a.name || '').localeCompare(b.name || '');
                                                case 'name-desc':
                                                    return (b.name || '').localeCompare(a.name || '');
                                                case 'project-count-desc':
                                                    return b.displayProjectCount - a.displayProjectCount;
                                                case 'project-count-asc':
                                                    return a.displayProjectCount - b.displayProjectCount;
                                                case 'created-desc':
                                                    const aDate = a.createdAt ? a.createdAt.toDate() : new Date(0);
                                                    const bDate = b.createdAt ? b.createdAt.toDate() : new Date(0);
                                                    return bDate - aDate;
                                                case 'created-asc':
                                                    const aDateAsc = a.createdAt ? a.createdAt.toDate() : new Date(0);
                                                    const bDateAsc = b.createdAt ? b.createdAt.toDate() : new Date(0);
                                                    return aDateAsc - bDateAsc;
                                                default:
                                                    return 0;
                                            }
                                        });

                                        return filteredCompanies.length > 0 ? (
                                            filteredCompanies.map(company => {
                                                const isCollapsed = collapsedCompanies[company.id];

                                                return (
                                                    <div key={company.id} className="glass-card rounded-2xl overflow-hidden">
                                                        {/* 会社ヘッダー（プロジェクトヘッダー風） */}
                                                        <div className="bg-gray-800 bg-opacity-50 mobile-compact-card border-b border-gray-600 border-opacity-30 relative">
                                                            <div className="flex justify-between items-start mb-3">
                                                                <div
                                                                    className="flex items-start gap-3 cursor-pointer flex-1"
                                                                    onClick={() => toggleCompanyCollapse(company.id)}
                                                                >
                                                                    <span className="text-white text-sm flex-shrink-0 w-5 flex justify-center" style={{ marginTop: '43px' }}>
                                                                        {isCollapsed ? icons.chevronRight : icons.chevronDown}
                                                                    </span>
                                                                    <div className="flex-1 min-w-0">
                                                                        <div className="flex flex-col mb-2 mt-10">
                                                                            <h3 className="text-base md:text-lg font-bold text-white truncate">{company.name}</h3>
                                                                            <div className="flex flex-wrap gap-2 mt-1">
                                                                                {company.createdByName && (
                                                                                    <span
                                                                                        className="mobile-text-xs text-white font-bold px-2 py-1 rounded-full"
                                                                                        style={{ background: getUserIconColor(company.createdBy) }}
                                                                                    >
                                                                                        {company.createdByName}
                                                                                    </span>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                        {company.description && (
                                                                            <p className="text-gray-300 mobile-text-sm line-clamp-2">{company.description}</p>
                                                                        )}
                                                                    </div>
                                                                </div>

                                                                {/* アクションボタン（左側） */}
                                                                {isAdmin && (
                                                                    <div className="absolute top-2 left-3 flex gap-2 z-10">
                                                                        <DeleteButton
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                openDeleteConfirm('company', company.id, company.name);
                                                                            }}
                                                                        />
                                                                        <EditButton
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                openEditCompany(company);
                                                                            }}
                                                                        />
                                                                    </div>
                                                                )}

                                                                {/* 区切りライン */}
                                                                <div className="absolute left-0 right-0 border-t border-gray-600" style={{ top: '38px' }}></div>
                                                            </div>

                                                            {/* 会社統計 */}
                                                            <div className="grid grid-cols-3 gap-2 mobile-text-xs text-center">
                                                                <div>
                                                                    <div className="text-gray-400">
                                                                        {statusFilter === 'active' ? '進行中' :
                                                                            statusFilter === 'completed' ? '完了' :
                                                                                '総案件'}
                                                                    </div>
                                                                    <div className="text-white font-bold">
                                                                        {company.displayProjectCount}
                                                                    </div>
                                                                </div>
                                                                <div>
                                                                    <div className="text-gray-400">テンプレート</div>
                                                                    <div className="text-white font-bold">
                                                                        {taskTemplates.filter(t => t.companyId === company.id).length +
                                                                            checklistTemplates.filter(c => c.companyId === company.id).length +
                                                                            wiringTemplates.filter(w => w.companyId === company.id).length}
                                                                    </div>
                                                                </div>
                                                                <div>
                                                                    <div className="text-gray-400">状態</div>
                                                                    <div className="text-white font-bold">
                                                                        {company.totalProjects > 0 ? '使用中' : '未使用'}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* 詳細内容（折りたたみ可能） */}
                                                        <div className={`company-details-container mobile-compact-card space-y-3 ${!isCollapsed ? 'expanded' : 'collapsed'}`}>

                                                            {/* タスクテンプレートセクション */}
                                                            <div className="border-t border-gray-600 pt-4">
                                                                <div className="flex justify-between items-center mb-3">
                                                                    <h5 className="mobile-text-sm font-bold text-white">工程テンプレート</h5>
                                                                    {isAdmin && (
                                                                        <button
                                                                            onClick={() => {
                                                                                setNewTemplate({
                                                                                    name: '',
                                                                                    companyId: company.id,
                                                                                    tasks: [{ title: '', estimatedHours: '', description: '' }]
                                                                                });
                                                                                setEditingTemplate(null);
                                                                                setShowTemplateForm(true);
                                                                            }}
                                                                            className="flex items-center justify-center text-white font-medium transition-all duration-300 gradient-button hover:shadow-lg w-5 h-5 rounded-full flex-shrink-0 text-xs"
                                                                            disabled={taskTemplates.filter(t => t.companyId === company.id).length >= 10}
                                                                        >
                                                                            <span style={{ transform: 'translateY(0.3px) translateX(0.2px)' }}>＋</span>
                                                                        </button>
                                                                    )}
                                                                </div>

                                                                {taskTemplates.filter(t => t.companyId === company.id).length > 0 ? (
                                                                    <div className="grid grid-cols-1 gap-3">
                                                                        {taskTemplates.filter(t => t.companyId === company.id).map(template => (
                                                                            <div key={template.id} className="glass-card-dark px-3 pt-3 pb-2 rounded-lg">
                                                                                {/* アクションボタン（左端） */}
                                                                                <div className="flex gap-2 mb-1 -mt-2" style={{ minHeight: '22px' }}>
                                                                                    {isAdmin && (
                                                                                        <>
                                                                                            <DeleteButton
                                                                                                onClick={() => openDeleteConfirm('template', template.id, template.name)} />
                                                                                            <EditButton
                                                                                                onClick={() => {
                                                                                                    setEditingTemplate(template);
                                                                                                    // 編集前のデータを深いコピーで保存
                                                                                                    const originalData = {
                                                                                                        name: template.name,
                                                                                                        companyId: template.companyId,
                                                                                                        tasks: (template.tasks || []).map(task => ({
                                                                                                            title: task.title || '',
                                                                                                            estimatedHours: task.estimatedHours || '',
                                                                                                            description: task.description || ''
                                                                                                        }))
                                                                                                    };
                                                                                                    setOriginalTemplate(originalData);
                                                                                                    setNewTemplate({ ...originalData });
                                                                                                    setShowTemplateForm(true);
                                                                                                }} />
                                                                                            <CopyButton
                                                                                                onClick={() => copyTemplate(template)} />
                                                                                        </>
                                                                                    )}
                                                                                </div>
                                                                                {/* 区切りライン */}
                                                                                <div className="mb-2 -mx-3" style={{ borderTop: '1px solid rgba(255, 255, 255, 0.1)' }}></div>
                                                                                <div className="space-y-1">
                                                                                    <div className="font-bold text-white mobile-text-xs mt-1">
                                                                                        {template.name}
                                                                                    </div>
                                                                                    <div className="flex justify-between items-center -mb-1">
                                                                                        <div className="text-gray-400 mobile-text-xs">
                                                                                            工程数: {template.tasks?.length || 0} /
                                                                                            総工数: {template.tasks?.reduce((sum, t) =>
                                                                                                sum + (parseFloat(t.estimatedHours) || 0), 0
                                                                                            )}h
                                                                                        </div>
                                                                                        <div className="text-gray-400 mobile-text-xs">
                                                                                            最終更新: {(() => {
                                                                                                if (!template.updatedAt) return '時刻不明';
                                                                                                try {
                                                                                                    const date = template.updatedAt.toDate ?
                                                                                                        new Date(template.updatedAt.toDate()) :
                                                                                                        new Date(template.updatedAt);
                                                                                                    return isNaN(date.getTime()) ? '時刻不明' : date.toLocaleDateString('ja-JP');
                                                                                                } catch {
                                                                                                    return '時刻不明';
                                                                                                }
                                                                                            })()}
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                ) : (
                                                                    <p className="text-gray-500 mobile-text-sm text-center py-4">
                                                                        工程テンプレートがまだ作成されていません
                                                                    </p>
                                                                )}
                                                                <p className="mobile-text-xs text-gray-500 text-right mt-2">
                                                                    {taskTemplates.filter(t => t.companyId === company.id).length}/10 作成済み
                                                                </p>
                                                            </div>

                                                            {/* 配線仕様テンプレートセクション */}
                                                            <div className="border-t border-gray-600 pt-4">
                                                                <div className="flex justify-between items-center mb-3">
                                                                    <h5 className="mobile-text-sm font-bold text-white">配線仕様テンプレート</h5>
                                                                    {isAdmin && (
                                                                        <button
                                                                            onClick={() => {
                                                                                setNewWiring({
                                                                                    ...newWiring,
                                                                                    name: '',
                                                                                    companyId: company.id
                                                                                });
                                                                                setEditingWiring(null);
                                                                                setShowWiringForm(true);
                                                                            }}
                                                                            className="flex items-center justify-center text-white font-medium transition-all duration-300 gradient-button hover:shadow-lg w-5 h-5 rounded-full flex-shrink-0 text-xs"
                                                                            disabled={wiringTemplates.filter(w => w.companyId === company.id).length >= 10}
                                                                        >
                                                                            <span style={{ transform: 'translateY(0.3px) translateX(0.2px)' }}>＋</span>
                                                                        </button>
                                                                    )}
                                                                </div>

                                                                {wiringTemplates.filter(w => w.companyId === company.id).length > 0 ? (
                                                                    <div className="grid grid-cols-1 gap-3">
                                                                        {wiringTemplates.filter(w => w.companyId === company.id).map(wiring => (
                                                                            <div key={wiring.id} className="glass-card-dark px-3 pt-3 pb-2 rounded-lg">
                                                                                {/* アクションボタン（左端） */}
                                                                                <div className="flex gap-2 mb-1 -mt-2" style={{ minHeight: '22px' }}>
                                                                                    {isAdmin && (
                                                                                        <>
                                                                                            <DeleteButton
                                                                                                onClick={() => openDeleteConfirm('wiring', wiring.id, wiring.name)} />
                                                                                            <EditButton
                                                                                                onClick={() => {
                                                                                                    setEditingWiring(wiring);
                                                                                                    setNewWiring(wiring);
                                                                                                    setShowWiringForm(true);
                                                                                                }} />
                                                                                            <CopyButton
                                                                                                onClick={() => copyWiringTemplate(wiring)} />
                                                                                        </>
                                                                                    )}
                                                                                </div>
                                                                                {/* 区切りライン */}
                                                                                <div className="mb-2 -mx-3" style={{ borderTop: '1px solid rgba(255, 255, 255, 0.1)' }}></div>
                                                                                <div className="space-y-1">
                                                                                    <div className="font-bold text-white mobile-text-xs mt-1">
                                                                                        {wiring.name}
                                                                                    </div>
                                                                                    <div className="flex justify-between items-center -mb-1">
                                                                                        <div className="text-gray-400 mobile-text-xs">
                                                                                            セクション数: {(() => {
                                                                                                if (!wiring.specifications) return 0;
                                                                                                let count = 0;
                                                                                                const specs = wiring.specifications;

                                                                                                // 各セクションが設定されているかチェック
                                                                                                if (specs.wire && (
                                                                                                    specs.wire.power?.standards?.length > 0 ||
                                                                                                    specs.wire.power?.remarks ||
                                                                                                    specs.wire.ground?.caseColor ||
                                                                                                    specs.wire.ground?.remarks ||
                                                                                                    specs.wire.controlAC?.standards ||
                                                                                                    specs.wire.controlAC?.remarks ||
                                                                                                    specs.wire.controlDC?.standards ||
                                                                                                    specs.wire.controlDC?.remarks ||
                                                                                                    specs.wire.insulationCapRemarks ||
                                                                                                    specs.wire.specialSpec
                                                                                                )) count++;
                                                                                                if (specs.terminal && (
                                                                                                    specs.terminal.power ||
                                                                                                    specs.terminal.controlAC ||
                                                                                                    specs.terminal.controlDC ||
                                                                                                    specs.terminal.remarks
                                                                                                )) count++;
                                                                                                if (specs.terminalBlock && (
                                                                                                    specs.terminalBlock.cover ||
                                                                                                    specs.terminalBlock.namePlate ||
                                                                                                    specs.terminalBlock.bridge ||
                                                                                                    specs.terminalBlock.remarks
                                                                                                )) count++;
                                                                                                if (specs.namePlate && (
                                                                                                    specs.namePlate.fontSize ||
                                                                                                    specs.namePlate.remarks
                                                                                                )) count++;
                                                                                                if (specs.deviceSeal && (
                                                                                                    specs.deviceSeal.fontSize ||
                                                                                                    specs.deviceSeal.length ||
                                                                                                    specs.deviceSeal.positions?.length > 0 ||
                                                                                                    specs.deviceSeal.remarks
                                                                                                )) count++;
                                                                                                if (specs.markTube && (
                                                                                                    specs.markTube.fontSize ||
                                                                                                    specs.markTube.length ||
                                                                                                    specs.markTube.printSpec ||
                                                                                                    specs.markTube.orientation?.up ||
                                                                                                    specs.markTube.orientation?.down ||
                                                                                                    specs.markTube.orientation?.left ||
                                                                                                    specs.markTube.orientation?.right ||
                                                                                                    specs.markTube.remarks
                                                                                                )) count++;
                                                                                                if (specs.otherConfirm && (
                                                                                                    specs.otherConfirm.tighteningPen ||
                                                                                                    specs.otherConfirm.matchMark ||
                                                                                                    specs.otherConfirm.screw ||
                                                                                                    specs.otherConfirm.hookTube ||
                                                                                                    specs.otherConfirm.spiralTube ||
                                                                                                    specs.otherConfirm.insulock ||
                                                                                                    specs.otherConfirm.mountBase ||
                                                                                                    specs.otherConfirm.routeSpecialNote ||
                                                                                                    specs.otherConfirm.remarks
                                                                                                )) count++;

                                                                                                return count;
                                                                                            })()}
                                                                                        </div>
                                                                                        <div className="text-gray-400 mobile-text-xs">
                                                                                            最終更新: {(() => {
                                                                                                if (!wiring.updatedAt) return '時刻不明';
                                                                                                try {
                                                                                                    const date = wiring.updatedAt.toDate ?
                                                                                                        new Date(wiring.updatedAt.toDate()) :
                                                                                                        new Date(wiring.updatedAt);
                                                                                                    return isNaN(date.getTime()) ? '時刻不明' : date.toLocaleDateString('ja-JP');
                                                                                                } catch {
                                                                                                    return '時刻不明';
                                                                                                }
                                                                                            })()}
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                ) : (
                                                                    <p className="text-gray-500 mobile-text-sm text-center py-4">
                                                                        配線仕様テンプレートがまだ作成されていません
                                                                    </p>
                                                                )}

                                                                <p className="mobile-text-xs text-gray-500 text-right mt-2">
                                                                    {wiringTemplates.filter(w => w.companyId === company.id).length}/10 作成済み
                                                                </p>
                                                            </div>

                                                            {/* チェックリストセクション */}
                                                            <div className="border-t border-gray-600 pt-4">
                                                                <div className="flex justify-between items-center mb-3">
                                                                    <h5 className="mobile-text-sm font-bold text-white">検査リストテンプレート</h5>
                                                                    {isAdmin && (
                                                                        <button
                                                                            onClick={() => {
                                                                                setNewChecklist({
                                                                                    name: '',
                                                                                    companyId: company.id,
                                                                                    checkType: 'single',
                                                                                    categories: [
                                                                                        {
                                                                                            name: '',
                                                                                            items: [{ name: '', description: '' }]
                                                                                        }
                                                                                    ]
                                                                                });
                                                                                setEditingChecklist(null);
                                                                                setShowChecklistForm(true);
                                                                            }}
                                                                            className="flex items-center justify-center text-white font-medium transition-all duration-300 gradient-button hover:shadow-lg w-5 h-5 rounded-full flex-shrink-0 text-xs"
                                                                            disabled={checklistTemplates.filter(c => c.companyId === company.id).length >= 10}
                                                                        >
                                                                            <span style={{ transform: 'translateY(0.3px) translateX(0.2px)' }}>＋</span>
                                                                        </button>
                                                                    )}
                                                                </div>

                                                                {checklistTemplates.filter(c => c.companyId === company.id).length > 0 ? (
                                                                    <div className="grid grid-cols-1 gap-3">
                                                                        {checklistTemplates.filter(c => c.companyId === company.id).map(checklist => (
                                                                            <div key={checklist.id} className="glass-card-dark px-3 pt-3 pb-2 rounded-lg">
                                                                                {/* アクションボタン（左端） */}
                                                                                <div className="flex gap-2 mb-1 -mt-2" style={{ minHeight: '22px' }}>
                                                                                    {isAdmin && (
                                                                                        <>
                                                                                            <DeleteButton
                                                                                                onClick={() => openDeleteConfirm('checklist', checklist.id, checklist.name)} />
                                                                                            <EditButton
                                                                                                onClick={() => {
                                                                                                    setEditingChecklist(checklist);
                                                                                                    setNewChecklist({
                                                                                                        name: checklist.name,
                                                                                                        companyId: checklist.companyId,
                                                                                                        checkType: checklist.checkType || 'single',
                                                                                                        categories: JSON.parse(JSON.stringify(checklist.categories || []))
                                                                                                    });
                                                                                                    setShowChecklistForm(true);
                                                                                                }} />
                                                                                            <CopyButton
                                                                                                onClick={() => copyChecklistTemplate(checklist)} />
                                                                                        </>
                                                                                    )}
                                                                                </div>
                                                                                {/* 区切りライン */}
                                                                                <div className="mb-2 -mx-3" style={{ borderTop: '1px solid rgba(255, 255, 255, 0.1)' }}></div>
                                                                                <div className="space-y-1">
                                                                                    <div className="font-bold text-white mobile-text-xs mt-1">
                                                                                        {checklist.name}
                                                                                    </div>
                                                                                    <div className="flex justify-between items-center -mb-1">
                                                                                        <div className="text-gray-400 mobile-text-xs">
                                                                                            カテゴリ数: {checklist.categories?.length || 0} /
                                                                                            項目数: {checklist.categories?.reduce((sum, cat) => sum + (cat.items?.length || 0), 0) || 0}
                                                                                        </div>
                                                                                        <div className="text-gray-400 mobile-text-xs">
                                                                                            最終更新: {(() => {
                                                                                                if (!checklist.updatedAt) return '時刻不明';
                                                                                                try {
                                                                                                    const date = checklist.updatedAt.toDate ?
                                                                                                        new Date(checklist.updatedAt.toDate()) :
                                                                                                        new Date(checklist.updatedAt);
                                                                                                    return isNaN(date.getTime()) ? '時刻不明' : date.toLocaleDateString('ja-JP');
                                                                                                } catch {
                                                                                                    return '時刻不明';
                                                                                                }
                                                                                            })()}
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                ) : (
                                                                    <p className="text-gray-500 mobile-text-sm text-center py-4">
                                                                        検査リストテンプレートがまだ作成されていません
                                                                    </p>
                                                                )}

                                                                <p className="mobile-text-xs text-gray-500 text-right mt-2">
                                                                    {checklistTemplates.filter(c => c.companyId === company.id).length}/10 作成済み
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        ) : (
                                            <div className="text-center text-gray-400 py-8">
                                                <p className="text-base md:text-lg mb-2">
                                                    {searchQuery ? '検索に一致する会社がありません' : '登録済み会社がありません'}
                                                </p>
                                                <p className="mobile-text-sm">
                                                    {searchQuery ? '検索条件を変更するか、' : ''}新規会社登録ボタンから追加してください
                                                </p>
                                            </div>
                                        );
                                    })()}
                                </div>

                                {/* 新規会社登録フォーム */}
                                {showCompanyForm && (
                                    <div className="modal-overlay" onClick={() => setShowCompanyForm(false)}>
                                        <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-xl mx-4" onClick={(e) => e.stopPropagation()}>
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-base font-bold text-white pt-2">新規会社登録</h3>
                                            </div>
                                            <div className="space-y-3 mb-4">
                                                <input
                                                    type="text"
                                                    placeholder="会社名"
                                                    value={newCompany.name}
                                                    onChange={(e) => setNewCompany({ ...newCompany, name: e.target.value })}
                                                    className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                                />
                                                <textarea
                                                    placeholder="会社説明（任意）"
                                                    value={newCompany.description}
                                                    onChange={(e) => setNewCompany({ ...newCompany, description: e.target.value })}
                                                    className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                                    rows={3}
                                                />
                                            </div>
                                            <div className="flex flex-col gap-2 mb-1.5">
                                                <button
                                                    onClick={createCompany}
                                                    className="gradient-button text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 text-sm w-full"
                                                >
                                                    登録
                                                </button>
                                                <button
                                                    onClick={() => setShowCompanyForm(false)}
                                                    className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                                >
                                                    キャンセル
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* 会社編集フォーム */}
                        {showEditCompanyForm && editCompany && (
                            <div className="modal-overlay" onClick={() => setShowEditCompanyForm(false)}>
                                <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-xl mx-4" onClick={(e) => e.stopPropagation()}>
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-base font-bold text-white pt-2">会社情報編集</h3>
                                    </div>
                                    <div className="space-y-3 mb-4">
                                        <input
                                            type="text"
                                            placeholder="会社名"
                                            value={editCompany.name}
                                            onChange={(e) => setEditCompany({ ...editCompany, name: e.target.value })}
                                            className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                        />
                                        <textarea
                                            placeholder="会社説明（任意）"
                                            value={editCompany.description || ''}
                                            onChange={(e) => setEditCompany({ ...editCompany, description: e.target.value })}
                                            className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                            rows={3}
                                        />
                                    </div>
                                    <div className="flex flex-col gap-2 mb-1.5">
                                        <button
                                            onClick={updateCompany}
                                            className="gradient-button text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 text-sm w-full"
                                        >
                                            更新
                                        </button>
                                        <button
                                            onClick={() => setShowEditCompanyForm(false)}
                                            className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                        >
                                            キャンセル
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* チェックリストテンプレート作成フォーム */}
                        {showChecklistForm && (
                            <div className="modal-overlay" onClick={() => {
                                setShowChecklistForm(false);
                                setEditingChecklist(null);
                                setNewChecklist({
                                    name: '',
                                    companyId: '',
                                    checkType: 'single',
                                    categories: [{ name: '', items: [{ name: '', description: '' }] }]
                                });
                            }}>
                                <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-4xl mx-4"
                                    onClick={(e) => e.stopPropagation()}
                                    style={{ maxHeight: '90vh', overflowY: 'auto' }}>
                                    <div className="mb-4">
                                        <h3 className="text-base font-bold text-white pt-2">
                                            {editingChecklist ? '検査リストテンプレート編集' : '検査リストテンプレート作成'}
                                        </h3>
                                    </div>

                                    <input
                                        type="text"
                                        placeholder="検査リストテンプレート名"
                                        value={newChecklist.name}
                                        onChange={(e) => setNewChecklist({ ...newChecklist, name: e.target.value })}
                                        className="w-full dark-input rounded-xl px-4 py-3 mb-3 text-sm focus:outline-none"
                                    />

                                    {/* チェックタイプ選択 */}
                                    <div className="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-6 mb-4">
                                        <span className="text-white font-medium mobile-text-sm">チェック項目数:</span>
                                        <div className="flex gap-4">
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input
                                                    type="radio"
                                                    name="checkType"
                                                    value="single"
                                                    checked={newChecklist.checkType === 'single'}
                                                    onChange={(e) => setNewChecklist({ ...newChecklist, checkType: e.target.value })}
                                                />
                                                <span className="text-gray-300 mobile-text-sm">1次のみ</span>
                                            </label>
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input
                                                    type="radio"
                                                    name="checkType"
                                                    value="double"
                                                    checked={newChecklist.checkType === 'double' || !newChecklist.checkType}
                                                    onChange={(e) => setNewChecklist({ ...newChecklist, checkType: e.target.value })}
                                                />
                                                <span className="text-gray-300 mobile-text-sm">1次・2次</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div className="mb-6">
                                        {newChecklist.categories.map((category, catIndex) => {
                                            const isCategoryDragging = draggedChecklistCategory && draggedChecklistCategory.index === catIndex;
                                            const isCategoryDragOver = dragOverChecklistCategory && dragOverChecklistCategory.index === catIndex;

                                            return (
                                                <div key={catIndex}
                                                    data-category-index={catIndex}
                                                    className={`glass-card-dark mobile-compact-card rounded-xl task-draggable ${isCategoryDragging ? 'task-dragging' : ''} ${isCategoryDragOver ? 'task-drag-over' : ''}`}
                                                    style={{
                                                        boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)',
                                                        marginBottom: '12px',
                                                        paddingBottom: '6px'
                                                    }}
                                                    draggable="true"
                                                    onDragStart={(e) => {
                                                        setDraggedChecklistCategory({ index: catIndex, category });
                                                        e.dataTransfer.effectAllowed = 'move';
                                                        e.dataTransfer.setData('text/html', e.target.outerHTML);
                                                        e.target.style.opacity = '0.5';
                                                    }}
                                                    onDragEnd={(e) => {
                                                        e.target.style.opacity = '1';
                                                        setDraggedChecklistCategory(null);
                                                        setDragOverChecklistCategory(null);
                                                        setTimeout(() => {
                                                            setDragOverChecklistCategory(null);
                                                        }, 50);
                                                    }}
                                                    onDragOver={(e) => {
                                                        e.preventDefault();
                                                        e.dataTransfer.dropEffect = 'move';
                                                        const categoryElement = e.currentTarget.closest('.task-draggable');
                                                        if (categoryElement && draggedChecklistCategory) {
                                                            const categoryIndex = parseInt(categoryElement.getAttribute('data-category-index'));
                                                            if (categoryIndex !== draggedChecklistCategory.index) {
                                                                setDragOverChecklistCategory({ index: categoryIndex, category: newChecklist.categories[categoryIndex] });
                                                            }
                                                        }
                                                    }}
                                                    onDragEnter={(e) => {
                                                        e.preventDefault();
                                                        if (draggedChecklistCategory && catIndex !== draggedChecklistCategory.index) {
                                                            setDragOverChecklistCategory({ index: catIndex, category });
                                                        }
                                                    }}
                                                    onDragLeave={(e) => {
                                                        const relatedTarget = e.relatedTarget;
                                                        const currentTarget = e.currentTarget;
                                                        if (!relatedTarget || !currentTarget.contains(relatedTarget)) {
                                                            setDragOverChecklistCategory(null);
                                                        }
                                                    }}
                                                    onDrop={(e) => {
                                                        e.preventDefault();
                                                        setDragOverChecklistCategory(null);

                                                        if (!draggedChecklistCategory || draggedChecklistCategory.index === catIndex) {
                                                            return;
                                                        }

                                                        const dragIndex = draggedChecklistCategory.index;
                                                        const dropIndex = catIndex;
                                                        const updatedCategories = [...newChecklist.categories];
                                                        const draggedItem = updatedCategories[dragIndex];
                                                        updatedCategories.splice(dragIndex, 1);
                                                        updatedCategories.splice(dropIndex, 0, draggedItem);
                                                        setNewChecklist({ ...newChecklist, categories: updatedCategories });
                                                    }}>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <input
                                                            type="text"
                                                            placeholder="カテゴリ名（例：外観検査）"
                                                            value={category.name}
                                                            onChange={(e) => {
                                                                const updated = [...newChecklist.categories];
                                                                updated[catIndex].name = e.target.value;
                                                                setNewChecklist({ ...newChecklist, categories: updated });
                                                            }}
                                                            className={`flex-1 dark-input rounded-xl px-3 py-3 text-xs focus:outline-none ${newChecklist.categories.length > 1 ? 'mr-2' : ''}`}
                                                        />
                                                        {newChecklist.categories.length > 1 && (
                                                            <button
                                                                onClick={() => {
                                                                    const updated = newChecklist.categories.filter((_, i) => i !== catIndex);
                                                                    setNewChecklist({ ...newChecklist, categories: updated });
                                                                }}
                                                                className="text-gray-400 hover:text-white text-xl flex-shrink-0"
                                                            >
                                                                ✕
                                                            </button>
                                                        )}
                                                    </div>

                                                    <div className="space-y-2 ml-2 sm:ml-4">
                                                        {category.items.map((item, itemIndex) => {
                                                            const isItemDragging = draggedChecklistItem && draggedChecklistItem.catIndex === catIndex && draggedChecklistItem.itemIndex === itemIndex;
                                                            const isItemDragOver = dragOverChecklistItem && dragOverChecklistItem.catIndex === catIndex && dragOverChecklistItem.itemIndex === itemIndex;

                                                            return (
                                                                <div key={itemIndex}
                                                                    data-category-index={catIndex}
                                                                    data-item-index={itemIndex}
                                                                    className={`space-y-2 task-draggable ${isItemDragging ? 'task-dragging' : ''} ${isItemDragOver ? 'task-drag-over' : ''}`}
                                                                    draggable="true"
                                                                    onDragStart={(e) => {
                                                                        setDraggedChecklistItem({ catIndex, itemIndex, item });
                                                                        e.dataTransfer.effectAllowed = 'move';
                                                                        e.dataTransfer.setData('text/html', e.target.outerHTML);
                                                                        e.target.style.opacity = '0.5';
                                                                    }}
                                                                    onDragEnd={(e) => {
                                                                        e.target.style.opacity = '1';
                                                                        setDraggedChecklistItem(null);
                                                                        setDragOverChecklistItem(null);
                                                                        setTimeout(() => {
                                                                            setDragOverChecklistItem(null);
                                                                        }, 50);
                                                                    }}
                                                                    onDragOver={(e) => {
                                                                        e.preventDefault();
                                                                        e.dataTransfer.dropEffect = 'move';
                                                                        if (draggedChecklistItem) {
                                                                            if (draggedChecklistItem.catIndex === catIndex &&
                                                                                draggedChecklistItem.itemIndex !== itemIndex) {
                                                                                setDragOverChecklistItem({ catIndex, itemIndex, item });
                                                                            }
                                                                        }
                                                                    }}
                                                                    onDragEnter={(e) => {
                                                                        e.preventDefault();
                                                                        if (draggedChecklistItem &&
                                                                            draggedChecklistItem.catIndex === catIndex &&
                                                                            draggedChecklistItem.itemIndex !== itemIndex) {
                                                                            setDragOverChecklistItem({ catIndex, itemIndex, item });
                                                                        }
                                                                    }}
                                                                    onDragLeave={(e) => {
                                                                        const relatedTarget = e.relatedTarget;
                                                                        const currentTarget = e.currentTarget;
                                                                        if (!relatedTarget || !currentTarget.contains(relatedTarget)) {
                                                                            setDragOverChecklistItem(null);
                                                                        }
                                                                    }}
                                                                    onDrop={(e) => {
                                                                        e.preventDefault();
                                                                        setDragOverChecklistItem(null);

                                                                        if (!draggedChecklistItem ||
                                                                            draggedChecklistItem.catIndex !== catIndex ||
                                                                            draggedChecklistItem.itemIndex === itemIndex) {
                                                                            return;
                                                                        }

                                                                        const dragIndex = draggedChecklistItem.itemIndex;
                                                                        const dropIndex = itemIndex;
                                                                        const updated = [...newChecklist.categories];
                                                                        const draggedItem = updated[catIndex].items[dragIndex];
                                                                        updated[catIndex].items.splice(dragIndex, 1);
                                                                        updated[catIndex].items.splice(dropIndex, 0, draggedItem);
                                                                        setNewChecklist({ ...newChecklist, categories: updated });
                                                                    }}>
                                                                    <div className="flex gap-2">
                                                                        <input
                                                                            type="text"
                                                                            placeholder="検査項目"
                                                                            value={item.name}
                                                                            onChange={(e) => {
                                                                                const updated = [...newChecklist.categories];
                                                                                updated[catIndex].items[itemIndex].name = e.target.value;
                                                                                setNewChecklist({ ...newChecklist, categories: updated });
                                                                            }}
                                                                            className="flex-1 dark-input rounded-xl px-3 py-3 text-xs focus:outline-none"
                                                                        />
                                                                        {category.items.length > 1 && (
                                                                            <button
                                                                                onClick={() => {
                                                                                    const updated = [...newChecklist.categories];
                                                                                    updated[catIndex].items = updated[catIndex].items.filter((_, i) => i !== itemIndex);
                                                                                    setNewChecklist({ ...newChecklist, categories: updated });
                                                                                }}
                                                                                className="text-gray-400 hover:text-white text-xl flex-shrink-0"
                                                                            >
                                                                                ✕
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                    <input
                                                                        type="text"
                                                                        placeholder="備考（任意）"
                                                                        value={item.description}
                                                                        onChange={(e) => {
                                                                            const updated = [...newChecklist.categories];
                                                                            updated[catIndex].items[itemIndex].description = e.target.value;
                                                                            setNewChecklist({ ...newChecklist, categories: updated });
                                                                        }}
                                                                        className="w-full dark-input rounded-xl px-3 py-3 text-xs focus:outline-none"
                                                                    />
                                                                </div>
                                                            );
                                                        })}
                                                        <button
                                                            onClick={() => {
                                                                const updated = [...newChecklist.categories];
                                                                updated[catIndex].items.push({ name: '', description: '' });
                                                                setNewChecklist({ ...newChecklist, categories: updated });
                                                            }}
                                                            className="mobile-text-xs text-gray-400 hover:text-white"
                                                        >
                                                            + 項目を追加
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}

                                        <button
                                            onClick={() => {
                                                setNewChecklist({
                                                    ...newChecklist,
                                                    categories: [...newChecklist.categories, { name: '', items: [{ name: '', description: '' }] }]
                                                });
                                            }}
                                            className="w-full glass-card-dark text-white py-2 rounded-lg mobile-text-sm"
                                        >
                                            + カテゴリを追加
                                        </button>
                                    </div>

                                    <div className="grid grid-cols-1 gap-2 mb-1.5">
                                        <button
                                            onClick={saveChecklistTemplate}
                                            className="gradient-button text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 text-sm w-full"
                                        >
                                            {editingChecklist ? '更新' : '保存'}
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowChecklistForm(false);
                                                setEditingChecklist(null);
                                                setNewChecklist({
                                                    name: '',
                                                    companyId: '',
                                                    checkType: 'single',
                                                    categories: [{ name: '', items: [{ name: '', description: '' }] }]
                                                });
                                            }}
                                            className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                        >
                                            キャンセル
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* タスクテンプレート作成フォーム */}
                        {showTemplateForm && (
                            <div className="modal-overlay" onClick={cancelTemplateEdit}>
                                <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-4xl mx-4"
                                    onClick={(e) => e.stopPropagation()}
                                    style={{ maxHeight: '90vh', overflowY: 'auto' }}>
                                    <div className="mb-4">
                                        <h3 className="text-base font-bold text-white pt-2">
                                            {editingTemplate ? '工程テンプレート編集' : '工程テンプレート作成'}
                                        </h3>
                                    </div>

                                    <input
                                        type="text"
                                        placeholder="工程テンプレート名"
                                        value={newTemplate.name}
                                        onChange={(e) => setNewTemplate({ ...newTemplate, name: e.target.value })}
                                        className="w-full dark-input rounded-xl px-4 py-3 mb-3 text-sm focus:outline-none"
                                    />

                                    <div className="space-y-3 mb-3">
                                        {newTemplate.tasks.map((task, index) => {
                                            const isDragging = draggedTemplateTask && draggedTemplateTask.index === index;
                                            const isDragOver = dragOverTemplateTask && dragOverTemplateTask.index === index;

                                            return (
                                                <div key={index}
                                                    data-task-index={index}
                                                    className={`glass-card-dark mobile-compact-card rounded-xl task-draggable ${isDragging ? 'task-dragging' : ''} ${isDragOver ? 'task-drag-over' : ''}`}
                                                    style={{
                                                        boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)',
                                                        paddingBottom: '2px'
                                                    }}
                                                    draggable="true"
                                                    onDragStart={(e) => {
                                                        setDraggedTemplateTask({ index, task });
                                                        e.dataTransfer.effectAllowed = 'move';
                                                        e.dataTransfer.setData('text/html', e.target.outerHTML);
                                                        e.target.style.opacity = '0.5';
                                                    }}
                                                    onDragEnd={(e) => {
                                                        e.target.style.opacity = '1';
                                                        setDraggedTemplateTask(null);
                                                        setDragOverTemplateTask(null);
                                                        setTimeout(() => {
                                                            setDragOverTemplateTask(null);
                                                        }, 50);
                                                    }}
                                                    onDragOver={(e) => {
                                                        e.preventDefault();
                                                        e.dataTransfer.dropEffect = 'move';
                                                        const taskElement = e.currentTarget.closest('.task-draggable');
                                                        if (taskElement && draggedTemplateTask) {
                                                            const taskIndex = parseInt(taskElement.getAttribute('data-task-index'));
                                                            if (taskIndex !== draggedTemplateTask.index) {
                                                                setDragOverTemplateTask({ index: taskIndex, task: newTemplate.tasks[taskIndex] });
                                                            }
                                                        }
                                                    }}
                                                    onDragEnter={(e) => {
                                                        e.preventDefault();
                                                        if (draggedTemplateTask && index !== draggedTemplateTask.index) {
                                                            setDragOverTemplateTask({ index, task });
                                                        }
                                                    }}
                                                    onDragLeave={(e) => {
                                                        const relatedTarget = e.relatedTarget;
                                                        const currentTarget = e.currentTarget;
                                                        if (!relatedTarget || !currentTarget.contains(relatedTarget)) {
                                                            setDragOverTemplateTask(null);
                                                        }
                                                    }}
                                                    onDrop={(e) => {
                                                        e.preventDefault();
                                                        setDragOverTemplateTask(null);

                                                        if (!draggedTemplateTask || draggedTemplateTask.index === index) {
                                                            return;
                                                        }

                                                        const dragIndex = draggedTemplateTask.index;
                                                        const dropIndex = index;
                                                        const updatedTasks = [...newTemplate.tasks];
                                                        const draggedItem = updatedTasks[dragIndex];
                                                        updatedTasks.splice(dragIndex, 1);
                                                        updatedTasks.splice(dropIndex, 0, draggedItem);
                                                        setNewTemplate({ ...newTemplate, tasks: updatedTasks });
                                                    }}
                                                >
                                                    <div className="space-y-2">
                                                        {/* 工程名と削除ボタンを横並びに */}
                                                        <div className="flex justify-between items-center mb-2">
                                                            <input
                                                                type="text"
                                                                placeholder="工程名"
                                                                value={task.title}
                                                                onChange={(e) => {
                                                                    const updatedTasks = [...newTemplate.tasks];
                                                                    updatedTasks[index].title = e.target.value;
                                                                    setNewTemplate({ ...newTemplate, tasks: updatedTasks });
                                                                }}
                                                                className={`flex-1 dark-input rounded-xl px-3 py-3 text-xs focus:outline-none ${newTemplate.tasks.length > 1 ? 'mr-2' : ''}`}
                                                            />
                                                            {newTemplate.tasks.length > 1 && (
                                                                <button
                                                                    onClick={() => {
                                                                        const updatedTasks = newTemplate.tasks.filter((_, i) => i !== index);
                                                                        setNewTemplate({ ...newTemplate, tasks: updatedTasks });
                                                                    }}
                                                                    className="text-gray-400 hover:text-white text-xl flex-shrink-0"
                                                                    title="工程を削除"
                                                                >
                                                                    ✕
                                                                </button>
                                                            )}
                                                        </div>

                                                        <div className="flex gap-2 items-center">
                                                            <div className="number-input-container flex-1">
                                                                <input
                                                                    type="number"
                                                                    inputMode="decimal"
                                                                    pattern="[0-9]*[.,]?[0-9]*"
                                                                    placeholder="予想工数（時間）"
                                                                    value={task.estimatedHours}
                                                                    onChange={(e) => {
                                                                        const updatedTasks = [...newTemplate.tasks];
                                                                        updatedTasks[index].estimatedHours = e.target.value;
                                                                        setNewTemplate({ ...newTemplate, tasks: updatedTasks });
                                                                    }}
                                                                    className="w-full dark-input rounded-xl px-3 py-3 text-xs focus:outline-none"
                                                                    step="0.5"
                                                                />
                                                                <div className="custom-spin-buttons">
                                                                    <button
                                                                        type="button"
                                                                        className="spin-button spin-button-up"
                                                                        onClick={() => {
                                                                            const updatedTasks = [...newTemplate.tasks];
                                                                            const currentValue = parseFloat(updatedTasks[index].estimatedHours) || 0;
                                                                            updatedTasks[index].estimatedHours = (currentValue + 0.5).toString();
                                                                            setNewTemplate({ ...newTemplate, tasks: updatedTasks });
                                                                        }}
                                                                    />
                                                                    <button
                                                                        type="button"
                                                                        className="spin-button spin-button-down"
                                                                        onClick={() => {
                                                                            const updatedTasks = [...newTemplate.tasks];
                                                                            const currentValue = parseFloat(updatedTasks[index].estimatedHours) || 0;
                                                                            updatedTasks[index].estimatedHours = Math.max(0, currentValue - 0.5).toString();
                                                                            setNewTemplate({ ...newTemplate, tasks: updatedTasks });
                                                                        }}
                                                                    />
                                                                </div>
                                                            </div>

                                                        </div>

                                                        <textarea
                                                            placeholder="説明（任意）"
                                                            value={task.description}
                                                            onChange={(e) => {
                                                                const updatedTasks = [...newTemplate.tasks];
                                                                updatedTasks[index].description = e.target.value;
                                                                setNewTemplate({ ...newTemplate, tasks: updatedTasks });
                                                            }}
                                                            className="w-full dark-input rounded-xl px-3 py-3 text-xs focus:outline-none"
                                                            rows={2}
                                                        />
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <button
                                        onClick={() => {
                                            setNewTemplate({
                                                ...newTemplate,
                                                tasks: [...newTemplate.tasks, { title: '', estimatedHours: '', description: '' }]
                                            });
                                        }}
                                        className="w-full glass-card-dark text-white py-2 rounded-lg mb-3 mobile-text-sm"
                                    >
                                        + 工程を追加
                                    </button>

                                    <div className="grid grid-cols-1 gap-2 mb-1.5 mt-3">
                                        <button
                                            onClick={() => saveTemplate()}
                                            className="gradient-button text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 text-sm w-full"
                                        >
                                            {editingTemplate ? '更新' : '作成'}
                                        </button>
                                        <button
                                            onClick={cancelTemplateEdit}
                                            className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                        >
                                            キャンセル
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 配線仕様テンプレート作成フォーム */}
                        {showWiringForm && (
                            <div className="modal-overlay" onClick={() => {
                                setShowWiringForm(false);
                                setEditingWiring(null);
                                resetWiringForm();
                            }}>
                                <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-4xl mx-4"
                                    onClick={(e) => e.stopPropagation()}
                                    style={{ maxHeight: '90vh', overflowY: 'auto' }}>
                                    <div className="mb-4">
                                        <h3 className="text-base font-bold text-white pt-2">
                                            {editingWiring
                                                ? (editingWiring.projectId ? '配線仕様編集' : '配線仕様テンプレート編集')
                                                : '配線仕様テンプレート作成'}
                                        </h3>
                                    </div>

                                    <input
                                        type="text"
                                        placeholder="配線仕様テンプレート名"
                                        value={newWiring.name}
                                        onChange={(e) => setNewWiring({ ...newWiring, name: e.target.value })}
                                        className="w-full dark-input rounded-xl px-4 py-3 mb-3 text-sm focus:outline-none"
                                    />

                                    {/* 使用電線セクション */}
                                    <div className="glass-card-dark p-3 rounded-xl mb-3"
                                        style={{
                                            boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)',
                                            paddingBottom: '4px'
                                        }}>
                                        <h4 className="mobile-text-sm font-bold text-white mb-2">電線</h4>

                                        {/* 動力 */}
                                        <div className="mb-1.5">
                                            <h5 className="mobile-text-sm font-bold text-white mb-3">動力</h5>



                                            {/* 規格（複数選択） */}
                                            <div className="mb-2">

                                                {[0, 1, 2, 3, 4].map(index => (
                                                    (index === 0 || newWiring.specifications.wire.power.standards[index - 1]) && (
                                                        <div key={index} className="mb-2">
                                                            <div className="flex gap-2 items-center">
                                                                <div className="custom-select-container flex-1">
                                                                    <select
                                                                        value={newWiring.specifications.wire.power.standards[index] || ''}
                                                                        onChange={(e) => {
                                                                            const newStandards = [...(newWiring.specifications.wire.power.standards || [])];
                                                                            newStandards[index] = e.target.value;
                                                                            setNewWiring({
                                                                                ...newWiring,
                                                                                specifications: {
                                                                                    ...newWiring.specifications,
                                                                                    wire: {
                                                                                        ...newWiring.specifications.wire,
                                                                                        power: {
                                                                                            ...newWiring.specifications.wire.power,
                                                                                            standards: newStandards.filter(s => s) // 空の要素を除去
                                                                                        }
                                                                                    }
                                                                                }
                                                                            });
                                                                        }}
                                                                        className="custom-select text-xs"
                                                                    >
                                                                        <option value="">規格（最大5個まで）</option>
                                                                        <option value="IV">IV</option>
                                                                        <option value="KV">KV</option>
                                                                        <option value="KIV">KIV</option>
                                                                        <option value="HIV">HIV</option>
                                                                        <option value="UL1007">UL1007</option>
                                                                        <option value="UL1015">UL1015</option>
                                                                        <option value="その他">その他</option>
                                                                    </select>
                                                                    <div className="custom-select-arrow"></div>
                                                                </div>
                                                                {newWiring.specifications.wire.power.standards[index] === 'その他' && (
                                                                    <input
                                                                        type="text"
                                                                        placeholder="規格を入力"
                                                                        value={newWiring.specifications.wire.power[`customStandard${index}`] || ''}
                                                                        onChange={(e) => setNewWiring({
                                                                            ...newWiring,
                                                                            specifications: {
                                                                                ...newWiring.specifications,
                                                                                wire: {
                                                                                    ...newWiring.specifications.wire,
                                                                                    power: {
                                                                                        ...newWiring.specifications.wire.power,
                                                                                        [`customStandard${index}`]: e.target.value
                                                                                    }
                                                                                }
                                                                            }
                                                                        })}
                                                                        className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                                    />
                                                                )}
                                                            </div>
                                                        </div>
                                                    )
                                                ))}
                                            </div>

                                            {/* 配線方式選択 */}
                                            <div className="mb-2">

                                                <div className="custom-select-container">
                                                    <select
                                                        value={newWiring.specifications.wire.power.wiringType}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                wire: {
                                                                    ...newWiring.specifications.wire,
                                                                    power: {
                                                                        ...newWiring.specifications.wire.power,
                                                                        wiringType: e.target.value,
                                                                        phases: {} // リセット
                                                                    }
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">配線方式</option>
                                                        <option value="three-phase-4">三相4線</option>
                                                        <option value="three-phase-3">三相3線</option>
                                                        <option value="single-phase-3">単相3線</option>
                                                        <option value="single-phase-2">単相2線</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>

                                            {/* 相線色（配線方式に応じて表示） */}
                                            {newWiring.specifications.wire.power.wiringType && (
                                                <div className="mb-2">


                                                    {/* 三相4線 */}
                                                    {newWiring.specifications.wire.power.wiringType === 'three-phase-4' && (
                                                        <div className="space-y-2">
                                                            {[
                                                                { key: 'rPhase', label: 'R相' },
                                                                { key: 'sPhase', label: 'S相' },
                                                                { key: 'tPhase', label: 'T相' },
                                                                { key: 'nPhase', label: 'N相' }
                                                            ].map(phase => (
                                                                <div key={phase.key}>
                                                                    <div className="custom-select-container">
                                                                        <select
                                                                            value={newWiring.specifications.wire.power.phases[phase.key] || ''}
                                                                            onChange={(e) => setNewWiring({
                                                                                ...newWiring,
                                                                                specifications: {
                                                                                    ...newWiring.specifications,
                                                                                    wire: {
                                                                                        ...newWiring.specifications.wire,
                                                                                        power: {
                                                                                            ...newWiring.specifications.wire.power,
                                                                                            phases: {
                                                                                                ...newWiring.specifications.wire.power.phases,
                                                                                                [phase.key]: e.target.value
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            })}
                                                                            className="custom-select text-xs"
                                                                        >
                                                                            <option value="">線色:{phase.label}</option>
                                                                            <option value="黒">黒</option>
                                                                            <option value="白">白</option>
                                                                            <option value="赤">赤</option>
                                                                            <option value="緑">緑</option>
                                                                            <option value="黄">黄</option>
                                                                            <option value="茶">茶</option>
                                                                            <option value="青">青</option>
                                                                            <option value="灰">灰</option>
                                                                            <option value="橙">橙</option>
                                                                            <option value="空色">空色</option>
                                                                            <option value="桃">桃</option>
                                                                            <option value="若草">若草</option>
                                                                            <option value="その他">その他</option>
                                                                        </select>
                                                                        <div className="custom-select-arrow"></div>
                                                                    </div>
                                                                    {newWiring.specifications.wire.power.phases[phase.key] === 'その他' && (
                                                                        <input
                                                                            type="text"
                                                                            placeholder="色を入力"
                                                                            value={newWiring.specifications.wire.power[`${phase.key}Custom`] || ''}
                                                                            onChange={(e) => setNewWiring({
                                                                                ...newWiring,
                                                                                specifications: {
                                                                                    ...newWiring.specifications,
                                                                                    wire: {
                                                                                        ...newWiring.specifications.wire,
                                                                                        power: {
                                                                                            ...newWiring.specifications.wire.power,
                                                                                            [`${phase.key}Custom`]: e.target.value
                                                                                        }
                                                                                    }
                                                                                }
                                                                            })}
                                                                            className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                                        />
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}

                                                    {/* 三相3線 */}
                                                    {newWiring.specifications.wire.power.wiringType === 'three-phase-3' && (
                                                        <div className="space-y-2">
                                                            {[
                                                                { key: 'rPhase', label: 'R相' },
                                                                { key: 'sPhase', label: 'S相' },
                                                                { key: 'tPhase', label: 'T相' }
                                                            ].map(phase => (
                                                                <div key={phase.key}>
                                                                    <div className="custom-select-container">
                                                                        <select
                                                                            value={newWiring.specifications.wire.power.phases[phase.key] || ''}
                                                                            onChange={(e) => setNewWiring({
                                                                                ...newWiring,
                                                                                specifications: {
                                                                                    ...newWiring.specifications,
                                                                                    wire: {
                                                                                        ...newWiring.specifications.wire,
                                                                                        power: {
                                                                                            ...newWiring.specifications.wire.power,
                                                                                            phases: {
                                                                                                ...newWiring.specifications.wire.power.phases,
                                                                                                [phase.key]: e.target.value
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            })}
                                                                            className="custom-select text-xs"
                                                                        >
                                                                            <option value="">線色:{phase.label}</option>
                                                                            <option value="黒">黒</option>
                                                                            <option value="白">白</option>
                                                                            <option value="赤">赤</option>
                                                                            <option value="緑">緑</option>
                                                                            <option value="黄">黄</option>
                                                                            <option value="茶">茶</option>
                                                                            <option value="青">青</option>
                                                                            <option value="灰">灰</option>
                                                                            <option value="橙">橙</option>
                                                                            <option value="空色">空色</option>
                                                                            <option value="桃">桃</option>
                                                                            <option value="若草">若草</option>
                                                                            <option value="その他">その他</option>
                                                                        </select>
                                                                        <div className="custom-select-arrow"></div>
                                                                    </div>
                                                                    {newWiring.specifications.wire.power.phases[phase.key] === 'その他' && (
                                                                        <input
                                                                            type="text"
                                                                            placeholder="色を入力"
                                                                            value={newWiring.specifications.wire.power[`${phase.key}Custom`] || ''}
                                                                            onChange={(e) => setNewWiring({
                                                                                ...newWiring,
                                                                                specifications: {
                                                                                    ...newWiring.specifications,
                                                                                    wire: {
                                                                                        ...newWiring.specifications.wire,
                                                                                        power: {
                                                                                            ...newWiring.specifications.wire.power,
                                                                                            [`${phase.key}Custom`]: e.target.value
                                                                                        }
                                                                                    }
                                                                                }
                                                                            })}
                                                                            className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                                        />
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}

                                                    {/* 単相3線 */}
                                                    {newWiring.specifications.wire.power.wiringType === 'single-phase-3' && (
                                                        <div className="space-y-2">
                                                            {[
                                                                { key: 'rPhase', label: 'R相' },
                                                                { key: 'nPhase', label: 'N相' },
                                                                { key: 'tPhase', label: 'T相' }
                                                            ].map(phase => (
                                                                <div key={phase.key}>
                                                                    <div className="custom-select-container">
                                                                        <select
                                                                            value={newWiring.specifications.wire.power.phases[phase.key] || ''}
                                                                            onChange={(e) => setNewWiring({
                                                                                ...newWiring,
                                                                                specifications: {
                                                                                    ...newWiring.specifications,
                                                                                    wire: {
                                                                                        ...newWiring.specifications.wire,
                                                                                        power: {
                                                                                            ...newWiring.specifications.wire.power,
                                                                                            phases: {
                                                                                                ...newWiring.specifications.wire.power.phases,
                                                                                                [phase.key]: e.target.value
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            })}
                                                                            className="custom-select text-xs"
                                                                        >
                                                                            <option value="">線色:{phase.label}</option>
                                                                            <option value="黒">黒</option>
                                                                            <option value="白">白</option>
                                                                            <option value="赤">赤</option>
                                                                            <option value="緑">緑</option>
                                                                            <option value="黄">黄</option>
                                                                            <option value="茶">茶</option>
                                                                            <option value="青">青</option>
                                                                            <option value="灰">灰</option>
                                                                            <option value="橙">橙</option>
                                                                            <option value="空色">空色</option>
                                                                            <option value="桃">桃</option>
                                                                            <option value="若草">若草</option>
                                                                            <option value="その他">その他</option>
                                                                        </select>
                                                                        <div className="custom-select-arrow"></div>
                                                                    </div>
                                                                    {newWiring.specifications.wire.power.phases[phase.key] === 'その他' && (
                                                                        <input
                                                                            type="text"
                                                                            placeholder="色を入力"
                                                                            value={newWiring.specifications.wire.power[`${phase.key}Custom`] || ''}
                                                                            onChange={(e) => setNewWiring({
                                                                                ...newWiring,
                                                                                specifications: {
                                                                                    ...newWiring.specifications,
                                                                                    wire: {
                                                                                        ...newWiring.specifications.wire,
                                                                                        power: {
                                                                                            ...newWiring.specifications.wire.power,
                                                                                            [`${phase.key}Custom`]: e.target.value
                                                                                        }
                                                                                    }
                                                                                }
                                                                            })}
                                                                            className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                                        />
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}

                                                    {/* 単相2線 */}
                                                    {newWiring.specifications.wire.power.wiringType === 'single-phase-2' && (
                                                        <div className="space-y-2">
                                                            {[
                                                                { key: 'lPhase', label: 'L相' },
                                                                { key: 'nPhase', label: 'N相' }
                                                            ].map(phase => (
                                                                <div key={phase.key}>
                                                                    <div className="custom-select-container">
                                                                        <select
                                                                            value={newWiring.specifications.wire.power.phases[phase.key] || ''}
                                                                            onChange={(e) => setNewWiring({
                                                                                ...newWiring,
                                                                                specifications: {
                                                                                    ...newWiring.specifications,
                                                                                    wire: {
                                                                                        ...newWiring.specifications.wire,
                                                                                        power: {
                                                                                            ...newWiring.specifications.wire.power,
                                                                                            phases: {
                                                                                                ...newWiring.specifications.wire.power.phases,
                                                                                                [phase.key]: e.target.value
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            })}
                                                                            className="custom-select text-xs"
                                                                        >
                                                                            <option value="">線色:{phase.label}</option>
                                                                            <option value="黒">黒</option>
                                                                            <option value="白">白</option>
                                                                            <option value="赤">赤</option>
                                                                            <option value="緑">緑</option>
                                                                            <option value="黄">黄</option>
                                                                            <option value="茶">茶</option>
                                                                            <option value="青">青</option>
                                                                            <option value="灰">灰</option>
                                                                            <option value="橙">橙</option>
                                                                            <option value="空色">空色</option>
                                                                            <option value="桃">桃</option>
                                                                            <option value="若草">若草</option>
                                                                            <option value="その他">その他</option>
                                                                        </select>
                                                                        <div className="custom-select-arrow"></div>
                                                                    </div>
                                                                    {newWiring.specifications.wire.power.phases[phase.key] === 'その他' && (
                                                                        <input
                                                                            type="text"
                                                                            placeholder="色を入力"
                                                                            value={newWiring.specifications.wire.power[`${phase.key}Custom`] || ''}
                                                                            onChange={(e) => setNewWiring({
                                                                                ...newWiring,
                                                                                specifications: {
                                                                                    ...newWiring.specifications,
                                                                                    wire: {
                                                                                        ...newWiring.specifications.wire,
                                                                                        power: {
                                                                                            ...newWiring.specifications.wire.power,
                                                                                            [`${phase.key}Custom`]: e.target.value
                                                                                        }
                                                                                    }
                                                                                }
                                                                            })}
                                                                            className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                                        />
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {/* 備考 */}
                                            <div>

                                                <textarea
                                                    value={newWiring.specifications.wire.power.remarks || ''}
                                                    onChange={(e) => setNewWiring({
                                                        ...newWiring,
                                                        specifications: {
                                                            ...newWiring.specifications,
                                                            wire: {
                                                                ...newWiring.specifications.wire,
                                                                power: {
                                                                    ...newWiring.specifications.wire.power,
                                                                    remarks: e.target.value
                                                                }
                                                            }
                                                        }
                                                    })}
                                                    className="w-full dark-input rounded-xl px-4 py-3 text-xs focus:outline-none"
                                                    rows={2}
                                                    placeholder="備考を入力"
                                                />
                                            </div>
                                        </div>

                                        {/* 接地 */}
                                        <div className="mb-1.5">
                                            <h5 className="mobile-text-sm font-bold text-white mb-3">接地</h5>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                                                <div>

                                                    <div className="flex gap-2">
                                                        <div className="custom-select-container flex-1">
                                                            <select
                                                                value={newWiring.specifications.wire.ground.caseColor}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            ground: {
                                                                                ...newWiring.specifications.wire.ground,
                                                                                caseColor: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">線色:筐体</option>
                                                                <option value="緑">緑</option>
                                                                <option value="緑/黄">緑/黄</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                        <div className="custom-select-container" style={{ width: '100px' }}>
                                                            <select
                                                                value={newWiring.specifications.wire.ground.caseDiameter}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            ground: {
                                                                                ...newWiring.specifications.wire.ground,
                                                                                caseDiameter: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">sq</option>
                                                                <option value="0.75">0.75</option>
                                                                <option value="1.25">1.25</option>
                                                                <option value="2">2</option>
                                                                <option value="3.5">3.5</option>
                                                                <option value="5.5">5.5</option>
                                                                <option value="8">8</option>
                                                                <option value="14">14</option>
                                                                <option value="22">22</option>
                                                                <option value="38">38</option>
                                                                <option value="60">60</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div>

                                                    <div className="flex gap-2">
                                                        <div className="custom-select-container flex-1">
                                                            <select
                                                                value={newWiring.specifications.wire.ground.doorColor}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            ground: {
                                                                                ...newWiring.specifications.wire.ground,
                                                                                doorColor: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">線色:扉</option>
                                                                <option value="緑">緑</option>
                                                                <option value="緑/黄">緑/黄</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                        <div className="custom-select-container" style={{ width: '100px' }}>
                                                            <select
                                                                value={newWiring.specifications.wire.ground.doorDiameter}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            ground: {
                                                                                ...newWiring.specifications.wire.ground,
                                                                                doorDiameter: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">sq</option>
                                                                <option value="0.75">0.75</option>
                                                                <option value="1.25">1.25</option>
                                                                <option value="2">2</option>
                                                                <option value="3.5">3.5</option>
                                                                <option value="5.5">5.5</option>
                                                                <option value="8">8</option>
                                                                <option value="14">14</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div>

                                                    <div className="flex gap-2">
                                                        <div className="custom-select-container flex-1">
                                                            <select
                                                                value={newWiring.specifications.wire.ground.panelColor}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            ground: {
                                                                                ...newWiring.specifications.wire.ground,
                                                                                panelColor: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">線色:盤間</option>
                                                                <option value="緑">緑</option>
                                                                <option value="緑/黄">緑/黄</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                        <div className="custom-select-container" style={{ width: '100px' }}>
                                                            <select
                                                                value={newWiring.specifications.wire.ground.panelDiameter}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            ground: {
                                                                                ...newWiring.specifications.wire.ground,
                                                                                panelDiameter: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">sq</option>
                                                                <option value="0.75">0.75</option>
                                                                <option value="1.25">1.25</option>
                                                                <option value="2">2</option>
                                                                <option value="3.5">3.5</option>
                                                                <option value="5.5">5.5</option>
                                                                <option value="8">8</option>
                                                                <option value="14">14</option>
                                                                <option value="22">22</option>
                                                                <option value="38">38</option>
                                                                <option value="60">60</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {/* 備考 */}
                                            <div className="mt-2">

                                                <textarea
                                                    value={newWiring.specifications.wire.ground.remarks || ''}
                                                    onChange={(e) => setNewWiring({
                                                        ...newWiring,
                                                        specifications: {
                                                            ...newWiring.specifications,
                                                            wire: {
                                                                ...newWiring.specifications.wire,
                                                                ground: {
                                                                    ...newWiring.specifications.wire.ground,
                                                                    remarks: e.target.value
                                                                }
                                                            }
                                                        }
                                                    })}
                                                    className="w-full dark-input rounded-xl px-4 py-3 text-xs focus:outline-none"
                                                    rows={2}
                                                    placeholder="備考を入力"
                                                />
                                            </div>
                                        </div>

                                        {/* 絶縁キャップ */}
                                        <div className="mb-1.5">
                                            <h5 className="mobile-text-sm font-bold text-white mb-3">絶縁キャップ</h5>
                                            <div className="flex gap-2">
                                                <div className="custom-select-container flex-1">
                                                    <select
                                                        value={newWiring.specifications.wire.insulationCap}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                wire: {
                                                                    ...newWiring.specifications.wire,
                                                                    insulationCap: e.target.value,
                                                                    insulationCapDiameter: e.target.value !== '太線のみ必要' ? '' : newWiring.specifications.wire.insulationCapDiameter,
                                                                    insulationCapRemarks: newWiring.specifications.wire.insulationCapRemarks // ← この行を追加
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">仕様</option>
                                                        <option value="全て必要">全て必要</option>
                                                        <option value="不要">不要</option>
                                                        <option value="太線のみ必要">太線のみ必要</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                                {newWiring.specifications.wire.insulationCap === '太線のみ必要' && (
                                                    <div className="custom-select-container" style={{ width: '150px' }}>
                                                        <select
                                                            value={newWiring.specifications.wire.insulationCapDiameter}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    wire: {
                                                                        ...newWiring.specifications.wire,
                                                                        insulationCapDiameter: e.target.value
                                                                    }
                                                                }
                                                            })}
                                                            className="custom-select text-xs"
                                                        >
                                                            <option value="">sq以上</option>
                                                            <option value="2">2sq以上</option>
                                                            <option value="3.5">3.5sq以上</option>
                                                            <option value="5.5">5.5sq以上</option>
                                                            <option value="8">8sq以上</option>
                                                            <option value="14">14sq以上</option>
                                                        </select>
                                                        <div className="custom-select-arrow"></div>
                                                    </div>
                                                )}
                                            </div>
                                            {/* 備考 */}
                                            <div className="mt-2">

                                                <textarea
                                                    value={newWiring.specifications.wire.insulationCapRemarks || ''}
                                                    onChange={(e) => setNewWiring({
                                                        ...newWiring,
                                                        specifications: {
                                                            ...newWiring.specifications,
                                                            wire: {
                                                                ...newWiring.specifications.wire,
                                                                insulationCap: newWiring.specifications.wire.insulationCap, // ← この行を追加
                                                                insulationCapDiameter: newWiring.specifications.wire.insulationCapDiameter, // ← この行を追加
                                                                insulationCapRemarks: e.target.value
                                                            }
                                                        }
                                                    })}
                                                    className="w-full dark-input rounded-xl px-4 py-3 text-xs focus:outline-none"
                                                    rows={2}
                                                    placeholder="備考を入力"
                                                />
                                            </div>
                                        </div>

                                        {/* 制御AC */}
                                        <div className="mb-1.5">
                                            <h5 className="mobile-text-sm font-bold text-white mb-3">制御AC</h5>

                                            {/* 規格（複数選択） */}
                                            <div className="mb-2">

                                                {[0, 1, 2, 3, 4].map(index => (
                                                    (index === 0 || newWiring.specifications.wire.controlAC.standards[index - 1]) && (
                                                        <div key={index} className="mb-2">
                                                            <div className="flex gap-2 items-center">
                                                                <div className="custom-select-container flex-1">
                                                                    <select
                                                                        value={newWiring.specifications.wire.controlAC.standards[index] || ''}
                                                                        onChange={(e) => {
                                                                            const newStandards = [...(newWiring.specifications.wire.controlAC.standards || [])];
                                                                            newStandards[index] = e.target.value;
                                                                            setNewWiring({
                                                                                ...newWiring,
                                                                                specifications: {
                                                                                    ...newWiring.specifications,
                                                                                    wire: {
                                                                                        ...newWiring.specifications.wire,
                                                                                        controlAC: {
                                                                                            ...newWiring.specifications.wire.controlAC,
                                                                                            standards: newStandards.filter(s => s)
                                                                                        }
                                                                                    }
                                                                                }
                                                                            });
                                                                        }}
                                                                        className="custom-select text-xs"
                                                                    >
                                                                        <option value="">規格（最大5個まで）</option>
                                                                        <option value="IV">IV</option>
                                                                        <option value="KV">KV</option>
                                                                        <option value="KIV">KIV</option>
                                                                        <option value="HIV">HIV</option>
                                                                        <option value="UL1007">UL1007</option>
                                                                        <option value="UL1015">UL1015</option>
                                                                        <option value="その他">その他</option>
                                                                    </select>
                                                                    <div className="custom-select-arrow"></div>
                                                                </div>
                                                                {newWiring.specifications.wire.controlAC.standards[index] === 'その他' && (
                                                                    <input
                                                                        type="text"
                                                                        placeholder="規格を入力"
                                                                        value={newWiring.specifications.wire.controlAC[`customStandard${index}`] || ''}
                                                                        onChange={(e) => setNewWiring({
                                                                            ...newWiring,
                                                                            specifications: {
                                                                                ...newWiring.specifications,
                                                                                wire: {
                                                                                    ...newWiring.specifications.wire,
                                                                                    controlAC: {
                                                                                        ...newWiring.specifications.wire.controlAC,
                                                                                        [`customStandard${index}`]: e.target.value
                                                                                    }
                                                                                }
                                                                            }
                                                                        })}
                                                                        className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                                    />
                                                                )}
                                                            </div>
                                                        </div>
                                                    )
                                                ))}
                                            </div>

                                            {/* コモン・非コモン設定（行レイアウト） */}
                                            <div className="space-y-2">
                                                <div>

                                                    <div className="flex gap-2 items-center">
                                                        <div className="custom-select-container flex-1">
                                                            <select
                                                                value={newWiring.specifications.wire.controlAC.commonColor}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlAC: {
                                                                                ...newWiring.specifications.wire.controlAC,
                                                                                commonColor: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">線色:コモン</option>
                                                                <option value="黒">黒</option>
                                                                <option value="白">白</option>
                                                                <option value="赤">赤</option>
                                                                <option value="緑">緑</option>
                                                                <option value="黄">黄</option>
                                                                <option value="茶">茶</option>
                                                                <option value="青">青</option>
                                                                <option value="灰">灰</option>
                                                                <option value="橙">橙</option>
                                                                <option value="空色">空色</option>
                                                                <option value="桃">桃</option>
                                                                <option value="若草">若草</option>
                                                                <option value="その他">その他</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                        {newWiring.specifications.wire.controlAC.commonColor === 'その他' && (
                                                            <input
                                                                type="text"
                                                                placeholder="色を入力"
                                                                value={newWiring.specifications.wire.controlAC.commonColorCustom || ''}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlAC: {
                                                                                ...newWiring.specifications.wire.controlAC,
                                                                                commonColorCustom: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                            />
                                                        )}
                                                        <div className="custom-select-container" style={{ width: '100px' }}>
                                                            <select
                                                                value={newWiring.specifications.wire.controlAC.commonDiameter}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlAC: {
                                                                                ...newWiring.specifications.wire.controlAC,
                                                                                commonDiameter: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">sq</option>
                                                                <option value="0.5">0.5</option>
                                                                <option value="0.75">0.75</option>
                                                                <option value="1.25">1.25</option>
                                                                <option value="2">2</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div>

                                                    <div className="flex gap-2 items-center">
                                                        <div className="custom-select-container flex-1">
                                                            <select
                                                                value={newWiring.specifications.wire.controlAC.nonCommonColor}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlAC: {
                                                                                ...newWiring.specifications.wire.controlAC,
                                                                                nonCommonColor: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">線色:コモン以外</option>
                                                                <option value="黒">黒</option>
                                                                <option value="白">白</option>
                                                                <option value="赤">赤</option>
                                                                <option value="緑">緑</option>
                                                                <option value="黄">黄</option>
                                                                <option value="茶">茶</option>
                                                                <option value="青">青</option>
                                                                <option value="灰">灰</option>
                                                                <option value="橙">橙</option>
                                                                <option value="空色">空色</option>
                                                                <option value="桃">桃</option>
                                                                <option value="若草">若草</option>
                                                                <option value="その他">その他</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                        {newWiring.specifications.wire.controlAC.nonCommonColor === 'その他' && (
                                                            <input
                                                                type="text"
                                                                placeholder="色を入力"
                                                                value={newWiring.specifications.wire.controlAC.nonCommonColorCustom || ''}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlAC: {
                                                                                ...newWiring.specifications.wire.controlAC,
                                                                                nonCommonColorCustom: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                            />
                                                        )}
                                                        <div className="custom-select-container" style={{ width: '100px' }}>
                                                            <select
                                                                value={newWiring.specifications.wire.controlAC.nonCommonDiameter}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlAC: {
                                                                                ...newWiring.specifications.wire.controlAC,
                                                                                nonCommonDiameter: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">sq</option>
                                                                <option value="0.5">0.5</option>
                                                                <option value="0.75">0.75</option>
                                                                <option value="1.25">1.25</option>
                                                                <option value="2">2</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>

                                            {/* 備考 */}
                                            <div className="mt-2">

                                                <textarea
                                                    value={newWiring.specifications.wire.controlAC.remarks || ''}
                                                    onChange={(e) => setNewWiring({
                                                        ...newWiring,
                                                        specifications: {
                                                            ...newWiring.specifications,
                                                            wire: {
                                                                ...newWiring.specifications.wire,
                                                                controlAC: {
                                                                    ...newWiring.specifications.wire.controlAC,
                                                                    remarks: e.target.value
                                                                }
                                                            }
                                                        }
                                                    })}
                                                    className="w-full dark-input rounded-xl px-4 py-3 text-xs focus:outline-none"
                                                    rows={2}
                                                    placeholder="備考を入力"
                                                />
                                            </div>
                                        </div>

                                        {/* 制御DC */}
                                        <div className="mb-1.5">
                                            <h5 className="mobile-text-sm font-bold text-white mb-3">制御DC</h5>

                                            {/* 規格（複数選択） */}
                                            <div className="mb-2">

                                                {[0, 1, 2, 3, 4].map(index => (
                                                    (index === 0 || newWiring.specifications.wire.controlDC.standards[index - 1]) && (
                                                        <div key={index} className="mb-2">
                                                            <div className="flex gap-2 items-center">
                                                                <div className="custom-select-container flex-1">
                                                                    <select
                                                                        value={newWiring.specifications.wire.controlDC.standards[index] || ''}
                                                                        onChange={(e) => {
                                                                            const newStandards = [...(newWiring.specifications.wire.controlDC.standards || [])];
                                                                            newStandards[index] = e.target.value;
                                                                            setNewWiring({
                                                                                ...newWiring,
                                                                                specifications: {
                                                                                    ...newWiring.specifications,
                                                                                    wire: {
                                                                                        ...newWiring.specifications.wire,
                                                                                        controlDC: {
                                                                                            ...newWiring.specifications.wire.controlDC,
                                                                                            standards: newStandards.filter(s => s)
                                                                                        }
                                                                                    }
                                                                                }
                                                                            });
                                                                        }}
                                                                        className="custom-select text-xs"
                                                                    >
                                                                        <option value="">規格（最大5個まで）</option>
                                                                        <option value="IV">IV</option>
                                                                        <option value="KV">KV</option>
                                                                        <option value="KIV">KIV</option>
                                                                        <option value="HIV">HIV</option>
                                                                        <option value="UL1007">UL1007</option>
                                                                        <option value="UL1015">UL1015</option>
                                                                        <option value="その他">その他</option>
                                                                    </select>
                                                                    <div className="custom-select-arrow"></div>
                                                                </div>
                                                                {newWiring.specifications.wire.controlDC.standards[index] === 'その他' && (
                                                                    <input
                                                                        type="text"
                                                                        placeholder="規格を入力"
                                                                        value={newWiring.specifications.wire.controlDC[`customStandard${index}`] || ''}
                                                                        onChange={(e) => setNewWiring({
                                                                            ...newWiring,
                                                                            specifications: {
                                                                                ...newWiring.specifications,
                                                                                wire: {
                                                                                    ...newWiring.specifications.wire,
                                                                                    controlDC: {
                                                                                        ...newWiring.specifications.wire.controlDC,
                                                                                        [`customStandard${index}`]: e.target.value
                                                                                    }
                                                                                }
                                                                            }
                                                                        })}
                                                                        className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                                    />
                                                                )}
                                                            </div>
                                                        </div>
                                                    )
                                                ))}
                                            </div>

                                            {/* P母線・N母線・その他設定（行レイアウト） */}
                                            <div className="space-y-2">
                                                <div>

                                                    <div className="flex gap-2 items-center">
                                                        <div className="custom-select-container flex-1">
                                                            <select
                                                                value={newWiring.specifications.wire.controlDC.pBusColor}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlDC: {
                                                                                ...newWiring.specifications.wire.controlDC,
                                                                                pBusColor: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">線色:P母線</option>
                                                                <option value="黒">黒</option>
                                                                <option value="白">白</option>
                                                                <option value="赤">赤</option>
                                                                <option value="緑">緑</option>
                                                                <option value="黄">黄</option>
                                                                <option value="茶">茶</option>
                                                                <option value="青">青</option>
                                                                <option value="灰">灰</option>
                                                                <option value="橙">橙</option>
                                                                <option value="空色">空色</option>
                                                                <option value="桃">桃</option>
                                                                <option value="若草">若草</option>
                                                                <option value="その他">その他</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                        {newWiring.specifications.wire.controlDC.pBusColor === 'その他' && (
                                                            <input
                                                                type="text"
                                                                placeholder="色を入力"
                                                                value={newWiring.specifications.wire.controlDC.pBusColorCustom || ''}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlDC: {
                                                                                ...newWiring.specifications.wire.controlDC,
                                                                                pBusColorCustom: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                            />
                                                        )}
                                                        <div className="custom-select-container" style={{ width: '100px' }}>
                                                            <select
                                                                value={newWiring.specifications.wire.controlDC.pBusDiameter}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlDC: {
                                                                                ...newWiring.specifications.wire.controlDC,
                                                                                pBusDiameter: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">sq</option>
                                                                <option value="0.5">0.5</option>
                                                                <option value="0.75">0.75</option>
                                                                <option value="1.25">1.25</option>
                                                                <option value="2">2</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div>

                                                    <div className="flex gap-2 items-center">
                                                        <div className="custom-select-container flex-1">
                                                            <select
                                                                value={newWiring.specifications.wire.controlDC.nBusColor}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlDC: {
                                                                                ...newWiring.specifications.wire.controlDC,
                                                                                nBusColor: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">線色:N母線</option>
                                                                <option value="黒">黒</option>
                                                                <option value="白">白</option>
                                                                <option value="赤">赤</option>
                                                                <option value="緑">緑</option>
                                                                <option value="黄">黄</option>
                                                                <option value="茶">茶</option>
                                                                <option value="青">青</option>
                                                                <option value="灰">灰</option>
                                                                <option value="橙">橙</option>
                                                                <option value="空色">空色</option>
                                                                <option value="桃">桃</option>
                                                                <option value="若草">若草</option>
                                                                <option value="その他">その他</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                        {newWiring.specifications.wire.controlDC.nBusColor === 'その他' && (
                                                            <input
                                                                type="text"
                                                                placeholder="色を入力"
                                                                value={newWiring.specifications.wire.controlDC.nBusColorCustom || ''}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlDC: {
                                                                                ...newWiring.specifications.wire.controlDC,
                                                                                nBusColorCustom: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                            />
                                                        )}
                                                        <div className="custom-select-container" style={{ width: '100px' }}>
                                                            <select
                                                                value={newWiring.specifications.wire.controlDC.nBusDiameter}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlDC: {
                                                                                ...newWiring.specifications.wire.controlDC,
                                                                                nBusDiameter: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">sq</option>
                                                                <option value="0.5">0.5</option>
                                                                <option value="0.75">0.75</option>
                                                                <option value="1.25">1.25</option>
                                                                <option value="2">2</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div>

                                                    <div className="flex gap-2 items-center">
                                                        <div className="custom-select-container flex-1">
                                                            <select
                                                                value={newWiring.specifications.wire.controlDC.otherColor}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlDC: {
                                                                                ...newWiring.specifications.wire.controlDC,
                                                                                otherColor: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">線色:母線以外</option>
                                                                <option value="黒">黒</option>
                                                                <option value="白">白</option>
                                                                <option value="赤">赤</option>
                                                                <option value="緑">緑</option>
                                                                <option value="黄">黄</option>
                                                                <option value="茶">茶</option>
                                                                <option value="青">青</option>
                                                                <option value="灰">灰</option>
                                                                <option value="橙">橙</option>
                                                                <option value="空色">空色</option>
                                                                <option value="桃">桃</option>
                                                                <option value="若草">若草</option>
                                                                <option value="その他">その他</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                        {newWiring.specifications.wire.controlDC.otherColor === 'その他' && (
                                                            <input
                                                                type="text"
                                                                placeholder="色を入力"
                                                                value={newWiring.specifications.wire.controlDC.otherColorCustom || ''}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlDC: {
                                                                                ...newWiring.specifications.wire.controlDC,
                                                                                otherColorCustom: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                            />
                                                        )}
                                                        <div className="custom-select-container" style={{ width: '100px' }}>
                                                            <select
                                                                value={newWiring.specifications.wire.controlDC.otherDiameter}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        wire: {
                                                                            ...newWiring.specifications.wire,
                                                                            controlDC: {
                                                                                ...newWiring.specifications.wire.controlDC,
                                                                                otherDiameter: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">sq</option>
                                                                <option value="0.5">0.5</option>
                                                                <option value="0.75">0.75</option>
                                                                <option value="1.25">1.25</option>
                                                                <option value="2">2</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* 備考 */}
                                            <div className="mt-2">

                                                <textarea
                                                    value={newWiring.specifications.wire.controlDC.remarks || ''}
                                                    onChange={(e) => setNewWiring({
                                                        ...newWiring,
                                                        specifications: {
                                                            ...newWiring.specifications,
                                                            wire: {
                                                                ...newWiring.specifications.wire,
                                                                controlDC: {
                                                                    ...newWiring.specifications.wire.controlDC,
                                                                    remarks: e.target.value
                                                                }
                                                            }
                                                        }
                                                    })}
                                                    className="w-full dark-input rounded-xl px-4 py-3 text-xs focus:outline-none"
                                                    rows={2}
                                                    placeholder="備考を入力"
                                                />
                                            </div>
                                        </div>

                                        {/* 特殊仕様 */}
                                        <div className="mb-1.5">
                                            <h5 className="mobile-text-sm font-bold text-white mb-3">特殊仕様</h5>
                                            <textarea
                                                value={newWiring.specifications.wire.specialSpec || ''}
                                                onChange={(e) => setNewWiring({
                                                    ...newWiring,
                                                    specifications: {
                                                        ...newWiring.specifications,
                                                        wire: {
                                                            ...newWiring.specifications.wire,
                                                            specialSpec: e.target.value
                                                        }
                                                    }
                                                })}
                                                className="w-full dark-input rounded-xl px-4 py-3 text-xs"
                                                rows={2}
                                                placeholder="特殊仕様を入力"
                                            />
                                        </div>

                                        {/* メーカー指定（電線） */}
                                        <div>
                                            <h5 className="mobile-text-sm font-bold text-white mb-3">メーカー指定</h5>
                                            <div className="flex items-center gap-6 mb-2">
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input
                                                        type="radio"
                                                        name="wireManufacturer"
                                                        checked={!newWiring.specifications.wire.manufacturerSpecified}
                                                        onChange={() => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                wire: {
                                                                    ...newWiring.specifications.wire,
                                                                    manufacturerSpecified: false,
                                                                    manufacturer: ''
                                                                }
                                                            }
                                                        })}
                                                    />
                                                    <span className="text-gray-300 mobile-text-sm">無し</span>
                                                </label>
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input
                                                        type="radio"
                                                        name="wireManufacturer"
                                                        checked={newWiring.specifications.wire.manufacturerSpecified}
                                                        onChange={() => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                wire: {
                                                                    ...newWiring.specifications.wire,
                                                                    manufacturerSpecified: true
                                                                }
                                                            }
                                                        })}
                                                    />
                                                    <span className="text-gray-300 mobile-text-sm">有り</span>
                                                </label>
                                            </div>
                                            {newWiring.specifications.wire.manufacturerSpecified && (
                                                <input
                                                    type="text"
                                                    placeholder="メーカー名を入力"
                                                    value={newWiring.specifications.wire.manufacturer}
                                                    onChange={(e) => setNewWiring({
                                                        ...newWiring,
                                                        specifications: {
                                                            ...newWiring.specifications,
                                                            wire: {
                                                                ...newWiring.specifications.wire,
                                                                manufacturer: e.target.value
                                                            }
                                                        }
                                                    })}
                                                    className="w-full md:w-1/2 dark-input rounded-xl px-4 py-3 text-xs mb-1.5"
                                                />
                                            )}
                                        </div>
                                    </div>

                                    {/* 圧着端子セクション */}
                                    <div className="glass-card-dark p-3 rounded-xl mb-3" style={{ paddingBottom: '4px' }}>
                                        <h4 className="mobile-text-sm font-bold text-white mb-3">圧着端子</h4>

                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                                            <div>

                                                <div className="custom-select-container">
                                                    <select
                                                        value={newWiring.specifications.terminal.power}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                terminal: {
                                                                    ...newWiring.specifications.terminal,
                                                                    power: e.target.value
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">動力</option>
                                                        <option value="丸端子">丸端子</option>
                                                        <option value="Y端子">Y端子</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>
                                            <div>

                                                <div className="custom-select-container">
                                                    <select
                                                        value={newWiring.specifications.terminal.controlAC}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                terminal: {
                                                                    ...newWiring.specifications.terminal,
                                                                    controlAC: e.target.value
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">制御AC</option>
                                                        <option value="丸端子">丸端子</option>
                                                        <option value="Y端子">Y端子</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>
                                            <div>

                                                <div className="custom-select-container">
                                                    <select
                                                        value={newWiring.specifications.terminal.controlDC}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                terminal: {
                                                                    ...newWiring.specifications.terminal,
                                                                    controlDC: e.target.value
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">制御DC</option>
                                                        <option value="丸端子">丸端子</option>
                                                        <option value="Y端子">Y端子</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                                            <div>

                                                <div className="custom-select-container">
                                                    <select
                                                        value={newWiring.specifications.terminal.simultaneousCrimp}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                terminal: {
                                                                    ...newWiring.specifications.terminal,
                                                                    simultaneousCrimp: e.target.value
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">同時圧着</option>
                                                        <option value="可（全て）">可（全て）</option>
                                                        <option value="可（動力のみ）">可（動力のみ）</option>
                                                        <option value="可（アースのみ）">可（アースのみ）</option>
                                                        <option value="不可">不可</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>
                                            <div>

                                                <div className="custom-select-container">
                                                    <select
                                                        value={newWiring.specifications.terminal.screwClamp}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                terminal: {
                                                                    ...newWiring.specifications.terminal,
                                                                    screwClamp: e.target.value
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">ねじ式クランプ端子台への配線</option>
                                                        <option value="ブレード">ブレード</option>
                                                        <option value="棒">棒</option>
                                                        <option value="フェルール">フェルール</option>
                                                        <option value="裸配線可能">裸配線可能</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>
                                            <div>

                                                <div className="custom-select-container">
                                                    <select
                                                        value={newWiring.specifications.terminal.screwlessClamp}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                terminal: {
                                                                    ...newWiring.specifications.terminal,
                                                                    screwlessClamp: e.target.value
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">スクリューレス端子台への配線</option>
                                                        <option value="ブレード">ブレード</option>
                                                        <option value="棒">棒</option>
                                                        <option value="フェルール">フェルール</option>
                                                        <option value="裸配線可能">裸配線可能</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* 備考 */}
                                        <div className="mb-1.5">

                                            <textarea
                                                value={newWiring.specifications.terminal.remarks || ''}
                                                onChange={(e) => setNewWiring({
                                                    ...newWiring,
                                                    specifications: {
                                                        ...newWiring.specifications,
                                                        terminal: {
                                                            ...newWiring.specifications.terminal,
                                                            remarks: e.target.value
                                                        }
                                                    }
                                                })}
                                                className="w-full dark-input rounded-xl px-4 py-3 text-xs"
                                                rows={2}
                                                placeholder="備考を入力"
                                            />
                                        </div>

                                        {/* メーカー指定（端子） */}
                                        <div className="mt-1.5">
                                            <h5 className="mobile-text-sm font-bold text-white mb-3">メーカー指定</h5>
                                            <div className="flex items-center gap-6 mb-2">
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input
                                                        type="radio"
                                                        name="terminalManufacturer"
                                                        checked={!newWiring.specifications.terminal.manufacturerSpecified}
                                                        onChange={() => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                terminal: {
                                                                    ...newWiring.specifications.terminal,
                                                                    manufacturerSpecified: false,
                                                                    manufacturer: ''
                                                                }
                                                            }
                                                        })}
                                                    />
                                                    <span className="text-gray-300 mobile-text-sm">無し</span>
                                                </label>
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input
                                                        type="radio"
                                                        name="terminalManufacturer"
                                                        checked={newWiring.specifications.terminal.manufacturerSpecified}
                                                        onChange={() => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                terminal: {
                                                                    ...newWiring.specifications.terminal,
                                                                    manufacturerSpecified: true
                                                                }
                                                            }
                                                        })}
                                                    />
                                                    <span className="text-gray-300 mobile-text-sm">有り</span>
                                                </label>
                                            </div>
                                            {newWiring.specifications.terminal.manufacturerSpecified && (
                                                <input
                                                    type="text"
                                                    placeholder="メーカー名を入力"
                                                    value={newWiring.specifications.terminal.manufacturer}
                                                    onChange={(e) => setNewWiring({
                                                        ...newWiring,
                                                        specifications: {
                                                            ...newWiring.specifications,
                                                            terminal: {
                                                                ...newWiring.specifications.terminal,
                                                                manufacturer: e.target.value
                                                            }
                                                        }
                                                    })}
                                                    className="w-full md:w-1/2 dark-input rounded-xl px-4 py-3 text-xs mb-1.5"
                                                />
                                            )}
                                        </div>
                                    </div>

                                    {/* 端子台セクション */}
                                    <div className="glass-card-dark p-3 rounded-xl mb-3" style={{ paddingBottom: '4px' }}>
                                        <h4 className="mobile-text-sm font-bold text-white mb-3">端子台</h4>

                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mb-2">
                                            <div>

                                                <div className="custom-select-container">
                                                    <select
                                                        value={newWiring.specifications.terminalBlock.namePlate}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                terminalBlock: {
                                                                    ...newWiring.specifications.terminalBlock,
                                                                    namePlate: e.target.value
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">記名板</option>
                                                        <option value="有り">有り</option>
                                                        <option value="無し">無し</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>
                                            <div>

                                                <div className="custom-select-container">
                                                    <select
                                                        value={newWiring.specifications.terminalBlock.cover}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                terminalBlock: {
                                                                    ...newWiring.specifications.terminalBlock,
                                                                    cover: e.target.value
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">カバー</option>
                                                        <option value="有り">有り</option>
                                                        <option value="無し">無し</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>
                                            <div>

                                                <div className="flex gap-2 items-center">
                                                    <div className="custom-select-container flex-1">
                                                        <select
                                                            value={newWiring.specifications.terminalBlock.bridge}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    terminalBlock: {
                                                                        ...newWiring.specifications.terminalBlock,
                                                                        bridge: e.target.value
                                                                    }
                                                                }
                                                            })}
                                                            className="custom-select text-xs"
                                                        >
                                                            <option value="">渡り金具</option>
                                                            <option value="使用可（指定無し）">使用可（指定無し）</option>
                                                            <option value="使用可（指定有り）">使用可（指定有り）</option>
                                                            <option value="使用不可">使用不可</option>
                                                        </select>
                                                        <div className="custom-select-arrow"></div>
                                                    </div>
                                                    {newWiring.specifications.terminalBlock.bridge === '使用可（指定有り）' && (
                                                        <input
                                                            type="text"
                                                            placeholder="渡り金具の仕様を入力"
                                                            value={newWiring.specifications.terminalBlock.bridgeSpec || ''}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    terminalBlock: {
                                                                        ...newWiring.specifications.terminalBlock,
                                                                        bridgeSpec: e.target.value
                                                                    }
                                                                }
                                                            })}
                                                            className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                        />
                                                    )}
                                                </div>
                                            </div>
                                            <div>

                                                <div className="custom-select-container">
                                                    <select
                                                        value={newWiring.specifications.terminalBlock.maxWires}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                terminalBlock: {
                                                                    ...newWiring.specifications.terminalBlock,
                                                                    maxWires: e.target.value
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">配線可能数</option>
                                                        <option value="1本まで">1本まで</option>
                                                        <option value="2本まで">2本まで</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* 備考 */}
                                        <div className="mb-1.5">
                                            <textarea
                                                value={newWiring.specifications.terminalBlock.remarks || ''}
                                                onChange={(e) => setNewWiring({
                                                    ...newWiring,
                                                    specifications: {
                                                        ...newWiring.specifications,
                                                        terminalBlock: {
                                                            ...newWiring.specifications.terminalBlock,
                                                            remarks: e.target.value
                                                        }
                                                    }
                                                })}
                                                className="w-full dark-input rounded-xl px-4 py-3 text-xs"
                                                rows={2}
                                                placeholder="備考を入力"
                                            />
                                        </div>

                                        {/* メーカー指定 */}
                                        <div>
                                            <h5 className="mobile-text-sm font-bold text-white mb-3">メーカー指定</h5>
                                            <div className="flex items-center gap-6 mb-2">
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input
                                                        type="radio"
                                                        name="terminalBlockManufacturer"
                                                        checked={!newWiring.specifications.terminalBlock.manufacturerSpecified}
                                                        onChange={() => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                terminalBlock: {
                                                                    ...newWiring.specifications.terminalBlock,
                                                                    manufacturerSpecified: false,
                                                                    manufacturer: ''
                                                                }
                                                            }
                                                        })}
                                                    />
                                                    <span className="text-gray-300 mobile-text-sm">無し</span>
                                                </label>
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input
                                                        type="radio"
                                                        name="terminalBlockManufacturer"
                                                        checked={newWiring.specifications.terminalBlock.manufacturerSpecified}
                                                        onChange={() => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                terminalBlock: {
                                                                    ...newWiring.specifications.terminalBlock,
                                                                    manufacturerSpecified: true
                                                                }
                                                            }
                                                        })}
                                                    />
                                                    <span className="text-gray-300 mobile-text-sm">有り</span>
                                                </label>
                                            </div>
                                            {newWiring.specifications.terminalBlock.manufacturerSpecified && (
                                                <input
                                                    type="text"
                                                    placeholder="メーカー名を入力"
                                                    value={newWiring.specifications.terminalBlock.manufacturer}
                                                    onChange={(e) => setNewWiring({
                                                        ...newWiring,
                                                        specifications: {
                                                            ...newWiring.specifications,
                                                            terminalBlock: {
                                                                ...newWiring.specifications.terminalBlock,
                                                                manufacturer: e.target.value
                                                            }
                                                        }
                                                    })}
                                                    className="w-full md:w-1/2 dark-input rounded-xl px-4 py-3 text-xs mb-1.5"
                                                />
                                            )}
                                        </div>
                                    </div>

                                    {/* 記名板セクション */}
                                    <div className="glass-card-dark p-3 rounded-xl mb-3" style={{ paddingBottom: '4px' }}>
                                        <h4 className="mobile-text-sm font-bold text-white mb-3">記名板</h4>
                                        <div>

                                            <div className="flex gap-2 items-center">
                                                <div className="custom-select-container flex-1">
                                                    <select
                                                        value={newWiring.specifications.namePlate.fontSize}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                namePlate: {
                                                                    ...newWiring.specifications.namePlate,
                                                                    fontSize: e.target.value,
                                                                    customFontSize: e.target.value !== 'その他' ? '' : newWiring.specifications.namePlate.customFontSize
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">文字サイズ</option>
                                                        <option value="2mm半">2mm半</option>
                                                        <option value="2mm全">2mm全</option>
                                                        <option value="3mm半">3mm半</option>
                                                        <option value="3mm全">3mm全</option>
                                                        <option value="4mm半">4mm半</option>
                                                        <option value="4mm全">4mm全</option>
                                                        <option value="5mm半">5mm半</option>
                                                        <option value="5mm全">5mm全</option>
                                                        <option value="その他">その他</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                                {newWiring.specifications.namePlate.fontSize === 'その他' && (
                                                    <input
                                                        type="text"
                                                        placeholder="サイズを入力"
                                                        value={newWiring.specifications.namePlate.customFontSize}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                namePlate: {
                                                                    ...newWiring.specifications.namePlate,
                                                                    customFontSize: e.target.value
                                                                }
                                                            }
                                                        })}
                                                        className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                    />
                                                )}
                                            </div>

                                        </div>
                                        {/* 備考 */}
                                        <div className="mt-2">

                                            <textarea
                                                value={newWiring.specifications.namePlate.remarks || ''}
                                                onChange={(e) => setNewWiring({
                                                    ...newWiring,
                                                    specifications: {
                                                        ...newWiring.specifications,
                                                        namePlate: {
                                                            ...newWiring.specifications.namePlate,
                                                            remarks: e.target.value
                                                        }
                                                    }
                                                })}
                                                className="w-full dark-input rounded-xl px-4 py-3 text-xs"
                                                rows={2}
                                                placeholder="備考を入力"
                                            />
                                        </div>
                                    </div>

                                    {/* デバイスシールセクション */}
                                    <div className="glass-card-dark p-3 rounded-xl mb-3" style={{ paddingBottom: '4px' }}>
                                        <h4 className="mobile-text-sm font-bold text-white mb-3">デバイスシール</h4>

                                        <div className="space-y-2">
                                            <div>

                                                <div className="flex gap-2 items-center">
                                                    <div className="custom-select-container flex-1">
                                                        <select
                                                            value={newWiring.specifications.deviceSeal.fontSize}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    deviceSeal: {
                                                                        ...newWiring.specifications.deviceSeal,
                                                                        fontSize: e.target.value,
                                                                        customFontSize: e.target.value !== 'その他' ? '' : newWiring.specifications.deviceSeal.customFontSize
                                                                    }
                                                                }
                                                            })}
                                                            className="custom-select text-xs"
                                                        >
                                                            <option value="">文字サイズ</option>
                                                            <option value="2mm半">2mm半</option>
                                                            <option value="2mm全">2mm全</option>
                                                            <option value="3mm半">3mm半</option>
                                                            <option value="3mm全">3mm全</option>
                                                            <option value="4mm半">4mm半</option>
                                                            <option value="4mm全">4mm全</option>
                                                            <option value="5mm半">5mm半</option>
                                                            <option value="5mm全">5mm全</option>
                                                            <option value="その他">その他</option>
                                                        </select>
                                                        <div className="custom-select-arrow"></div>
                                                    </div>
                                                    {newWiring.specifications.deviceSeal.fontSize === 'その他' && (
                                                        <input
                                                            type="text"
                                                            placeholder="サイズを入力"
                                                            value={newWiring.specifications.deviceSeal.customFontSize}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    deviceSeal: {
                                                                        ...newWiring.specifications.deviceSeal,
                                                                        customFontSize: e.target.value
                                                                    }
                                                                }
                                                            })}
                                                            className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                        />
                                                    )}
                                                </div>
                                            </div>

                                            <div>

                                                <div className="flex gap-2 items-center">
                                                    <div className="custom-select-container flex-1">
                                                        <select
                                                            value={newWiring.specifications.deviceSeal.length}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    deviceSeal: {
                                                                        ...newWiring.specifications.deviceSeal,
                                                                        length: e.target.value,
                                                                        customLength: e.target.value !== 'その他' ? '' : newWiring.specifications.deviceSeal.customLength
                                                                    }
                                                                }
                                                            })}
                                                            className="custom-select text-xs"
                                                        >
                                                            <option value="">長さ</option>
                                                            <option value="自動">自動</option>
                                                            <option value="10mm">10mm</option>
                                                            <option value="15mm">15mm</option>
                                                            <option value="20mm">20mm</option>
                                                            <option value="25mm">25mm</option>
                                                            <option value="30mm">30mm</option>
                                                            <option value="その他">その他</option>
                                                        </select>
                                                        <div className="custom-select-arrow"></div>
                                                    </div>
                                                    {newWiring.specifications.deviceSeal.length === 'その他' && (
                                                        <input
                                                            type="text"
                                                            placeholder="長さを入力"
                                                            value={newWiring.specifications.deviceSeal.customLength}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    deviceSeal: {
                                                                        ...newWiring.specifications.deviceSeal,
                                                                        customLength: e.target.value
                                                                    }
                                                                }
                                                            })}
                                                            className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                        />
                                                    )}
                                                </div>
                                            </div>

                                            <div>

                                                <div className="flex flex-wrap gap-4 mb-2 text-xs">
                                                    {['板金', 'ダクト蓋', '部品'].map(position => (
                                                        <label key={position} className="flex items-center gap-2 cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                checked={newWiring.specifications.deviceSeal.positions.includes(position)}
                                                                onChange={(e) => {
                                                                    const positions = e.target.checked
                                                                        ? [...newWiring.specifications.deviceSeal.positions, position]
                                                                        : newWiring.specifications.deviceSeal.positions.filter(p => p !== position);
                                                                    setNewWiring({
                                                                        ...newWiring,
                                                                        specifications: {
                                                                            ...newWiring.specifications,
                                                                            deviceSeal: {
                                                                                ...newWiring.specifications.deviceSeal,
                                                                                positions
                                                                            }
                                                                        }
                                                                    });
                                                                }}
                                                            />
                                                            <span className="text-gray-300">{position}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                                <input
                                                    type="text"
                                                    placeholder="その他の位置（任意）"
                                                    value={newWiring.specifications.deviceSeal.customPosition}
                                                    onChange={(e) => setNewWiring({
                                                        ...newWiring,
                                                        specifications: {
                                                            ...newWiring.specifications,
                                                            deviceSeal: {
                                                                ...newWiring.specifications.deviceSeal,
                                                                customPosition: e.target.value
                                                            }
                                                        }
                                                    })}
                                                    className="w-full md:w-1/2 dark-input rounded-xl px-4 py-3 text-xs"
                                                />
                                            </div>
                                            {/* 備考 */}
                                            <div className="mt-2">

                                                <textarea
                                                    value={newWiring.specifications.deviceSeal.remarks || ''}
                                                    onChange={(e) => setNewWiring({
                                                        ...newWiring,
                                                        specifications: {
                                                            ...newWiring.specifications,
                                                            deviceSeal: {
                                                                ...newWiring.specifications.deviceSeal,
                                                                remarks: e.target.value
                                                            }
                                                        }
                                                    })}
                                                    className="w-full dark-input rounded-xl px-4 py-3 text-xs focus:outline-none"
                                                    rows={2}
                                                    placeholder="備考を入力"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* マークチューブセクション */}
                                    <div className="glass-card-dark p-3 rounded-xl mb-3" style={{ paddingBottom: '4px' }}>
                                        <h4 className="mobile-text-sm font-bold text-white mb-3">マークチューブ</h4>

                                        {/* 向き */}
                                        <div className="mb-2">

                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                {[
                                                    { key: 'up', label: '上' },
                                                    { key: 'down', label: '下' },
                                                    { key: 'left', label: '左' },
                                                    { key: 'right', label: '右' }
                                                ].map(direction => (
                                                    <div key={direction.key}>

                                                        <div className="custom-select-container">
                                                            <select
                                                                value={newWiring.specifications.markTube.orientation[direction.key]}
                                                                onChange={(e) => setNewWiring({
                                                                    ...newWiring,
                                                                    specifications: {
                                                                        ...newWiring.specifications,
                                                                        markTube: {
                                                                            ...newWiring.specifications.markTube,
                                                                            orientation: {
                                                                                ...newWiring.specifications.markTube.orientation,
                                                                                [direction.key]: e.target.value
                                                                            }
                                                                        }
                                                                    }
                                                                })}
                                                                className="custom-select text-xs"
                                                            >
                                                                <option value="">向き:{direction.label}</option>
                                                                <option value="正向き">正向き</option>
                                                                <option value="逆向き">逆向き</option>
                                                            </select>
                                                            <div className="custom-select-arrow"></div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        {/* 文字サイズ */}
                                        <div className="mb-2">

                                            <div className="flex gap-2 items-center">
                                                <div className="custom-select-container flex-1">
                                                    <select
                                                        value={newWiring.specifications.markTube.fontSize}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                markTube: {
                                                                    ...newWiring.specifications.markTube,
                                                                    fontSize: e.target.value,
                                                                    customFontSize: e.target.value !== 'その他' ? '' : newWiring.specifications.markTube.customFontSize
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">文字サイズ</option>
                                                        <option value="2mm半">2mm半</option>
                                                        <option value="2mm全">2mm全</option>
                                                        <option value="3mm半">3mm半</option>
                                                        <option value="3mm全">3mm全</option>
                                                        <option value="4mm半">4mm半</option>
                                                        <option value="4mm全">4mm全</option>
                                                        <option value="5mm半">5mm半</option>
                                                        <option value="5mm全">5mm全</option>
                                                        <option value="その他">その他</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                                {newWiring.specifications.markTube.fontSize === 'その他' && (
                                                    <input
                                                        type="text"
                                                        placeholder="サイズを入力"
                                                        value={newWiring.specifications.markTube.customFontSize}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                markTube: {
                                                                    ...newWiring.specifications.markTube,
                                                                    customFontSize: e.target.value
                                                                }
                                                            }
                                                        })}
                                                        className="w-40 md:w-1/2 dark-input rounded-xl px-4 py-3 text-xs"
                                                    />
                                                )}
                                            </div>
                                        </div>

                                        {/* 長さ */}
                                        <div className="mb-2">

                                            <div className="flex gap-2 items-center">
                                                <div className="custom-select-container flex-1">
                                                    <select
                                                        value={newWiring.specifications.markTube.length}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                markTube: {
                                                                    ...newWiring.specifications.markTube,
                                                                    length: e.target.value,
                                                                    customLength: e.target.value !== 'その他' ? '' : newWiring.specifications.markTube.customLength
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">長さ</option>
                                                        <option value="自動">自動</option>
                                                        <option value="10mm">10mm</option>
                                                        <option value="15mm">15mm</option>
                                                        <option value="20mm">20mm</option>
                                                        <option value="25mm">25mm</option>
                                                        <option value="30mm">30mm</option>
                                                        <option value="その他">その他</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                                {newWiring.specifications.markTube.length === 'その他' && (
                                                    <input
                                                        type="text"
                                                        placeholder="長さを入力"
                                                        value={newWiring.specifications.markTube.customLength}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                markTube: {
                                                                    ...newWiring.specifications.markTube,
                                                                    customLength: e.target.value
                                                                }
                                                            }
                                                        })}
                                                        className="w-40 md:w-1/2 dark-input rounded-xl px-4 py-3 text-xs"
                                                    />
                                                )}
                                            </div>
                                        </div>

                                        {/* 印字仕様 */}
                                        <div>

                                            <div className="flex gap-2 items-center">
                                                <div className="custom-select-container flex-1">
                                                    <select
                                                        value={newWiring.specifications.markTube.printSpec}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                markTube: {
                                                                    ...newWiring.specifications.markTube,
                                                                    printSpec: e.target.value,
                                                                    printSpecDetail: e.target.value !== '有り' ? '' : newWiring.specifications.markTube.printSpecDetail
                                                                }
                                                            }
                                                        })}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="">印字仕様</option>
                                                        <option value="無し">無し</option>
                                                        <option value="有り">有り</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                                {newWiring.specifications.markTube.printSpec === '有り' && (
                                                    <input
                                                        type="text"
                                                        placeholder="印字仕様を入力"
                                                        value={newWiring.specifications.markTube.printSpecDetail}
                                                        onChange={(e) => setNewWiring({
                                                            ...newWiring,
                                                            specifications: {
                                                                ...newWiring.specifications,
                                                                markTube: {
                                                                    ...newWiring.specifications.markTube,
                                                                    printSpecDetail: e.target.value
                                                                }
                                                            }
                                                        })}
                                                        className="w-40 md:w-1/2 dark-input rounded-xl px-4 py-3 text-xs"
                                                    />
                                                )}
                                            </div>
                                        </div>
                                        {/* 備考 */}
                                        <div className="mt-2">

                                            <textarea
                                                value={newWiring.specifications.markTube.remarks || ''}
                                                onChange={(e) => setNewWiring({
                                                    ...newWiring,
                                                    specifications: {
                                                        ...newWiring.specifications,
                                                        markTube: {
                                                            ...newWiring.specifications.markTube,
                                                            remarks: e.target.value
                                                        }
                                                    }
                                                })}
                                                className="w-full dark-input rounded-xl px-4 py-3 text-xs"
                                                rows={2}
                                                placeholder="備考を入力"
                                            />
                                        </div>
                                    </div>

                                    {/* その他確認事項セクション */}
                                    <div className="glass-card-dark p-3 rounded-xl mb-3" style={{ paddingBottom: '4px' }}>
                                        <h4 className="mobile-text-sm font-bold text-white mb-3">その他確認事項</h4>

                                        <div className="space-y-2">
                                            {/* 増し締めペン */}
                                            <div>

                                                <div className="flex gap-2 items-center">
                                                    <div className="custom-select-container flex-1">
                                                        <select
                                                            value={newWiring.specifications.otherConfirm.tighteningPen}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    otherConfirm: {
                                                                        ...newWiring.specifications.otherConfirm,
                                                                        tighteningPen: e.target.value,
                                                                        tighteningPenDetail: e.target.value !== '有り' ? '' : newWiring.specifications.otherConfirm.tighteningPenDetail
                                                                    }
                                                                }
                                                            })}
                                                            className="custom-select text-xs"
                                                        >
                                                            <option value="">増し締めペン</option>
                                                            <option value="有り">有り</option>
                                                            <option value="無し">無し</option>
                                                        </select>
                                                        <div className="custom-select-arrow"></div>
                                                    </div>
                                                    {newWiring.specifications.otherConfirm.tighteningPen === '有り' && (
                                                        <input
                                                            type="text"
                                                            placeholder="詳細を入力"
                                                            value={newWiring.specifications.otherConfirm.tighteningPenDetail}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    otherConfirm: {
                                                                        ...newWiring.specifications.otherConfirm,
                                                                        tighteningPenDetail: e.target.value
                                                                    }
                                                                }
                                                            })}
                                                            className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                        />
                                                    )}
                                                </div>
                                            </div>

                                            {/* 合マーク */}
                                            <div>

                                                <div className="flex gap-2 items-center">
                                                    <div className="custom-select-container flex-1">
                                                        <select
                                                            value={newWiring.specifications.otherConfirm.matchMark}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    otherConfirm: {
                                                                        ...newWiring.specifications.otherConfirm,
                                                                        matchMark: e.target.value
                                                                    }
                                                                }
                                                            })}
                                                            className="custom-select text-xs"
                                                        >
                                                            <option value="">合マーク</option>
                                                            <option value="数字">数字</option>
                                                            <option value="ローマ字">ローマ字</option>
                                                            <option value="無し">無し</option>
                                                            <option value="その他">その他</option>  // ← 追加
                                                        </select>
                                                        <div className="custom-select-arrow"></div>
                                                    </div>
                                                    {newWiring.specifications.otherConfirm.matchMark === 'その他' && (
                                                        <input
                                                            type="text"
                                                            placeholder="詳細を入力"
                                                            value={newWiring.specifications.otherConfirm.matchMarkDetail}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    otherConfirm: {
                                                                        ...newWiring.specifications.otherConfirm,
                                                                        matchMarkDetail: e.target.value
                                                                    }
                                                                }
                                                            })}
                                                            className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                        />
                                                    )}
                                                </div>
                                            </div>

                                            {/* ネジ */}
                                            <div>

                                                <div className="flex gap-2 items-center">
                                                    <div className="custom-select-container flex-1">
                                                        <select
                                                            value={newWiring.specifications.otherConfirm.screw}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    otherConfirm: {
                                                                        ...newWiring.specifications.otherConfirm,
                                                                        screw: e.target.value,
                                                                        screwDetail: e.target.value !== 'その他' ? '' : newWiring.specifications.otherConfirm.screwDetail
                                                                    }
                                                                }
                                                            })}
                                                            className="custom-select text-xs"
                                                        >
                                                            <option value="">ネジ</option>
                                                            <option value="三価ホワイト">三価ホワイト</option>
                                                            <option value="ステンレス">ステンレス</option>
                                                            <option value="その他">その他</option>
                                                        </select>
                                                        <div className="custom-select-arrow"></div>
                                                    </div>
                                                    {newWiring.specifications.otherConfirm.screw === 'その他' && (
                                                        <input
                                                            type="text"
                                                            placeholder="ネジの種類を入力"
                                                            value={newWiring.specifications.otherConfirm.screwDetail}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    otherConfirm: {
                                                                        ...newWiring.specifications.otherConfirm,
                                                                        screwDetail: e.target.value
                                                                    }
                                                                }
                                                            })}
                                                            className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                        />
                                                    )}
                                                </div>
                                            </div>

                                            {/* ホックチューブ */}
                                            <div>

                                                <div className="flex gap-2 items-center">
                                                    <div className="custom-select-container flex-1">
                                                        <select
                                                            value={newWiring.specifications.otherConfirm.hookTube}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    otherConfirm: {
                                                                        ...newWiring.specifications.otherConfirm,
                                                                        hookTube: e.target.value
                                                                    }
                                                                }
                                                            })}
                                                            className="custom-select text-xs"
                                                        >
                                                            <option value="">ホックチューブ</option>
                                                            <option value="グレー">グレー</option>
                                                            <option value="黒">黒</option>
                                                            <option value="その他">その他</option>  // ← 追加
                                                        </select>
                                                        <div className="custom-select-arrow"></div>
                                                    </div>
                                                    {newWiring.specifications.otherConfirm.hookTube === 'その他' && (
                                                        <input
                                                            type="text"
                                                            placeholder="色を入力"
                                                            value={newWiring.specifications.otherConfirm.hookTubeDetail}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    otherConfirm: {
                                                                        ...newWiring.specifications.otherConfirm,
                                                                        hookTubeDetail: e.target.value
                                                                    }
                                                                }
                                                            })}
                                                            className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                        />
                                                    )}
                                                </div>
                                            </div>

                                            {/* スパイラルチューブ */}
                                            <div>

                                                <div className="flex gap-2 items-center">
                                                    <div className="custom-select-container flex-1">
                                                        <select
                                                            value={newWiring.specifications.otherConfirm.spiralTube}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    otherConfirm: {
                                                                        ...newWiring.specifications.otherConfirm,
                                                                        spiralTube: e.target.value,
                                                                        spiralTubeDetail: e.target.value !== 'その他' ? '' : newWiring.specifications.otherConfirm.spiralTubeDetail
                                                                    }
                                                                }
                                                            })}
                                                            className="custom-select text-xs"
                                                        >
                                                            <option value="">スパイラルチューブ</option>
                                                            <option value="白">白</option>
                                                            <option value="黒">黒</option>
                                                            <option value="その他">その他</option>
                                                        </select>
                                                        <div className="custom-select-arrow"></div>
                                                    </div>
                                                    {newWiring.specifications.otherConfirm.spiralTube === 'その他' && (
                                                        <input
                                                            type="text"
                                                            placeholder="色を入力"
                                                            value={newWiring.specifications.otherConfirm.spiralTubeDetail}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    otherConfirm: {
                                                                        ...newWiring.specifications.otherConfirm,
                                                                        spiralTubeDetail: e.target.value
                                                                    }
                                                                }
                                                            })}
                                                            className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                        />
                                                    )}
                                                </div>
                                            </div>

                                            {/* インシュロック */}
                                            <div>

                                                <div className="flex gap-2 items-center">
                                                    <div className="custom-select-container flex-1">
                                                        <select
                                                            value={newWiring.specifications.otherConfirm.insulock}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    otherConfirm: {
                                                                        ...newWiring.specifications.otherConfirm,
                                                                        insulock: e.target.value,
                                                                        insulockDetail: e.target.value !== 'その他' ? '' : newWiring.specifications.otherConfirm.insulockDetail
                                                                    }
                                                                }
                                                            })}
                                                            className="custom-select text-xs"
                                                        >
                                                            <option value="">インシュロック</option>
                                                            <option value="白">白</option>
                                                            <option value="黒">黒</option>
                                                            <option value="その他">その他</option>
                                                        </select>
                                                        <div className="custom-select-arrow"></div>
                                                    </div>
                                                    {newWiring.specifications.otherConfirm.insulock === 'その他' && (
                                                        <input
                                                            type="text"
                                                            placeholder="色を入力"
                                                            value={newWiring.specifications.otherConfirm.insulockDetail}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    otherConfirm: {
                                                                        ...newWiring.specifications.otherConfirm,
                                                                        insulockDetail: e.target.value
                                                                    }
                                                                }
                                                            })}
                                                            className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                        />
                                                    )}
                                                </div>
                                            </div>

                                            {/* マウントベース */}
                                            <div>

                                                <div className="flex gap-2 items-center">
                                                    <div className="custom-select-container flex-1">
                                                        <select
                                                            value={newWiring.specifications.otherConfirm.mountBase}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    otherConfirm: {
                                                                        ...newWiring.specifications.otherConfirm,
                                                                        mountBase: e.target.value,
                                                                        mountBaseDetail: e.target.value !== 'その他' ? '' : newWiring.specifications.otherConfirm.mountBaseDetail
                                                                    }
                                                                }
                                                            })}
                                                            className="custom-select text-xs"
                                                        >
                                                            <option value="">マウントベース</option>
                                                            <option value="白">白</option>
                                                            <option value="黒">黒</option>
                                                            <option value="その他">その他</option>
                                                        </select>
                                                        <div className="custom-select-arrow"></div>
                                                    </div>
                                                    {newWiring.specifications.otherConfirm.mountBase === 'その他' && (
                                                        <input
                                                            type="text"
                                                            placeholder="色を入力"
                                                            value={newWiring.specifications.otherConfirm.mountBaseDetail}
                                                            onChange={(e) => setNewWiring({
                                                                ...newWiring,
                                                                specifications: {
                                                                    ...newWiring.specifications,
                                                                    otherConfirm: {
                                                                        ...newWiring.specifications.otherConfirm,
                                                                        mountBaseDetail: e.target.value
                                                                    }
                                                                }
                                                            })}
                                                            className="w-40 dark-input rounded-xl px-4 py-3 text-xs"
                                                        />
                                                    )}
                                                </div>
                                            </div>

                                            {/* 配線ルートに関しての特記事項 */}
                                            <div>

                                                <textarea
                                                    value={newWiring.specifications.otherConfirm.routeSpecialNote || ''}
                                                    onChange={(e) => setNewWiring({
                                                        ...newWiring,
                                                        specifications: {
                                                            ...newWiring.specifications,
                                                            otherConfirm: {
                                                                ...newWiring.specifications.otherConfirm,
                                                                routeSpecialNote: e.target.value
                                                            }
                                                        }
                                                    })}
                                                    className="w-full dark-input rounded-xl px-4 py-3 text-xs focus:outline-none"
                                                    rows={2}
                                                    placeholder="配線ルートに関する特記事項を入力"
                                                />
                                            </div>
                                        </div>
                                        {/* 備考 */}
                                        <div className="mt-0.5">

                                            <textarea
                                                value={newWiring.specifications.otherConfirm.remarks || ''}
                                                onChange={(e) => setNewWiring({
                                                    ...newWiring,
                                                    specifications: {
                                                        ...newWiring.specifications,
                                                        otherConfirm: {
                                                            ...newWiring.specifications.otherConfirm,
                                                            remarks: e.target.value
                                                        }
                                                    }
                                                })}
                                                className="w-full dark-input rounded-xl px-4 py-3 text-xs"
                                                rows={2}
                                                placeholder="備考を入力"
                                            />
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 gap-2 mb-1.5 mt-6">
                                        <button
                                            onClick={saveWiringTemplate}
                                            className="gradient-button text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 text-sm w-full"
                                        >
                                            {editingWiring ? '更新' : '保存'}
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowWiringForm(false);
                                                setEditingWiring(null);
                                                resetWiringForm();
                                            }}
                                            className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                        >
                                            キャンセル
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* プロジェクト管理タブ */}
                        {activeTab === 'tasks' && (
                            <div className="space-y-6 md:space-y-8">
                                <div className="flex flex-row justify-between items-center gap-3 sm:gap-0">
                                    <h2 className="text-lg md:text-2xl font-bold text-white neon-text" style={{ margin: '1px 0' }}>
                                        案件管理
                                    </h2>
                                    {isAdmin && (
                                        <button
                                            onClick={() => setShowNewProjectForm(true)}
                                            className="flex items-center justify-center text-white font-normal transition-all duration-300 gradient-button hover:shadow-lg w-7 h-7 rounded-full flex-shrink-0"
                                        >
                                            ＋
                                        </button>
                                    )}
                                </div>

                                <div className="glass-card mobile-compact-card rounded-2xl">
                                    <div className="space-y-2">
                                        {/* 検索バー */}
                                        <div className="w-full">
                                            <input
                                                type="text"
                                                placeholder="案件名・会社名で検索..."
                                                value={searchQuery}
                                                onChange={(e) => setSearchQuery(e.target.value)}
                                                className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-xs"
                                            />
                                        </div>

                                        {/* 並び替えとステータス（横並び） */}
                                        <div className="flex gap-2">
                                            <div className="flex-1">
                                                <div className="custom-select-container">
                                                    <select
                                                        value={sortOption}
                                                        onChange={(e) => setSortOption(e.target.value)}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="created-desc">作成順（新しい順）</option>
                                                        <option value="created-asc">作成順（古い順）</option>
                                                        <option value="deadline-asc">締切順（近い順）</option>
                                                        <option value="deadline-desc">締切順（遠い順）</option>
                                                        <option value="progress-desc">進捗順（高い順）</option>
                                                        <option value="progress-asc">進捗順（低い順）</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>

                                            <div className="flex-1">
                                                <div className="custom-select-container">
                                                    <select
                                                        value={statusFilter}
                                                        onChange={(e) => setStatusFilter(e.target.value)}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="all">全て ({filteredProjects.length})</option>
                                                        <option value="active">進行中 ({filteredProjects.filter(p => p.status === '進行中').length})</option>
                                                        <option value="completed">完了 ({filteredProjects.filter(p => p.status === '完了').length})</option>
                                                        <option value="favorite">お気に入り ({filteredProjects.filter(p => isFavorite(p.id)).length})</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* 新規プロジェクトフォーム */}
                                {showNewProjectForm && (
                                    <div className="modal-overlay" onClick={() => {
                                        resetNewProjectForm();
                                        setShowNewProjectForm(false);
                                    }}>
                                        <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-2xl mx-4" onClick={(e) => e.stopPropagation()}>
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-base font-bold text-white pt-2">新規案件作成</h3>
                                            </div>

                                            <div className="grid grid-cols-1 gap-3 mb-3">
                                                <input
                                                    type="text"
                                                    placeholder="案件名"
                                                    value={newProject.name}
                                                    onChange={(e) => setNewProject({ ...newProject, name: e.target.value })}
                                                    className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                                />
                                                {companyInputMode === 'select' ? (
                                                    <div className="custom-select-container">
                                                        <select
                                                            value={newProject.company}
                                                            onChange={(e) => {
                                                                if (e.target.value === '__manual__') {
                                                                    setCompanyInputMode('manual');
                                                                    setNewProject({ ...newProject, company: '' });
                                                                } else {
                                                                    setNewProject({ ...newProject, company: e.target.value });
                                                                }
                                                            }}
                                                            className="custom-select text-sm"
                                                        >
                                                            <option value="">会社を選択...</option>
                                                            {companies.map(company => (
                                                                <option key={company.id} value={company.name}>
                                                                    {company.name}
                                                                </option>
                                                            ))}
                                                        </select>
                                                        <div className="custom-select-arrow"></div>
                                                    </div>
                                                ) : (
                                                    <input
                                                        type="text"
                                                        placeholder="会社名を入力"
                                                        value={newProject.company}
                                                        onChange={(e) => {
                                                            setNewProject({ ...newProject, company: e.target.value });
                                                            if (e.target.value === '') {
                                                                setCompanyInputMode('select');
                                                            }
                                                        }}
                                                        className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                                    />
                                                )}
                                            </div>

                                            {/* 日付と金額の入力欄 - モバイル対応版 */}
                                            <div className="grid grid-cols-1 gap-3 mb-3">
                                                {/* 開始日 */}
                                                <div className="relative w-full">
                                                    <input
                                                        type="date"
                                                        value={newProject.startDate}
                                                        onChange={(e) =>
                                                            setNewProject({ ...newProject, startDate: e.target.value })
                                                        }
                                                        className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm w-full"
                                                        style={{
                                                            WebkitAppearance: 'none',
                                                            MozAppearance: 'none',
                                                            appearance: 'none',
                                                            minHeight: '44px'
                                                        }}
                                                    />
                                                    {!newProject.startDate && (
                                                        <span
                                                            className="absolute inset-y-0 left-4 flex items-center text-sm pointer-events-none"
                                                            style={{ color: 'rgba(255, 255, 255, 0.5)' }}
                                                        >
                                                            開始日
                                                        </span>
                                                    )}
                                                    {newProject.startDate && (
                                                        <button
                                                            type="button"
                                                            onClick={() => setNewProject({ ...newProject, startDate: '' })}
                                                            className="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white text-lg"
                                                            title="日付をクリア"
                                                        >
                                                            ✕
                                                        </button>
                                                    )}
                                                </div>

                                                {/* 締切日 */}
                                                <div className="relative w-full">
                                                    <input
                                                        type="date"
                                                        value={newProject.deadline}
                                                        onChange={(e) =>
                                                            setNewProject({ ...newProject, deadline: e.target.value })
                                                        }
                                                        className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm w-full"
                                                        style={{
                                                            WebkitAppearance: 'none',
                                                            MozAppearance: 'none',
                                                            appearance: 'none',
                                                            minHeight: '44px'
                                                        }}
                                                    />
                                                    {!newProject.deadline && (
                                                        <span
                                                            className="absolute inset-y-0 left-4 flex items-center text-sm pointer-events-none"
                                                            style={{ color: 'rgba(255, 255, 255, 0.5)' }}
                                                        >
                                                            締切日
                                                        </span>

                                                    )}
                                                    {newProject.deadline && (
                                                        <button
                                                            type="button"
                                                            onClick={() => setNewProject({ ...newProject, deadline: '' })}
                                                            className="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white text-lg"
                                                            title="日付をクリア"
                                                        >
                                                            ✕
                                                        </button>
                                                    )}
                                                </div>

                                                {/* 労務費 */}
                                                <div className="number-input-container">
                                                    <input
                                                        type="number"
                                                        inputMode="numeric"
                                                        pattern="[0-9]*"
                                                        placeholder="労務費（円）"
                                                        value={newProject.laborCost || ''}
                                                        onChange={(e) => {
                                                            const laborCost = e.target.value;
                                                            const materialCost = parseFloat(newProject.materialCost) || 0;
                                                            const totalAmount = (parseFloat(laborCost) || 0) + materialCost;
                                                            setNewProject({
                                                                ...newProject,
                                                                laborCost: laborCost,
                                                                amount: totalAmount.toString()
                                                            });
                                                        }}
                                                        className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm w-full"
                                                        step="1000"
                                                        style={{ minHeight: '44px' }}
                                                    />
                                                    <div className="custom-spin-buttons">
                                                        <button
                                                            type="button"
                                                            className="spin-button spin-button-up"
                                                            onClick={() => {
                                                                const currentValue = parseFloat(newProject.laborCost) || 0;
                                                                const materialCost = parseFloat(newProject.materialCost) || 0;
                                                                const newLaborCost = currentValue + 1000;
                                                                const totalAmount = newLaborCost + materialCost;
                                                                setNewProject({
                                                                    ...newProject,
                                                                    laborCost: newLaborCost.toString(),
                                                                    amount: totalAmount.toString()
                                                                });
                                                            }}
                                                        />
                                                        <button
                                                            type="button"
                                                            className="spin-button spin-button-down"
                                                            onClick={() => {
                                                                const currentValue = parseFloat(newProject.laborCost) || 0;
                                                                const materialCost = parseFloat(newProject.materialCost) || 0;
                                                                const newLaborCost = Math.max(0, currentValue - 1000);
                                                                const totalAmount = newLaborCost + materialCost;
                                                                setNewProject({
                                                                    ...newProject,
                                                                    laborCost: newLaborCost.toString(),
                                                                    amount: totalAmount.toString()
                                                                });
                                                            }}
                                                        />
                                                    </div>
                                                </div>

                                                {/* 資材費 */}
                                                <div className="number-input-container">
                                                    <input
                                                        type="number"
                                                        inputMode="numeric"
                                                        pattern="[0-9]*"
                                                        placeholder="資材費（円）"
                                                        value={newProject.materialCost || ''}
                                                        onChange={(e) => {
                                                            const materialCost = e.target.value;
                                                            const laborCost = parseFloat(newProject.laborCost) || 0;
                                                            const totalAmount = laborCost + (parseFloat(materialCost) || 0);
                                                            setNewProject({
                                                                ...newProject,
                                                                materialCost: materialCost,
                                                                amount: totalAmount.toString()
                                                            });
                                                        }}
                                                        className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm w-full"
                                                        step="1000"
                                                        style={{ minHeight: '44px' }}
                                                    />
                                                    <div className="custom-spin-buttons">
                                                        <button
                                                            type="button"
                                                            className="spin-button spin-button-up"
                                                            onClick={() => {
                                                                const currentValue = parseFloat(newProject.materialCost) || 0;
                                                                const laborCost = parseFloat(newProject.laborCost) || 0;
                                                                const newMaterialCost = currentValue + 1000;
                                                                const totalAmount = laborCost + newMaterialCost;
                                                                setNewProject({
                                                                    ...newProject,
                                                                    materialCost: newMaterialCost.toString(),
                                                                    amount: totalAmount.toString()
                                                                });
                                                            }}
                                                        />
                                                        <button
                                                            type="button"
                                                            className="spin-button spin-button-down"
                                                            onClick={() => {
                                                                const currentValue = parseFloat(newProject.materialCost) || 0;
                                                                const laborCost = parseFloat(newProject.laborCost) || 0;
                                                                const newMaterialCost = Math.max(0, currentValue - 1000);
                                                                const totalAmount = laborCost + newMaterialCost;
                                                                setNewProject({
                                                                    ...newProject,
                                                                    materialCost: newMaterialCost.toString(),
                                                                    amount: totalAmount.toString()
                                                                });
                                                            }}
                                                        />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* タスクテンプレート選択 */}
                                            <div className="mb-3">
                                                <div className="custom-select-container">
                                                    <select
                                                        value={selectedTemplate ? selectedTemplate.id : ''}
                                                        onChange={(e) => {
                                                            const template = taskTemplates.find(t => t.id === e.target.value);
                                                            setSelectedTemplate(template || null);
                                                        }}
                                                        className="custom-select text-sm"
                                                    >
                                                        <option value="">工程テンプレートを選択（任意）...</option>
                                                        {(() => {
                                                            if (!newProject.company) {
                                                                return <option disabled>会社を選択してください</option>;
                                                            }

                                                            const company = companies.find(c => c.name === newProject.company);
                                                            if (!company) {
                                                                return <option disabled>選択された会社にテンプレートがありません</option>;
                                                            }

                                                            const availableTemplates = taskTemplates.filter(template => template.companyId === company.id);

                                                            if (availableTemplates.length === 0) {
                                                                return <option disabled>この会社のテンプレートがありません</option>;
                                                            }

                                                            return availableTemplates.map(template => (
                                                                <option key={template.id} value={template.id}>
                                                                    {template.name} （{template.tasks.length}工程 / {
                                                                        template.tasks.reduce((sum, t) => sum + (parseFloat(t.estimatedHours) || 0), 0)
                                                                    }時間）
                                                                </option>
                                                            ));
                                                        })()}
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>

                                            {/* 配線仕様テンプレート選択 */}
                                            <div className="mb-3">
                                                <div className="custom-select-container">
                                                    <select
                                                        value={newProject.wiringTemplateId || ''}
                                                        onChange={(e) => setNewProject({ ...newProject, wiringTemplateId: e.target.value })}
                                                        className="custom-select text-sm"
                                                    >
                                                        <option value="">配線仕様テンプレートを選択（任意）...</option>
                                                        {(() => {
                                                            if (!newProject.company) {
                                                                return <option disabled>会社を選択してください</option>;
                                                            }

                                                            const company = companies.find(c => c.name === newProject.company);
                                                            if (!company) {
                                                                return <option disabled>選択された会社にテンプレートがありません</option>;
                                                            }

                                                            const availableWirings = wiringTemplates.filter(template => template.companyId === company.id);

                                                            if (availableWirings.length === 0) {
                                                                return <option disabled>この会社のテンプレートがありません</option>;
                                                            }

                                                            return availableWirings.map(template => (
                                                                <option key={template.id} value={template.id}>
                                                                    {template.name}
                                                                </option>
                                                            ));
                                                        })()}
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>

                                            <textarea
                                                placeholder="案件説明"
                                                value={newProject.description}
                                                onChange={(e) => setNewProject({ ...newProject, description: e.target.value })}
                                                className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none mb-2 text-sm"
                                                rows={3}
                                            />

                                            <div className="grid grid-cols-1 gap-2 mb-1.5 mt-2.5">
                                                <button
                                                    onClick={createProject}
                                                    className="gradient-button text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 text-sm w-full"
                                                >
                                                    作成
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        resetNewProjectForm(); // 追加
                                                        setShowNewProjectForm(false);
                                                    }}
                                                    className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                                >
                                                    キャンセル
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* 新規タスクフォーム */}
                                {showNewTaskForm && (
                                    <div className="modal-overlay" onClick={() => setShowNewTaskForm(false)}>
                                        <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-xl mx-4" onClick={(e) => e.stopPropagation()}>
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-base font-bold text-white pt-2">新規工程作成</h3>
                                            </div>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                                <input
                                                    type="text"
                                                    placeholder="工程名"
                                                    value={newTask.title}
                                                    onChange={(e) => setNewTask({ ...newTask, title: e.target.value })}
                                                    className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                                />
                                                <div className="number-input-container">
                                                    <input
                                                        type="number"
                                                        inputMode="decimal"
                                                        pattern="[0-9]*[.,]?[0-9]*"
                                                        placeholder="予想工数（時間）"
                                                        value={newTask.estimatedHours}
                                                        onChange={(e) => setNewTask({ ...newTask, estimatedHours: e.target.value })}
                                                        className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                                        step="0.5"
                                                    />
                                                    <div className="custom-spin-buttons">
                                                        <button
                                                            type="button"
                                                            className="spin-button spin-button-up"
                                                            onClick={() => {
                                                                const currentValue = parseFloat(newTask.estimatedHours) || 0;
                                                                setNewTask({ ...newTask, estimatedHours: (currentValue + 0.5).toString() });
                                                            }}
                                                        />
                                                        <button
                                                            type="button"
                                                            className="spin-button spin-button-down"
                                                            onClick={() => {
                                                                const currentValue = parseFloat(newTask.estimatedHours) || 0;
                                                                setNewTask({ ...newTask, estimatedHours: Math.max(0, currentValue - 0.5).toString() });
                                                            }}
                                                        />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* チェックリストテンプレート選択 */}
                                            <div className="mb-3">
                                                <div className="custom-select-container">
                                                    <select
                                                        value={newTask.checklistTemplateId || ''}
                                                        onChange={(e) => setNewTask({ ...newTask, checklistTemplateId: e.target.value })}
                                                        className="custom-select text-sm"
                                                    >
                                                        <option value="">検査リストテンプレートを選択（任意）...</option>
                                                        {(() => {
                                                            if (!newTask.projectId) {
                                                                return <option disabled>案件を選択してください</option>;
                                                            }

                                                            const project = projects.find(p => String(p.id) === String(newTask.projectId));
                                                            if (!project) {
                                                                return <option disabled>案件が見つかりません</option>;
                                                            }

                                                            const company = companies.find(c => c.name === project.company);
                                                            if (!company) {
                                                                return <option disabled>会社情報が見つかりません</option>;
                                                            }

                                                            const availableChecklists = checklistTemplates.filter(t => t.companyId === company.id);

                                                            if (availableChecklists.length === 0) {
                                                                return <option disabled>この会社の検査リストテンプレートがありません</option>;
                                                            }

                                                            return availableChecklists.map(template => (
                                                                <option key={template.id} value={template.id}>
                                                                    {template.name}
                                                                </option>
                                                            ));
                                                        })()}
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>

                                            <textarea
                                                placeholder="工程説明"
                                                value={newTask.description}
                                                onChange={(e) => setNewTask({ ...newTask, description: e.target.value })}
                                                className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none mb-2 text-sm"
                                                rows={3}
                                            />
                                            <div className="grid grid-cols-1 gap-2 mb-1.5 mt-2.5">
                                                <button
                                                    onClick={createTask}
                                                    className="gradient-button text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 text-sm w-full"
                                                >
                                                    作成
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        resetNewTaskForm(); // 追加
                                                        setShowNewTaskForm(false);
                                                    }}
                                                    className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                                >
                                                    キャンセル
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* プロジェクト編集フォーム */}
                                {showEditProjectForm && editProject && (
                                    <div className="modal-overlay" onClick={() => setShowEditProjectForm(false)}>
                                        <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-2xl mx-4" onClick={(e) => e.stopPropagation()}>
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-base font-bold text-white pt-2">案件編集</h3>
                                            </div>

                                            {/* プロジェクト名と会社名 */}
                                            <div className="grid grid-cols-1 gap-3 mb-3">
                                                <input
                                                    type="text"
                                                    placeholder="案件名"
                                                    value={editProject.name}
                                                    onChange={(e) => setEditProject({ ...editProject, name: e.target.value })}
                                                    className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                                />
                                                {companyInputMode === 'select' ? (
                                                    <div className="custom-select-container">
                                                        <select
                                                            value={editProject.company || ''}
                                                            onChange={(e) => {
                                                                if (e.target.value === '__manual__') {
                                                                    setCompanyInputMode('manual');
                                                                } else {
                                                                    setEditProject({ ...editProject, company: e.target.value });
                                                                }
                                                            }}
                                                            className="custom-select text-sm"
                                                        >
                                                            <option value="">会社を選択...</option>
                                                            {companies.map(company => (
                                                                <option key={company.id} value={company.name}>
                                                                    {company.name}
                                                                </option>
                                                            ))}
                                                        </select>
                                                        <div className="custom-select-arrow"></div>
                                                    </div>
                                                ) : (
                                                    <input
                                                        type="text"
                                                        placeholder="会社名を入力"
                                                        value={editProject.company || ''}
                                                        onChange={(e) => {
                                                            setEditProject({ ...editProject, company: e.target.value });
                                                            if (e.target.value === '') {
                                                                setCompanyInputMode('select');
                                                            }
                                                        }}
                                                        className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                                    />
                                                )}
                                            </div>

                                            {/* 日付と金額の入力欄 - モバイル対応版 */}
                                            <div className="grid grid-cols-1 gap-3 mb-3">
                                                {/* 開始日 */}
                                                <div className="relative w-full">
                                                    <input
                                                        type="date"
                                                        value={editProject.startDate}
                                                        onChange={(e) =>
                                                            setEditProject({ ...editProject, startDate: e.target.value })
                                                        }
                                                        className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm w-full"
                                                        style={{
                                                            WebkitAppearance: 'none',
                                                            MozAppearance: 'none',
                                                            appearance: 'none',
                                                            minHeight: '44px'
                                                        }}
                                                    />
                                                    {!editProject.startDate && (
                                                        <span
                                                            className="absolute inset-y-0 left-4 flex items-center text-sm pointer-events-none"
                                                            style={{ color: 'rgba(255, 255, 255, 0.5)' }}
                                                        >
                                                            開始日
                                                        </span>

                                                    )}
                                                    {editProject.startDate && (
                                                        <button
                                                            type="button"
                                                            onClick={() => setEditProject({ ...editProject, startDate: '' })}
                                                            className="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white text-lg"
                                                            title="日付をクリア"
                                                        >
                                                            ✕
                                                        </button>
                                                    )}
                                                </div>

                                                {/* 締切日 */}
                                                <div className="relative w-full">
                                                    <input
                                                        type="date"
                                                        value={editProject.deadline}
                                                        onChange={(e) =>
                                                            setEditProject({ ...editProject, deadline: e.target.value })
                                                        }
                                                        className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm w-full"
                                                        style={{
                                                            WebkitAppearance: 'none',
                                                            MozAppearance: 'none',
                                                            appearance: 'none',
                                                            minHeight: '44px'
                                                        }}
                                                    />
                                                    {!editProject.deadline && (
                                                        <span
                                                            className="absolute inset-y-0 left-4 flex items-center text-sm pointer-events-none"
                                                            style={{ color: 'rgba(255, 255, 255, 0.5)' }}
                                                        >
                                                            締切日
                                                        </span>

                                                    )}
                                                    {editProject.deadline && (
                                                        <button
                                                            type="button"
                                                            onClick={() => setEditProject({ ...editProject, deadline: '' })}
                                                            className="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white text-lg"
                                                            title="日付をクリア"
                                                        >
                                                            ✕
                                                        </button>
                                                    )}
                                                </div>

                                                {/* 労務費 */}
                                                <div className="number-input-container">
                                                    <input
                                                        type="number"
                                                        inputMode="numeric"
                                                        pattern="[0-9]*"
                                                        placeholder="労務費（円）"
                                                        value={editProject.laborCost || ''}
                                                        onChange={(e) => {
                                                            const laborCost = e.target.value;
                                                            const materialCost = parseFloat(editProject.materialCost) || 0;
                                                            const totalAmount = (parseFloat(laborCost) || 0) + materialCost;
                                                            setEditProject({
                                                                ...editProject,
                                                                laborCost: laborCost,
                                                                amount: totalAmount.toString()
                                                            });
                                                        }}
                                                        className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm w-full"
                                                        step="1000"
                                                        style={{ minHeight: '44px' }}
                                                    />
                                                    <div className="custom-spin-buttons">
                                                        <button
                                                            type="button"
                                                            className="spin-button spin-button-up"
                                                            onClick={() => {
                                                                const currentValue = parseFloat(editProject.laborCost) || 0;
                                                                const materialCost = parseFloat(editProject.materialCost) || 0;
                                                                const newLaborCost = currentValue + 1000;
                                                                const totalAmount = newLaborCost + materialCost;
                                                                setEditProject({
                                                                    ...editProject,
                                                                    laborCost: newLaborCost.toString(),
                                                                    amount: totalAmount.toString()
                                                                });
                                                            }}
                                                        />
                                                        <button
                                                            type="button"
                                                            className="spin-button spin-button-down"
                                                            onClick={() => {
                                                                const currentValue = parseFloat(editProject.laborCost) || 0;
                                                                const materialCost = parseFloat(editProject.materialCost) || 0;
                                                                const newLaborCost = Math.max(0, currentValue - 1000);
                                                                const totalAmount = newLaborCost + materialCost;
                                                                setEditProject({
                                                                    ...editProject,
                                                                    laborCost: newLaborCost.toString(),
                                                                    amount: totalAmount.toString()
                                                                });
                                                            }}
                                                        />
                                                    </div>
                                                </div>

                                                {/* 資材費 */}
                                                <div className="number-input-container">
                                                    <input
                                                        type="number"
                                                        inputMode="numeric"
                                                        pattern="[0-9]*"
                                                        placeholder="資材費（円）"
                                                        value={editProject.materialCost || ''}
                                                        onChange={(e) => {
                                                            const materialCost = e.target.value;
                                                            const laborCost = parseFloat(editProject.laborCost) || 0;
                                                            const totalAmount = laborCost + (parseFloat(materialCost) || 0);
                                                            setEditProject({
                                                                ...editProject,
                                                                materialCost: materialCost,
                                                                amount: totalAmount.toString()
                                                            });
                                                        }}
                                                        className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm w-full"
                                                        step="1000"
                                                        style={{ minHeight: '44px' }}
                                                    />
                                                    <div className="custom-spin-buttons">
                                                        <button
                                                            type="button"
                                                            className="spin-button spin-button-up"
                                                            onClick={() => {
                                                                const currentValue = parseFloat(editProject.materialCost) || 0;
                                                                const laborCost = parseFloat(editProject.laborCost) || 0;
                                                                const newMaterialCost = currentValue + 1000;
                                                                const totalAmount = laborCost + newMaterialCost;
                                                                setEditProject({
                                                                    ...editProject,
                                                                    materialCost: newMaterialCost.toString(),
                                                                    amount: totalAmount.toString()
                                                                });
                                                            }}
                                                        />
                                                        <button
                                                            type="button"
                                                            className="spin-button spin-button-down"
                                                            onClick={() => {
                                                                const currentValue = parseFloat(editProject.materialCost) || 0;
                                                                const laborCost = parseFloat(editProject.laborCost) || 0;
                                                                const newMaterialCost = Math.max(0, currentValue - 1000);
                                                                const totalAmount = laborCost + newMaterialCost;
                                                                setEditProject({
                                                                    ...editProject,
                                                                    materialCost: newMaterialCost.toString(),
                                                                    amount: totalAmount.toString()
                                                                });
                                                            }}
                                                        />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* タスクテンプレート選択 */}
                                            <div className="mb-3">
                                                <div className="custom-select-container">
                                                    <select
                                                        value={selectedTemplate ? selectedTemplate.id : ''}
                                                        onChange={(e) => {
                                                            const template = taskTemplates.find(t => t.id === e.target.value);
                                                            setSelectedTemplate(template || null);
                                                        }}
                                                        className="custom-select text-sm"
                                                    >
                                                        <option value="">工程テンプレートを選択（任意）...</option>
                                                        {(() => {
                                                            if (!editProject.company) {
                                                                return <option disabled>会社を選択してください</option>;
                                                            }
                                                            const company = companies.find(c => c.name === editProject.company);
                                                            if (!company) {
                                                                return <option disabled>選択された会社にテンプレートがありません</option>;
                                                            }
                                                            const availableTemplates = taskTemplates.filter(template => template.companyId === company.id);
                                                            if (availableTemplates.length === 0) {
                                                                return <option disabled>この会社のテンプレートがありません</option>;
                                                            }
                                                            return availableTemplates.map(template => (
                                                                <option key={template.id} value={template.id}>
                                                                    {template.name} （{template.tasks.length}工程 / {
                                                                        template.tasks.reduce((sum, t) => sum + (parseFloat(t.estimatedHours) || 0), 0)
                                                                    }時間）
                                                                </option>
                                                            ));
                                                        })()}
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>

                                            {/* 配線仕様テンプレート選択 */}
                                            <div className="mb-3">
                                                <div className="custom-select-container">
                                                    <select
                                                        value={editProject.wiringTemplateId || ''}
                                                        onChange={(e) => setEditProject({ ...editProject, wiringTemplateId: e.target.value })}
                                                        className="custom-select text-sm"
                                                    >
                                                        <option value="">配線仕様テンプレートを選択（任意）...</option>
                                                        {(() => {
                                                            if (!editProject.company) {
                                                                return <option disabled>会社を選択してください</option>;
                                                            }
                                                            const company = companies.find(c => c.name === editProject.company);
                                                            if (!company) {
                                                                return <option disabled>選択された会社にテンプレートがありません</option>;
                                                            }
                                                            const availableWirings = wiringTemplates.filter(template => template.companyId === company.id);
                                                            if (availableWirings.length === 0) {
                                                                return <option disabled>この会社のテンプレートがありません</option>;
                                                            }
                                                            return availableWirings.map(template => (
                                                                <option key={template.id} value={template.id}>
                                                                    {template.name}
                                                                </option>
                                                            ));
                                                        })()}
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>

                                            <textarea
                                                placeholder="案件説明"
                                                value={editProject.description}
                                                onChange={(e) => setEditProject({ ...editProject, description: e.target.value })}
                                                className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none mb-2 text-sm"
                                                rows={3}
                                            />

                                            <div className="grid grid-cols-1 gap-2 mb-1.5 mt-2.5">
                                                <button
                                                    onClick={updateProject}
                                                    className="gradient-button text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 text-sm w-full"
                                                >
                                                    更新
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        setShowEditProjectForm(false);
                                                        setCompanyInputMode('select');
                                                    }}
                                                    className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                                >
                                                    キャンセル
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* タスク編集フォーム */}
                                {showEditTaskForm && editTask && (
                                    <div className="modal-overlay" onClick={() => setShowEditTaskForm(false)}>
                                        <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-xl mx-4" onClick={(e) => e.stopPropagation()}>
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-base font-bold text-white pt-2">工程編集</h3>
                                            </div>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                                <input
                                                    type="text"
                                                    placeholder="工程名"
                                                    value={editTask.title}
                                                    onChange={(e) => setEditTask({ ...editTask, title: e.target.value })}
                                                    className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                                />
                                                <div className="number-input-container">
                                                    <input
                                                        type="number"
                                                        inputMode="decimal"
                                                        pattern="[0-9]*[.,]?[0-9]*"
                                                        placeholder="予想工数（時間）"
                                                        value={editTask.estimatedHours}
                                                        onChange={(e) => setEditTask({ ...editTask, estimatedHours: e.target.value })}
                                                        className="dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                                        step="0.5"
                                                    />
                                                    <div className="custom-spin-buttons">
                                                        <button
                                                            type="button"
                                                            className="spin-button spin-button-up"
                                                            onClick={() => {
                                                                const currentValue = parseFloat(editTask.estimatedHours) || 0;
                                                                setEditTask({ ...editTask, estimatedHours: (currentValue + 0.5).toString() });
                                                            }}
                                                        />
                                                        <button
                                                            type="button"
                                                            className="spin-button spin-button-down"
                                                            onClick={() => {
                                                                const currentValue = parseFloat(editTask.estimatedHours) || 0;
                                                                setEditTask({ ...editTask, estimatedHours: Math.max(0, currentValue - 0.5).toString() });
                                                            }}
                                                        />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* チェックリストテンプレート選択 */}
                                            <div className="mb-3">
                                                <div className="custom-select-container">
                                                    <select
                                                        value={editTask.checklistTemplateId || ''}
                                                        onChange={(e) => setEditTask({ ...editTask, checklistTemplateId: e.target.value })}
                                                        className="custom-select text-sm"
                                                    >
                                                        <option value="">検査リストテンプレートを選択（任意）...</option>
                                                        {(() => {
                                                            const project = projects.find(p => String(p.id) === String(editTask.projectId));
                                                            if (!project) {
                                                                return <option disabled>案件が見つかりません</option>;
                                                            }

                                                            const company = companies.find(c => c.name === project.company);
                                                            if (!company) {
                                                                return <option disabled>会社情報が見つかりません</option>;
                                                            }

                                                            const availableChecklists = checklistTemplates.filter(t => t.companyId === company.id);

                                                            if (availableChecklists.length === 0) {
                                                                return <option disabled>この会社の検査リストテンプレートがありません</option>;
                                                            }

                                                            return availableChecklists.map(template => (
                                                                <option key={template.id} value={template.id}>
                                                                    {template.name}
                                                                </option>
                                                            ));
                                                        })()}
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>

                                            <textarea
                                                placeholder="工程説明"
                                                value={editTask.description}
                                                onChange={(e) => setEditTask({ ...editTask, description: e.target.value })}
                                                className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none mb-2 text-sm"
                                                rows={3}
                                            />
                                            <div className="grid grid-cols-1 gap-2 mb-1.5 mt-2.5">
                                                <button
                                                    onClick={updateTask}
                                                    className="gradient-button text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 text-sm w-full"
                                                >
                                                    更新
                                                </button>
                                                <button
                                                    onClick={() => setShowEditTaskForm(false)}
                                                    className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                                >
                                                    キャンセル
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* 工数詳細モーダル */}
                                {showHoursDetail && detailTaskId && (
                                    <div className="modal-overlay" onClick={() => setShowHoursDetail(false)}>
                                        <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-3xl mx-4" onClick={(e) => e.stopPropagation()}>
                                            <div className="mb-4">
                                                <h3 className="text-base font-bold text-white pt-2">工程詳細</h3>
                                            </div>
                                            {(() => {
                                                const task = tasks.find(t => t.id === detailTaskId);
                                                const taskSessions = workSessions.filter(s => s.taskId === detailTaskId);

                                                // ユーザーごとに工数を集計
                                                const userHoursMap = {};
                                                taskSessions.forEach(session => {
                                                    const userId = session.userId;
                                                    if (!userHoursMap[userId]) {
                                                        userHoursMap[userId] = {
                                                            userId: userId,
                                                            userName: session.userName,
                                                            totalHours: 0,
                                                            sessions: []
                                                        };
                                                    }
                                                    userHoursMap[userId].totalHours += (session.hours || session.totalHours || 0);
                                                    userHoursMap[userId].sessions.push(session);
                                                });

                                                // ユーザー配列に変換し、工数の多い順にソート
                                                const userHoursList = Object.values(userHoursMap).sort((a, b) => b.totalHours - a.totalHours);
                                                const totalHours = userHoursList.reduce((sum, user) => sum + user.totalHours, 0);

                                                return (
                                                    <div>
                                                        <div className="mb-4">
                                                            <h4 className="mobile-text-sm font-bold text-white mb-2">{task?.title}</h4>
                                                            <div className="grid grid-cols-2 gap-2">
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">総実績工数</div>
                                                                    <div className="font-bold text-white mobile-text-sm">{totalHours.toFixed(1)}h</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">予想工数</div>
                                                                    <div className="font-bold text-white mobile-text-sm">{task?.estimatedHours || 0}h</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">参加者数</div>
                                                                    <div className="font-bold text-white mobile-text-sm">{userHoursList.length}人</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">作業日数</div>
                                                                    <div className="font-bold text-white mobile-text-sm">
                                                                        {new Set(taskSessions.map(s => s.date ? s.date.toDate().toDateString() : '')).size}日
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div className="space-y-3">
                                                            <h5 className="font-bold text-white mobile-text-sm">ユーザー別工数</h5>
                                                            {userHoursList.length > 0 ? (
                                                                userHoursList.map((userItem, index) => (
                                                                    <div key={userItem.userId} className="glass-card-dark mobile-compact-card rounded-xl">
                                                                        <div className="flex justify-between items-start mb-3">
                                                                            <div className="flex items-center gap-2">
                                                                                <div
                                                                                    className="user-icon user-icon-small"
                                                                                    style={{ background: getUserIconColor(userItem.userId) }}
                                                                                >
                                                                                    {(userItem.userName || 'U').charAt(0).toUpperCase()}
                                                                                </div>
                                                                                <div>
                                                                                    <p className="font-bold text-white mobile-text-sm">{userItem.userName}</p>
                                                                                    <p className="text-gray-400 mobile-text-xs">
                                                                                        {userItem.sessions.length}日間で作業
                                                                                        {userItem.userId === user?.uid && (
                                                                                            <span className="text-blue-300 ml-1">（自分）</span>
                                                                                        )}
                                                                                    </p>
                                                                                </div>
                                                                            </div>
                                                                            <div className="text-right">
                                                                                <p className="font-bold text-white mobile-text-sm">{userItem.totalHours.toFixed(1)}h</p>
                                                                                <p className="text-gray-400 mobile-text-xs">
                                                                                    全体の{totalHours > 0 ? ((userItem.totalHours / totalHours) * 100).toFixed(1) : '0'}%
                                                                                </p>
                                                                            </div>
                                                                        </div>

                                                                        {/* 日別の詳細（折りたたみ可能） */}
                                                                        <details className="mt-3">
                                                                            <summary className="text-gray-400 mobile-text-xs cursor-pointer hover:text-gray-300 transition-colors">
                                                                                日別の詳細を表示
                                                                            </summary>
                                                                            <div className="mt-2 space-y-1 pl-4">
                                                                                {(userItem.sessions || [])
                                                                                    .sort((a, b) => {
                                                                                        const dateA = a.date ? a.date.toDate() : new Date(0);
                                                                                        const dateB = b.date ? b.date.toDate() : new Date(0);
                                                                                        return dateB - dateA; // 新しい日付順
                                                                                    })
                                                                                    .map((session, sessionIndex) => (
                                                                                        <div key={sessionIndex} className="flex justify-between items-center mobile-text-xs">
                                                                                            <span className="text-gray-300">
                                                                                                {session.date
                                                                                                    ? session.date.toDate().toLocaleDateString('ja-JP')
                                                                                                    : '日付不明'}
                                                                                            </span>
                                                                                            <span className="text-white font-medium">
                                                                                                {(session.hours || session.totalHours || 0).toFixed(1)}h
                                                                                            </span>
                                                                                        </div>
                                                                                    ))
                                                                                }
                                                                            </div>
                                                                        </details>
                                                                    </div>
                                                                ))
                                                            ) : (
                                                                <div className="text-center text-gray-400 py-6">
                                                                    <p className="mobile-text-sm">まだ工数が記録されていません</p>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })()}

                                            {/* 閉じるボタン */}
                                            <div className="mt-6 mb-1.5">
                                                <button
                                                    onClick={() => setShowHoursDetail(false)}
                                                    className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                                >
                                                    閉じる
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* プロジェクト詳細モーダル */}
                                {showProjectDetail && detailProjectId && (
                                    <div className="modal-overlay" onClick={() => setShowProjectDetail(false)}>
                                        <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-3xl mx-4" onClick={(e) => e.stopPropagation()}>
                                            <div className="mb-4">
                                                <h3 className="text-base font-bold text-white pt-2">案件詳細</h3>
                                            </div>
                                            {(() => {
                                                const project = projects.find(p => p.id === detailProjectId);
                                                const projectTasks = tasks.filter(t => String(t.projectId) === String(detailProjectId));
                                                const stats = getProjectStats(detailProjectId);

                                                // ユーザーごとの工数を集計（日付別workSessionsから）
                                                const userHours = {};
                                                workSessions
                                                    .filter(s => String(s.projectId) === String(detailProjectId))
                                                    .forEach(session => {
                                                        const userId = session.userId;
                                                        const userName = session.userName;
                                                        if (!userHours[userId]) {
                                                            userHours[userId] = {
                                                                userName: userName,
                                                                totalHours: 0,
                                                                taskCount: new Set(),
                                                                tasks: {},
                                                                sessions: []
                                                            };
                                                        }
                                                        userHours[userId].totalHours += (session.hours || session.totalHours || 0);
                                                        userHours[userId].taskCount.add(session.taskId);
                                                        userHours[userId].sessions.push(session);

                                                        // タスクごとの工数も記録
                                                        if (!userHours[userId].tasks[session.taskId]) {
                                                            userHours[userId].tasks[session.taskId] = {
                                                                taskName: session.taskName,
                                                                hours: 0
                                                            };
                                                        }
                                                        userHours[userId].tasks[session.taskId].hours += (session.hours || session.totalHours || 0);
                                                    });

                                                const userHoursArray = Object.entries(userHours)
                                                    .map(([userId, data]) => ({
                                                        userId,
                                                        ...data,
                                                        taskCount: data.taskCount.size
                                                    }))
                                                    .sort((a, b) => b.totalHours - a.totalHours);

                                                return (
                                                    <div>
                                                        <div className="mb-4">
                                                            <h4 className="mobile-text-sm font-bold text-white mb-2">{project?.name}</h4>
                                                            {project?.company && (
                                                                <div className="mobile-text-xs text-purple-300 font-medium">
                                                                    {project.company}
                                                                </div>
                                                            )}
                                                            <div className="grid grid-cols-2 gap-2 mt-3">
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">総工数</div>
                                                                    <div className="font-bold text-white mobile-text-sm">{stats.totalActual.toFixed(1)}h</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">工程数</div>
                                                                    <div className="font-bold text-white mobile-text-sm">{stats.totalTasks}</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">進捗率</div>
                                                                    <div className="font-bold text-white mobile-text-sm">{stats.progress.toFixed(1)}%</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">作業者数</div>
                                                                    <div className="font-bold text-white mobile-text-sm">{userHoursArray.length}人</div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div className="space-y-3">
                                                            <h5 className="font-bold text-white mobile-text-sm">ユーザー別工数</h5>
                                                            {userHoursArray.length > 0 ? (
                                                                userHoursArray.map((userItem, index) => (
                                                                    <div key={userItem.userId} className="glass-card-dark mobile-compact-card rounded-xl">
                                                                        <div className="flex justify-between items-start mb-3">
                                                                            <div className="flex items-center gap-2">
                                                                                <div
                                                                                    className="user-icon user-icon-small"
                                                                                    style={{ background: getUserIconColor(userItem.userId) }}
                                                                                >
                                                                                    {(userItem.userName || 'U').charAt(0).toUpperCase()}
                                                                                </div>
                                                                                <div>
                                                                                    <p className="font-bold text-white mobile-text-sm">{userItem.userName}</p>
                                                                                    <p className="text-gray-400 mobile-text-xs">
                                                                                        {userItem.taskCount}個の工程で作業
                                                                                        {userItem.userId === user?.uid && (
                                                                                            <span className="text-blue-300 ml-1">（自分）</span>
                                                                                        )}
                                                                                    </p>
                                                                                    <p className="text-gray-400 mobile-text-xs">
                                                                                        {userItem.sessions.length}日間で作業
                                                                                    </p>
                                                                                </div>
                                                                            </div>
                                                                            <div className="text-right">
                                                                                <p className="font-bold text-white mobile-text-sm">{userItem.totalHours.toFixed(1)}h</p>
                                                                                <p className="text-gray-400 mobile-text-xs">
                                                                                    {stats.totalActual > 0 ? ((userItem.totalHours / stats.totalActual) * 100).toFixed(1) : '0'}%
                                                                                </p>
                                                                            </div>
                                                                        </div>

                                                                        {/* タスクごとの内訳 */}
                                                                        <div className="space-y-1 mt-3 pl-8">
                                                                            <h6 className="text-gray-300 mobile-text-xs font-medium">工程別内訳</h6>
                                                                            {Object.entries(userItem.tasks || {})
                                                                                .sort((a, b) => b[1].hours - a[1].hours)
                                                                                .map(([taskId, taskData]) => (
                                                                                    <div key={taskId} className="flex justify-between items-center mobile-text-xs">
                                                                                        <span className="text-gray-300">{taskData.taskName}</span>
                                                                                        <span className="text-white font-medium">{taskData.hours.toFixed(1)}h</span>
                                                                                    </div>
                                                                                ))
                                                                            }
                                                                        </div>

                                                                        {/* 日別の詳細（折りたたみ可能） */}
                                                                        <details className="mt-3 pl-8">
                                                                            <summary className="text-gray-400 mobile-text-xs cursor-pointer hover:text-gray-300 transition-colors">
                                                                                日別の詳細を表示
                                                                            </summary>
                                                                            <div className="mt-2 space-y-1">
                                                                                {(userItem.sessions || [])
                                                                                    .sort((a, b) => {
                                                                                        const dateA = a.date ? a.date.toDate() : new Date(0);
                                                                                        const dateB = b.date ? b.date.toDate() : new Date(0);
                                                                                        return dateB - dateA; // 新しい日付順
                                                                                    })
                                                                                    .map((session, sessionIndex) => (
                                                                                        <div key={sessionIndex} className="flex justify-between items-center mobile-text-xs">
                                                                                            <span className="text-gray-300">
                                                                                                {session.date
                                                                                                    ? session.date.toDate().toLocaleDateString('ja-JP')
                                                                                                    : '日付不明'}
                                                                                                - {session.taskName}
                                                                                            </span>
                                                                                            <span className="text-white font-medium">
                                                                                                {(session.hours || session.totalHours || 0).toFixed(1)}h
                                                                                            </span>
                                                                                        </div>
                                                                                    ))
                                                                                }
                                                                            </div>
                                                                        </details>
                                                                    </div>
                                                                ))
                                                            ) : (
                                                                <div className="text-center text-gray-400 py-6">
                                                                    <p className="mobile-text-sm">まだ工数が記録されていません</p>
                                                                </div>
                                                            )}
                                                        </div>

                                                        {/* 閉じるボタン */}
                                                        <div className="mt-6 mb-1.5">
                                                            <button
                                                                onClick={() => setShowProjectDetail(false)}
                                                                className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                                            >
                                                                閉じる
                                                            </button>
                                                        </div>
                                                    </div>
                                                );
                                            })()}
                                        </div>
                                    </div>
                                )}

                                {/* プロジェクト一覧 */}
                                <div className="space-y-4 md:space-y-6">
                                    {sortedProjects.length > 0 ? (
                                        sortedProjects.map(project => {
                                            const projectTasks = tasks.filter(task => String(task.projectId) === String(project.id));
                                            const stats = getProjectStats(project.id);
                                            const isCollapsed = collapsedProjects[project.id];
                                            return (
                                                <div key={project.id} className={`glass-card rounded-2xl overflow-hidden ${project.status === '完了' ? 'opacity-75' : ''}`}>
                                                    {/* プロジェクトヘッダー（モバイル最適化） */}
                                                    <div className="bg-gray-800 bg-opacity-50 mobile-compact-card border-b border-gray-600 border-opacity-30 relative">
                                                        <div className="flex justify-between items-start mb-3">
                                                            <div
                                                                className="flex items-start gap-3 cursor-pointer flex-1"
                                                                onClick={() => toggleProjectCollapse(project.id)}
                                                            >
                                                                <span className="text-white text-sm flex-shrink-0 w-5 flex justify-center" style={{ marginTop: '43px' }}>
                                                                    {isCollapsed ? icons.chevronRight : icons.chevronDown}
                                                                </span>
                                                                <div className="flex-1 min-w-0">
                                                                    <div className="flex flex-col mb-2 mt-10">
                                                                        <h3 className="text-base md:text-lg font-bold text-white truncate">{project.name}</h3>
                                                                        {project.company && (
                                                                            <div className="text-purple-300 truncate mobile-text-sm">
                                                                                {project.company}
                                                                            </div>
                                                                        )}
                                                                        <div className="flex flex-wrap gap-2 mt-1">
                                                                            <span className={`mobile-text-xs text-white px-2 py-1 rounded-full font-bold ${project.status === '完了'
                                                                                ? 'bg-green-600 bg-opacity-60'
                                                                                : 'bg-blue-600 bg-opacity-60'
                                                                                }`}>
                                                                                {project.status}
                                                                            </span>
                                                                            {project.deadline && (
                                                                                <span className={`mobile-text-xs text-white px-2 py-1 rounded-full font-bold ${project.status === '完了'
                                                                                    ? 'bg-green-600 bg-opacity-60'
                                                                                    : 'bg-blue-600 bg-opacity-60'
                                                                                    }`}>
                                                                                    締切: {(() => {
                                                                                        try {
                                                                                            const date = new Date(project.deadline);
                                                                                            return isNaN(date.getTime()) ? '日付不明' : date.toLocaleDateString('ja-JP');
                                                                                        } catch (error) {
                                                                                            return '日付不明';
                                                                                        }
                                                                                    })()}
                                                                                </span>
                                                                            )}
                                                                            {project.createdByName && (
                                                                                <span
                                                                                    className="mobile-text-xs text-white font-bold px-2 py-1 rounded-full"
                                                                                    style={{ background: getUserIconColor(project.createdBy) }}
                                                                                >
                                                                                    {project.createdByName}
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                    {project.description && (
                                                                        <p className="text-gray-300 mobile-text-sm mb-1 line-clamp-2">{project.description}</p>
                                                                    )}
                                                                </div>
                                                            </div>

                                                            {/* アクションボタン（左側：削除、編集、詳細、お気に入り） */}
                                                            <div className="absolute top-2 left-3 flex gap-2 z-10">
                                                                {isAdmin && (
                                                                    <DeleteButton
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            openDeleteConfirm('project', project.id, project.name);
                                                                        }}
                                                                    />
                                                                )}
                                                                {project.status === '進行中' && isAdmin && (
                                                                    <EditButton
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            openEditProject(project);
                                                                        }}
                                                                    />
                                                                )}
                                                                <InfoButton
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        openProjectDetail(project.id);
                                                                    }}
                                                                />
                                                                <FavoriteButton
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        toggleFavorite(project.id);
                                                                    }}
                                                                    isFavorite={isFavorite(project.id)}
                                                                />
                                                            </div>

                                                            {/* 新規工程ボタン（右側） */}
                                                            {isAdmin && (
                                                                <div className="absolute top-2 right-3 z-10">
                                                                    <button
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            resetNewTaskForm();
                                                                            setNewTask(prev => ({ ...prev, projectId: String(project.id) }));
                                                                            setShowNewTaskForm(true);
                                                                        }}
                                                                        className="flex items-center justify-center text-white font-medium transition-all duration-300 gradient-button hover:shadow-lg w-5 h-5 rounded-full flex-shrink-0 text-xs"
                                                                    >
                                                                        <span style={{ transform: 'translateY(0.3px) translateX(0.2px)' }}>＋</span>
                                                                    </button>
                                                                </div>
                                                            )}

                                                            {/* 区切りライン */}
                                                            <div className="absolute left-0 right-0 border-t border-gray-600" style={{ top: '38px' }}></div>
                                                        </div>



                                                        {/* プロジェクト統計（モバイル用コンパクト） */}
                                                        <div className="flex items-start justify-between mb-3">
                                                            <div className="grid grid-cols-3 gap-2 mobile-text-xs text-center flex-1">
                                                                <div>
                                                                    <div className="text-gray-400">進捗</div>
                                                                    <div className={`font-bold ${project.status === '完了' ? 'text-green-400' : 'text-white'}`}>
                                                                        {stats.progress.toFixed(1)}%
                                                                    </div>
                                                                </div>
                                                                <div>
                                                                    <div className="text-gray-400">工程</div>
                                                                    <div className="text-white font-bold">{stats.completedTasks}/{stats.totalTasks}</div>
                                                                </div>
                                                                <div>
                                                                    <div className="text-gray-400">工数</div>
                                                                    <div className="text-white font-bold">{stats.totalActual.toFixed(1)}h/{stats.totalEstimated}h</div>
                                                                </div>
                                                            </div>

                                                        </div>

                                                        {/* プロジェクト進捗バー */}
                                                        <div className="w-full bg-gray-600 bg-opacity-30 rounded-full h-1.5 mb-4">
                                                            <div
                                                                className={`h-1.5 rounded-full transition-all duration-500 ${project.status === '完了' ? 'bg-green-500' : 'progress-bar'
                                                                    }`}
                                                                style={{ width: `${stats.progress}%` }}
                                                            ></div>
                                                        </div>

                                                        {/* 配線仕様表示（進捗バーの下） */}
                                                        {projectWirings[project.id] && (
                                                            <div
                                                                className="mb-2 glass-card px-3 pt-3 pb-2 rounded-lg cursor-pointer hover:bg-gray-700 hover:bg-opacity-20 transition-all duration-200"
                                                                style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    openWiringModal(project.id);
                                                                }}>
                                                                {/* アクションボタン（左端） */}
                                                                <div className="flex gap-2 mb-1 -mt-2" style={{ minHeight: '22px' }}>
                                                                    {project.status === '進行中' && isAdmin && (
                                                                        <>
                                                                            <DeleteButton
                                                                                onClick={(e) => {
                                                                                    e.stopPropagation();
                                                                                    const wiring = projectWirings[project.id];
                                                                                    if (wiring) {
                                                                                        openDeleteConfirm('projectWiring', wiring.id, wiring.templateName || '配線仕様');
                                                                                    }
                                                                                }} />
                                                                            <EditButton onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                openWiringEditModal(project.id);
                                                                            }} />
                                                                        </>
                                                                    )}
                                                                </div>
                                                                {/* 区切りライン */}
                                                                <div className="mb-2 -mx-3" style={{ borderTop: '1px solid rgba(255, 255, 255, 0.1)' }}></div>
                                                                <div className="flex justify-between items-center mobile-text-sm mt-1">
                                                                    <div className={`font-bold ${project.status === '完了' ? 'text-gray-400' : 'text-white'}`}>
                                                                        配線仕様: {projectWirings[project.id].templateName}
                                                                    </div>
                                                                    <div className="text-gray-400 mobile-text-xs">
                                                                        {(() => {
                                                                            const wiring = projectWirings[project.id];
                                                                            if (!wiring?.specifications) return 0;
                                                                            let count = 0;
                                                                            const specs = wiring.specifications;

                                                                            // 各セクションが設定されているかチェック
                                                                            if (specs.wire && (
                                                                                specs.wire.power?.standards?.length > 0 ||
                                                                                specs.wire.power?.remarks ||
                                                                                specs.wire.ground?.caseColor ||
                                                                                specs.wire.ground?.remarks ||
                                                                                specs.wire.controlAC?.standards ||
                                                                                specs.wire.controlAC?.remarks ||
                                                                                specs.wire.controlDC?.standards ||
                                                                                specs.wire.controlDC?.remarks ||
                                                                                specs.wire.insulationCapRemarks ||
                                                                                specs.wire.specialSpec
                                                                            )) count++;
                                                                            if (specs.terminal && (
                                                                                specs.terminal.power ||
                                                                                specs.terminal.controlAC ||
                                                                                specs.terminal.controlDC ||
                                                                                specs.terminal.remarks
                                                                            )) count++;
                                                                            if (specs.terminalBlock && (
                                                                                specs.terminalBlock.cover ||
                                                                                specs.terminalBlock.namePlate ||
                                                                                specs.terminalBlock.bridge ||
                                                                                specs.terminalBlock.remarks
                                                                            )) count++;
                                                                            if (specs.namePlate && (
                                                                                specs.namePlate.fontSize ||
                                                                                specs.namePlate.remarks
                                                                            )) count++;
                                                                            if (specs.deviceSeal && (
                                                                                specs.deviceSeal.fontSize ||
                                                                                specs.deviceSeal.length ||
                                                                                specs.deviceSeal.positions?.length > 0 ||
                                                                                specs.deviceSeal.remarks
                                                                            )) count++;
                                                                            if (specs.markTube && (
                                                                                specs.markTube.fontSize ||
                                                                                specs.markTube.length ||
                                                                                specs.markTube.printSpec ||
                                                                                specs.markTube.orientation?.up ||
                                                                                specs.markTube.orientation?.down ||
                                                                                specs.markTube.orientation?.left ||
                                                                                specs.markTube.orientation?.right ||
                                                                                specs.markTube.remarks
                                                                            )) count++;
                                                                            if (specs.otherConfirm && (
                                                                                specs.otherConfirm.tighteningPen ||
                                                                                specs.otherConfirm.matchMark ||
                                                                                specs.otherConfirm.screw ||
                                                                                specs.otherConfirm.hookTube ||
                                                                                specs.otherConfirm.spiralTube ||
                                                                                specs.otherConfirm.insulock ||
                                                                                specs.otherConfirm.mountBase ||
                                                                                specs.otherConfirm.routeSpecialNote ||
                                                                                specs.otherConfirm.remarks
                                                                            )) count++;

                                                                            return count;
                                                                        })()} セクション
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        )}

                                                    </div>


                                                    {/* プロジェクトのタスク一覧（モバイル最適化） */}
                                                    <div className={`project-tasks-container mobile-compact-card space-y-3 ${!isCollapsed ? 'expanded' : 'collapsed'
                                                        }`}>
                                                        {projectTasks.length > 0 ? (
                                                            projectTasks
                                                                .sort((a, b) => (a.order || 0) - (b.order || 0))
                                                                .map(task => {
                                                                    const isTimerActive = activeTimers[task.id];
                                                                    const isDragging = draggedTask && draggedTask.id === task.id;
                                                                    const isDragOver = dragOverTask && dragOverTask.id === task.id;
                                                                    const isCompleted = task.status === '完了';

                                                                    return (
                                                                        <div
                                                                            key={task.id}
                                                                            data-task-id={task.id}
                                                                            className={`glass-card-dark p-3 rounded-xl transition-all duration-300 hover:shadow-lg border-l-4 relative ${isCompleted ? 'border-green-500' : 'border-gray-500'
                                                                                } task-draggable ${isDragging ? 'task-dragging' : ''} ${isDragOver ? 'task-drag-over' : ''}`}
                                                                            draggable={!isCompleted && project.status === '進行中'}
                                                                            onDragStart={(e) => !isCompleted && project.status === '進行中' && handleDragStart(e, task)}
                                                                            onDragEnd={handleDragEnd}
                                                                            onDragOver={handleDragOver}
                                                                            onDragEnter={(e) => handleDragEnter(e, task)}
                                                                            onDragLeave={handleDragLeave}
                                                                            onDrop={(e) => handleDrop(e, task)}
                                                                        >
                                                                            <div className="flex items-start justify-between mb-2 mt-10">
                                                                                <div className="flex items-start gap-2 flex-1 min-w-0">
                                                                                    <input
                                                                                        type="checkbox"
                                                                                        checked={isCompleted}
                                                                                        onChange={(e) => updateTaskStatus(task.id, e.target.checked ? '完了' : '進行中')}
                                                                                        className="w-4 h-4 -mt-0.5"
                                                                                    />
                                                                                    <div className="flex-1 min-w-0 ml-1">
                                                                                        <div className="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 mb-1">
                                                                                            <h4 className="font-bold text-white mobile-text-sm truncate leading-tight">{task.title}</h4>
                                                                                            <div className="text-gray-400 mobile-text-xs -mt-0.5">
                                                                                                {project.name}
                                                                                            </div>
                                                                                            <div className="flex flex-wrap gap-1">
                                                                                                <span className={`px-2 py-1 rounded-full mobile-text-xs font-bold ${isCompleted ? 'bg-green-600 bg-opacity-60 text-white' : 'bg-blue-600 bg-opacity-60 text-white'
                                                                                                    }`}>
                                                                                                    {task.status}
                                                                                                </span>
                                                                                                {task.createdByName && (
                                                                                                    <span
                                                                                                        className="mobile-text-xs text-white font-bold px-2 py-1 rounded-full"
                                                                                                        style={{ background: getUserIconColor(task.createdBy) }}
                                                                                                    >
                                                                                                        {task.createdByName}
                                                                                                    </span>
                                                                                                )}
                                                                                            </div>
                                                                                        </div>
                                                                                        {task.description && (
                                                                                            <p className="text-gray-300 mobile-text-xs line-clamp-2">{task.description}</p>
                                                                                        )}
                                                                                    </div>
                                                                                </div>
                                                                            </div>

                                                                            {/* アクションボタン（左側：削除、編集、詳細） */}
                                                                            <div className="absolute top-2 left-2 flex gap-2 z-10 ml-1">
                                                                                {!isCompleted && isAdmin && (
                                                                                    <DeleteButton onClick={() => openDeleteConfirm('task', task.id, task.title)} />
                                                                                )}
                                                                                {!isCompleted && isAdmin && (
                                                                                    <EditButton onClick={() => openEditTask(task)} />
                                                                                )}
                                                                                <InfoButton onClick={() => openHoursDetail(task.id)} />
                                                                            </div>

                                                                            {/* タイマー・工数ボタン（右側） */}
                                                                            {!isCompleted && (
                                                                                <div className="absolute top-2 right-2 flex items-center gap-2 z-10 mr-1">
                                                                                    {/* タイマー表示（タイマーボタンの左） */}
                                                                                    {isTimerActive && timerDisplays[task.id] && (
                                                                                        <span className="text-red-300 font-bold text-xs whitespace-nowrap">
                                                                                            {timerDisplays[task.id]}
                                                                                        </span>
                                                                                    )}
                                                                                    <button
                                                                                        onClick={() => toggleTimer(task.id)}
                                                                                        className={`flex items-center justify-center text-white font-normal transition-all duration-300 w-5 h-5 rounded-full flex-shrink-0 text-xs ${isTimerActive
                                                                                            ? 'gradient-red hover:shadow-lg pulse-animation'
                                                                                            : 'gradient-button hover:shadow-lg'
                                                                                            }`}
                                                                                    >
                                                                                        <span style={{ transform: isTimerActive ? 'translateX(0.2px)' : 'translate(0.5px, 0.3px)' }}>
                                                                                            {isTimerActive ? '■' : '▶'}
                                                                                        </span>
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => openHoursInputModal(task)}
                                                                                        className="flex items-center justify-center text-white font-normal transition-all duration-300 gradient-button hover:shadow-lg w-5 h-5 rounded-full flex-shrink-0 text-xs"
                                                                                    >
                                                                                        <svg
                                                                                            width="10"
                                                                                            height="10"
                                                                                            viewBox="0 0 10 10"
                                                                                            fill="none"
                                                                                            xmlns="http://www.w3.org/2000/svg"
                                                                                        >
                                                                                            <line x1="2" y1="3" x2="8" y2="3" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" />
                                                                                            <line x1="2" y1="7" x2="8" y2="7" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" />
                                                                                            <line x1="3.5" y1="1" x2="3.5" y2="9" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" />
                                                                                            <line x1="6.5" y1="1" x2="6.5" y2="9" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" />
                                                                                        </svg>
                                                                                    </button>
                                                                                </div>
                                                                            )}

                                                                            {/* 区切りライン */}
                                                                            <div className="absolute left-0 right-0" style={{ top: '38px', borderTop: '1px solid rgba(255, 255, 255, 0.1)' }}></div>

                                                                            {/* タスク統計（モバイル用コンパクト） */}
                                                                            <div className="grid grid-cols-3 gap-2 mobile-text-xs text-center mb-2">
                                                                                <div>
                                                                                    <div className="text-gray-400">予想</div>
                                                                                    <div className="text-white font-bold">{task.estimatedHours}h</div>
                                                                                </div>
                                                                                <div>
                                                                                    <div className="text-gray-400">自分</div>
                                                                                    <div className="text-blue-300 font-bold">{(userTaskHoursMap[task.id] || 0).toFixed(1)}h</div>
                                                                                </div>
                                                                                <div>
                                                                                    <div className="text-gray-400">総実績</div>
                                                                                    <div className="text-white font-bold">{(taskTotalHoursMap[task.id] || 0).toFixed(1)}h</div>
                                                                                </div>
                                                                            </div>

                                                                            {/* 区切りライン */}
                                                                            <div className="relative mb-3">
                                                                                <div className="absolute inset-0 flex items-center">
                                                                                    <div className="w-full border-t border-gray-600"></div>
                                                                                </div>
                                                                                <div className="relative flex justify-center text-sm"></div>
                                                                            </div>

                                                                            {/* チェックリスト表示（モバイル最適化） */}
                                                                            {(() => {
                                                                                const checklistKey = `task_${task.id}`;
                                                                                const hasChecklist = projectChecklists[checklistKey];

                                                                                if (!hasChecklist) return null;

                                                                                const checklist = projectChecklists[checklistKey];
                                                                                const totalItems = checklist.categories?.reduce((sum, cat) =>
                                                                                    sum + (cat.items?.length || 0), 0) || 0;
                                                                                const firstCheckCount = checklist.categories?.reduce((sum, cat) =>
                                                                                    sum + cat.items.filter(item => item.firstCheck).length, 0) || 0;
                                                                                const secondCheckCount = checklist.categories?.reduce((sum, cat) =>
                                                                                    sum + cat.items.filter(item => item.secondCheck).length, 0) || 0;

                                                                                return (
                                                                                    <div
                                                                                        className={`mt-3 px-3 pt-3 pb-2 glass-card rounded-lg border transition-all duration-200 ${isCompleted
                                                                                            ? 'border-gray-500 border-opacity-30 cursor-pointer hover:bg-gray-700 hover:bg-opacity-20'
                                                                                            : 'border-purple-500 border-opacity-30 cursor-pointer hover:bg-gray-700 hover:bg-opacity-20'
                                                                                            }`}
                                                                                        style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}
                                                                                        onClick={() => {
                                                                                            openChecklistModal(task.id, 'task');
                                                                                        }}>
                                                                                        {/* アクションボタン（左端） */}
                                                                                        <div className="flex gap-2 mb-1 -mt-2" style={{ minHeight: '22px' }}>
                                                                                            {!isCompleted && isAdmin && (
                                                                                                <>
                                                                                                    <DeleteButton
                                                                                                        onClick={(e) => {
                                                                                                            e.stopPropagation();
                                                                                                            const checklistKey = `task_${task.id}`;
                                                                                                            const checklist = projectChecklists[checklistKey];
                                                                                                            if (checklist) {
                                                                                                                openDeleteConfirm('projectChecklist', checklist.id, checklist.templateName || 'カスタム検査リスト');
                                                                                                            }
                                                                                                        }} />
                                                                                                    <EditButton onClick={(e) => {
                                                                                                        e.stopPropagation();
                                                                                                        openEditChecklistModal(task.id);
                                                                                                    }} />
                                                                                                </>
                                                                                            )}
                                                                                        </div>
                                                                                        {/* 区切りライン */}
                                                                                        <div className="mb-2 -mx-3" style={{ borderTop: '1px solid rgba(255, 255, 255, 0.1)' }}></div>
                                                                                        <div className={`flex justify-between items-center mobile-text-sm mt-1`}>
                                                                                            <div className={`font-bold ${isCompleted ? 'text-gray-400' : 'text-white'}`}>
                                                                                                検査リスト: {checklist.templateName || 'カスタム'}
                                                                                            </div>
                                                                                            <div className={`flex ${checklist.checkType === 'single' ? '' : 'gap-4'} mobile-text-xs`}>
                                                                                                <div className={isCompleted ? 'text-gray-500' : 'text-gray-300'}>
                                                                                                    1次: <span className={`font-bold ${isCompleted ? 'text-gray-400' : 'text-white'}`}>{firstCheckCount}/{totalItems}</span>
                                                                                                </div>
                                                                                                {checklist.checkType !== 'single' && (
                                                                                                    <div className={isCompleted ? 'text-gray-500' : 'text-gray-300'}>
                                                                                                        2次: <span className={`font-bold ${isCompleted ? 'text-gray-400' : 'text-white'}`}>{secondCheckCount}/{totalItems}</span>
                                                                                                    </div>
                                                                                                )}
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                );
                                                                            })()}


                                                                        </div>
                                                                    );
                                                                })
                                                        ) : (
                                                            <div className="text-center text-gray-400 py-6">
                                                                <p className="mobile-text-sm">この案件にはまだ工程がありません</p>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })
                                    ) : (
                                        <div className="text-center text-gray-400 py-8">
                                            <p className="text-base md:text-lg mb-2">
                                                {searchQuery ? '検索に一致する案件がありません' :
                                                    statusFilter === 'active' ? '進行中の案件がありません' :
                                                        statusFilter === 'completed' ? '完了した案件がありません' :
                                                            '案件がありません'}
                                            </p>
                                            <p className="mobile-text-sm">
                                                {statusFilter !== 'all' ? 'フィルターを変更するか、' : ''}新規案件を作成してください
                                            </p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* ガントチャートタブ */}
                        {activeTab === 'gantt' && (
                            <div className="space-y-6 md:space-y-8">
                                <div className="flex flex-row justify-between items-center gap-3 sm:gap-0">
                                    <h2 className="text-lg md:text-2xl font-bold text-white neon-text" style={{ margin: '1px 0' }}>
                                        工程表
                                    </h2>
                                </div>

                                <div className="glass-card mobile-compact-card rounded-2xl">
                                    <div className="space-y-2">
                                        {/* 検索バー */}
                                        <div className="w-full">
                                            <input
                                                type="text"
                                                placeholder="案件名・会社名で検索..."
                                                value={searchQuery}
                                                onChange={(e) => setSearchQuery(e.target.value)}
                                                className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-xs"
                                            />
                                        </div>

                                        {/* 並び替えとステータス（横並び） */}
                                        <div className="flex gap-2">
                                            <div className="flex-1">
                                                <div className="custom-select-container">
                                                    <select
                                                        value={sortOption}
                                                        onChange={(e) => setSortOption(e.target.value)}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="created-desc">作成順（新しい順）</option>
                                                        <option value="created-asc">作成順（古い順）</option>
                                                        <option value="deadline-asc">締切順（近い順）</option>
                                                        <option value="deadline-desc">締切順（遠い順）</option>
                                                        <option value="progress-desc">進捗順（高い順）</option>
                                                        <option value="progress-asc">進捗順（低い順）</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>
                                            <div className="flex-1">
                                                <div className="custom-select-container">
                                                    <select
                                                        value={statusFilter}
                                                        onChange={(e) => setStatusFilter(e.target.value)}
                                                        className="custom-select text-xs"
                                                    >
                                                        <option value="all">全て ({filteredProjects.length})</option>
                                                        <option value="active">進行中 ({filteredProjects.filter(p => p.status === '進行中').length})</option>
                                                        <option value="completed">完了 ({filteredProjects.filter(p => p.status === '完了').length})</option>
                                                        <option value="favorite">お気に入り ({filteredProjects.filter(p => isFavorite(p.id)).length})</option>
                                                    </select>
                                                    <div className="custom-select-arrow"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {(() => {
                                    // プロジェクトのフィルタリング（開始日と締切日があるもの）- ステータスフィルター適用
                                    let projectsForGantt = filteredProjects.filter(p => p.startDate && p.deadline);

                                    // ステータスフィルターを適用
                                    if (statusFilter === 'active') {
                                        projectsForGantt = projectsForGantt.filter(p => p.status === '進行中');
                                    } else if (statusFilter === 'completed') {
                                        projectsForGantt = projectsForGantt.filter(p => p.status === '完了');
                                    } else if (statusFilter === 'favorite') {
                                        projectsForGantt = projectsForGantt.filter(p => isFavorite(p.id));
                                    }

                                    const activeProjects = sortProjects(projectsForGantt);

                                    if (activeProjects.length === 0) {
                                        return (
                                            <div className="glass-card p-12 rounded-2xl text-center">
                                                <p className="text-gray-400 text-lg">
                                                    {searchQuery
                                                        ? '検索に一致する、開始日と締切日が設定されている案件がありません'
                                                        : statusFilter === 'active'
                                                            ? '進行中で開始日と締切日が設定されている案件がありません'
                                                            : statusFilter === 'completed'
                                                                ? '完了で開始日と締切日が設定されている案件がありません'
                                                                : statusFilter === 'favorite'
                                                                    ? 'お気に入りで開始日と締切日が設定されている案件がありません'
                                                                    : '開始日と締切日が設定されている案件がありません'
                                                    }
                                                </p>
                                            </div>
                                        );
                                    }

                                    // 日付範囲の計算
                                    const allDates = [];
                                    activeProjects.forEach(p => {
                                        allDates.push(new Date(p.startDate));
                                        allDates.push(new Date(p.deadline));
                                    });

                                    const minDate = new Date(Math.min(...allDates));
                                    const maxDate = new Date(Math.max(...allDates));

                                    // 月初と月末に調整
                                    minDate.setDate(1);
                                    maxDate.setMonth(maxDate.getMonth() + 1, 0);

                                    // 簡易的な日本の祝日判定（2024-2025年の主要な祝日）
                                    const isHoliday = (date) => {
                                        const year = date.getFullYear();
                                        const month = date.getMonth() + 1;
                                        const day = date.getDate();
                                        const holidays = {
                                            2024: {
                                                '1-1': true, '1-8': true, '2-11': true, '2-12': true, '2-23': true,
                                                '3-20': true, '4-29': true, '5-3': true, '5-4': true, '5-5': true, '5-6': true,
                                                '7-15': true, '8-11': true, '8-12': true, '9-16': true, '9-22': true, '9-23': true,
                                                '10-14': true, '11-3': true, '11-4': true, '11-23': true
                                            },
                                            2025: {
                                                '1-1': true, '1-13': true, '2-11': true, '2-23': true, '2-24': true,
                                                '3-20': true, '4-29': true, '5-3': true, '5-4': true, '5-5': true, '5-6': true,
                                                '7-21': true, '8-11': true, '9-15': true, '9-23': true,
                                                '10-13': true, '11-3': true, '11-23': true, '11-24': true
                                            },
                                            2026: {
                                                '1-1': true, '1-12': true, '2-11': true, '2-23': true,
                                                '3-20': true, '4-29': true, '5-3': true, '5-4': true, '5-5': true, '5-6': true,
                                                '7-20': true, '8-11': true, '9-21': true, '9-22': true, '9-23': true,
                                                '10-12': true, '11-3': true, '11-23': true
                                            }
                                        };
                                        return holidays[year] && holidays[year][`${month}-${day}`];
                                    };

                                    // 今日の日付を取得（ループの外で一度だけ）
                                    const today = new Date();
                                    today.setHours(0, 0, 0, 0);

                                    // 全ての日付を生成
                                    const allDays = [];
                                    const dayWidth = 25; // 1日あたりの幅（ピクセル）
                                    let currentDay = new Date(minDate);
                                    while (currentDay <= maxDate) {
                                        const dayOfWeek = currentDay.getDay();
                                        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                                        const isHol = isHoliday(currentDay);

                                        // 今日かどうかを判定（日付の文字列比較で確実に）
                                        const currentDayStr = currentDay.toDateString();
                                        const todayStr = today.toDateString();
                                        const isToday = currentDayStr === todayStr;

                                        allDays.push({
                                            date: new Date(currentDay),
                                            day: currentDay.getDate(),
                                            dayOfWeek: dayOfWeek,
                                            isWeekend: isWeekend,
                                            isHoliday: isHol,
                                            isSunday: dayOfWeek === 0,
                                            isSaturday: dayOfWeek === 6,
                                            isToday: isToday
                                        });

                                        currentDay.setDate(currentDay.getDate() + 1);
                                    }

                                    // 月ごとの日数を計算
                                    const monthsWithDays = [];
                                    let currentMonth = null;
                                    let daysInMonth = 0;

                                    allDays.forEach(day => {
                                        const monthKey = `${day.date.getFullYear()}-${day.date.getMonth()}`;
                                        if (currentMonth !== monthKey) {
                                            if (currentMonth !== null) {
                                                monthsWithDays[monthsWithDays.length - 1].days = daysInMonth;
                                            }
                                            currentMonth = monthKey;
                                            daysInMonth = 1;
                                            monthsWithDays.push({
                                                year: day.date.getFullYear(),
                                                month: day.date.getMonth(),
                                                name: day.date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short' }),
                                                days: 0
                                            });
                                        } else {
                                            daysInMonth++;
                                        }
                                    });
                                    if (monthsWithDays.length > 0) {
                                        monthsWithDays[monthsWithDays.length - 1].days = daysInMonth;
                                    }

                                    // 全期間の日数を計算
                                    const totalDays = allDays.length;

                                    // 各プロジェクトの位置と幅を計算
                                    const projectBars = activeProjects.map(project => {
                                        const projectStart = new Date(project.startDate);
                                        const projectEnd = new Date(project.deadline);
                                        const startOffset = Math.floor((projectStart - minDate) / (1000 * 60 * 60 * 24));
                                        const duration = Math.ceil((projectEnd - projectStart) / (1000 * 60 * 60 * 24)) + 1;

                                        const stats = getProjectStats(project.id);

                                        return {
                                            ...project,
                                            startOffset,
                                            duration,
                                            progress: stats.progress
                                        };
                                    });

                                    return (
                                        <div className="glass-card rounded-2xl overflow-hidden">
                                            {/* モバイル版: 4分割レイアウト */}
                                            <div className="block relative" style={{ minHeight: '80vh', height: 'auto', maxHeight: '90vh' }}>

                                                {/* 左上：プロジェクト名ヘッダー（完全固定） */}
                                                <div
                                                    className="absolute top-0 left-0 z-30 bg-gray-900 bg-opacity-95 backdrop-blur-sm border-r border-b border-gray-600"
                                                    style={{ padding: ganttProjectNameWidth.mobile > 0 ? '20px 12px' : '0', width: `${ganttProjectNameWidth.mobile}px`, height: '90px', transition: 'width 0.3s ease, padding 0.3s ease' }}
                                                >
                                                    {ganttProjectNameWidth.mobile > 0 && (
                                                        <div className="font-bold text-white text-base flex items-center h-full whitespace-nowrap overflow-hidden">
                                                            案件名
                                                        </div>
                                                    )}
                                                </div>

                                                {/* 右上：日付ヘッダー（横スクロール、縦固定）- スクロールバー非表示 */}
                                                <div
                                                    className="absolute top-0 z-20 bg-gray-900 bg-opacity-95 backdrop-blur-sm border-b border-gray-600"
                                                    style={{
                                                        left: `${ganttProjectNameWidth.mobile}px`,
                                                        right: '0',
                                                        height: '90px',
                                                        overflow: 'hidden',
                                                        transition: 'left 0.3s ease',
                                                        paddingRight: '17px'
                                                    }}
                                                    id="mobileGanttHeader"
                                                >
                                                    <div className="min-w-max flex flex-col justify-end h-full" style={{ width: `${totalDays * 22}px`, padding: '4px 0 2px 0', transform: 'translateZ(0)', willChange: 'transform' }} id="mobileHeaderContent">
                                                        {/* ヘッダー（月表示） */}
                                                        <div className="flex mb-4">
                                                            {monthsWithDays.map((month, index) => (
                                                                <div
                                                                    key={index}
                                                                    className="text-center font-bold text-white px-1"
                                                                    style={{ width: `${month.days * 22}px`, fontSize: '11px', lineHeight: '18px' }}
                                                                >
                                                                    {month.name.replace('年', '/').replace('月', '')}
                                                                </div>
                                                            ))}
                                                        </div>


                                                        {/* 日付ヘッダー */}
                                                        <div className="flex">
                                                            {allDays.map((day, index) => (
                                                                <div
                                                                    key={index}
                                                                    className={`gantt-day-header text-center ${day.isToday ? 'bg-purple-900 bg-opacity-25 text-purple-200' :
                                                                        day.isHoliday || day.isSunday ? 'bg-red-900 bg-opacity-20 text-red-300' :
                                                                            day.isSaturday ? 'bg-blue-900 bg-opacity-20 text-blue-300' :
                                                                                'text-gray-400'
                                                                        }`}
                                                                    style={{ width: '22px', fontSize: '9px', lineHeight: '16px', minHeight: '16px' }}
                                                                >
                                                                    <div className="font-bold">{(day.day === 1 || day.day % 10 === 0 || day.isToday) ? day.day : ''}</div>
                                                                    {(day.day === 1 || day.day % 10 === 0 || day.isToday) && (
                                                                        <div style={{ fontSize: '7px' }}>
                                                                            {['日', '月', '火', '水', '木', '金', '土'][day.dayOfWeek]}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* 左下：プロジェクト名列（縦スクロール、横固定）- スクロールバー非表示 */}
                                                <div
                                                    className="absolute left-0 z-10 bg-gray-800 bg-opacity-30 border-r border-gray-600"
                                                    style={{
                                                        top: '90px',
                                                        width: `${ganttProjectNameWidth.mobile}px`,
                                                        height: 'calc(80vh - 90px)',
                                                        overflow: 'hidden',
                                                        transition: 'width 0.3s ease'
                                                    }}
                                                >
                                                    <div className="space-y-4" style={{
                                                        padding: '20px 12px',
                                                        height: `${projectBars.length * 64 + 120}px`,
                                                        minHeight: '900px',
                                                        transform: 'translateZ(0)',
                                                        willChange: 'transform'
                                                    }}>
                                                        {projectBars.map((project, index) => (
                                                            <div key={project.id} className="flex items-center gap-2" style={{ height: '64px' }}>
                                                                <div className="flex flex-col gap-0 w-full overflow-hidden">
                                                                    <div className="text-white font-medium text-xs whitespace-nowrap overflow-hidden" title={project.name}>
                                                                        {project.name}
                                                                    </div>
                                                                    {project.company && (
                                                                        <div className="text-purple-300 mt-0.5 whitespace-nowrap overflow-hidden" title={project.company} style={{ fontSize: '9px' }}>
                                                                            {project.company}
                                                                        </div>
                                                                    )}
                                                                    {project.createdByName && (
                                                                        <span
                                                                            className="mt-1 whitespace-nowrap overflow-hidden text-white font-bold px-2 py-1 rounded-full"
                                                                            style={{
                                                                                fontSize: '8px',
                                                                                display: 'inline-block',
                                                                                width: 'auto',
                                                                                maxWidth: 'fit-content',
                                                                                background: getUserIconColor(project.createdBy)
                                                                            }}
                                                                        >
                                                                            {project.createdByName}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                                {/* 右下：タイムライン（両方向スクロール）- メインスクロールエリア */}
                                                <div
                                                    className="absolute timeline-area overflow-auto gantt-scroll-vertical"
                                                    style={{
                                                        top: '90px',
                                                        left: `${ganttProjectNameWidth.mobile}px`,
                                                        right: '0',
                                                        height: 'calc(80vh - 90px)',
                                                        cursor: isDragging ? 'grabbing' : 'grab',
                                                        transition: 'left 0.3s ease'
                                                    }}
                                                    onMouseDown={handleGanttMouseDown}
                                                    onMouseLeave={handleGanttMouseLeave}
                                                    onClick={() => {
                                                        // ガントチャート内をタッチして案件列の幅を切り替え
                                                        toggleGanttProjectNameWidth(true);
                                                    }}
                                                    onScroll={(e) => {
                                                        // より高速なスクロール同期
                                                        requestAnimationFrame(() => {
                                                            const scrollLeft = e.target.scrollLeft;
                                                            const scrollTop = e.target.scrollTop;

                                                            // モバイル版：日付ヘッダーと横スクロールを同期
                                                            const mobileHeaderContent = document.getElementById('mobileHeaderContent');
                                                            if (mobileHeaderContent) {
                                                                mobileHeaderContent.style.transform = `translateX(-${scrollLeft}px)`;
                                                                mobileHeaderContent.style.willChange = 'transform';
                                                            }

                                                            // プロジェクト名列と縦スクロールを同期
                                                            const projectNameArea = e.target.parentElement.querySelector('.absolute.left-0.z-10 > div');
                                                            if (projectNameArea) {
                                                                projectNameArea.style.transform = `translateY(-${scrollTop}px)`;
                                                                projectNameArea.style.willChange = 'transform';
                                                            }
                                                        });
                                                    }}
                                                >
                                                    <div className="min-w-max relative" style={{
                                                        width: `${totalDays * 22}px`,
                                                        height: `${projectBars.length * 64 + 120}px`,
                                                        minHeight: '900px',
                                                        padding: '20px 0'
                                                    }}>
                                                        {/* 全体の背景グリッド */}
                                                        <div className="absolute" style={{ top: '0', left: '0', right: '0', bottom: '0', minHeight: '100%' }}>
                                                            {allDays.map((day, dayIndex) => (
                                                                <div
                                                                    key={dayIndex}
                                                                    className="absolute top-0 bottom-0"
                                                                    style={{
                                                                        left: `${dayIndex * 22}px`,
                                                                        width: '22px',
                                                                        borderLeft: '1px solid rgba(255, 255, 255, 0.05)',
                                                                        background: day.isToday ? 'linear-gradient(180deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15))' :
                                                                            day.isHoliday || day.isSunday ? 'rgba(239, 68, 68, 0.05)' :
                                                                                day.isSaturday ? 'rgba(59, 130, 246, 0.05)' :
                                                                                    'transparent'
                                                                    }}
                                                                ></div>
                                                            ))}
                                                        </div>

                                                        {/* プロジェクトバー */}
                                                        <div className="relative space-y-4">
                                                            {projectBars.map((project, index) => (
                                                                <div key={project.id} className="relative" style={{ height: '64px' }}>
                                                                    {/* プロジェクトバー */}
                                                                    <div
                                                                        className="absolute top-1/2 transform -translate-y-1/2 h-7 rounded-md overflow-hidden shadow-lg transition-all duration-300 hover:scale-105 hover:shadow-xl bg-gray-500 bg-opacity-30"
                                                                        style={{
                                                                            left: `${project.startOffset * 22}px`,
                                                                            width: `${project.duration * 22}px`,
                                                                            zIndex: 10,
                                                                            minWidth: '22px'
                                                                        }}
                                                                    >
                                                                        {/* 進捗バー */}
                                                                        <div
                                                                            className={`h-full ${project.status === '完了' ? 'bg-green-600' : 'progress-bar'}`}
                                                                            style={{ width: `${project.progress}%` }}
                                                                        ></div>

                                                                        {/* 進捗テキスト */}
                                                                        {project.duration * 22 >= 44 && (
                                                                            <div className="absolute inset-0 flex items-center justify-center text-white font-bold drop-shadow-lg" style={{ fontSize: '9px' }}>
                                                                                {project.progress.toFixed(0)}%
                                                                            </div>
                                                                        )}
                                                                    </div>

                                                                    {/* 開始日と締切日の表示 */}
                                                                    <div
                                                                        className="absolute top-1/2 transform -translate-y-1/2 mt-6 text-gray-400"
                                                                        style={{ left: `${project.startOffset * 22}px`, fontSize: '9px' }}
                                                                    >
                                                                        {new Date(project.startDate).toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' })}
                                                                    </div>
                                                                    <div
                                                                        className="absolute top-1/2 transform -translate-y-1/2 mt-6 text-gray-400 text-right"
                                                                        style={{
                                                                            left: `${(project.startOffset + project.duration) * 22}px`,
                                                                            transform: 'translateX(-100%) translateY(-50%)',
                                                                            fontSize: '9px'
                                                                        }}
                                                                    >
                                                                        {new Date(project.deadline).toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' })}
                                                                    </div>

                                                                    {/* 進捗表示（小さなバー用） */}
                                                                    {project.duration * 22 < 44 && (
                                                                        <div
                                                                            className="absolute top-1/2 transform -translate-y-1/2 text-white font-bold bg-gray-800 bg-opacity-80 px-1 rounded"
                                                                            style={{
                                                                                left: `${(project.startOffset + project.duration) * 22 + 8}px`,
                                                                                fontSize: '9px'
                                                                            }}
                                                                        >
                                                                            {project.progress.toFixed(0)}%
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>



                                        </div>
                                    );
                                })()}
                            </div>
                        )}



                        {/* 分析・レポートタブ */}
                        {activeTab === 'analytics' && (
                            <div className="space-y-6 md:space-y-8">
                                <div className="flex flex-row justify-between items-center gap-3 sm:gap-0">
                                    <h2 className="text-lg md:text-2xl font-bold text-white neon-text" style={{ margin: '1px 0' }}>
                                        分析
                                    </h2>
                                </div>

                                <div className="glass-card mobile-compact-card rounded-2xl">
                                    <div className="space-y-2">
                                        {/* 検索バー */}
                                        <div className="w-full">
                                            <input
                                                type="text"
                                                placeholder="案件名・会社名で検索..."
                                                value={searchQuery}
                                                onChange={(e) => setSearchQuery(e.target.value)}
                                                className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-xs"
                                            />
                                        </div>

                                        {/* 並び替えとステータス（横並び） */}
                                        <div className="flex gap-2">
                                            <div className="custom-select-container flex-1">
                                                <select
                                                    value={sortOption}
                                                    onChange={(e) => setSortOption(e.target.value)}
                                                    className="custom-select w-full text-xs"
                                                >
                                                    <option value="created-desc">作成順（新しい順）</option>
                                                    <option value="created-asc">作成順（古い順）</option>
                                                    <option value="deadline-asc">締切順（近い順）</option>
                                                    <option value="deadline-desc">締切順（遠い順）</option>
                                                    <option value="progress-desc">進捗順（高い順）</option>
                                                    <option value="progress-asc">進捗順（低い順）</option>
                                                </select>
                                                <div className="custom-select-arrow"></div>
                                            </div>
                                            <div className="custom-select-container flex-1">
                                                <select
                                                    value={statusFilter}
                                                    onChange={(e) => setStatusFilter(e.target.value)}
                                                    className="custom-select w-full text-xs"
                                                >
                                                    <option value="all">全て ({filteredProjects.length})</option>
                                                    <option value="active">進行中 ({filteredProjects.filter(p => p.status === '進行中').length})</option>
                                                    <option value="completed">完了 ({filteredProjects.filter(p => p.status === '完了').length})</option>
                                                    <option value="favorite">お気に入り ({filteredProjects.filter(p => isFavorite(p.id)).length})</option>
                                                </select>
                                                <div className="custom-select-arrow"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* 全体統計と案件別工数分析 */}
                                <div className="space-y-4">
                                    {/* 全体統計 */}
                                    <div className="grid grid-cols-2 gap-2">
                                        <div className="glass-card p-3 rounded-2xl text-center">
                                            <div className="font-bold text-white text-base mb-1">{sortedProjects.length}</div>
                                            <div className="text-gray-400 mobile-text-xs">総案件数</div>
                                        </div>
                                        <div className="glass-card p-3 rounded-2xl text-center">
                                            <div className="font-bold text-white text-base mb-1">
                                                {tasks.filter(task => sortedProjects.some(p => String(p.id) === String(task.projectId))).length}
                                            </div>
                                            <div className="text-gray-400 mobile-text-xs">総工程数</div>
                                        </div>
                                        <div className="glass-card p-3 rounded-2xl text-center">
                                            <div className="font-bold text-white text-base mb-1">
                                                {tasks.filter(task =>
                                                    sortedProjects.some(p => String(p.id) === String(task.projectId))
                                                ).reduce((sum, task) => sum + (task.estimatedHours || 0), 0).toFixed(1)}h
                                            </div>
                                            <div className="text-gray-400 mobile-text-xs">総予想工数</div>
                                        </div>
                                        <div className="glass-card p-3 rounded-2xl text-center">
                                            <div className="font-bold text-white text-base mb-1">
                                                {tasks.filter(task =>
                                                    sortedProjects.some(p => String(p.id) === String(task.projectId))
                                                ).reduce((sum, task) => sum + (taskTotalHoursMap[task.id] || 0), 0).toFixed(1)}h
                                            </div>
                                            <div className="text-gray-400 mobile-text-xs">総実績工数</div>
                                        </div>
                                        <div className="glass-card p-3 rounded-2xl text-center">
                                            <div className="font-bold text-white text-base mb-1">
                                                ¥{sortedProjects.reduce((sum, project) => sum + (parseFloat(project.laborCost) || 0), 0).toLocaleString()}
                                            </div>
                                            <div className="text-gray-400 mobile-text-xs">総労務費</div>
                                        </div>
                                        <div className="glass-card p-3 rounded-2xl text-center">
                                            <div className="font-bold text-white text-base mb-1">
                                                ¥{sortedProjects.reduce((sum, project) => sum + (parseFloat(project.materialCost) || 0), 0).toLocaleString()}
                                            </div>
                                            <div className="text-gray-400 mobile-text-xs">総資材費</div>
                                        </div>
                                        <div className="glass-card p-3 rounded-2xl text-center">
                                            <div className="font-bold text-white text-base mb-1">
                                                ¥{sortedProjects.reduce((sum, project) => sum + (project.amount || 0), 0).toLocaleString()}
                                            </div>
                                            <div className="text-gray-400 mobile-text-xs">総案件金額</div>
                                        </div>


                                        <div className="glass-card p-3 rounded-2xl text-center">
                                            <div className="font-bold text-white text-base mb-1">
                                                {(() => {
                                                    const totalLaborCost = sortedProjects.reduce((sum, project) => sum + (parseFloat(project.laborCost) || 0), 0);
                                                    const totalActual = tasks.filter(task =>
                                                        sortedProjects.some(p => String(p.id) === String(task.projectId))
                                                    ).reduce((sum, task) => sum + (taskTotalHoursMap[task.id] || 0), 0);
                                                    const avgHourlyRate = totalActual > 0 ? totalLaborCost / totalActual : 0;
                                                    return `¥${Math.round(avgHourlyRate).toLocaleString()}/h`;
                                                })()}
                                            </div>
                                            <div className="text-gray-400 mobile-text-xs">平均時間単価</div>
                                        </div>
                                    </div>

                                    {/* プロジェクト別詳細 */}
                                    <div className="glass-card p-3 rounded-2xl">
                                        <h3 className="text-base font-bold mb-3 text-white">案件別工数分析</h3>
                                        {sortedProjects.length > 0 ? (
                                            <div className="space-y-3">
                                                {sortedProjects.map(project => {
                                                    const stats = getProjectStats(project.id);

                                                    return (
                                                        <div key={project.id} className="glass-card-dark p-3 rounded-lg">
                                                            <div className="flex flex-col gap-2 mb-2">
                                                                <div className="w-full">
                                                                    <h4 className="font-bold text-white mobile-text-sm">{project.name}</h4>
                                                                    {project.company && (
                                                                        <div className="mobile-text-xs text-purple-300 font-medium">
                                                                            {project.company}
                                                                        </div>
                                                                    )}
                                                                    {project.createdByName && (
                                                                        <div>
                                                                            <span
                                                                                className="text-white font-bold px-2 py-1 rounded-full"
                                                                                style={{
                                                                                    fontSize: '8px',
                                                                                    display: 'inline-block',
                                                                                    width: 'auto',
                                                                                    maxWidth: 'fit-content',
                                                                                    background: getUserIconColor(project.createdBy)
                                                                                }}
                                                                            >
                                                                                {project.createdByName}
                                                                            </span>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <div className="grid grid-cols-2 gap-2 mobile-text-xs">
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">進捗</div>
                                                                    <div className="font-bold text-white mobile-text-sm">{stats.progress.toFixed(1)}%</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">工程数</div>
                                                                    <div className="font-bold text-white mobile-text-sm">{stats.totalTasks}</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">予想工数</div>
                                                                    <div className="font-bold text-white mobile-text-sm">{stats.totalEstimated}h</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">実績工数</div>
                                                                    <div className="font-bold text-white mobile-text-sm">{stats.totalActual.toFixed(1)}h</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">労務費</div>
                                                                    <div className="font-bold text-gray-200 mobile-text-sm">¥{stats.laborCost.toLocaleString()}</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">資材費</div>
                                                                    <div className="font-bold text-gray-200 mobile-text-sm">¥{stats.materialCost.toLocaleString()}</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">案件金額</div>
                                                                    <div className="font-bold text-gray-200 mobile-text-sm">¥{stats.amount.toLocaleString()}</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-gray-400 mobile-text-xs">時間単価</div>
                                                                    <div className="font-bold text-gray-200 mobile-text-sm">
                                                                        {stats.hourlyRate > 0 ? `¥${Math.round(stats.hourlyRate).toLocaleString()}/h` : '-'}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        ) : (
                                            <div className="text-center text-gray-400 py-4">
                                                <p className="mobile-text-sm mb-1">
                                                    {searchQuery ? '検索に一致する案件がありません' :
                                                        statusFilter === 'active' ? '進行中の案件がありません' :
                                                            statusFilter === 'completed' ? '完了した案件がありません' :
                                                                '案件がありません'}
                                                </p>
                                                <p className="mobile-text-xs">
                                                    {statusFilter !== 'all' ? 'フィルターを変更するか、' : ''}新規案件を作成してください
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* マイページタブ */}
                        {activeTab === 'mypage' && (
                            <div className="space-y-6 md:space-y-8">
                                <div className="flex flex-row justify-between items-center gap-3 sm:gap-0">
                                    <h2 className="text-lg md:text-2xl font-bold text-white neon-text" style={{ margin: '1px 0' }}>
                                        ユーザー
                                    </h2>
                                </div>

                                {/* 検索・フィルター */}
                                <div className="glass-card mobile-compact-card rounded-2xl">
                                    <div className="space-y-2">
                                        {/* 検索バー */}
                                        <div className="w-full">
                                            <input
                                                type="text"
                                                placeholder="案件名・工程名で検索..."
                                                value={searchQuery}
                                                onChange={(e) => setSearchQuery(e.target.value)}
                                                className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-xs"
                                            />
                                        </div>

                                        {/* 並び替えとフィルター（横並び） */}
                                        <div className="flex gap-2">
                                            <div className="custom-select-container flex-1">
                                                <select
                                                    value={sortOption}
                                                    onChange={(e) => setSortOption(e.target.value)}
                                                    className="custom-select w-full text-xs"
                                                >
                                                    <option value="date-desc">作業日順（新しい順）</option>
                                                    <option value="date-asc">作業日順（古い順）</option>
                                                    <option value="hours-desc">工数順（多い順）</option>
                                                    <option value="hours-asc">工数順（少ない順）</option>
                                                </select>
                                                <div className="custom-select-arrow"></div>
                                            </div>
                                            <div className="custom-select-container flex-1">
                                                <select
                                                    value={workHistoryFilter}
                                                    onChange={(e) => setWorkHistoryFilter(e.target.value)}
                                                    className="custom-select w-full text-xs"
                                                >
                                                    <option value="all">全て</option>
                                                    <option value="today">今日</option>
                                                    <option value="thisweek">今週</option>
                                                    <option value="thismonth">今月</option>
                                                    <option value="lastmonth">先月</option>
                                                </select>
                                                <div className="custom-select-arrow"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* 工数カレンダーとサマリー */}
                                <div className="space-y-4">
                                    {/* 工数カレンダー */}
                                    <div className="glass-card p-3 rounded-2xl">
                                        <h3 className="text-base font-bold text-white mb-3">工数カレンダー</h3>

                                        {/* カレンダーヘッダー */}
                                        <div className="flex justify-between items-center mb-3">
                                            <button
                                                onClick={() => {
                                                    const prevMonth = new Date(currentCalendarDate);
                                                    prevMonth.setMonth(prevMonth.getMonth() - 1);
                                                    setCurrentCalendarDate(prevMonth);
                                                }}
                                                className="text-white mobile-text-sm p-2 hover:bg-white hover:bg-opacity-10 rounded"
                                            >
                                                ←
                                            </button>
                                            <h4 className="mobile-text-sm font-bold text-white">
                                                {currentCalendarDate.getFullYear()}年{currentCalendarDate.getMonth() + 1}月
                                            </h4>
                                            <button
                                                onClick={() => {
                                                    const nextMonth = new Date(currentCalendarDate);
                                                    nextMonth.setMonth(nextMonth.getMonth() + 1);
                                                    setCurrentCalendarDate(nextMonth);
                                                }}
                                                className="text-white mobile-text-sm p-2 hover:bg-white hover:bg-opacity-10 rounded"
                                            >
                                                →
                                            </button>
                                        </div>

                                        {/* 曜日ヘッダー */}
                                        <div className="grid grid-cols-7 gap-1 mb-2">
                                            {['日', '月', '火', '水', '木', '金', '土'].map(day => (
                                                <div key={day} className="text-center mobile-text-xs text-gray-400 font-bold p-1">
                                                    {day}
                                                </div>
                                            ))}
                                        </div>

                                        {/* カレンダー */}
                                        <div className="grid grid-cols-7 gap-1">
                                            {(() => {
                                                const year = currentCalendarDate.getFullYear();
                                                const month = currentCalendarDate.getMonth();
                                                const firstDay = new Date(year, month, 1);
                                                const lastDay = new Date(year, month + 1, 0);
                                                const startDate = new Date(firstDay);
                                                startDate.setDate(startDate.getDate() - firstDay.getDay());

                                                const days = [];
                                                const current = new Date(startDate);

                                                for (let i = 0; i < 42; i++) {
                                                    // 日本時間での日付文字列を生成（UTCオフセットを考慮）
                                                    const year = current.getFullYear();
                                                    const month = String(current.getMonth() + 1).padStart(2, '0');
                                                    const day = String(current.getDate()).padStart(2, '0');
                                                    const dateStr = `${year}-${month}-${day}`;

                                                    const dayHours = workSessions
                                                        .filter(s => s.userId === user.uid)
                                                        .filter(s => {
                                                            if (s.date && s.date.toDate) {
                                                                const sessionDate = s.date.toDate();
                                                                const sessionYear = sessionDate.getFullYear();
                                                                const sessionMonth = String(sessionDate.getMonth() + 1).padStart(2, '0');
                                                                const sessionDay = String(sessionDate.getDate()).padStart(2, '0');
                                                                const sessionDateStr = `${sessionYear}-${sessionMonth}-${sessionDay}`;
                                                                return sessionDateStr === dateStr;
                                                            }
                                                            if (s.date && typeof s.date === 'string') {
                                                                return s.date === dateStr;
                                                            }
                                                            if (s.startTime && s.startTime.toDate) {
                                                                const sessionDate = s.startTime.toDate();
                                                                const sessionYear = sessionDate.getFullYear();
                                                                const sessionMonth = String(sessionDate.getMonth() + 1).padStart(2, '0');
                                                                const sessionDay = String(sessionDate.getDate()).padStart(2, '0');
                                                                const sessionDateStr = `${sessionYear}-${sessionMonth}-${sessionDay}`;
                                                                return sessionDateStr === dateStr;
                                                            }
                                                            return false;
                                                        })
                                                        .reduce((sum, s) => sum + (s.hours || 0), 0);

                                                    const isCurrentMonth = current.getMonth() === month;
                                                    const isToday = current.toDateString() === new Date().toDateString();
                                                    const dayOfWeek = current.getDay(); // 0:日曜, 6:土曜
                                                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                                                    // 日本の祝日判定（完全版）
                                                    const isHoliday = (() => {
                                                        const currentYear = current.getFullYear();
                                                        const currentMonth = current.getMonth() + 1;
                                                        const currentDate = current.getDate();

                                                        const holidays = {
                                                            2024: {
                                                                '1-1': true, '1-8': true, '2-11': true, '2-12': true, '2-23': true,
                                                                '3-20': true, '4-29': true, '5-3': true, '5-4': true, '5-5': true, '5-6': true,
                                                                '7-15': true, '8-11': true, '8-12': true, '9-16': true, '9-22': true, '9-23': true,
                                                                '10-14': true, '11-3': true, '11-4': true, '11-23': true
                                                            },
                                                            2025: {
                                                                '1-1': true, '1-13': true, '2-11': true, '2-23': true, '2-24': true,
                                                                '3-20': true, '4-29': true, '5-3': true, '5-4': true, '5-5': true, '5-6': true,
                                                                '7-21': true, '8-11': true, '9-15': true, '9-23': true,
                                                                '10-13': true, '11-3': true, '11-23': true, '11-24': true
                                                            },
                                                            2026: {
                                                                '1-1': true, '1-12': true, '2-11': true, '2-23': true,
                                                                '3-20': true, '4-29': true, '5-3': true, '5-4': true, '5-5': true, '5-6': true,
                                                                '7-20': true, '8-11': true, '9-21': true, '9-22': true, '9-23': true,
                                                                '10-12': true, '11-3': true, '11-23': true
                                                            }
                                                        };

                                                        return holidays[currentYear] && holidays[currentYear][`${currentMonth}-${currentDate}`];
                                                    })();

                                                    days.push(
                                                        <div
                                                            key={dateStr}
                                                            className={`
                                                            text-center p-1 rounded mobile-text-xs min-h-10 flex flex-col justify-center cursor-pointer hover:bg-white hover:bg-opacity-10 transition-all duration-200
                                                            ${isCurrentMonth ? 'text-white' : 'text-gray-600'}
                                                            ${isToday ? 'gradient-button' : ''}
                                                        `}
                                                            onClick={() => {
                                                                if (dayHours > 0) {
                                                                    openDailyHoursModal(dateStr);
                                                                }
                                                            }}
                                                        >
                                                            <div className={`font-bold ${!isToday ? (dayOfWeek === 0 || isHoliday ? 'text-red-300' : dayOfWeek === 6 ? 'text-blue-300' : 'text-white') : 'text-white'}`}>
                                                                {current.getDate()}
                                                            </div>
                                                            <div className={`mobile-text-xs h-4 ${isToday ? 'text-white' : 'text-gray-300'}`}>
                                                                {dayHours > 0 ? `${dayHours.toFixed(1)}h` : ''}
                                                            </div>
                                                        </div>
                                                    );
                                                    current.setDate(current.getDate() + 1);
                                                }
                                                return days;
                                            })()}
                                        </div>
                                    </div>

                                    {/* 自分の工数サマリー */}
                                    <div className="glass-card p-3 rounded-2xl">
                                        <h3 className="text-base font-bold text-white mb-2">自分の工数サマリー</h3>
                                        <div className="grid grid-cols-3 gap-2 mb-3">
                                            <div className="text-center">
                                                <div className="font-bold text-white mobile-text-sm">
                                                    {workSessions.filter(s => s.userId === user.uid)
                                                        .reduce((sum, s) => sum + (s.hours || 0), 0).toFixed(1)}h
                                                </div>
                                                <div className="text-gray-400 mobile-text-xs">総工数</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="font-bold text-white mobile-text-sm">
                                                    {new Set(workSessions.filter(s => s.userId === user.uid)
                                                        .map(s => s.projectId)).size}
                                                </div>
                                                <div className="text-gray-400 mobile-text-xs">参加案件数</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="font-bold text-white mobile-text-sm">
                                                    {new Set(workSessions.filter(s => s.userId === user.uid)
                                                        .map(s => s.taskId)).size}
                                                </div>
                                                <div className="text-gray-400 mobile-text-xs">作業工程数</div>
                                            </div>
                                        </div>

                                        {/* プロジェクト別工数 */}
                                        <div className="space-y-3">
                                            {projects.filter(p =>
                                                workSessions.some(s => s.userId === user.uid && s.projectId === p.id)
                                            ).map(project => {
                                                const projectHours = workSessions
                                                    .filter(s => s.userId === user.uid && s.projectId === project.id)
                                                    .reduce((sum, s) => sum + (s.hours || 0), 0);

                                                return (
                                                    <div key={project.id} className="glass-card-dark p-3 rounded-lg">
                                                        <div className="flex justify-between items-center">
                                                            <div className="flex-1 min-w-0">
                                                                <h4 className="font-bold text-white mobile-text-sm truncate">{project.name}</h4>
                                                                {project.company && (
                                                                    <div className="text-purple-300 mobile-text-xs truncate">{project.company}</div>
                                                                )}
                                                            </div>
                                                            <div className="text-right ml-2">
                                                                <span className="font-bold text-white mobile-text-sm">
                                                                    {projectHours.toFixed(1)}h
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    {/* 自分の作業履歴 */}
                                    <div className="glass-card p-3 rounded-2xl">
                                        <h3 className="text-base font-bold text-white mb-3">作業履歴</h3>

                                        {(() => {
                                            // 現在のユーザーの作業セッションをフィルタリング
                                            const userWorkSessions = workSessions.filter(s => s.userId === user.uid);

                                            if (userWorkSessions.length === 0) {
                                                return (
                                                    <div className="text-center text-gray-400 py-4">
                                                        <p className="mobile-text-sm">作業履歴がありません</p>
                                                    </div>
                                                );
                                            }

                                            // 日付でのフィルタリング
                                            let filteredSessions = userWorkSessions;
                                            if (workHistoryFilter !== 'all') {
                                                const now = new Date();
                                                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                                                // 今週の開始日（日曜日）と終了日（土曜日）
                                                const thisWeekStart = new Date(today);
                                                thisWeekStart.setDate(today.getDate() - today.getDay());
                                                const thisWeekEnd = new Date(thisWeekStart);
                                                thisWeekEnd.setDate(thisWeekStart.getDate() + 6);
                                                thisWeekEnd.setHours(23, 59, 59, 999);

                                                const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                                                const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                                                const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
                                                lastMonthEnd.setHours(23, 59, 59, 999);

                                                filteredSessions = userWorkSessions.filter(session => {
                                                    if (!session.date) return false;

                                                    let sessionDate;
                                                    if (session.date.toDate) {
                                                        sessionDate = session.date.toDate();
                                                    } else {
                                                        sessionDate = new Date(session.date);
                                                    }

                                                    // セッション日付を日付のみで比較（時間を0時0分0秒に設定）
                                                    const sessionDateOnly = new Date(sessionDate.getFullYear(), sessionDate.getMonth(), sessionDate.getDate());

                                                    switch (workHistoryFilter) {
                                                        case 'today':
                                                            return sessionDateOnly.getTime() === today.getTime();
                                                        case 'thisweek':
                                                            return sessionDateOnly >= thisWeekStart && sessionDateOnly <= thisWeekEnd;
                                                        case 'thismonth':
                                                            return sessionDateOnly >= thisMonthStart;
                                                        case 'lastmonth':
                                                            return sessionDateOnly >= lastMonthStart && sessionDateOnly <= lastMonthEnd;
                                                        default:
                                                            return true;
                                                    }
                                                });
                                            }

                                            // 検索クエリでのフィルタリング
                                            if (searchQuery.trim()) {
                                                filteredSessions = filteredSessions.filter(session =>
                                                    (session.taskName || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
                                                    (session.projectName || '').toLowerCase().includes(searchQuery.toLowerCase())
                                                );
                                            }

                                            // ソート
                                            filteredSessions.sort((a, b) => {
                                                switch (sortOption) {
                                                    case 'date-asc':
                                                        // 日付がない場合は最後に配置
                                                        if (!a.date && !b.date) return 0;
                                                        if (!a.date) return 1;
                                                        if (!b.date) return -1;

                                                        const dateA = a.date.toDate ? a.date.toDate() : new Date(a.date);
                                                        const dateB = b.date.toDate ? b.date.toDate() : new Date(b.date);
                                                        const timeDiff = dateA.getTime() - dateB.getTime();

                                                        // 日付が同じ場合は作成順（ID順）でソート
                                                        if (timeDiff === 0) {
                                                            return (a.id || '').localeCompare(b.id || '');
                                                        }
                                                        return timeDiff;

                                                    case 'date-desc':
                                                    default:
                                                        // 日付がない場合は最後に配置
                                                        if (!a.date && !b.date) return 0;
                                                        if (!a.date) return 1;
                                                        if (!b.date) return -1;

                                                        const dateA2 = a.date.toDate ? a.date.toDate() : new Date(a.date);
                                                        const dateB2 = b.date.toDate ? b.date.toDate() : new Date(b.date);
                                                        const timeDiff2 = dateB2.getTime() - dateA2.getTime();

                                                        // 日付が同じ場合は作成順（ID順）でソート
                                                        if (timeDiff2 === 0) {
                                                            return (b.id || '').localeCompare(a.id || '');
                                                        }
                                                        return timeDiff2;

                                                    case 'hours-asc':
                                                        const hoursDiff1 = (a.hours || 0) - (b.hours || 0);
                                                        // 工数が同じ場合は日付でソート
                                                        if (hoursDiff1 === 0) {
                                                            if (!a.date && !b.date) return 0;
                                                            if (!a.date) return 1;
                                                            if (!b.date) return -1;
                                                            const dateA3 = a.date.toDate ? a.date.toDate() : new Date(a.date);
                                                            const dateB3 = b.date.toDate ? b.date.toDate() : new Date(b.date);
                                                            return dateB3.getTime() - dateA3.getTime();
                                                        }
                                                        return hoursDiff1;

                                                    case 'hours-desc':
                                                        const hoursDiff2 = (b.hours || 0) - (a.hours || 0);
                                                        // 工数が同じ場合は日付でソート
                                                        if (hoursDiff2 === 0) {
                                                            if (!a.date && !b.date) return 0;
                                                            if (!a.date) return 1;
                                                            if (!b.date) return -1;
                                                            const dateA4 = a.date.toDate ? a.date.toDate() : new Date(a.date);
                                                            const dateB4 = b.date.toDate ? b.date.toDate() : new Date(b.date);
                                                            return dateB4.getTime() - dateA4.getTime();
                                                        }
                                                        return hoursDiff2;
                                                }
                                            });

                                            if (filteredSessions.length === 0) {
                                                return (
                                                    <div className="text-center text-gray-400 py-4">
                                                        <p className="mobile-text-sm">
                                                            {searchQuery ? '検索に一致する作業履歴がありません' :
                                                                workHistoryFilter === 'today' ? '今日の作業履歴がありません' :
                                                                    workHistoryFilter === 'thisweek' ? '今週の作業履歴がありません' :
                                                                        workHistoryFilter === 'thismonth' ? '今月の作業履歴がありません' :
                                                                            workHistoryFilter === 'lastmonth' ? '先月の作業履歴がありません' : '作業履歴がありません'}
                                                        </p>
                                                    </div>
                                                );
                                            }

                                            return (
                                                <div className="space-y-3">
                                                    {filteredSessions.map(session => {
                                                        const sessionDate = session.date?.toDate ? session.date.toDate() : new Date(session.date);
                                                        const formattedDate = sessionDate.toLocaleDateString('ja-JP', {
                                                            year: 'numeric',
                                                            month: '2-digit',
                                                            day: '2-digit'
                                                        });

                                                        // プロジェクトと会社情報を取得
                                                        const project = projects.find(p => p.id === session.projectId);
                                                        const company = companies.find(c => c.id === project?.companyId);
                                                        const companyName = company?.name || project?.companyName || session.companyName || project?.company || '会社名不明';

                                                        return (
                                                            <div key={session.id} className="glass-card-dark p-3 rounded-xl">
                                                                <div className="flex justify-between items-start">
                                                                    <div className="flex-1 min-w-0">
                                                                        <div className="flex items-center gap-2 mb-1">
                                                                            <span className="mobile-text-xs text-gray-400">{formattedDate}</span>
                                                                        </div>
                                                                        <h4 className="font-bold text-white mobile-text-sm truncate">
                                                                            {session.projectName}
                                                                        </h4>
                                                                        <p className="text-purple-300 mobile-text-xs truncate">
                                                                            {companyName}
                                                                        </p>
                                                                        <p className="text-gray-400 mobile-text-xs truncate">
                                                                            {session.taskName}
                                                                        </p>
                                                                    </div>
                                                                    <div className="text-right ml-2">
                                                                        <span className="font-bold text-white mobile-text-sm">
                                                                            {(session.hours || 0).toFixed(1)}h
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            );
                                        })()}
                                    </div>
                                </div>


                            </div>
                        )}

                        {deleteConfirm.show && (
                            <div className="modal-overlay" onClick={() => setDeleteConfirm({ show: false, type: '', id: null, name: '', inputName: '' })}>
                                <div className="modal-content glass-card mobile-compact-card rounded-2xl w-full max-w-md mx-4" onClick={(e) => e.stopPropagation()}>
                                    <div className="text-center">
                                        {/* カスタム注意アイコン */}
                                        <div className="flex justify-center mb-4 mt-2">
                                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="gray" strokeWidth="1.5">
                                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                                                <line x1="12" y1="9" x2="12" y2="13" />
                                                <circle cx="12" cy="17" r="0.5" fill="white" />
                                            </svg>
                                        </div>
                                        <div className="text-gray-300 mb-4 text-sm">
                                            <p className="mb-3">
                                                {deleteConfirm.type === 'project' ? '案件' :
                                                    deleteConfirm.type === 'task' ? '工程' :
                                                        deleteConfirm.type === 'company' ? '会社' :
                                                            deleteConfirm.type === 'template' ? '工程テンプレート' :
                                                                deleteConfirm.type === 'checklist' ? '検査リストテンプレート' :
                                                                    deleteConfirm.type === 'projectChecklist' ? '検査リスト' :
                                                                        deleteConfirm.type === 'wiring' ? '配線仕様テンプレート' :
                                                                            deleteConfirm.type === 'projectWiring' ? '配線仕様' : ''}
                                                「{deleteConfirm.name}」を削除しますか？
                                            </p>

                                            <div className="mb-4">
                                                <p className="text-gray-400 text-xs mb-2">
                                                    削除を確認するため、以下の名前を正確に入力してください：
                                                </p>
                                                <div className="bg-gray-800 bg-opacity-50 rounded-lg p-2 mb-2">
                                                    <span className="text-white font-mono text-sm">{deleteConfirm.name}</span>
                                                </div>
                                                <input
                                                    type="text"
                                                    value={deleteConfirm.inputName}
                                                    onChange={(e) => setDeleteConfirm({ ...deleteConfirm, inputName: e.target.value })}
                                                    placeholder="削除対象の名前を入力してください"
                                                    className="w-full px-3 py-2 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-yellow-500 focus:outline-none text-sm"
                                                />
                                            </div>

                                            {deleteConfirm.type === 'project' && (
                                                <span className="block text-red-300 text-xs mt-2">
                                                    ※ 関連する工程もすべて削除されます
                                                </span>
                                            )}
                                            {deleteConfirm.type === 'task' && (
                                                <span className="block text-red-300 text-xs mt-2">
                                                    ※ 関連する検査リストもすべて削除されます
                                                </span>
                                            )}
                                            {deleteConfirm.type === 'company' && (
                                                <span className="block text-red-300 text-xs mt-2">
                                                    ※ この会社の工程テンプレート・配線仕様テンプレート・検査リストテンプレートも削除されます
                                                </span>
                                            )}
                                            {deleteConfirm.type === 'template' && (
                                                <span className="block text-red-300 text-xs mt-2">
                                                    ※ この工程テンプレートは完全に削除されます
                                                </span>
                                            )}
                                            {deleteConfirm.type === 'checklist' && (
                                                <span className="block text-red-300 text-xs mt-2">
                                                    ※ この検査リストテンプレートは完全に削除されます
                                                </span>
                                            )}
                                            {deleteConfirm.type === 'projectChecklist' && (
                                                <span className="block text-red-300 text-xs mt-2">
                                                    ※ この検査リストの全ての検査記録が削除されます
                                                </span>
                                            )}
                                            {deleteConfirm.type === 'wiring' && (
                                                <span className="block text-red-300 text-xs mt-2">
                                                    ※ この配線仕様テンプレートは完全に削除されます
                                                </span>
                                            )}
                                            {deleteConfirm.type === 'projectWiring' && (
                                                <span className="block text-red-300 text-xs mt-2">
                                                    ※ この案件の配線仕様設定が削除されます
                                                </span>
                                            )}
                                        </div>
                                        <div className="flex gap-2 mb-1.5">
                                            <button
                                                onClick={() => setDeleteConfirm({ show: false, type: '', id: null, name: '', inputName: '' })}
                                                className="flex-1 glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm"
                                            >
                                                キャンセル
                                            </button>
                                            <button
                                                onClick={handleDelete}
                                                disabled={deleteConfirm.inputName !== deleteConfirm.name}
                                                className={`flex-1 px-4 py-3 rounded-xl font-bold transition-all duration-300 text-sm ${deleteConfirm.inputName === deleteConfirm.name
                                                    ? 'gradient-red text-white hover:shadow-lg cursor-pointer'
                                                    : 'bg-gray-600 bg-opacity-50 text-gray-400 cursor-not-allowed'
                                                    }`}
                                            >
                                                削除
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 検査モーダル */}
                        {showChecklistModal && currentProjectChecklist && (
                            <div className="modal-overlay" onClick={() => setShowChecklistModal(false)}>
                                <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-4xl mx-4"
                                    onClick={(e) => e.stopPropagation()}
                                    style={{ maxHeight: '90vh', overflowY: 'auto' }}>
                                    <div className="mb-4">
                                        <h3 className="text-base font-bold text-white pt-2">検査リスト</h3>
                                    </div>

                                    <div className="space-y-3">
                                        {currentProjectChecklist.categories.map((category, catIndex) => (
                                            <div key={catIndex} className="glass-card-dark mobile-compact-card rounded-xl">
                                                <h4 className="font-bold text-white mobile-text-sm mb-3 mt-1">{category.name}</h4>
                                                <div className="space-y-3 mb-1">
                                                    {category.items.map((item, itemIndex) => (
                                                        <div key={itemIndex} className="glass-card rounded-lg mobile-compact-card"
                                                            style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)', marginBottom: '0' }}>
                                                            <div className="flex-1 mb-3">
                                                                <p className="text-white font-medium mobile-text-sm">{item.name}</p>
                                                                {item.description && (
                                                                    <p className="text-gray-400 mobile-text-xs mt-1">{item.description}</p>
                                                                )}
                                                            </div>

                                                            {/* Combined checkbox and user info section */}
                                                            <div className="flex flex-col gap-2 mb-1">
                                                                <div className="flex items-center justify-between h-[48px]">
                                                                    <label className={`flex items-center gap-2 ${currentProjectChecklist.isTaskCompleted ? 'cursor-default opacity-50 pointer-events-none' : 'cursor-pointer'}`}>
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={item.firstCheck || false}
                                                                            onChange={(e) => {
                                                                                if (!currentProjectChecklist.isTaskCompleted) {
                                                                                    updateChecklistItem(catIndex, itemIndex, 'firstCheck', e.target.checked);
                                                                                }
                                                                            }}
                                                                            disabled={currentProjectChecklist.isTaskCompleted}
                                                                        />
                                                                        <span className="text-gray-300 mobile-text-sm">1次</span>
                                                                    </label>
                                                                    {item.firstCheck && item.firstCheckByName && (
                                                                        <div className="mobile-text-xs text-gray-400 flex items-center gap-2">
                                                                            <span
                                                                                className="text-white font-bold px-2 py-1 rounded-full"
                                                                                style={{
                                                                                    fontSize: '8px',
                                                                                    background: getUserIconColor(item.firstCheckBy)
                                                                                }}
                                                                            >
                                                                                {item.firstCheckByName}
                                                                            </span>
                                                                            {item.firstCheckAt && (
                                                                                <span className="text-gray-400 mobile-text-xs">
                                                                                    ({new Date(item.firstCheckAt).toLocaleString('ja-JP', {
                                                                                        month: 'numeric',
                                                                                        day: 'numeric',
                                                                                        hour: '2-digit',
                                                                                        minute: '2-digit'
                                                                                    })})
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                                {currentProjectChecklist.checkType !== 'single' && (
                                                                    <div className="flex items-center justify-between h-[48px]">
                                                                        <label className={`flex items-center gap-2 ${currentProjectChecklist.isTaskCompleted ? 'cursor-default opacity-50 pointer-events-none' : 'cursor-pointer'}`}>
                                                                            <input
                                                                                type="checkbox"
                                                                                checked={item.secondCheck || false}
                                                                                onChange={(e) => {
                                                                                    if (!currentProjectChecklist.isTaskCompleted) {
                                                                                        updateChecklistItem(catIndex, itemIndex, 'secondCheck', e.target.checked);
                                                                                    }
                                                                                }}
                                                                                disabled={currentProjectChecklist.isTaskCompleted}
                                                                            />
                                                                            <span className="text-gray-300 mobile-text-sm">2次</span>
                                                                        </label>
                                                                        {item.secondCheck && item.secondCheckByName && (
                                                                            <div className="mobile-text-xs text-gray-400 flex items-center gap-2">
                                                                                <span
                                                                                    className="text-white font-bold px-2 py-1 rounded-full"
                                                                                    style={{
                                                                                        fontSize: '8px',
                                                                                        background: getUserIconColor(item.secondCheckBy)
                                                                                    }}
                                                                                >
                                                                                    {item.secondCheckByName}
                                                                                </span>
                                                                                {item.secondCheckAt && (
                                                                                    <span className="text-gray-400 mobile-text-xs">
                                                                                        ({new Date(item.secondCheckAt).toLocaleString('ja-JP', {
                                                                                            month: 'numeric',
                                                                                            day: 'numeric',
                                                                                            hour: '2-digit',
                                                                                            minute: '2-digit'
                                                                                        })})
                                                                                    </span>
                                                                                )}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="mt-3 mobile-compact-card glass-card-dark rounded-xl">
                                        <div className={`grid gap-3 mobile-text-sm ${currentProjectChecklist.checkType === 'single' ? 'grid-cols-1' : 'grid-cols-1 sm:grid-cols-2'}`}>
                                            <div className="text-center sm:text-left">
                                                <span className="text-gray-400">1次完了: </span>
                                                <span className="text-white font-bold">
                                                    {currentProjectChecklist.categories.reduce((total, cat) =>
                                                        total + cat.items.filter(item => item.firstCheck).length, 0
                                                    )} / {currentProjectChecklist.categories.reduce((total, cat) =>
                                                        total + cat.items.length, 0
                                                    )}
                                                </span>
                                            </div>
                                            {currentProjectChecklist.checkType !== 'single' && (
                                                <div className="text-center sm:text-left">
                                                    <span className="text-gray-400">2次完了: </span>
                                                    <span className="text-white font-bold">
                                                        {currentProjectChecklist.categories.reduce((total, cat) =>
                                                            total + cat.items.filter(item => item.secondCheck).length, 0
                                                        )} / {currentProjectChecklist.categories.reduce((total, cat) =>
                                                            total + cat.items.length, 0
                                                        )}
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="mt-6 mb-1.5">
                                        <button
                                            onClick={() => setShowChecklistModal(false)}
                                            className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                        >
                                            閉じる
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* チェックリスト編集モーダル */}
                        {showEditChecklistModal && editingProjectChecklist && (
                            <div className="modal-overlay" onClick={() => {
                                setShowEditChecklistModal(false);
                                setEditingProjectChecklist(null);
                            }}>
                                <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-4xl mx-4"
                                    onClick={(e) => e.stopPropagation()}
                                    style={{ maxHeight: '90vh', overflowY: 'auto' }}>
                                    <div className="mb-4">
                                        <h3 className="text-base font-bold text-white pt-2">検査リスト編集</h3>
                                    </div>

                                    {/* チェックリスト名の入力フィールド */}
                                    <input
                                        type="text"
                                        placeholder="検査リスト名"
                                        value={editingProjectChecklist.templateName || editingProjectChecklist.name || ''}
                                        onChange={(e) => setEditingProjectChecklist({
                                            ...editingProjectChecklist,
                                            templateName: e.target.value,
                                            name: e.target.value
                                        })}
                                        className="w-full dark-input rounded-xl px-4 py-3 mb-3 text-sm focus:outline-none"
                                    />

                                    {/* チェックタイプ選択 */}
                                    <div className="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-6 mb-4">
                                        <span className="text-white font-medium mobile-text-sm">チェック項目数:</span>
                                        <div className="flex gap-4">
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input
                                                    type="radio"
                                                    name="editCheckType"
                                                    value="single"
                                                    checked={editingProjectChecklist.checkType === 'single'}
                                                    onChange={(e) => setEditingProjectChecklist({
                                                        ...editingProjectChecklist,
                                                        checkType: e.target.value
                                                    })}
                                                />
                                                <span className="text-gray-300 mobile-text-sm">1次のみ</span>
                                            </label>
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input
                                                    type="radio"
                                                    name="editCheckType"
                                                    value="double"
                                                    checked={editingProjectChecklist.checkType === 'double' || !editingProjectChecklist.checkType}
                                                    onChange={(e) => setEditingProjectChecklist({
                                                        ...editingProjectChecklist,
                                                        checkType: e.target.value
                                                    })}
                                                />
                                                <span className="text-gray-300 mobile-text-sm">1次・2次</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div className="mb-6">
                                        {editingProjectChecklist.categories.map((category, catIndex) => {
                                            const isCategoryDragging = draggedChecklistCategory && draggedChecklistCategory.index === catIndex;
                                            const isCategoryDragOver = dragOverChecklistCategory && dragOverChecklistCategory.index === catIndex;

                                            return (
                                                <div key={catIndex}
                                                    data-category-index={catIndex}
                                                    className={`glass-card-dark mobile-compact-card rounded-xl task-draggable ${isCategoryDragging ? 'task-dragging' : ''} ${isCategoryDragOver ? 'task-drag-over' : ''}`}
                                                    style={{
                                                        boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)',
                                                        marginBottom: '12px',
                                                        paddingBottom: '6px'
                                                    }}
                                                    draggable="true"
                                                    onDragStart={(e) => {
                                                        setDraggedChecklistCategory({ index: catIndex, category });
                                                        e.dataTransfer.effectAllowed = 'move';
                                                        e.dataTransfer.setData('text/html', e.target.outerHTML);
                                                        e.target.style.opacity = '0.5';
                                                    }}
                                                    onDragEnd={(e) => {
                                                        e.target.style.opacity = '1';
                                                        setDraggedChecklistCategory(null);
                                                        setDragOverChecklistCategory(null);
                                                        setTimeout(() => {
                                                            setDragOverChecklistCategory(null);
                                                        }, 50);
                                                    }}
                                                    onDragOver={(e) => {
                                                        e.preventDefault();
                                                        e.dataTransfer.dropEffect = 'move';
                                                        const categoryElement = e.currentTarget.closest('.task-draggable');
                                                        if (categoryElement && draggedChecklistCategory) {
                                                            const categoryIndex = parseInt(categoryElement.getAttribute('data-category-index'));
                                                            if (categoryIndex !== draggedChecklistCategory.index) {
                                                                setDragOverChecklistCategory({ index: categoryIndex, category: editingProjectChecklist.categories[categoryIndex] });
                                                            }
                                                        }
                                                    }}
                                                    onDragEnter={(e) => {
                                                        e.preventDefault();
                                                        if (draggedChecklistCategory && catIndex !== draggedChecklistCategory.index) {
                                                            setDragOverChecklistCategory({ index: catIndex, category });
                                                        }
                                                    }}
                                                    onDragLeave={(e) => {
                                                        const relatedTarget = e.relatedTarget;
                                                        const currentTarget = e.currentTarget;
                                                        if (!relatedTarget || !currentTarget.contains(relatedTarget)) {
                                                            setDragOverChecklistCategory(null);
                                                        }
                                                    }}
                                                    onDrop={(e) => {
                                                        e.preventDefault();
                                                        setDragOverChecklistCategory(null);

                                                        if (!draggedChecklistCategory || draggedChecklistCategory.index === catIndex) {
                                                            return;
                                                        }

                                                        const dragIndex = draggedChecklistCategory.index;
                                                        const dropIndex = catIndex;
                                                        const updated = { ...editingProjectChecklist };
                                                        const draggedItem = updated.categories[dragIndex];
                                                        updated.categories.splice(dragIndex, 1);
                                                        updated.categories.splice(dropIndex, 0, draggedItem);
                                                        setEditingProjectChecklist(updated);
                                                    }}>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <input
                                                            type="text"
                                                            value={category.name}
                                                            onChange={(e) => {
                                                                const updated = { ...editingProjectChecklist };
                                                                updated.categories[catIndex].name = e.target.value;
                                                                setEditingProjectChecklist(updated);
                                                            }}
                                                            className={`flex-1 dark-input rounded-xl px-3 py-3 text-xs focus:outline-none ${editingProjectChecklist.categories.length > 1 ? 'mr-2' : ''}`}
                                                            placeholder="カテゴリ名"
                                                        />
                                                        {editingProjectChecklist.categories.length > 1 && (
                                                            <button
                                                                onClick={() => {
                                                                    const updated = { ...editingProjectChecklist };
                                                                    updated.categories = updated.categories.filter((_, i) => i !== catIndex);
                                                                    setEditingProjectChecklist(updated);
                                                                }}
                                                                className="text-gray-400 hover:text-white text-xl flex-shrink-0"
                                                            >
                                                                ✕
                                                            </button>
                                                        )}
                                                    </div>

                                                    <div className="space-y-2 ml-2 sm:ml-4">
                                                        {category.items.map((item, itemIndex) => {
                                                            const isItemDragging = draggedChecklistItem && draggedChecklistItem.catIndex === catIndex && draggedChecklistItem.itemIndex === itemIndex;
                                                            const isItemDragOver = dragOverChecklistItem && dragOverChecklistItem.catIndex === catIndex && dragOverChecklistItem.itemIndex === itemIndex;

                                                            return (
                                                                <div key={itemIndex}
                                                                    data-category-index={catIndex}
                                                                    data-item-index={itemIndex}
                                                                    className={`space-y-2 task-draggable ${isItemDragging ? 'task-dragging' : ''} ${isItemDragOver ? 'task-drag-over' : ''}`}
                                                                    draggable="true"
                                                                    onDragStart={(e) => {
                                                                        setDraggedChecklistItem({ catIndex, itemIndex, item });
                                                                        e.dataTransfer.effectAllowed = 'move';
                                                                        e.dataTransfer.setData('text/html', e.target.outerHTML);
                                                                        e.target.style.opacity = '0.5';
                                                                    }}
                                                                    onDragEnd={(e) => {
                                                                        e.target.style.opacity = '1';
                                                                        setDraggedChecklistItem(null);
                                                                        setDragOverChecklistItem(null);
                                                                        setTimeout(() => {
                                                                            setDragOverChecklistItem(null);
                                                                        }, 50);
                                                                    }}
                                                                    onDragOver={(e) => {
                                                                        e.preventDefault();
                                                                        e.dataTransfer.dropEffect = 'move';
                                                                        if (draggedChecklistItem) {
                                                                            if (draggedChecklistItem.catIndex === catIndex &&
                                                                                draggedChecklistItem.itemIndex !== itemIndex) {
                                                                                setDragOverChecklistItem({ catIndex, itemIndex, item });
                                                                            }
                                                                        }
                                                                    }}
                                                                    onDragEnter={(e) => {
                                                                        e.preventDefault();
                                                                        if (draggedChecklistItem &&
                                                                            draggedChecklistItem.catIndex === catIndex &&
                                                                            draggedChecklistItem.itemIndex !== itemIndex) {
                                                                            setDragOverChecklistItem({ catIndex, itemIndex, item });
                                                                        }
                                                                    }}
                                                                    onDragLeave={(e) => {
                                                                        const relatedTarget = e.relatedTarget;
                                                                        const currentTarget = e.currentTarget;
                                                                        if (!relatedTarget || !currentTarget.contains(relatedTarget)) {
                                                                            setDragOverChecklistItem(null);
                                                                        }
                                                                    }}
                                                                    onDrop={(e) => {
                                                                        e.preventDefault();
                                                                        setDragOverChecklistItem(null);

                                                                        if (!draggedChecklistItem ||
                                                                            draggedChecklistItem.catIndex !== catIndex ||
                                                                            draggedChecklistItem.itemIndex === itemIndex) {
                                                                            return;
                                                                        }

                                                                        const dragIndex = draggedChecklistItem.itemIndex;
                                                                        const dropIndex = itemIndex;
                                                                        const updated = { ...editingProjectChecklist };
                                                                        const draggedItem = updated.categories[catIndex].items[dragIndex];
                                                                        updated.categories[catIndex].items.splice(dragIndex, 1);
                                                                        updated.categories[catIndex].items.splice(dropIndex, 0, draggedItem);
                                                                        setEditingProjectChecklist(updated);
                                                                    }}>
                                                                    <div className="flex gap-2">
                                                                        <input
                                                                            type="text"
                                                                            value={item.name}
                                                                            onChange={(e) => {
                                                                                const updated = { ...editingProjectChecklist };
                                                                                updated.categories[catIndex].items[itemIndex].name = e.target.value;
                                                                                setEditingProjectChecklist(updated);
                                                                            }}
                                                                            className="flex-1 dark-input rounded-xl px-3 py-3 text-xs focus:outline-none"
                                                                            placeholder="検査項目"
                                                                        />
                                                                        {category.items.length > 1 && (
                                                                            <button
                                                                                onClick={() => {
                                                                                    const updated = { ...editingProjectChecklist };
                                                                                    updated.categories[catIndex].items = updated.categories[catIndex].items.filter((_, i) => i !== itemIndex);
                                                                                    setEditingProjectChecklist(updated);
                                                                                }}
                                                                                className="text-gray-400 hover:text-white text-xl flex-shrink-0"
                                                                            >
                                                                                ✕
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                    <input
                                                                        type="text"
                                                                        value={item.description || ''}
                                                                        onChange={(e) => {
                                                                            const updated = { ...editingProjectChecklist };
                                                                            updated.categories[catIndex].items[itemIndex].description = e.target.value;
                                                                            setEditingProjectChecklist(updated);
                                                                        }}
                                                                        className="w-full dark-input rounded-xl px-3 py-3 text-xs focus:outline-none"
                                                                        placeholder="備考（任意）"
                                                                    />
                                                                </div>
                                                            );
                                                        })}
                                                        <button
                                                            onClick={() => {
                                                                const updated = { ...editingProjectChecklist };
                                                                updated.categories[catIndex].items.push({
                                                                    name: '',
                                                                    description: '',
                                                                    firstCheck: false,
                                                                    secondCheck: false
                                                                });
                                                                setEditingProjectChecklist(updated);
                                                            }}
                                                            className="mobile-text-xs text-gray-400 hover:text-white"
                                                        >
                                                            + 項目を追加
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}

                                        <button
                                            onClick={() => {
                                                const updated = { ...editingProjectChecklist };
                                                updated.categories.push({
                                                    name: '',
                                                    items: [{
                                                        name: '',
                                                        description: '',
                                                        firstCheck: false,
                                                        secondCheck: false
                                                    }]
                                                });
                                                setEditingProjectChecklist(updated);
                                            }}
                                            className="w-full glass-card-dark text-white py-2 rounded-lg mobile-text-sm"
                                        >
                                            + カテゴリを追加
                                        </button>
                                    </div>

                                    <div className="grid grid-cols-1 gap-2 mb-1.5">
                                        <button
                                            onClick={saveEditedChecklist}
                                            className="gradient-button text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 text-sm w-full"
                                        >
                                            更新
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowEditChecklistModal(false);
                                                setEditingProjectChecklist(null); // nullに設定して完全にクリア
                                            }}
                                            className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                        >
                                            キャンセル
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 配線仕様モーダル */}
                        {showWiringModal && currentProjectWiring && (
                            <div className="modal-overlay" onClick={() => setShowWiringModal(false)}>
                                <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-5xl mx-4"
                                    onClick={(e) => e.stopPropagation()}
                                    style={{ maxHeight: '90vh', overflowY: 'auto' }}>
                                    <div className="mb-4">
                                        <h3 className="text-base font-bold text-white pt-2">配線仕様: {currentProjectWiring.templateName}</h3>
                                    </div>

                                    {(() => {
                                        const specs = currentProjectWiring.specifications;

                                        return (
                                            <div className="space-y-3">
                                                {/* 使用電線セクション */}
                                                {((specs.wire.power.standards?.length > 0 || specs.wire.power.wiringType || Object.keys(specs.wire.power.phases || {}).some(key => specs.wire.power.phases[key]) || specs.wire.power.remarks) ||
                                                    (specs.wire.ground.caseColor || specs.wire.ground.doorColor || specs.wire.ground.panelColor || specs.wire.ground.remarks) ||
                                                    specs.wire.insulationCap ||
                                                    (specs.wire.controlAC.standards?.length > 0 || specs.wire.controlAC.commonColor || specs.wire.controlAC.nonCommonColor || specs.wire.controlAC.remarks) ||
                                                    (specs.wire.controlDC.standards?.length > 0 || specs.wire.controlDC.pBusColor || specs.wire.controlDC.nBusColor || specs.wire.controlDC.otherColor || specs.wire.controlDC.remarks) ||
                                                    specs.wire.specialSpec ||
                                                    (specs.wire.manufacturerSpecified && specs.wire.manufacturer)) && (
                                                        <div className="glass-card-dark mobile-compact-card rounded-xl mb-4" style={{ padding: '8px 12px 12px 12px' }}>
                                                            <h4 className="mobile-text-sm font-bold text-white mb-2 mt-1">電線</h4>
                                                            <div className="space-y-3">
                                                                {/* 動力 */}
                                                                {(specs.wire.power.standards?.length > 0 || specs.wire.power.wiringType || Object.keys(specs.wire.power.phases || {}).some(key => specs.wire.power.phases[key]) || specs.wire.power.remarks) && (
                                                                    <div>
                                                                        <h5 className="mobile-text-sm font-bold text-white mb-3">動力</h5>

                                                                        <div className="space-y-3">
                                                                            {/* 規格 */}
                                                                            {specs.wire.power.standards?.length > 0 && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">規格</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">使用する電線規格</p>
                                                                                    </div>
                                                                                    <div className="text-right">
                                                                                        <span className="text-white mobile-text-sm">
                                                                                            {specs.wire.power.standards.map((standard, index) =>
                                                                                                standard === 'その他' && specs.wire.power[`customStandard${index}`]
                                                                                                    ? specs.wire.power[`customStandard${index}`]
                                                                                                    : standard
                                                                                            ).join(', ')}
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {/* 配線方式 */}
                                                                            {specs.wire.power.wiringType && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">配線方式</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">使用する配線方式</p>
                                                                                    </div>
                                                                                    <div className="text-right">
                                                                                        <span className="text-white mobile-text-sm">
                                                                                            {specs.wire.power.wiringType === 'three-phase-4' ? '三相4線' :
                                                                                                specs.wire.power.wiringType === 'three-phase-3' ? '三相3線' :
                                                                                                    specs.wire.power.wiringType === 'single-phase-3' ? '単相3線' :
                                                                                                        specs.wire.power.wiringType === 'single-phase-2' ? '単相2線' :
                                                                                                            specs.wire.power.wiringType}
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {/* 相線色（相ごとに個別表示） */}
                                                                            {['rPhase', 'sPhase', 'tPhase', 'lPhase', 'nPhase']
                                                                                .filter(key => specs.wire.power.phases[key])
                                                                                .map((key) => (
                                                                                    <div key={key} className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                        <div className="flex-1">
                                                                                            <p className="text-white font-medium mobile-text-sm">
                                                                                                {key === 'rPhase' ? 'R相' :
                                                                                                    key === 'sPhase' ? 'S相' :
                                                                                                        key === 'tPhase' ? 'T相' :
                                                                                                            key === 'lPhase' ? 'L相' :
                                                                                                                key === 'nPhase' ? 'N相' :
                                                                                                                    key.replace('Phase', '相')}
                                                                                            </p>
                                                                                            <p className="text-gray-400 mobile-text-xs">
                                                                                                {key === 'rPhase' ? 'R相の仕様' :
                                                                                                    key === 'sPhase' ? 'S相の仕様' :
                                                                                                        key === 'tPhase' ? 'T相の仕様' :
                                                                                                            key === 'lPhase' ? 'L相の仕様' :
                                                                                                                key === 'nPhase' ? 'N相の仕様' :
                                                                                                                    key.replace('Phase', '相の仕様')}
                                                                                            </p>
                                                                                        </div>
                                                                                        <div className="text-right flex-1 ml-4">
                                                                                            <p className="text-white font-medium mobile-text-sm">
                                                                                                {specs.wire.power.phases[key] === 'その他' && specs.wire.power[`${key}Custom`]
                                                                                                    ? specs.wire.power[`${key}Custom`]
                                                                                                    : specs.wire.power.phases[key]}
                                                                                            </p>
                                                                                        </div>
                                                                                    </div>
                                                                                ))}

                                                                            {/* 備考 */}
                                                                            {specs.wire.power.remarks && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">備考</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">追加の仕様や特殊仕様</p>
                                                                                    </div>
                                                                                    <div className="text-right flex-1 ml-4">
                                                                                        <span className="text-white mobile-text-sm whitespace-pre-line">{specs.wire.power.remarks}</span>
                                                                                    </div>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                )}

                                                                {/* 接地 */}
                                                                {(specs.wire.ground.caseColor || specs.wire.ground.doorColor || specs.wire.ground.panelColor || specs.wire.ground.remarks) && (
                                                                    <div>
                                                                        <h5 className="text-white font-bold mobile-text-sm mb-3">接地</h5>

                                                                        <div className="space-y-3">
                                                                            {/* 筐体 */}
                                                                            {specs.wire.ground.caseColor && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">筐体</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">筐体接地線の仕様</p>
                                                                                    </div>
                                                                                    <div className="text-right">
                                                                                        <span className="text-white mobile-text-sm">{specs.wire.ground.caseColor} / {specs.wire.ground.caseDiameter}sq</span>
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {/* 扉 */}
                                                                            {specs.wire.ground.doorColor && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">扉</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">扉接地線の仕様</p>
                                                                                    </div>
                                                                                    <div className="text-right">
                                                                                        <span className="text-white mobile-text-sm">{specs.wire.ground.doorColor} / {specs.wire.ground.doorDiameter}sq</span>
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {/* 盤間 */}
                                                                            {specs.wire.ground.panelColor && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">盤間</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">盤間接地線の仕様</p>
                                                                                    </div>
                                                                                    <div className="text-right">
                                                                                        <span className="text-white mobile-text-sm">{specs.wire.ground.panelColor} / {specs.wire.ground.panelDiameter}sq</span>
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {/* 接地の備考 */}
                                                                            {specs.wire.ground.remarks && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">備考</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">追加の仕様や注意事項</p>
                                                                                    </div>
                                                                                    <div className="text-right flex-1 ml-4">
                                                                                        <span className="text-white mobile-text-sm whitespace-pre-line">{specs.wire.ground.remarks}</span>
                                                                                    </div>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                )}

                                                                {/* 絶縁キャップ */}
                                                                {((specs.wire.insulationCap && specs.wire.insulationCap !== '' && specs.wire.insulationCap !== '選択してください') || specs.wire.insulationCapRemarks) && (
                                                                    <div>
                                                                        <h5 className="text-white font-bold mobile-text-sm mb-3">絶縁キャップ</h5>

                                                                        <div className="space-y-3">
                                                                            {/* 設定カードは絶縁キャップが選択されている場合のみ表示 */}
                                                                            {specs.wire.insulationCap && specs.wire.insulationCap !== '' && specs.wire.insulationCap !== '選択してください' && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">設定</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">絶縁キャップの使用設定</p>
                                                                                    </div>
                                                                                    <div className="text-right">
                                                                                        <span className="text-white mobile-text-sm">
                                                                                            {specs.wire.insulationCap}
                                                                                            {specs.wire.insulationCapDiameter && ` (${specs.wire.insulationCapDiameter}sq以上)`}
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {/* 備考 */}
                                                                            {specs.wire.insulationCapRemarks && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">備考</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">追加の使用や注意事項</p>
                                                                                    </div>
                                                                                    <div className="text-right flex-1 ml-4">
                                                                                        <span className="text-white mobile-text-sm whitespace-pre-line">{specs.wire.insulationCapRemarks}</span>
                                                                                    </div>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                )}

                                                                {/* 制御AC */}
                                                                {(specs.wire.controlAC.standards?.length > 0 || specs.wire.controlAC.commonColor || specs.wire.controlAC.nonCommonColor || specs.wire.controlAC.remarks) && (
                                                                    <div>
                                                                        <h5 className="text-white font-bold mobile-text-sm mb-3">制御AC</h5>

                                                                        <div className="space-y-3">
                                                                            {/* 規格 */}
                                                                            {specs.wire.controlAC.standards?.length > 0 && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">規格</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">使用する電線規格</p>
                                                                                    </div>
                                                                                    <div className="text-right">
                                                                                        <span className="text-white mobile-text-sm">
                                                                                            {specs.wire.controlAC.standards.map((standard, index) =>
                                                                                                standard === 'その他' && specs.wire.controlAC[`customStandard${index}`]
                                                                                                    ? specs.wire.controlAC[`customStandard${index}`]
                                                                                                    : standard
                                                                                            ).join(', ')}
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {/* コモン */}
                                                                            {specs.wire.controlAC.commonColor && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">コモン</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">コモン線の仕様</p>
                                                                                    </div>
                                                                                    <div className="text-right">
                                                                                        <span className="text-white mobile-text-sm">
                                                                                            {specs.wire.controlAC.commonColor === 'その他' && specs.wire.controlAC.commonColorCustom
                                                                                                ? specs.wire.controlAC.commonColorCustom
                                                                                                : specs.wire.controlAC.commonColor} / {specs.wire.controlAC.commonDiameter}sq
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {/* コモン以外 */}
                                                                            {specs.wire.controlAC.nonCommonColor && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">コモン以外</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">非コモン線の仕様</p>
                                                                                    </div>
                                                                                    <div className="text-right">
                                                                                        <span className="text-white mobile-text-sm">
                                                                                            {specs.wire.controlAC.nonCommonColor === 'その他' && specs.wire.controlAC.nonCommonColorCustom
                                                                                                ? specs.wire.controlAC.nonCommonColorCustom
                                                                                                : specs.wire.controlAC.nonCommonColor} / {specs.wire.controlAC.nonCommonDiameter}sq
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {/* 制御ACの備考 */}
                                                                            {specs.wire.controlAC.remarks && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">備考</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">追加の仕様や注意事項</p>
                                                                                    </div>
                                                                                    <div className="text-right flex-1 ml-4">
                                                                                        <span className="text-white mobile-text-sm whitespace-pre-line">{specs.wire.controlAC.remarks}</span>
                                                                                    </div>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                )}

                                                                {/* 制御DC */}
                                                                {(specs.wire.controlDC.standards?.length > 0 || specs.wire.controlDC.pBusColor || specs.wire.controlDC.nBusColor || specs.wire.controlDC.otherColor || specs.wire.controlDC.remarks) && (
                                                                    <div>
                                                                        <h5 className="text-white font-bold mobile-text-sm mb-3">制御DC</h5>

                                                                        <div className="space-y-3">
                                                                            {/* 規格 */}
                                                                            {specs.wire.controlDC.standards?.length > 0 && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">規格</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">使用する電線規格</p>
                                                                                    </div>
                                                                                    <div className="text-right">
                                                                                        <span className="text-white mobile-text-sm">
                                                                                            {specs.wire.controlDC.standards.map((standard, index) =>
                                                                                                standard === 'その他' && specs.wire.controlDC[`customStandard${index}`]
                                                                                                    ? specs.wire.controlDC[`customStandard${index}`]
                                                                                                    : standard
                                                                                            ).join(', ')}
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {/* P母線 */}
                                                                            {specs.wire.controlDC.pBusColor && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">P母線</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">P母線の仕様</p>
                                                                                    </div>
                                                                                    <div className="text-right">
                                                                                        <span className="text-white mobile-text-sm">
                                                                                            {specs.wire.controlDC.pBusColor === 'その他' && specs.wire.controlDC.pBusColorCustom
                                                                                                ? specs.wire.controlDC.pBusColorCustom
                                                                                                : specs.wire.controlDC.pBusColor} / {specs.wire.controlDC.pBusDiameter}sq
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {/* N母線 */}
                                                                            {specs.wire.controlDC.nBusColor && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">N母線</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">N母線の仕様</p>
                                                                                    </div>
                                                                                    <div className="text-right">
                                                                                        <span className="text-white mobile-text-sm">
                                                                                            {specs.wire.controlDC.nBusColor === 'その他' && specs.wire.controlDC.nBusColorCustom
                                                                                                ? specs.wire.controlDC.nBusColorCustom
                                                                                                : specs.wire.controlDC.nBusColor} / {specs.wire.controlDC.nBusDiameter}sq
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {/* 母線以外 */}
                                                                            {specs.wire.controlDC.otherColor && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">母線以外</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">非母線の仕様</p>
                                                                                    </div>
                                                                                    <div className="text-right">
                                                                                        <span className="text-white mobile-text-sm">
                                                                                            {specs.wire.controlDC.otherColor === 'その他' && specs.wire.controlDC.otherColorCustom
                                                                                                ? specs.wire.controlDC.otherColorCustom
                                                                                                : specs.wire.controlDC.otherColor} / {specs.wire.controlDC.otherDiameter}sq
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {/* 制御DCの備考 */}
                                                                            {specs.wire.controlDC.remarks && (
                                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                                    <div className="flex-1">
                                                                                        <p className="text-white font-medium mobile-text-sm">備考</p>
                                                                                        <p className="text-gray-400 mobile-text-xs">追加の仕様や注意事項</p>
                                                                                    </div>
                                                                                    <div className="text-right flex-1 ml-4">
                                                                                        <span className="text-white mobile-text-sm whitespace-pre-line">{specs.wire.controlDC.remarks}</span>
                                                                                    </div>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                )}

                                                                {/* 特殊仕様セクション */}
                                                                {specs.wire.specialSpec && (
                                                                    <div>
                                                                        <h5 className="text-white font-bold mobile-text-sm mb-3">特殊仕様</h5>
                                                                        <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                            <div className="flex-1">
                                                                                <p className="text-white font-medium mobile-text-sm">仕様詳細</p>
                                                                                <p className="text-gray-400 mobile-text-xs">特殊な仕様や要求事項</p>
                                                                            </div>
                                                                            <div className="text-right flex-1 ml-4">
                                                                                <span className="text-white mobile-text-sm whitespace-pre-line">{specs.wire.specialSpec}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                )}

                                                                {/* メーカー指定（電線） - 特殊仕様の直後に配置 */}
                                                                {specs.wire.manufacturerSpecified && specs.wire.manufacturer && (
                                                                    <div>
                                                                        <h5 className="text-white font-bold mobile-text-sm mb-3">メーカー指定</h5>
                                                                        <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                            <div className="flex-1">
                                                                                <p className="text-white font-medium mobile-text-sm">指定メーカー</p>
                                                                                <p className="text-gray-400 mobile-text-xs">使用する電線メーカー</p>
                                                                            </div>
                                                                            <div className="text-right">
                                                                                <span className="text-white mobile-text-sm">{specs.wire.manufacturer}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    )}

                                                {/* 圧着端子 */}
                                                {(specs.terminal.power || specs.terminal.controlAC || specs.terminal.controlDC || specs.terminal.simultaneousCrimp || specs.terminal.screwClamp || specs.terminal.screwlessClamp || specs.terminal.remarks || (specs.terminal.manufacturerSpecified && specs.terminal.manufacturer)) && (
                                                    <div className="glass-card-dark mobile-compact-card rounded-xl" style={{ padding: '8px 12px 12px 12px' }}>
                                                        <h4 className="text-lg font-bold text-white mobile-text-sm mb-2">圧着端子</h4>

                                                        <div className="space-y-3">
                                                            {specs.terminal.power && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">動力</p>
                                                                        <p className="text-gray-400 mobile-text-xs">動力回路用圧着端子</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">{specs.terminal.power}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.terminal.controlAC && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">制御AC</p>
                                                                        <p className="text-gray-400 mobile-text-xs">AC制御回路用圧着端子</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">{specs.terminal.controlAC}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.terminal.controlDC && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">制御DC</p>
                                                                        <p className="text-gray-400 mobile-text-xs">DC制御回路用圧着端子</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">{specs.terminal.controlDC}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.terminal.simultaneousCrimp && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">同時圧着</p>
                                                                        <p className="text-gray-400 mobile-text-xs">複数線の同時圧着可否</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">{specs.terminal.simultaneousCrimp}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.terminal.screwClamp && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">ネジ式クランプ端子台</p>
                                                                        <p className="text-gray-400 mobile-text-xs">ネジ式クランプ端子台への配線</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">{specs.terminal.screwClamp}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.terminal.screwlessClamp && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">スクリューレス端子台</p>
                                                                        <p className="text-gray-400 mobile-text-xs">スクリューレス端子台への配線</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">{specs.terminal.screwlessClamp}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.terminal.remarks && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">備考</p>
                                                                        <p className="text-gray-400 mobile-text-xs">追加の仕様や注意事項</p>
                                                                    </div>
                                                                    <div className="text-right flex-1 ml-4">
                                                                        <span className="text-white mobile-text-sm whitespace-pre-line">{specs.terminal.remarks}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.terminal.manufacturerSpecified && specs.terminal.manufacturer && (
                                                                <div>
                                                                    <h5 className="text-white font-bold mobile-text-sm mb-3">メーカー指定</h5>
                                                                    <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                        <div className="flex-1">
                                                                            <p className="text-white font-medium mobile-text-sm">指定メーカー</p>
                                                                            <p className="text-gray-400 mobile-text-xs">使用する圧着端子メーカー</p>
                                                                        </div>
                                                                        <div className="text-right">
                                                                            <span className="text-white mobile-text-sm">{specs.terminal.manufacturer}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* 端子台 */}
                                                {(specs.terminalBlock.namePlate || specs.terminalBlock.cover || specs.terminalBlock.bridge || specs.terminalBlock.maxWires || specs.terminalBlock.remarks || (specs.terminalBlock.manufacturerSpecified && specs.terminalBlock.manufacturer)) && (
                                                    <div className="glass-card-dark mobile-compact-card rounded-xl" style={{ padding: '8px 12px 12px 12px' }}>
                                                        <h4 className="text-lg font-bold text-white mobile-text-sm mb-2">端子台</h4>

                                                        <div className="space-y-3">
                                                            {specs.terminalBlock.namePlate && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">記名板</p>
                                                                        <p className="text-gray-400 mobile-text-xs">記名板の有無</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">{specs.terminalBlock.namePlate}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.terminalBlock.cover && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">カバー</p>
                                                                        <p className="text-gray-400 mobile-text-xs">端子台カバーの有無</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">{specs.terminalBlock.cover}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.terminalBlock.bridge && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">渡り金具</p>
                                                                        <p className="text-gray-400 mobile-text-xs">渡り金具の使用設定</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.terminalBlock.bridge}
                                                                            {specs.terminalBlock.bridge === '使用可（指定有り）' && specs.terminalBlock.bridgeSpec &&
                                                                                ` (${specs.terminalBlock.bridgeSpec})`
                                                                            }
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.terminalBlock.maxWires && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">配線可能数</p>
                                                                        <p className="text-gray-400 mobile-text-xs">1端子あたりの配線可能数</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">{specs.terminalBlock.maxWires}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.terminalBlock.remarks && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">備考</p>
                                                                        <p className="text-gray-400 mobile-text-xs">追加の仕様や注意事項</p>
                                                                    </div>
                                                                    <div className="text-right flex-1 ml-4">
                                                                        <span className="text-white mobile-text-sm whitespace-pre-line">{specs.terminalBlock.remarks}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.terminalBlock.manufacturerSpecified && specs.terminalBlock.manufacturer && (
                                                                <div>
                                                                    <h5 className="text-white font-bold mobile-text-sm mb-3">メーカー指定</h5>
                                                                    <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                        <div className="flex-1">
                                                                            <p className="text-white font-medium mobile-text-sm">指定メーカー</p>
                                                                            <p className="text-gray-400 mobile-text-xs">使用する端子台メーカー</p>
                                                                        </div>
                                                                        <div className="text-right">
                                                                            <span className="text-white mobile-text-sm">{specs.terminalBlock.manufacturer}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* 記名板 */}
                                                {((specs.namePlate.fontSize && specs.namePlate.fontSize !== '' && specs.namePlate.fontSize !== '選択してください') || specs.namePlate.remarks) && (
                                                    <div className="glass-card-dark mobile-compact-card rounded-xl" style={{ padding: '8px 12px 12px 12px' }}>
                                                        <h4 className="text-lg font-bold text-white mobile-text-sm mb-2">記名板</h4>

                                                        <div className="space-y-3">
                                                            {/* 文字サイズが選択されている場合のみ表示 */}
                                                            {specs.namePlate.fontSize && specs.namePlate.fontSize !== '' && specs.namePlate.fontSize !== '選択してください' && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">文字サイズ</p>
                                                                        <p className="text-gray-400 mobile-text-xs">記名板の文字サイズ設定</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.namePlate.fontSize === 'その他' && specs.namePlate.customFontSize
                                                                                ? specs.namePlate.customFontSize
                                                                                : specs.namePlate.fontSize}
                                                                        </span>

                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.namePlate.remarks && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">備考</p>
                                                                        <p className="text-gray-400 mobile-text-xs">追加の仕様や注意事項</p>
                                                                    </div>
                                                                    <div className="text-right flex-1 ml-4">
                                                                        <span className="text-white mobile-text-sm whitespace-pre-line">{specs.namePlate.remarks}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* デバイスシール */}
                                                {(specs.deviceSeal.fontSize || specs.deviceSeal.length || specs.deviceSeal.positions?.length > 0 || specs.deviceSeal.remarks) && (
                                                    <div className="glass-card-dark mobile-compact-card rounded-xl" style={{ padding: '8px 12px 12px 12px' }}>
                                                        <h4 className="text-lg font-bold text-white mobile-text-sm mb-2">デバイスシール</h4>

                                                        <div className="space-y-3">
                                                            {specs.deviceSeal.fontSize && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">文字サイズ</p>
                                                                        <p className="text-gray-400 mobile-text-xs">デバイスシールの文字サイズ</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.deviceSeal.fontSize === 'その他' && specs.deviceSeal.customFontSize
                                                                                ? specs.deviceSeal.customFontSize
                                                                                : specs.deviceSeal.fontSize}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}

                                                            {specs.deviceSeal.length && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">長さ</p>
                                                                        <p className="text-gray-400 mobile-text-xs">デバイスシールの長さ設定</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.deviceSeal.length === 'その他' && specs.deviceSeal.customLength
                                                                                ? specs.deviceSeal.customLength
                                                                                : specs.deviceSeal.length}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}

                                                            {specs.deviceSeal.positions?.length > 0 && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">位置</p>
                                                                        <p className="text-gray-400 mobile-text-xs">デバイスシールの取付位置</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.deviceSeal.positions.join(', ')}
                                                                            {specs.deviceSeal.customPosition && `, ${specs.deviceSeal.customPosition}`}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.deviceSeal.remarks && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">備考</p>
                                                                        <p className="text-gray-400 mobile-text-xs">追加の仕様や注意事項</p>
                                                                    </div>
                                                                    <div className="text-right flex-1 ml-4">
                                                                        <span className="text-white mobile-text-sm whitespace-pre-line">{specs.deviceSeal.remarks}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* マークチューブ */}
                                                {(Object.values(specs.markTube?.orientation || {}).some(v => v) || specs.markTube?.fontSize || specs.markTube?.length || specs.markTube?.printSpec || specs.markTube?.remarks) && (
                                                    <div className="glass-card-dark mobile-compact-card rounded-xl" style={{ padding: '8px 12px 12px 12px' }}>
                                                        <h4 className="text-lg font-bold text-white mobile-text-sm -mb-1">マークチューブ</h4>

                                                        {Object.values(specs.markTube.orientation || {}).some(v => v) && (
                                                            <div className="glass-card mobile-compact-card rounded-lg mb-3 mt-3 pb-16" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                <h5 className="text-white font-medium mobile-text-sm mb-3">向き</h5>
                                                                <div className="flex justify-center">
                                                                    <div
                                                                        className="relative mb-3"   // ← ここで図を下にずらす
                                                                        style={{
                                                                            width: '200px', height: '200px',        // 200px → 150pxに変更
                                                                            transform: 'scale(0.7)'
                                                                        }}
                                                                    >
                                                                        {/* 中央の円 */}
                                                                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-gray-600 rounded-full border-2 border-white"></div>

                                                                        {/* 上 - 枠ごと時計回りに90°回転 */}
                                                                        <div className="absolute top-2 left-1/2 transform -translate-x-1/2"
                                                                            style={{ transform: 'translateX(-50%) rotate(90deg)', transformOrigin: 'center' }}>
                                                                            <div className="w-16 h-10 border-2 border-gray-400 rounded flex items-center justify-center bg-gray-800">
                                                                                <span className={`text-white font-bold`}
                                                                                    style={{ transform: specs.markTube.orientation.up === '逆向き' ? 'rotate(180deg)' : 'none' }}>
                                                                                    ABC
                                                                                </span>
                                                                            </div>
                                                                        </div>

                                                                        {/* 下 - 枠ごと反時計回りに90°回転 */}
                                                                        <div className="absolute bottom-2 left-1/2 transform -translate-x-1/2"
                                                                            style={{ transform: 'translateX(-50%) rotate(-90deg)', transformOrigin: 'center' }}>
                                                                            <div className="w-16 h-10 border-2 border-gray-400 rounded flex items-center justify-center bg-gray-800">
                                                                                <span className={`text-white font-bold`}
                                                                                    style={{ transform: specs.markTube.orientation.down === '逆向き' ? 'rotate(180deg)' : 'none' }}>
                                                                                    ABC
                                                                                </span>
                                                                            </div>
                                                                        </div>

                                                                        {/* 左 - 文字のみ時計回りに90°回転 */}
                                                                        <div className="absolute top-1/2 left-0 transform -translate-y-1/2 w-16 h-10 border-2 border-gray-400 rounded flex items-center justify-center bg-gray-800">
                                                                            <span className="text-white font-bold"
                                                                                style={{ transform: `rotate(0deg) ${specs.markTube.orientation.left === '逆向き' ? 'rotate(180deg)' : ''}` }}>
                                                                                ABC
                                                                            </span>
                                                                        </div>

                                                                        {/* 右 - 文字のみ時計回りに90°回転 */}
                                                                        <div className="absolute top-1/2 right-0 transform -translate-y-1/2 w-16 h-10 border-2 border-gray-400 rounded flex items-center justify-center bg-gray-800">
                                                                            <span className="text-white font-bold"
                                                                                style={{ transform: `rotate(180deg) ${specs.markTube.orientation.right === '逆向き' ? 'rotate(180deg)' : ''}` }}>
                                                                                ABC
                                                                            </span>
                                                                        </div>

                                                                        {/* ラベル */}
                                                                        <div className="absolute -top-10 left-1/2 transform -translate-x-1/2 text-white font-medium">上: {specs.markTube.orientation.up || '未設定'}</div>
                                                                        <div className="absolute -bottom-10 left-1/2 transform -translate-x-1/2 text-white font-medium">下: {specs.markTube.orientation.down || '未設定'}</div>
                                                                        <div className="absolute top-1/2 -left-20 transform -translate-y-1/2 text-white font-medium">左: {specs.markTube.orientation.left || '未設定'}</div>
                                                                        <div className="absolute top-1/2 -right-20 transform -translate-y-1/2 text-white font-medium">右: {specs.markTube.orientation.right || '未設定'}</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* その他の仕様 */}
                                                        <div className="space-y-3 mt-3">
                                                            {specs.markTube.fontSize && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">文字サイズ</p>
                                                                        <p className="text-gray-400 mobile-text-xs">マークチューブの文字サイズ</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.markTube.fontSize === 'その他' && specs.markTube.customFontSize
                                                                                ? specs.markTube.customFontSize
                                                                                : specs.markTube.fontSize}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.markTube.length && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">長さ</p>
                                                                        <p className="text-gray-400 mobile-text-xs">マークチューブの長さ設定</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.markTube.length === 'その他' && specs.markTube.customLength
                                                                                ? specs.markTube.customLength
                                                                                : specs.markTube.length}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.markTube.printSpec && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">印字仕様</p>
                                                                        <p className="text-gray-400 mobile-text-xs">印字の仕様と詳細</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.markTube.printSpec}
                                                                            {specs.markTube.printSpecDetail && ` (${specs.markTube.printSpecDetail})`}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.markTube.remarks && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">備考</p>
                                                                        <p className="text-gray-400 mobile-text-xs">追加の仕様や注意事項</p>
                                                                    </div>
                                                                    <div className="text-right flex-1 ml-4">
                                                                        <span className="text-white mobile-text-sm whitespace-pre-line">{specs.markTube.remarks}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* その他確認事項 */}
                                                {(specs.otherConfirm.tighteningPen || specs.otherConfirm.matchMark || specs.otherConfirm.screw || specs.otherConfirm.hookTube || specs.otherConfirm.spiralTube || specs.otherConfirm.insulock || specs.otherConfirm.mountBase || specs.otherConfirm.routeSpecialNote || specs.otherConfirm.remarks) && (
                                                    <div className="glass-card-dark mobile-compact-card rounded-xl" style={{ padding: '8px 12px 12px 12px' }}>
                                                        <h4 className="text-lg font-bold text-white mobile-text-sm mb-2">その他確認事項</h4>

                                                        <div className="space-y-3">
                                                            {specs.otherConfirm.tighteningPen && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">増し締めペン</p>
                                                                        <p className="text-gray-400 mobile-text-xs">増し締めペンの使用設定</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.otherConfirm.tighteningPen}
                                                                            {specs.otherConfirm.tighteningPenDetail && ` (${specs.otherConfirm.tighteningPenDetail})`}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.otherConfirm.matchMark && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">合マーク</p>
                                                                        <p className="text-gray-400 mobile-text-xs">合マークの表記方式</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.otherConfirm.matchMark === 'その他' && specs.otherConfirm.matchMarkDetail
                                                                                ? specs.otherConfirm.matchMarkDetail
                                                                                : specs.otherConfirm.matchMark}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.otherConfirm.screw && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">ネジ</p>
                                                                        <p className="text-gray-400 mobile-text-xs">使用するネジの種類</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.otherConfirm.screw === 'その他' && specs.otherConfirm.screwDetail
                                                                                ? specs.otherConfirm.screwDetail
                                                                                : specs.otherConfirm.screw}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.otherConfirm.hookTube && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">ホックチューブ</p>
                                                                        <p className="text-gray-400 mobile-text-xs">ホックチューブの色</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.otherConfirm.hookTube === 'その他' && specs.otherConfirm.hookTubeDetail
                                                                                ? specs.otherConfirm.hookTubeDetail
                                                                                : specs.otherConfirm.hookTube}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.otherConfirm.spiralTube && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">スパイラルチューブ</p>
                                                                        <p className="text-gray-400 mobile-text-xs">スパイラルチューブの色</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.otherConfirm.spiralTube === 'その他' && specs.otherConfirm.spiralTubeDetail
                                                                                ? specs.otherConfirm.spiralTubeDetail
                                                                                : specs.otherConfirm.spiralTube}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.otherConfirm.insulock && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">インシュロック</p>
                                                                        <p className="text-gray-400 mobile-text-xs">インシュロックの色</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.otherConfirm.insulock === 'その他' && specs.otherConfirm.insulockDetail
                                                                                ? specs.otherConfirm.insulockDetail
                                                                                : specs.otherConfirm.insulock}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.otherConfirm.mountBase && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">マウントベース</p>
                                                                        <p className="text-gray-400 mobile-text-xs">マウントベースの色</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="text-white mobile-text-sm">
                                                                            {specs.otherConfirm.mountBase === 'その他' && specs.otherConfirm.mountBaseDetail
                                                                                ? specs.otherConfirm.mountBaseDetail
                                                                                : specs.otherConfirm.mountBase}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.otherConfirm.routeSpecialNote && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">配線ルートに関しての特記事項</p>
                                                                        <p className="text-gray-400 mobile-text-xs">配線ルートの特殊な要求や注意事項</p>
                                                                    </div>
                                                                    <div className="text-right flex-1 ml-4">
                                                                        <span className="text-white mobile-text-sm whitespace-pre-line">
                                                                            {specs.otherConfirm.routeSpecialNote}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {specs.otherConfirm.remarks && (
                                                                <div className="flex items-start justify-between mobile-compact-card glass-card rounded-lg" style={{ boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }}>
                                                                    <div className="flex-1">
                                                                        <p className="text-white font-medium mobile-text-sm">備考</p>
                                                                        <p className="text-gray-400 mobile-text-xs">その他の確認事項に関する備考</p>
                                                                    </div>
                                                                    <div className="text-right flex-1 ml-4">
                                                                        <span className="text-white mobile-text-sm whitespace-pre-line">{specs.otherConfirm.remarks}</span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}

                                            </div>
                                        );
                                    })()}

                                    <div className="mt-6 mb-1.5">
                                        <button
                                            onClick={() => setShowWiringModal(false)}
                                            className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                        >
                                            閉じる
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 工数入力モーダル */}
                        {showHoursInputModal && hoursInputTask && (
                            <div className="modal-overlay" onClick={() => setShowHoursInputModal(false)}>
                                <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-sm mx-4" onClick={(e) => e.stopPropagation()}>
                                    <div className="mb-4">
                                        <h3 className="text-base font-bold text-white pt-2">工数入力</h3>
                                    </div>

                                    <div className="mb-4">
                                        <h4 className="font-bold text-white mobile-text-sm mb-2">{hoursInputTask.title}</h4>
                                        <p className="text-gray-300 mobile-text-xs">
                                            案件: {projects.find(p => String(p.id) === String(hoursInputTask.projectId))?.name}
                                        </p>
                                    </div>

                                    <div className="space-y-3 mb-4">
                                        {/* 日付入力 */}
                                        <div>
                                            <label className="text-gray-300 mobile-text-sm block mb-2">日付</label>
                                            <div className="relative w-full">
                                                <input
                                                    type="date"
                                                    value={selectedDate}
                                                    onChange={(e) => {
                                                        setSelectedDate(e.target.value);
                                                        // 日付変更時に既存工数を取得
                                                        const existingSession = workSessions.find(s =>
                                                            s.userId === user.uid &&
                                                            s.taskId === hoursInputTask.id &&
                                                            s.date &&
                                                            s.date.toDate().toDateString() === new Date(e.target.value).toDateString()
                                                        );
                                                        setDailyHours(existingSession ? parseFloat(existingSession.hours).toFixed(1) : '');
                                                    }}
                                                    className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                                    min="2020-01-01"
                                                    max="2030-12-31"
                                                    style={{
                                                        WebkitAppearance: 'none',
                                                        MozAppearance: 'none',
                                                        appearance: 'none',
                                                        minHeight: '44px'
                                                    }}
                                                />
                                                {selectedDate && (
                                                    <button
                                                        type="button"
                                                        onClick={() => setSelectedDate(new Date().toISOString().split('T')[0])}
                                                        className="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white text-lg"
                                                        title="今日に戻す"
                                                    >
                                                        ↻
                                                    </button>
                                                )}
                                            </div>
                                        </div>

                                        {/* 工数入力 */}
                                        <div>
                                            <label className="text-gray-300 mobile-text-sm block mb-2">実績工数（時間）</label>
                                            <div className="number-input-container">
                                                <input
                                                    type="number"
                                                    inputMode="decimal"
                                                    pattern="[0-9]*[.,]?[0-9]*"
                                                    value={dailyHours}
                                                    onChange={(e) => setDailyHours(e.target.value)}
                                                    className="w-full dark-input rounded-xl px-4 py-3 focus:outline-none text-sm"
                                                    step="0.1"
                                                    min="0"
                                                    placeholder="0.0"
                                                    style={{ minHeight: '44px' }}
                                                />
                                                <div className="custom-spin-buttons">
                                                    <button
                                                        type="button"
                                                        className="spin-button spin-button-up"
                                                        onClick={() => {
                                                            const currentValue = parseFloat(dailyHours) || 0;
                                                            setDailyHours((currentValue + 0.1).toFixed(1));
                                                        }}
                                                    />
                                                    <button
                                                        type="button"
                                                        className="spin-button spin-button-down"
                                                        onClick={() => {
                                                            const currentValue = parseFloat(dailyHours) || 0;
                                                            setDailyHours(Math.max(0, currentValue - 0.1).toFixed(1));
                                                        }}
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        {/* クイック入力ボタン */}
                                        <div>
                                            <label className="text-gray-300 mobile-text-sm block mb-2">クイック入力</label>
                                            <div className="grid grid-cols-4 gap-2">
                                                {[0.5, 1, 2, 4, 6, 8].map(hours => (
                                                    <button
                                                        key={hours}
                                                        onClick={() => setDailyHours(hours.toFixed(1))}
                                                        className="glass-card-dark text-white py-2 px-2 rounded-lg mobile-text-xs font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300"
                                                    >
                                                        {hours.toFixed(1)}h
                                                    </button>
                                                ))}
                                                <button
                                                    onClick={() => setDailyHours('0')}
                                                    className="glass-card-dark text-white py-2 px-2 rounded-lg mobile-text-xs font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300"
                                                >
                                                    0h
                                                </button>
                                                <button
                                                    onClick={() => setDailyHours('')}
                                                    className="glass-card-dark text-white py-2 px-2 rounded-lg mobile-text-xs font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300"
                                                >
                                                    クリア
                                                </button>
                                            </div>
                                        </div>

                                        {/* 既存工数の表示 */}
                                        {(() => {
                                            const existingSession = workSessions.find(s =>
                                                s.userId === user.uid &&
                                                s.taskId === hoursInputTask.id &&
                                                s.date &&
                                                s.date.toDate().toDateString() === new Date(selectedDate).toDateString()
                                            );

                                            if (existingSession) {
                                                return (
                                                    <div className="glass-card-dark p-3 rounded-lg">
                                                        <p className="text-gray-300 mobile-text-xs">
                                                            現在の記録: <span className="text-white font-bold">{parseFloat(existingSession.hours).toFixed(1)}時間</span>
                                                        </p>
                                                    </div>
                                                );
                                            }
                                            return null;
                                        })()}
                                    </div>

                                    <div className="grid grid-cols-1 gap-2 mb-1.5 mt-6">
                                        <button
                                            onClick={saveDailyHours}
                                            className="gradient-button text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 text-sm w-full"
                                        >
                                            更新
                                        </button>
                                        <button
                                            onClick={() => setShowHoursInputModal(false)}
                                            className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                        >
                                            キャンセル
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* ユーザー管理モーダル */}
                        {showUserManagementModal && (
                            <div className="modal-overlay" onClick={() => setShowUserManagementModal(false)}>
                                <div className="modal-content glass-card mobile-compact-card rounded-2xl w-full max-w-4xl mx-4"
                                    onClick={(e) => e.stopPropagation()}
                                    style={{ maxHeight: '90vh', overflowY: 'auto' }}>
                                    <div className="mb-4">
                                        <h3 className="text-base font-bold text-white pt-2">
                                            ユーザー管理
                                        </h3>
                                    </div>

                                    <div>
                                        {allUsers.length > 0 ? (
                                            <div className="space-y-2">
                                                {allUsers.map(user => (
                                                    <div key={user.id} className="glass-card-dark p-3 rounded-lg flex items-center justify-between">
                                                        <div className="flex-1">
                                                            <div className="font-bold text-white mobile-text-sm">
                                                                {user.displayName ? user.displayName : `ユーザー (${user.email.split('@')[0]})`}
                                                            </div>
                                                            <div className="text-gray-400 mobile-text-xs">
                                                                {user.email}
                                                            </div>
                                                            {user.id === MASTER_ADMIN_UID && (
                                                                <span className="inline-block px-2 py-1 bg-yellow-500 text-black text-xs rounded mt-1">
                                                                    マスター管理者
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div className="flex items-center">
                                                            {user.id === MASTER_ADMIN_UID ? (
                                                                <span className="text-gray-500 mobile-text-xs">変更不可</span>
                                                            ) : (
                                                                <label className="flex items-center cursor-pointer">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={adminUsers.includes(user.id)}
                                                                        onChange={(e) => {
                                                                            const isChecked = e.target.checked;
                                                                            if (isChecked) {
                                                                                setAdminUsers(prev => [...prev.filter(id => id !== user.id), user.id]);
                                                                            } else {
                                                                                setAdminUsers(prev => prev.filter(id => id !== user.id));
                                                                            }
                                                                        }}
                                                                        className="mr-2"
                                                                    />
                                                                    <span className="text-white mobile-text-xs">管理者</span>
                                                                </label>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="text-center text-gray-400 py-8">
                                                ユーザーデータを読み込み中...
                                            </div>
                                        )}
                                    </div>



                                    <div className="flex flex-col gap-2 mt-6 mb-1.5">
                                        <button
                                            onClick={async () => {
                                                try {
                                                    // 管理者権限の更新処理
                                                    for (const user of allUsers) {
                                                        if (user.id !== MASTER_ADMIN_UID) {
                                                            const shouldBeAdmin = adminUsers.includes(user.id);
                                                            const currentIsAdmin = user.isAdmin === true;

                                                            // 権限状態が変更された場合のみ更新
                                                            if (shouldBeAdmin !== currentIsAdmin) {
                                                                await updateAdminStatus(user.id, shouldBeAdmin);
                                                            }
                                                        }
                                                    }

                                                    // 全ユーザー情報を再読み込み
                                                    await loadAllUsers();

                                                    // 現在ログインしているユーザーの権限を再確認
                                                    await checkAdminRights(auth.currentUser);

                                                    console.log('管理者権限更新完了');
                                                } catch (error) {
                                                    console.error('管理者権限更新エラー:', error);
                                                    alert('権限の更新に失敗しました。Firestoreセキュリティルールが正しく設定されているか確認してください。');
                                                }
                                                setShowUserManagementModal(false);
                                            }}
                                            className="gradient-button text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 text-sm w-full"
                                        >
                                            更新
                                        </button>
                                        <button
                                            onClick={() => setShowUserManagementModal(false)}
                                            className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                        >
                                            キャンセル
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* ユーザーアイコン色選択モーダル */}
                        {showColorPickerModal && (
                            <div className="modal-overlay" onClick={() => {
                                setTempIconColor(userIconColor); // 一時色を元に戻す
                                setShowColorPickerModal(false);
                            }}>
                                <div className="modal-content glass-card mobile-compact-card rounded-2xl w-full max-w-md mx-4"
                                    onClick={(e) => e.stopPropagation()}>
                                    <div className="mb-4">
                                        <h3 className="text-base font-bold text-white pt-2">
                                            アイコンの色を選択
                                        </h3>
                                    </div>

                                    {/* カラーパレット */}
                                    <div className="grid grid-cols-6 gap-3 mb-6">
                                        {[
                                            // グラデーション（初期色を含む）
                                            'linear-gradient(45deg, #667eea 0%, #764ba2 100%)',
                                            'linear-gradient(45deg, #f093fb 0%, #f5576c 100%)',
                                            'linear-gradient(45deg, #4facfe 0%, #00f2fe 100%)',
                                            'linear-gradient(45deg, #43e97b 0%, #38f9d7 100%)',
                                            'linear-gradient(45deg, #fa709a 0%, #fee140 100%)',
                                            'linear-gradient(45deg, #a8edea 0%, #fed6e3 100%)',
                                            'linear-gradient(45deg, #ffecd2 0%, #fcb69f 100%)',
                                            'linear-gradient(45deg, #ff8a80 0%, #ea4c89 100%)',
                                            // はっきりと違いがわかる基本色
                                            '#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4',
                                            '#8b5cf6', '#ec4899', '#374151', '#6b7280', '#e5e7eb',
                                            '#991b1b', '#92400e', '#365314', '#1e40af', '#581c87',
                                            // 追加色
                                            '#dc2626'
                                        ].map(color => (
                                            <div
                                                key={color}
                                                className={`w-10 h-10 rounded-full cursor-pointer transition-all duration-200 hover:scale-110 ${tempIconColor === color ? 'ring-2 ring-white ring-offset-2 ring-offset-gray-800' : ''
                                                    }`}
                                                style={{ background: color }}
                                                onClick={() => setTempIconColor(color)}
                                            />
                                        ))}
                                    </div>


                                    {/* ボタン */}
                                    <div className="space-y-2 mb-1.5">
                                        <button
                                            onClick={async () => {
                                                try {
                                                    // 一時色を実際の色に反映
                                                    setUserIconColor(tempIconColor);

                                                    // ユーザー設定をFirestoreに保存
                                                    const userSettingsRef = db.collection('userSettings').doc(user.uid);
                                                    await userSettingsRef.set({
                                                        iconColor: tempIconColor,
                                                        updatedAt: new Date()
                                                    }, { merge: true });
                                                    setShowColorPickerModal(false);
                                                } catch (error) {
                                                    console.error('色設定の保存に失敗しました:', error);
                                                    alert('色設定の保存に失敗しました');
                                                }
                                            }}
                                            className="gradient-button text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 text-sm w-full"
                                        >
                                            保存
                                        </button>
                                        <button
                                            onClick={() => {
                                                setTempIconColor(userIconColor); // 一時色を元に戻す
                                                setShowColorPickerModal(false);
                                            }}
                                            className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                        >
                                            キャンセル
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* ログアウト確認モーダル */}
                        {showLogoutConfirm && (
                            <div className="modal-overlay" onClick={() => setShowLogoutConfirm(false)}>
                                <div className="modal-content glass-card mobile-compact-card rounded-2xl w-full max-w-md mx-4" onClick={(e) => e.stopPropagation()}>
                                    <div className="text-center">
                                        {/* カスタムログアウトアイコン */}
                                        <div className="flex justify-center mb-4 mt-2">
                                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="gray" strokeWidth="1.5">
                                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                                                <polyline points="16,17 21,12 16,7" />
                                                <line x1="21" y1="12" x2="9" y2="12" />
                                            </svg>
                                        </div>
                                        <p className="text-gray-300 mb-4 text-sm">
                                            ログアウトしますか？
                                            <span className="block text-red-300 text-xs mt-2">
                                                ※ 未保存の変更がある場合は失われる可能性があります
                                            </span>
                                        </p>
                                        <div className="flex gap-2 mb-1.5">
                                            <button
                                                onClick={() => setShowLogoutConfirm(false)}
                                                className="flex-1 glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm"
                                            >
                                                キャンセル
                                            </button>
                                            <button
                                                onClick={confirmLogout}
                                                className="flex-1 gradient-red text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-300 text-sm"
                                            >
                                                ログアウト
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 日別工数表示モーダル */}
                        {showDailyHoursModal && (
                            <div className="modal-overlay" onClick={() => setShowDailyHoursModal(false)}>
                                <div className="modal-content glass-card mobile-compact-card rounded-2xl floating-animation w-full max-w-3xl mx-4" onClick={(e) => e.stopPropagation()}>
                                    <div className="mb-4">
                                        <h3 className="text-base font-bold text-white pt-2">
                                            {selectedDateForModal}の工数一覧
                                        </h3>
                                    </div>

                                    <div style={{ maxHeight: '60vh', overflowY: 'auto' }}>
                                        {dailyHoursSessions.length === 0 ? (
                                            <div className="text-center text-gray-400 py-8 mobile-text-sm">
                                                この日に記録された工数はありません
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                {dailyHoursSessions.map((session, index) => {
                                                    const project = projects.find(p => p.id === session.projectId);
                                                    const task = tasks.find(t => t.id === session.taskId);
                                                    const company = companies.find(c => c.id === project?.companyId);


                                                    return (
                                                        <div key={index} className="glass-card-dark p-3 rounded-xl mobile-compact-card">
                                                            <div className="flex justify-between items-start mb-2">
                                                                <div className="flex-1 pr-3">
                                                                    <h4 className="text-white font-bold mobile-text-sm truncate">
                                                                        {project?.name || session.projectName || '不明なプロジェクト'}
                                                                    </h4>
                                                                    <p className="text-purple-300 mobile-text-xs truncate">
                                                                        {company?.name || project?.companyName || session.companyName || project?.company || '会社名不明'}
                                                                    </p>
                                                                    <p className="text-gray-300 mobile-text-xs mt-0.5 -mb-2 truncate">
                                                                        {task?.name || session.taskName || '不明な工程'}
                                                                    </p>
                                                                </div>
                                                                <div className="text-right flex-shrink-0">
                                                                    <div className="text-white font-bold mobile-text-sm">
                                                                        {parseFloat(session.hours).toFixed(1)}h
                                                                    </div>
                                                                    <div className="text-gray-400 mobile-text-xs">
                                                                        {(() => {
                                                                            const timestamp = session.updatedAt || session.createdAt;
                                                                            if (!timestamp) return '時刻不明';

                                                                            try {
                                                                                let date;
                                                                                if (typeof timestamp.toDate === 'function') {
                                                                                    date = timestamp.toDate();
                                                                                } else {
                                                                                    date = new Date(timestamp);
                                                                                }

                                                                                // 有効な日付かチェック
                                                                                if (isNaN(date.getTime())) {
                                                                                    return '時刻不明';
                                                                                }

                                                                                return date.toLocaleTimeString('ja-JP', {
                                                                                    hour: '2-digit',
                                                                                    minute: '2-digit'
                                                                                });
                                                                            } catch (error) {
                                                                                console.warn('日付変換エラー:', error, timestamp);
                                                                                return '時刻不明';
                                                                            }
                                                                        })()}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {session.memo && (
                                                                <div className="mt-2 p-2 bg-black bg-opacity-20 rounded mobile-text-xs text-gray-300">
                                                                    {session.memo}
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}

                                                {/* 合計時間 */}
                                                <div className="mt-4 p-3 glass-card rounded-xl mobile-compact-card">
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-white font-bold mobile-text-sm">合計時間</span>
                                                        <span className="text-white font-bold mobile-text-sm">
                                                            {dailyHoursSessions.reduce((total, session) => total + session.hours, 0).toFixed(1)}h
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* 閉じるボタン */}
                                    <div className="mt-6 mb-1.5">
                                        <button
                                            onClick={() => setShowDailyHoursModal(false)}
                                            className="glass-card-dark text-white px-4 py-3 rounded-xl font-bold hover:bg-gray-500 hover:bg-opacity-20 transition-all duration-300 text-sm w-full"
                                        >
                                            閉じる
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        }

        // アプリケーションをレンダリング
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(ProjectManagementApp));
    </script>
</body>

</html>